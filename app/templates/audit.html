<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ“ä½œæ—¥å¿— - è®¾å¤‡å°è´¦ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/session-manager.js"></script>
    <script>
        // ç®€åŒ–çš„APIå®¢æˆ·ç«¯ï¼Œç›´æ¥å†…åµŒåˆ°é¡µé¢ä¸­
        const AuditLogAPI = {
            async getAuditLogs(params = {}) {
                const queryParams = new URLSearchParams();
                
                if (params.skip) queryParams.append('skip', params.skip);
                if (params.limit) queryParams.append('limit', params.limit);
                if (params.user_id) queryParams.append('user_id', params.user_id);
                if (params.action) queryParams.append('action', params.action);
                if (params.start_date) queryParams.append('start_date', params.start_date);
                if (params.end_date) queryParams.append('end_date', params.end_date);
                
                const endpoint = `/api/audit/${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
                return apiRequest(endpoint);
            },

            async getAuditUsers() {
                return apiRequest('/api/audit/users');
            }
        };

        // ç®€åŒ–çš„APIè¯·æ±‚å‡½æ•°
        async function apiRequest(endpoint) {
            const token = localStorage.getItem('access_token');
            const url = endpoint;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(url, { headers });
            
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_info');
                window.location.href = '/login';
                throw new Error('ç™»å½•å·²è¿‡æœŸ, è¯·é‡æ–°ç™»å½•');
            }
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `è¯·æ±‚å¤±è´¥: ${response.status}`);
            }
            
            return await response.json();
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #667eea;
        }
        .log-row:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }
        .action-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .action-create { background-color: #10b981; color: white; }
        .action-update { background-color: #3b82f6; color: white; }
        .action-delete { background-color: #ef4444; color: white; }
        .action-login { background-color: #8b5cf6; color: white; }
        .action-logout { background-color: #6b7280; color: white; }
        .action-other { background-color: #f59e0b; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="w-64 gradient-bg shadow-xl fixed left-0 top-0 h-full z-10">
            <div class="flex flex-col h-full">
                <!-- Logoå’Œæ ‡é¢˜ -->
                <div class="flex items-center justify-center h-16 px-4 border-b border-white/20">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-list text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-lg font-bold">è®¾å¤‡å°è´¦ç®¡ç†ç³»ç»Ÿ</h1>
                    </div>
                </div>

                <!-- å¯¼èˆªèœå• -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="/dashboard" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="dashboard-link">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span>ä»ªè¡¨ç›˜</span>
                    </a>
                    <a href="/equipment" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="equipment-link">
                        <i class="fas fa-cogs mr-3 text-lg"></i>
                        <span>è®¾å¤‡ç®¡ç†</span>
                    </a>
                    <a href="#" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="maintenance-link">
                        <i class="fas fa-tools mr-3 text-lg"></i>
                        <span>ç»´æŠ¤è®°å½•</span>
                    </a>
                    <a href="/reports" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="reports-link">
                        <i class="fas fa-chart-bar mr-3 text-lg"></i>
                        <span>ç»Ÿè®¡æŠ¥è¡¨</span>
                    </a>
                    
                    <!-- ç³»ç»Ÿç®¡ç†ä¸‹æ‹‰èœå• -->
                    <div class="relative">
                        <button class="sidebar-item active flex items-center justify-between w-full px-4 py-3 text-white/90 rounded-lg" id="system-menu-btn">
                            <div class="flex items-center">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                <span>ç³»ç»Ÿç®¡ç†</span>
                            </div>
                            <i class="fas fa-chevron-down text-sm transition-transform duration-200 rotate-180" id="system-menu-arrow"></i>
                        </button>
                        <div class="ml-4 mt-1 space-y-1" id="system-submenu">
                            <a href="/categories" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-tags mr-3"></i>
                                <span>è®¾å¤‡ç±»åˆ«</span>
                            </a>
                            <a href="/users" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-users mr-3"></i>
                                <span>ç”¨æˆ·ç®¡ç†</span>
                            </a>
                            <a href="/departments" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-building mr-3"></i>
                                <span>éƒ¨é—¨ç®¡ç†</span>
                            </a>
                            <a href="/audit" class="sidebar-item active flex items-center px-4 py-2 text-white/80 rounded-lg text-sm bg-white/10" id="audit-link">
                                <i class="fas fa-history mr-3"></i>
                                <span>æ“ä½œæ—¥å¿—</span>
                            </a>
                            <a href="/settings" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="settings-link">
                                <i class="fas fa-cog mr-3"></i>
                                <span>ç³»ç»Ÿè®¾ç½®</span>
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- ç”¨æˆ·ä¿¡æ¯ -->
                <div class="border-t border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-white text-xl mr-3"></i>
                            <div>
                                <p class="text-white text-sm font-medium" id="current-user">ç”¨æˆ·</p>
                                <p class="text-white/70 text-xs">åœ¨çº¿</p>
                            </div>
                        </div>
                        <button class="text-white/70 hover:text-white transition-colors" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-1 ml-64 overflow-hidden">
            <div class="h-full overflow-y-auto">
            <!-- é¡¶éƒ¨é€šçŸ¥å®¹å™¨ -->
            <div id="notification-container" class="fixed top-4 right-4 z-[99999] space-y-2 max-w-md"></div>
            
            <!-- ä¸»è¦å†…å®¹ -->
            <div class="p-8">
                <!-- é¡µé¢æ ‡é¢˜ -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">æ“ä½œæ—¥å¿—</h1>
                    <p class="text-gray-600">æŸ¥çœ‹ç³»ç»Ÿæ“ä½œè®°å½•å’Œå®¡è®¡ä¿¡æ¯</p>
                </div>

                <!-- ç­›é€‰åŒºåŸŸ -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ“ä½œç”¨æˆ·</label>
                            <select id="filter-user" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">æ‰€æœ‰ç”¨æˆ·</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ“ä½œç±»å‹</label>
                            <select id="filter-action" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">æ‰€æœ‰æ“ä½œ</option>
                                <option value="åˆ›å»º">åˆ›å»º</option>
                                <option value="ä¿®æ”¹">ä¿®æ”¹</option>
                                <option value="åˆ é™¤">åˆ é™¤</option>
                                <option value="ç™»å½•">ç™»å½•</option>
                                <option value="ç™»å‡º">ç™»å‡º</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="filter-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="filter-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button id="reset-filters" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                            <i class="fas fa-undo mr-2"></i>é‡ç½®
                        </button>
                        <button id="apply-filters" class="btn-primary text-white px-4 py-2 rounded-md hover:shadow-lg transition-all duration-200">
                            <i class="fas fa-filter mr-2"></i>åº”ç”¨ç­›é€‰
                        </button>
                    </div>
                </div>

                <!-- æ—¥å¿—ç»Ÿè®¡ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-list text-blue-600"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-gray-600">æ€»æ—¥å¿—æ•°</p>
                                <p class="text-lg font-semibold text-gray-900" id="total-logs">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i class="fas fa-plus text-green-600"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-gray-600">ä»Šæ—¥æ–°å¢</p>
                                <p class="text-lg font-semibold text-gray-900" id="today-logs">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i class="fas fa-users text-purple-600"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-gray-600">æ´»è·ƒç”¨æˆ·</p>
                                <p class="text-lg font-semibold text-gray-900" id="active-users">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <i class="fas fa-cog text-orange-600"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-gray-600">è®¾å¤‡æ“ä½œ</p>
                                <p class="text-lg font-semibold text-gray-900" id="equipment-ops">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ—¥å¿—åˆ—è¡¨ -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-900">æ“ä½œæ—¥å¿—åˆ—è¡¨</h2>
                            <div class="flex space-x-2">
                                <button id="refresh-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
                                </button>
                                <button id="export-btn" class="px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition-colors">
                                    <i class="fas fa-download mr-2"></i>å¯¼å‡º
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œæ—¶é—´</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œç”¨æˆ·</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œç±»å‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œå¯¹è±¡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œæè¿°</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¯¦ç»†ä¿¡æ¯</th>
                                </tr>
                            </thead>
                            <tbody id="audit-logs-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- æ—¥å¿—æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="px-6 py-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-700">
                                æ˜¾ç¤º <span id="page-info">0-0</span> æ¡ï¼Œå…± <span id="total-count">0</span> æ¡
                            </div>
                            <div class="flex space-x-2">
                                <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    ä¸Šä¸€é¡µ
                                </button>
                                <span id="page-numbers" class="flex space-x-1"></span>
                                <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    ä¸‹ä¸€é¡µ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="logDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-900">æ“ä½œæ—¥å¿—è¯¦æƒ…</h3>
                    <button onclick="closeLogDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" id="log-detail-content">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let pageSize = 20;
        let totalLogs = 0;
        let totalPages = 0;
        let currentUser = null;
        let auditLogs = [];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOM loaded, starting initialization...');
            
            try {
                initializePage();
                setupEventListeners();
                loadAuditUsers();
                loadAuditLogs(); // updateAuditStats ä¼šåœ¨ loadAuditLogs å®Œæˆåè°ƒç”¨
                console.log('âœ… Page initialization completed');
            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•: ' + error.message, 'error');
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // è®¾ç½®ç³»ç»Ÿç®¡ç†èœå•å±•å¼€çŠ¶æ€
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            if (systemSubmenu && systemMenuArrow) {
                systemSubmenu.classList.remove('hidden');
                systemMenuArrow.style.transform = 'rotate(180deg)';
            }

            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const userInfo = localStorage.getItem('user_info');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
                document.getElementById('current-user').textContent = currentUser.username;
            }

            // ä¸è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
            // ç”¨æˆ·å¯ä»¥é€šè¿‡ç­›é€‰å™¨é€‰æ‹©ç‰¹å®šçš„æ—¥æœŸèŒƒå›´
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç³»ç»Ÿç®¡ç†ä¸‹æ‹‰èœå•
            const systemMenuBtn = document.getElementById('system-menu-btn');
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            
            if (systemMenuBtn) {
                systemMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // åˆ‡æ¢å­èœå•æ˜¾ç¤º
                    systemSubmenu.classList.toggle('hidden');
                    systemMenuArrow.style.transform = systemSubmenu.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                });
            }

            // ç™»å‡ºæŒ‰é’®
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('current_user');
                window.location.href = '/login';
            });

            // ç­›é€‰æŒ‰é’®
            document.getElementById('apply-filters').addEventListener('click', function() {
                currentPage = 1;
                loadAuditLogs();
            });

            document.getElementById('reset-filters').addEventListener('click', function() {
                document.getElementById('filter-user').value = '';
                document.getElementById('filter-action').value = '';
                document.getElementById('filter-start-date').value = '';
                document.getElementById('filter-end-date').value = '';
                currentPage = 1;
                loadAuditLogs();
            });

            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadAuditLogs(); // updateAuditStats ä¼šåœ¨ loadAuditLogs å®Œæˆåè°ƒç”¨
            });

            // å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-btn').addEventListener('click', exportAuditLogs);

            // åˆ†é¡µæŒ‰é’®
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadAuditLogs();
                }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadAuditLogs();
                }
            });
        }

        // åŠ è½½æ“ä½œæ—¥å¿—
        async function loadAuditLogs() {
            try {
                console.log('å¼€å§‹åŠ è½½æ“ä½œæ—¥å¿—...');
                console.log('å½“å‰é¡µç :', currentPage);
                console.log('æ¯é¡µå¤§å°:', pageSize);
                
                // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
                if (typeof AuditLogAPI === 'undefined') {
                    throw new Error('AuditLogAPI æœªå®šä¹‰ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                showNotification('æ­£åœ¨åŠ è½½æ“ä½œæ—¥å¿—...', 'info');

                // æ„å»ºè¯·æ±‚å‚æ•°
                const params = {
                    skip: (currentPage - 1) * pageSize,
                    limit: pageSize
                };

                // æ·»åŠ ç­›é€‰æ¡ä»¶
                const userId = document.getElementById('filter-user').value;
                const action = document.getElementById('filter-action').value;
                const startDate = document.getElementById('filter-start-date').value;
                const endDate = document.getElementById('filter-end-date').value;

                if (userId) params.user_id = parseInt(userId);
                if (action) params.action = action;
                if (startDate) params.start_date = startDate;
                if (endDate) params.end_date = endDate;

                console.log('APIå‚æ•°:', params);

                const data = await AuditLogAPI.getAuditLogs(params);
                console.log('APIå“åº”æ•°æ®:', data);
                
                if (!data || !data.items) {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                auditLogs = data.items;
                totalLogs = data.total;
                totalPages = Math.ceil(totalLogs / pageSize);

                renderAuditLogsTable(auditLogs);
                updatePagination();
                updateAuditStats(); // åœ¨æ•°æ®åŠ è½½å®Œæˆåæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                
                showNotification('æ“ä½œæ—¥å¿—åŠ è½½æˆåŠŸ', 'success');
                
            } catch (error) {
                console.error('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥:', error);
                showNotification('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥: ' + error.message, 'error');
                renderAuditLogsTable([]);
            }
        }

        // æ¸²æŸ“æ“ä½œæ—¥å¿—è¡¨æ ¼
        function renderAuditLogsTable(logs) {
            const tbody = document.getElementById('audit-logs-tbody');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 block"></i>
                            <p>æš‚æ— æ“ä½œæ—¥å¿—</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr class="log-row cursor-pointer" onclick="showLogDetail(${log.id})">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatDateTime(log.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-gray-400 mr-2"></i>
                            ${log.user.username}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="action-badge action-${getActionClass(log.action)}">
                            ${log.action}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${log.equipment ? log.equipment.name : (log.equipment_id ? `è®¾å¤‡ID: ${log.equipment_id}` : 'ç³»ç»Ÿ')}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs">
                        <div class="truncate" title="${log.description}">
                            ${log.description}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="text-blue-600 hover:text-blue-800" onclick="event.stopPropagation(); showLogDetail(${log.id})">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // è·å–æ“ä½œç±»å‹æ ·å¼ç±»
        function getActionClass(action) {
            const actionMap = {
                'åˆ›å»º': 'create',
                'ä¿®æ”¹': 'update', 
                'åˆ é™¤': 'delete',
                'ç™»å½•': 'login',
                'ç™»å‡º': 'logout'
            };
            return actionMap[action] || 'other';
        }

        // æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
        function showLogDetail(logId) {
            const log = auditLogs.find(l => l.id === logId);
            if (!log) return;

            const content = document.getElementById('log-detail-content');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œæ—¶é—´</label>
                            <p class="text-sm text-gray-900">${formatDateTime(log.created_at)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œç”¨æˆ·</label>
                            <p class="text-sm text-gray-900">${log.user.username}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œç±»å‹</label>
                            <p class="text-sm text-gray-900">
                                <span class="action-badge action-${getActionClass(log.action)}">
                                    ${log.action}
                                </span>
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œå¯¹è±¡</label>
                            <p class="text-sm text-gray-900">
                                ${log.equipment ? log.equipment.name : (log.equipment_id ? `è®¾å¤‡ID: ${log.equipment_id}` : 'ç³»ç»Ÿ')}
                            </p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œæè¿°</label>
                        <p class="text-sm text-gray-900 bg-gray-50 p-3 rounded-md">${log.description}</p>
                    </div>
                    
                    ${(log.old_value || log.new_value) ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${log.old_value ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¿®æ”¹å‰</label>
                                    <p class="text-sm text-gray-900 bg-red-50 p-3 rounded-md font-mono text-xs">${log.old_value}</p>
                                </div>
                            ` : ''}
                            ${log.new_value ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¿®æ”¹å</label>
                                    <p class="text-sm text-gray-900 bg-green-50 p-3 rounded-md font-mono text-xs">${log.new_value}</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('logDetailModal').classList.remove('hidden');
        }

        // å…³é—­æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡†
        function closeLogDetailModal() {
            document.getElementById('logDetailModal').classList.add('hidden');
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadAuditUsers() {
            try {
                // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
                if (typeof AuditLogAPI === 'undefined') {
                    throw new Error('AuditLogAPI æœªå®šä¹‰ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                const users = await AuditLogAPI.getAuditUsers();
                const userSelect = document.getElementById('filter-user');
                
                if (!userSelect) {
                    console.error('ç”¨æˆ·é€‰æ‹©å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œæ¸…ç©ºå…¶ä»–é€‰é¡¹
                userSelect.innerHTML = '<option value="">æ‰€æœ‰ç”¨æˆ·</option>';
                
                if (users && Array.isArray(users)) {
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        userSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
            }
        }

        // æ›´æ–°æ“ä½œæ—¥å¿—ç»Ÿè®¡
        async function updateAuditStats() {
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ç»Ÿè®¡APIè°ƒç”¨
                // æš‚æ—¶ä½¿ç”¨ç°æœ‰æ•°æ®ç»Ÿè®¡
                const today = new Date().toDateString();
                const todayLogs = auditLogs.filter(log => 
                    new Date(log.created_at).toDateString() === today
                ).length;
                
                const uniqueUsers = new Set(auditLogs.map(log => log.user.username)).size;
                const equipmentOps = auditLogs.filter(log => log.equipment_id).length;

                document.getElementById('total-logs').textContent = totalLogs;
                document.getElementById('today-logs').textContent = todayLogs;
                document.getElementById('active-users').textContent = uniqueUsers;
                document.getElementById('equipment-ops').textContent = equipmentOps;
                
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePagination() {
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalLogs);
            
            document.getElementById('page-info').textContent = `${startItem}-${endItem}`;
            document.getElementById('total-count').textContent = totalLogs;
            
            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            // ç”Ÿæˆé¡µç 
            const pageNumbers = document.getElementById('page-numbers');
            pageNumbers.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    loadAuditLogs();
                };
                pageNumbers.appendChild(pageBtn);
            }
        }

        // å¯¼å‡ºæ“ä½œæ—¥å¿—
        function exportAuditLogs() {
            try {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "æ“ä½œæ—¶é—´,æ“ä½œç”¨æˆ·,æ“ä½œç±»å‹,æ“ä½œå¯¹è±¡,æ“ä½œæè¿°\n";
                
                auditLogs.forEach(log => {
                    const row = [
                        formatDateTime(log.created_at),
                        log.user.username,
                        log.action,
                        log.equipment ? log.equipment.name : (log.equipment_id ? `è®¾å¤‡ID: ${log.equipment_id}` : 'ç³»ç»Ÿ'),
                        `"${log.description.replace(/"/g, '""')}"`
                    ].join(',');
                    csvContent += row + "\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `æ“ä½œæ—¥å¿—_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('æ“ä½œæ—¥å¿—å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºåŒ—äº¬æ—¶é—´
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            
            const date = new Date(dateTimeString);
            if (isNaN(date.getTime())) return dateTimeString;
            
            // æ•°æ®åº“è¿”å›çš„æ˜¯UTCæ—¶é—´ï¼Œç›´æ¥è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
            const beijingOffset = 8 * 60 * 60 * 1000; // åŒ—äº¬æ—¶é—´åç§»é‡ï¼ˆæ¯«ç§’ï¼‰
            const beijingDate = new Date(date.getTime() + beijingOffset);
            
            return beijingDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            }[type] || 'bg-blue-500';
            
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type] || 'fa-info-circle';
            
            notification.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 transform transition-all duration-300 translate-x-full`;
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>