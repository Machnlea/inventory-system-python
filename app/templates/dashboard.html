<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/tab-session-manager.js"></script>
    <script src="/static/js/notification-manager.js"></script>
    <script src="/static/js/tailwind-components.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(2px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- 左侧导航栏 -->
        <div class="w-64 gradient-bg shadow-xl fixed left-0 top-0 h-full z-10">
            <div class="flex flex-col h-full">
                <!-- Logo和标题 -->
                <div class="flex items-center justify-center h-16 px-4 border-b border-white/20">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-list text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-lg font-bold">设备台账管理系统</h1>
                    </div>
                </div>

                <!-- 导航菜单 -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="/dashboard" class="sidebar-item active flex items-center px-4 py-3 text-white rounded-lg" id="dashboard-link">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="/equipment" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="equipment-link">
                        <i class="fas fa-cogs mr-3 text-lg"></i>
                        <span>设备管理</span>
                    </a>
                      <a href="/reports" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="reports-link">
                        <i class="fas fa-chart-bar mr-3 text-lg"></i>
                        <span>统计报表</span>
                    </a>
                    
                    <!-- 系统管理下拉菜单 -->
                    <div class="relative">
                        <button class="sidebar-item flex items-center justify-between w-full px-4 py-3 text-white/90 rounded-lg" id="system-menu-btn">
                            <div class="flex items-center">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                <span>系统管理</span>
                            </div>
                            <i class="fas fa-chevron-down text-sm transition-transform duration-200" id="system-menu-arrow"></i>
                        </button>
                        <div class="ml-4 mt-1 space-y-1 hidden" id="system-submenu">
                            <a href="/categories" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="categories-link">
                                <i class="fas fa-tags mr-3"></i>
                                <span>设备类别</span>
                            </a>
                            <a href="/departments" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-building mr-3"></i>
                                <span>部门管理</span>
                            </a>
                            <a href="/users" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="users-link">
                                <i class="fas fa-users mr-3"></i>
                                <span>用户管理</span>
                            </a>
                            <a href="/audit" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="audit-link">
                                <i class="fas fa-history mr-3"></i>
                                <span>操作日志</span>
                            </a>

                            <!-- 系统设置 - 仅管理员可见 -->
                            <a href="/settings" class="sidebar-item flex items-center px-4 py-2 text-white rounded-lg text-sm" id="settings-link" style="display: none;">
                                <i class="fas fa-cog mr-3"></i>
                                <span>系统设置</span>
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- 用户信息 -->
                <div class="border-t border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-white text-xl mr-3"></i>
                            <div>
                                <p class="text-white text-base font-medium" id="current-user"></p>
                            </div>
                        </div>
                        <button class="text-white/70 hover:text-white transition-colors" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 ml-64 overflow-hidden">
            <div class="h-full overflow-y-auto">
            <!-- 顶部通知容器 -->
            <div id="notification-container" class="fixed top-4 right-4 z-[99999] space-y-2 w-72"></div>
            
            <!-- 主要内容 -->
            <div class="p-8">
                <!-- 页面标题 -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">仪表盘</h1>
                    <p class="text-gray-600">设备管理概览与统计信息</p>
                </div>

                <!-- 设备统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">设备总数</p>
                                <p class="text-2xl font-bold text-gray-900" id="total-equipment">-</p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-3">
                                <i class="fas fa-cogs text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">在用设备</p>
                                <p class="text-2xl font-bold text-green-600" id="active-equipment">-</p>
                            </div>
                            <div class="bg-green-100 rounded-full p-3">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">停用报废</p>
                                <p class="text-2xl font-bold text-gray-600" id="inactive-equipment">-</p>
                            </div>
                            <div class="bg-gray-100 rounded-full p-3">
                                <i class="fas fa-ban text-gray-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">本月待检</p>
                                <p class="text-2xl font-bold text-orange-600" id="monthly-due">-</p>
                            </div>
                            <div class="bg-orange-100 rounded-full p-3">
                                <i class="fas fa-clock text-orange-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">超期未检</p>
                                <p class="text-2xl font-bold text-purple-600" id="overdue-equipment">-</p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-3">
                                <i class="fas fa-exclamation-triangle text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">设备类别</p>
                                <p class="text-2xl font-bold text-indigo-600" id="category-count">-</p>
                            </div>
                            <div class="bg-indigo-100 rounded-full p-3">
                                <i class="fas fa-tags text-indigo-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                    <!-- 设备分布图 -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">在用设备分布</h3>
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <!-- 图表 -->
                            <div class="flex-shrink-0">
                                <canvas id="categoryChart" width="280" height="280"></canvas>
                            </div>
                            <!-- 图例 -->
                            <div class="flex-1 min-w-0">
                                <div class="mb-2">
                                    <h4 class="text-sm font-medium text-gray-700">设备类别详情</h4>
                                </div>
                                <div id="categoryLegend" class="space-y-1 max-h-48 overflow-y-auto text-sm">
                                    <!-- 动态生成的图例 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 部门分布图 -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">在用设备部门分布</h3>
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <!-- 图表 -->
                            <div class="flex-shrink-0">
                                <canvas id="departmentChart" width="280" height="280"></canvas>
                            </div>
                            <!-- 图例 -->
                            <div class="flex-1 min-w-0">
                                <div class="mb-2">
                                    <h4 class="text-sm font-medium text-gray-700">部门详情</h4>
                                </div>
                                <div id="departmentLegend" class="space-y-1 max-h-48 overflow-y-auto text-sm">
                                    <!-- 动态生成的图例 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作 -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">快速操作</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <i class="fas fa-plus mr-2"></i>添加设备
                        </button>
                        <button class="bg-gradient-to-r from-orange-600 to-orange-700 text-white font-medium py-3 px-4 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1">
                            <i class="fas fa-file-export mr-2"></i>导出月度计划
                        </button>
                        <button class="bg-gradient-to-r from-green-600 to-green-700 text-white font-medium py-3 px-4 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1">
                            <i class="fas fa-download mr-2"></i>导出全部设备
                        </button>
                        <button class="bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium py-3 px-4 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1">
                            <i class="fas fa-file-import mr-2"></i>导入数据
                        </button>
                    </div>
                </div>

                <!-- 本月待检设备表格 -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">本月待检设备</h3>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-600">
                                共 <span id="monthly-due-total-count" class="font-medium text-orange-600">0</span> 台
                            </span>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                查看全部 <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">设备信息</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">内部编号</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">使用部门</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">有效期至</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">设备状态</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyDueTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 动态加载的待检设备数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // 侧边栏功能
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户权限并显示/隐藏系统设置菜单
            function checkUserPermissions() {
                const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
                if (userInfo) {
                    const user = JSON.parse(userInfo);
                    const settingsLink = document.getElementById('settings-link');
                    
                    // 仅当用户是管理员时显示系统设置菜单
                    if (user.is_admin && settingsLink) {
                        settingsLink.style.display = 'flex';
                    } else if (settingsLink) {
                        settingsLink.style.display = 'none';
                    }
                }
            }
            
            // 调用权限检查
            checkUserPermissions();
            
            // 系统管理下拉菜单
            const systemMenuBtn = document.getElementById('system-menu-btn');
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            
            if (systemMenuBtn) {
                systemMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 切换子菜单显示
                    systemSubmenu.classList.toggle('hidden');
                    
                    // 旋转箭头
                    if (systemSubmenu.classList.contains('hidden')) {
                        systemMenuArrow.style.transform = 'rotate(0deg)';
                    } else {
                        systemMenuArrow.style.transform = 'rotate(180deg)';
                    }
                });
            }
            
            // 侧边栏导航项点击事件
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // 如果是下拉菜单按钮，不执行导航逻辑
                    if (item.id === 'system-menu-btn') {
                        return;
                    }
                    
                    // 如果有href且不是#，让浏览器正常跳转
                    if (this.href && this.href !== location.href.split('#')[0] + '#') {
                        return; // 让浏览器处理跳转
                    }
                    
                    e.preventDefault();
                    
                    // 移除所有active类
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    
                    // 添加active类到当前项
                    this.classList.add('active');
                    
                    // 如果是子菜单项，同时激活父菜单
                    if (this.closest('#system-submenu')) {
                        systemMenuBtn.classList.add('active');
                    }
                    
                    // 处理特定的导航逻辑
                    const linkId = this.id;
                    console.log('导航到:', linkId);
                    
                    // 只为没有实际链接的项显示通知
                    if (this.href === location.href.split('#')[0] + '#' || !this.href) {
                        showNotification(`正在加载${this.textContent.trim()}页面...`, 'info');
                    }
                });
            });

            // 退出登录
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('确定要退出登录吗？')) {
                        // 先调用后端登出API销毁会话
                        const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                        if (token) {
                            fetch('/api/auth/logout', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Logout response:', data);
                            })
                            .catch(error => {
                                console.error('Logout error:', error);
                            })
                            .finally(() => {
                                // 使用会话管理器清除登录状态
                                if (window.tabSessionManager) {
                                    tabSessionManager.clearSession();
                                } else {
                                    // 兼容旧方式：清除本地存储
                                    sessionStorage.removeItem('access_token');
                                    sessionStorage.removeItem('refresh_token');
                                    sessionStorage.removeItem('user_info');
                                    localStorage.removeItem('access_token');
                                    localStorage.removeItem('refresh_token');
                                    localStorage.removeItem('user_info');
                                }
                                
                                // 跳转到登录页面
                                window.location.href = '/login';
                            });
                        } else {
                            // 如果没有token，直接清除并跳转
                            if (window.tabSessionManager) {
                                tabSessionManager.clearSession();
                            } else {
                                sessionStorage.removeItem('access_token');
                                sessionStorage.removeItem('refresh_token');
                                sessionStorage.removeItem('user_info');
                                localStorage.removeItem('access_token');
                                localStorage.removeItem('refresh_token');
                                localStorage.removeItem('user_info');
                            }
                            window.location.href = '/login';
                        }
                    }
                });
            }

            // 检查登录状态 - 支持多标签页独立登录
            let userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const currentUserElement = document.getElementById('current-user');
                if (currentUserElement) {
                    currentUserElement.textContent = user.username || '用户';
                    currentUserElement.style.visibility = 'visible'; // 显示用户信息
                }
            }
        });

  
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                showNotification('正在加载仪表盘数据...', 'info');
                
                // 获取统计数据
                const stats = await DashboardAPI.getStats();
                
                // 更新统计卡片
                document.getElementById('total-equipment').textContent = stats.total_equipment_count;
                document.getElementById('active-equipment').textContent = stats.active_equipment_count;
                document.getElementById('inactive-equipment').textContent = stats.inactive_count;
                document.getElementById('monthly-due').textContent = stats.monthly_due_count;
                document.getElementById('overdue-equipment').textContent = stats.overdue_count;
                document.getElementById('category-count').textContent = stats.category_distribution.length;
                
                // 创建图表
                createCharts(stats.category_distribution, stats.department_distribution);
                
                // 加载本月待检设备列表
                await loadMonthlyDueEquipments();
                
                showNotification('仪表盘数据加载成功', 'success');
                
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
                showNotification('加载仪表盘数据失败: ' + error.message, 'error');
                
                // 使用默认数据
                createCharts([], []);
                loadMonthlyDueEquipments([]); // 传入空数组作为默认数据
            }
        }

        // 加载本月待检设备列表
        async function loadMonthlyDueEquipments() {
            try {
                const equipments = await DashboardAPI.getMonthlyDueEquipments();
                updateMonthlyDueTable(equipments);
            } catch (error) {
                console.error('加载本月待检设备失败:', error);
                showNotification('加载本月待检设备失败: ' + error.message, 'error');
                updateMonthlyDueTable([]); // 传入空数组作为默认数据
            }
        }

        // 更新本月待检设备表格
        function updateMonthlyDueTable(equipments) {
            const tableBody = document.getElementById('monthlyDueTableBody');
            const totalCountElement = document.getElementById('monthly-due-total-count');
            
            // 更新总数显示
            if (totalCountElement) {
                totalCountElement.textContent = equipments.length;
            }
            
            if (!equipments || equipments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            本月暂无待检设备
                        </td>
                    </tr>
                `;
                return;
            }

            // 限制显示最多5条记录
            const displayEquipments = equipments.slice(0, 5);
            const hasMoreEquipments = equipments.length > 5;
            
            tableBody.innerHTML = displayEquipments.map(equipment => {
                // 安全地获取关联数据
                const departmentName = equipment.department ? equipment.department.name : '未知部门';
                const categoryName = equipment.category ? equipment.category.name : '其他';
                
                // 获取设备状态对应的样式
                const getStatusStyle = (status) => {
                    switch(status) {
                        case '在用':
                            return 'bg-green-100 text-green-800';
                        case '停用':
                            return 'bg-gray-100 text-gray-800';
                        case '报废':
                            return 'bg-red-100 text-red-800';
                        default:
                            return 'bg-gray-100 text-gray-800';
                    }
                };

                // 获取设备图标
                const getEquipmentIcon = (categoryName) => {
                    const iconMap = {
                        '压力表': 'fa-gauge',
                        '温度计': 'fa-thermometer-half',
                        '电子秤': 'fa-balance-scale',
                        '卡尺': 'fa-tachometer-alt',
                        '万用表': 'fa-microchip',
                        '游标卡尺': 'fa-tachometer-alt'
                    };
                    return iconMap[categoryName] || 'fa-cogs';
                };

                // 获取图标颜色
                const getIconColor = (categoryName) => {
                    const colorMap = {
                        '压力表': 'text-blue-600',
                        '温度计': 'text-yellow-600',
                        '电子秤': 'text-red-600',
                        '卡尺': 'text-green-600',
                        '万用表': 'text-purple-600',
                        '游标卡尺': 'text-green-600'
                    };
                    return colorMap[categoryName] || 'text-gray-600';
                };

                const iconClass = getEquipmentIcon(categoryName);
                const iconColor = getIconColor(categoryName);
                const statusStyle = getStatusStyle(equipment.status || '未知');
                
                // 格式化日期显示
                const formatDate = (dateString) => {
                    if (!dateString) return '-';
                    return dateString; // API返回的应该是格式化的日期字符串
                };
                
                // 检查设备是否可以进行检定（在用状态）
                const canCalibrate = equipment.status === '在用';
                const buttonClass = canCalibrate ? 'text-blue-600 hover:text-blue-900' : 'text-gray-400 hover:text-gray-600';
                const buttonDisabled = canCalibrate ? '' : 'disabled';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 flex-shrink-0">
                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="fas ${iconClass} ${iconColor}"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${equipment.name || '未知设备'}</div>
                                    <div class="text-sm text-gray-500">型号: ${equipment.model || '未知'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${equipment.internal_id || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${departmentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(equipment.valid_until)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusStyle}">${equipment.status || '未知'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="${buttonClass}" ${buttonDisabled} onclick="handleCalibration('${equipment.id}', '${equipment.name || '设备'}')">检定</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // 如果有更多设备，添加一个"显示更多"行
            if (hasMoreEquipments) {
                const remainingCount = equipments.length - 5;
                tableBody.innerHTML += `
                    <tr class="bg-gray-50 hover:bg-gray-100">
                        <td colspan="6" class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center text-gray-600">
                                <i class="fas fa-ellipsis-h mr-2"></i>
                                <span class="text-sm">还有 ${remainingCount} 台待检设备，点击"查看全部"查看详情</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // 处理检定操作 - 打开检定信息更新模态框
        function handleCalibration(equipmentId, equipmentName) {
            // 打开单个设备检定日期更新模态框
            openSingleCalibrationModal(equipmentId, equipmentName);
        }

        // 打开单个设备检定更新模态框
        async function openSingleCalibrationModal(equipmentId, equipmentName) {
            try {
                // 获取设备详细信息
                const response = await fetch(`/api/equipment/${equipmentId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token') || localStorage.getItem('access_token')}`
                    }
                });
                if (!response.ok) {
                    throw new Error('获取设备信息失败');
                }
                
                const equipment = await response.json();
                
                // 设置设备信息显示
                document.getElementById('singleCalibrationEquipmentName').textContent = equipment.name || '未知设备';
                document.getElementById('singleCalibrationMethodDisplay').textContent = equipment.calibration_method || '内检';
                document.getElementById('singleCalibrationInternalId').textContent = equipment.internal_id || '-';
                document.getElementById('singleCalibrationManufacturerId').textContent = equipment.manufacturer_id || '-';
                document.getElementById('singleCalibrationEquipmentModel').textContent = equipment.model || '-';
                document.getElementById('singleCalibrationCycle').textContent = equipment.calibration_cycle || '-';
                
                // 预填当前检定信息 - 检定日期默认为今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('singleCalibrationDate').value = today;
                document.getElementById('singleCalibrationResult').value = '合格';
                
                // 设置证书信息
                document.getElementById('singleCertificateNumber').value = equipment.certificate_number || '';
                document.getElementById('singleCertificateForm').value = equipment.certificate_form || '';
                
                // 根据检定方式显示/隐藏字段
                toggleCalibrationFields(equipment.calibration_method || '内检');
                
                // 外检信息
                if (equipment.calibration_method === '外检') {
                    document.getElementById('singleVerificationAgency').value = equipment.verification_agency || '';
                    document.getElementById('singleExternalCalibrationNotes').value = equipment.calibration_notes || '';
                } else {
                    document.getElementById('singleCalibrationNotes').value = equipment.calibration_notes || '';
                }
                
                // 初始化设备状态选择为"在用"
                const statusRadios = document.querySelectorAll('input[name="equipmentStatus"]');
                statusRadios[0].checked = true; // 默认选择"在用"
                
                // 初始化显示状态 - 检定合格时显示设备状态选择区域
                document.getElementById('equipmentStatusSection').classList.remove('hidden');
                document.getElementById('disposalSection').classList.add('hidden');
                document.getElementById('suspendedSection').classList.add('hidden');
                
                // 设置证书信息相互依赖验证
                setupCertificateFieldsValidation();
                
                // 显示模态框
                document.getElementById('singleCalibrationBtn').disabled = false;
                document.getElementById('singleCalibrationModal').classList.add('show');
                
                // 存储设备ID和设备信息
                window.singleCalibrationEquipmentId = equipmentId;
                window.singleCalibrationEquipmentData = equipment;
                
            } catch (error) {
                console.error('获取设备信息失败:', error);
                showNotification('获取设备信息失败: ' + error.message, 'error');
            }
        }

        // 关闭单个设备检定日期更新模态框
        function closeSingleCalibrationModal() {
            document.getElementById('singleCalibrationModal').classList.remove('show');
            window.singleCalibrationEquipmentId = null;
        }

        // 设置证书信息相互依赖监听器（内检设备）
        function setupCertificateFieldsValidation() {
            const certificateNumberField = document.getElementById('singleCertificateNumber');
            const certificateFormField = document.getElementById('singleCertificateForm');
            
            if (!certificateNumberField || !certificateFormField) return;
            
            // 证书编号输入监听器
            certificateNumberField.addEventListener('input', function() {
                const hasNumber = this.value.trim() !== '';
                if (hasNumber) {
                    // 如果填写了证书编号，证书形式变为必填
                    certificateFormField.required = true;
                    document.getElementById('certificateFormRequired').classList.remove('hidden');
                } else {
                    // 如果清空证书编号，且证书形式也没选择，则都不必填
                    if (certificateFormField.value === '') {
                        certificateFormField.required = false;
                        document.getElementById('certificateFormRequired').classList.add('hidden');
                    }
                }
            });
            
            // 证书形式选择监听器
            certificateFormField.addEventListener('change', function() {
                const hasForm = this.value !== '';
                if (hasForm) {
                    // 如果选择了证书形式，证书编号变为必填
                    certificateNumberField.required = true;
                    document.getElementById('certificateNumberRequired').classList.remove('hidden');
                } else {
                    // 如果清空证书形式，且证书编号也没填，则都不必填
                    if (certificateNumberField.value.trim() === '') {
                        certificateNumberField.required = false;
                        document.getElementById('certificateNumberRequired').classList.add('hidden');
                    }
                }
            });
        }

        // 根据检定方式切换字段显示
        function toggleCalibrationFields(calibrationMethod) {
            const externalFields = document.getElementById('externalCalibrationFields');
            const internalFields = document.getElementById('internalCalibrationFields');
            const certificateNumberRequired = document.getElementById('certificateNumberRequired');
            const certificateFormRequired = document.getElementById('certificateFormRequired');
            
            if (calibrationMethod === '外检') {
                externalFields.classList.remove('hidden');
                internalFields.classList.add('hidden');
                
                // 外检时检定机构为必填
                document.getElementById('singleVerificationAgency').required = true;
                
                // 外检时证书信息不强制必填，但如果有一个，另一个也必填
                // 这个逻辑在setupCertificateFieldsValidation中处理
            } else {
                externalFields.classList.add('hidden');
                internalFields.classList.remove('hidden');
                
                // 内检时检定机构不必填
                document.getElementById('singleVerificationAgency').required = false;
            }
        }

        // 切换报废信息区域显示
        function toggleDisposalSection() {
            const calibrationResult = document.getElementById('singleCalibrationResult').value;
            const disposalSection = document.getElementById('disposalSection');
            const equipmentStatusSection = document.getElementById('equipmentStatusSection');
            
            if (calibrationResult === '不合格') {
                disposalSection.classList.remove('hidden');
                equipmentStatusSection.classList.add('hidden');
                document.getElementById('singleStatusChangeDate').required = true;
                // 设置默认日期为今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('singleStatusChangeDate').value = today;
            } else {
                disposalSection.classList.add('hidden');
                equipmentStatusSection.classList.remove('hidden');
                document.getElementById('singleStatusChangeDate').required = false;
                document.getElementById('singleStatusChangeDate').value = '';
                document.getElementById('singleDisposalReason').value = '';
                
                // 重置设备状态选择为"在用"
                const statusRadios = document.querySelectorAll('input[name="equipmentStatus"]');
                statusRadios[0].checked = true; // 默认选择"在用"
                toggleEquipmentStatusFields(); // 更新停用信息显示
            }
        }

        // 切换设备状态相关字段显示（停用信息）
        function toggleEquipmentStatusFields() {
            const selectedStatus = document.querySelector('input[name="equipmentStatus"]:checked')?.value;
            const suspendedSection = document.getElementById('suspendedSection');
            const suspendedDateField = document.getElementById('suspendedDate');
            
            if (selectedStatus === '停用') {
                suspendedSection.classList.remove('hidden');
                suspendedDateField.required = true;
                // 设置默认日期为今天
                const today = new Date().toISOString().split('T')[0];
                suspendedDateField.value = today;
            } else {
                suspendedSection.classList.add('hidden');
                suspendedDateField.required = false;
                suspendedDateField.value = '';
                document.getElementById('suspendedReason').value = '';
            }
        }

        // 增强的单个设备检定更新
        async function performEnhancedSingleCalibrationUpdate() {
            const calibrationDate = document.getElementById('singleCalibrationDate').value;
            const calibrationResult = document.getElementById('singleCalibrationResult').value;
            
            if (!calibrationDate) {
                showNotification('请选择检定日期', 'warning');
                return;
            }
            
            // 根据设备检定方式验证必填字段
            const equipment = window.singleCalibrationEquipmentData;
            const calibrationMethod = equipment.calibration_method || '内检';
            
            if (calibrationMethod === '外检') {
                const certificateNumber = document.getElementById('singleCertificateNumber').value.trim();
                const verificationAgency = document.getElementById('singleVerificationAgency').value.trim();
                const certificateForm = document.getElementById('singleCertificateForm').value.trim();
                
                let hasErrors = false;
                
                if (!certificateNumber) {
                    showFieldError(document.getElementById('singleCertificateNumber'), '证书编号为必填项');
                    hasErrors = true;
                }
                if (!verificationAgency) {
                    showFieldError(document.getElementById('singleVerificationAgency'), '检定机构为必填项');
                    hasErrors = true;
                }
                if (!certificateForm) {
                    showFieldError(document.getElementById('singleCertificateForm'), '证书形式为必填项');
                    hasErrors = true;
                }
                
                if (hasErrors) {
                    showNotification('请填写所有必填字段', 'warning');
                    return;
                }
            } else {
                // 内检设备的证书信息相互依赖验证
                const certificateNumber = document.getElementById('singleCertificateNumber').value.trim();
                const certificateForm = document.getElementById('singleCertificateForm').value.trim();
                
                // 证书编号和证书形式要么都不填，要么都填
                const hasNumber = certificateNumber !== '';
                const hasForm = certificateForm !== '';
                
                if (hasNumber && !hasForm) {
                    showFieldError(document.getElementById('singleCertificateForm'), '填写证书编号时证书形式为必填项');
                    showNotification('证书编号和证书形式必须同时填写或同时留空', 'warning');
                    return;
                }
                
                if (hasForm && !hasNumber) {
                    showFieldError(document.getElementById('singleCertificateNumber'), '选择证书形式时证书编号为必填项');
                    showNotification('证书编号和证书形式必须同时填写或同时留空', 'warning');
                    return;
                }
            }
            
            // 检定不合格时验证报废信息
            if (calibrationResult === '不合格') {
                const statusChangeDate = document.getElementById('singleStatusChangeDate').value;
                if (!statusChangeDate) {
                    showNotification('检定不合格时状态变更时间为必填项', 'warning');
                    return;
                }
            } else {
                // 检定合格时验证设备状态设置
                const selectedStatus = document.querySelector('input[name="equipmentStatus"]:checked')?.value;
                if (!selectedStatus) {
                    showNotification('请选择设备状态', 'warning');
                    return;
                }
                
                // 如果选择停用，验证停用相关信息
                if (selectedStatus === '停用') {
                    const suspendedDate = document.getElementById('suspendedDate').value;
                    if (!suspendedDate) {
                        showNotification('选择停用状态时状态变更时间为必填项', 'warning');
                        return;
                    }
                }
            }
            
            try {
                showNotification('正在更新检定信息...', 'info');
                document.getElementById('singleCalibrationBtn').disabled = true;
                
                // 构建请求数据
                const requestData = {
                    calibration_date: calibrationDate,
                    calibration_result: calibrationResult,
                    notes: document.getElementById('singleCalibrationNotes').value.trim() || null
                };
                
                // 添加证书字段（内检和外检都可能有证书信息）
                const certificateNumber = document.getElementById('singleCertificateNumber')?.value.trim() || '';
                const certificateForm = document.getElementById('singleCertificateForm')?.value.trim() || '';
                
                if (certificateNumber) {
                    requestData.certificate_number = certificateNumber;
                }
                if (certificateForm) {
                    requestData.certificate_form = certificateForm;
                }
                
                // 添加外检特有字段
                if (calibrationMethod === '外检') {
                    requestData.verification_agency = document.getElementById('singleVerificationAgency').value.trim();
                    
                    // 添加外检备注
                    const externalNotes = document.getElementById('singleExternalCalibrationNotes').value.trim();
                    if (externalNotes) {
                        requestData.notes = externalNotes;
                    }
                } else if (calibrationMethod === '内检') {
                    // 添加内检备注
                    const internalNotes = document.getElementById('singleCalibrationNotes').value.trim();
                    if (internalNotes) {
                        requestData.notes = internalNotes;
                    }
                }
                
                // 根据检定结果设置设备状态
                if (calibrationResult === '不合格') {
                    // 检定不合格时的报废信息
                    requestData.status = '报废';
                    requestData.status_change_date = document.getElementById('singleStatusChangeDate').value;
                    
                    const disposalReason = document.getElementById('singleDisposalReason').value.trim();
                    if (disposalReason) {
                        requestData.notes = requestData.notes 
                            ? `${requestData.notes}\n报废原因：${disposalReason}` 
                            : `报废原因：${disposalReason}`;
                    }
                } else {
                    // 检定合格时的状态设置
                    const selectedStatus = document.querySelector('input[name="equipmentStatus"]:checked').value;
                    requestData.status = selectedStatus;
                    
                    if (selectedStatus === '停用') {
                        requestData.status_change_date = document.getElementById('suspendedDate').value;
                        const suspendedReason = document.getElementById('suspendedReason').value.trim();
                        if (suspendedReason) {
                            requestData.notes = requestData.notes 
                                ? `${requestData.notes}\n停用原因：${suspendedReason}` 
                                : `停用原因：${suspendedReason}`;
                        }
                    }
                }
                
                const response = await fetch(`/api/calibration/equipment/${window.singleCalibrationEquipmentId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token') || localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '更新检定信息失败');
                }
                
                const result = await response.json();
                showNotification('检定信息更新成功', 'success');
                
                // 关闭模态框
                closeSingleCalibrationModal();
                
                // 重新加载仪表盘数据以反映更新
                await loadMonthlyDueEquipments();
                
            } catch (error) {
                console.error('更新检定信息失败:', error);
                showNotification('更新检定信息失败: ' + error.message, 'error');
            } finally {
                document.getElementById('singleCalibrationBtn').disabled = false;
            }
        }

        // 显示字段错误
        function showFieldError(field, message) {
            // 移除已存在的错误提示
            hideFieldError(field);
            
            // 创建错误提示元素
            const errorElement = document.createElement('div');
            errorElement.className = 'field-error text-red-600 text-sm mt-1';
            errorElement.textContent = message;
            errorElement.setAttribute('data-field-error', field.id);
            
            // 添加错误样式
            field.classList.add('border-red-500', 'focus:ring-red-500');
            field.classList.remove('border-gray-300', 'focus:ring-blue-500');
            
            // 插入错误提示
            field.parentElement.appendChild(errorElement);
        }

        // 隐藏字段错误
        function hideFieldError(field) {
            // 移除错误样式
            field.classList.remove('border-red-500', 'focus:ring-red-500');
            field.classList.add('border-gray-300', 'focus:ring-blue-500');
            
            // 移除错误提示
            const errorElement = field.parentElement.querySelector(`[data-field-error="${field.id}"]`);
            if (errorElement) {
                errorElement.remove();
            }
        }

        // 创建图表
        function createCharts(categoryData, departmentData) {
            // 销毁现有图表实例
            const categoryChart = Chart.getChart('categoryChart');
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const departmentChart = Chart.getChart('departmentChart');
            if (departmentChart) {
                departmentChart.destroy();
            }
            
            // 设备分布图
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryLabels = categoryData.map(item => item.name);
            const categoryCounts = categoryData.map(item => item.count);
            
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels.length > 0 ? categoryLabels : ['暂无数据'],
                    datasets: [{
                        data: categoryCounts.length > 0 ? categoryCounts : [0],
                        backgroundColor: [
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#EF4444',   // 红色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1'    // 靛蓝色
                        ],
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed}台 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 部门分布图
            const departmentCtx = document.getElementById('departmentChart').getContext('2d');
            const departmentLabels = departmentData.map(item => item.name);
            const departmentCounts = departmentData.map(item => item.count);
            
            new Chart(departmentCtx, {
                type: 'doughnut',
                data: {
                    labels: departmentLabels.length > 0 ? departmentLabels : ['暂无数据'],
                    datasets: [{
                        data: departmentCounts.length > 0 ? departmentCounts : [0],
                        backgroundColor: [
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1',   // 靛蓝色
                            '#14B8A6',   // 蓝绿色
                            '#F59E0B',   // 琥珀色
                            '#8B5CF6',   // 紫色
                            '#EF4444',   // 红色
                            '#3B82F6',   // 蓝色
                            '#10B981',   // 绿色
                            '#F59E0B',   // 黄色
                            '#8B5CF6',   // 紫色
                            '#6B7280',   // 灰色
                            '#06B6D4',   // 青色
                            '#84CC16',   // 青绿色
                            '#F97316',   // 橙色
                            '#EC4899',   // 粉色
                            '#6366F1'    // 靛蓝色
                        ],
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed}台 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 生成自定义图例
            generateCustomLegend(categoryData, 'categoryLegend', [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6B7280',
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1', '#14B8A6'
            ]);
            
            generateCustomLegend(departmentData, 'departmentLegend', [
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1', '#14B8A6',
                '#F59E0B', '#8B5CF6', '#EF4444', '#3B82F6', '#10B981', '#6B7280'
            ]);
        }

        // 生成自定义图例
        function generateCustomLegend(data, containerId, colors) {
            const container = document.getElementById(containerId);
            if (!container || !data || data.length === 0) {
                if (container) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">暂无数据</p>';
                }
                return;
            }
            
            const total = data.reduce((total, d) => total + d.count, 0);
            
            const legendHTML = data.map((item, index) => {
                const color = colors[index % colors.length];
                const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                
                return `
                    <div class="flex items-center justify-between py-1 px-2 hover:bg-gray-50 rounded text-xs">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="w-2 h-2 rounded-full mr-2 flex-shrink-0" style="background-color: ${color}"></div>
                            <span class="text-gray-700 truncate" title="${item.name}">${item.name}</span>
                        </div>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <span class="text-gray-600">${item.count}</span>
                            <span class="text-gray-400">(${percentage}%)</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = legendHTML;
        }

        // 快速操作按钮事件
        function setupQuickActions() {
            const quickActions = {
                '添加设备': () => {
                    // 跳转到设备编辑页面（新增模式）
                    window.location.href = '/equipment/edit?mode=add';
                },
                '导出月度计划': async () => {
                    try {
                        showNotification('正在导出月度计划...', 'info');
                        await EquipmentAPI.exportMonthlyPlan();
                        showNotification('月度计划导出成功', 'success');
                    } catch (error) {
                        showNotification('导出失败: ' + error.message, 'error');
                    }
                },
                '导出全部设备': async () => {
                    try {
                        showNotification('正在导出全部设备数据...', 'info');
                        await EquipmentAPI.exportFiltered({});
                        showNotification('设备数据导出成功', 'success');
                    } catch (error) {
                        showNotification('导出失败: ' + error.message, 'error');
                    }
                },
                '导入数据': () => {
                    importEquipmentData();
                }
            };

            // 为所有快速操作按钮添加事件监听器
            document.querySelectorAll('.grid button').forEach(button => {
                button.addEventListener('click', async function() {
                    const buttonText = this.textContent.trim();
                    if (quickActions[buttonText]) {
                        await quickActions[buttonText]();
                    }
                });
            });
        }

        // 表格操作按钮事件
        function setupTableActions() {
            // 检定按钮 - 使用文本内容匹配
            document.querySelectorAll('button').forEach(button => {
                if (button.textContent.includes('检定') && !button.textContent.includes('紧急检定')) {
                    button.addEventListener('click', function() {
                        const row = this.closest('tr');
                        // 获取设备名称（从第一列的设备信息中提取）
                        const equipmentInfo = row.cells[0];
                        const equipmentNameElement = equipmentInfo.querySelector('.text-sm.font-medium');
                        const equipmentName = equipmentNameElement ? equipmentNameElement.textContent : '未知设备';
                        
                        // 获取内部编号
                        const internalId = row.cells[1].textContent.trim();
                        
                        // 构建通知消息
                        let notificationMessage = `正在处理 ${equipmentName}`;
                        if (internalId && internalId !== '-') {
                            notificationMessage += `（${internalId}）`;
                        }
                        notificationMessage += ' 的检定...';
                        
                        showNotification(notificationMessage, 'info');
                    });
                }
            });

            // 紧急检定按钮
            document.querySelectorAll('button').forEach(button => {
                if (button.textContent.includes('紧急检定')) {
                    button.addEventListener('click', function() {
                        const row = this.closest('tr');
                        // 获取设备名称（从第一列的设备信息中提取）
                        const equipmentInfo = row.cells[0];
                        const equipmentNameElement = equipmentInfo.querySelector('.text-sm.font-medium');
                        const equipmentName = equipmentNameElement ? equipmentNameElement.textContent : '未知设备';
                        
                        // 获取内部编号
                        const internalId = row.cells[1].textContent.trim();
                        
                        // 构建通知消息
                        let notificationMessage = `正在紧急处理 ${equipmentName}`;
                        if (internalId && internalId !== '-') {
                            notificationMessage += `（${internalId}）`;
                        }
                        notificationMessage += ' 的检定...';
                        
                        showNotification(notificationMessage, 'warning');
                    });
                }
            });

            // 查看全部按钮
            document.querySelectorAll('button').forEach(button => {
                if (button.textContent.includes('查看全部')) {
                    button.addEventListener('click', function() {
                        // 跳转到设备管理页面
                        window.location.href = '/equipment';
                    });
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 延迟加载以确保DOM完全加载
                setTimeout(async () => {
                    // 加载仪表盘数据
                    await loadDashboardData();
                    setupQuickActions();
                    setupTableActions();
                }, 100);
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败，请刷新页面重试', 'error');
            }
        });

        // 模态框点击外部关闭功能
        const importModal = document.getElementById('importModal');
        if (importModal) {
            importModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportModal();
                }
            });
        }
        const importResultModal = document.getElementById('importResultModal');
        if (importResultModal) {
            importResultModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportResultModal();
                }
            });
        }

        // 导入数据功能
        function importEquipmentData() {
            document.getElementById('importModal').classList.add('show');
        }

        // 关闭导入模态框
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
            // 重置表单
            document.getElementById('importFileInput').value = '';
            document.getElementById('selectedFileInfo').classList.add('hidden');
            document.getElementById('importBtn').disabled = true;
            document.getElementById('overwriteExisting').checked = false;
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('selectedFileName').textContent = file.name;
                document.getElementById('selectedFileInfo').classList.remove('hidden');
                document.getElementById('importBtn').disabled = false;
            }
        }

        // 下载导入模板
        async function downloadTemplate() {
            try {
                showNotification('正在下载导入模板...', 'info');
                await ImportExportAPI.downloadTemplate();
                showNotification('导入模板下载成功', 'success');
            } catch (error) {
                console.error('模板下载失败:', error);
                showNotification('模板下载失败: ' + error.message, 'error');
            }
        }

        // 执行导入操作
        async function performImport() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('请选择要导入的Excel文件', 'warning');
                return;
            }
            
            const overwrite = document.getElementById('overwriteExisting').checked;
            
            try {
                showNotification('正在导入数据，请稍候...', 'info');
                document.getElementById('importBtn').disabled = true;
                
                const result = await ImportExportAPI.uploadImportFile(file, overwrite);
                showImportResult(result);
                closeImportModal();
                
                // 重新加载仪表盘数据
                await loadDashboardData();
                
            } catch (error) {
                console.error('导入失败:', error);
                showNotification('导入失败: ' + error.message, 'error');
                document.getElementById('importBtn').disabled = false;
            }
        }

        // 显示导入结果
        // 全局变量存储导入结果
        let globalImportResult = null;
        let currentFilter = '全部';
        let isErrorGrouped = false;

        function showImportResult(result) {
            globalImportResult = result; // 保存结果供过滤使用
            currentFilter = '全部';
            isErrorGrouped = false;
            
            document.getElementById('successCount').textContent = result.success_count;
            document.getElementById('updateCount').textContent = result.update_count;
            document.getElementById('errorCount').textContent = result.error_count;
            document.getElementById('totalCount').textContent = result.summary.total_rows;
            
            // 重置统计卡片状态 - 默认选中"全部"
            document.querySelectorAll('.stats-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.filter === '全部') {
                    card.classList.add('active');
                }
            });
            
            // 初始化控制按钮状态
            document.getElementById('toggleErrorGrouping').style.display = 'none';
            document.getElementById('exportFailedBtn').style.display = 'none';
            
            // 更新过滤显示
            document.getElementById('currentFilterDisplay').textContent = `显示: 全部结果 (${result.detailed_results.length}条)`;
            document.getElementById('toggleErrorGrouping').innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
            
            renderImportResults(result.detailed_results);
            document.getElementById('importResultModal').classList.add('show');
        }

        // 渲染导入结果
        function renderImportResults(results) {
            const resultsList = document.getElementById('importResultsList');
            
            if (isErrorGrouped && currentFilter === '失败') {
                // 显示合并后的错误结果
                resultsList.innerHTML = renderGroupedErrors(results);
            } else {
                // 显示普通结果
                resultsList.innerHTML = results.map(item => `
                    <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center">
                        <div class="col-span-1 text-sm text-gray-500">${item.row}</div>
                        <div class="col-span-3 text-sm font-medium text-gray-900">${item.internal_id}</div>
                        <div class="col-span-3 text-sm text-gray-900">${item.name}</div>
                        <div class="col-span-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getResultStatusStyle(item.status)}">
                                ${item.status}
                            </span>
                        </div>
                        <div class="col-span-3 text-sm text-gray-600" title="${item.message}">${truncateMessage(item.message, 50)}</div>
                    </div>
                `).join('');
            }
        }

        // 过滤导入结果
        function filterImportResults(filterType) {
            if (!globalImportResult) return;
            
            // 更新统计卡片的激活状态
            document.querySelectorAll('.stats-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.filter === filterType) {
                    card.classList.add('active');
                }
            });
            
            currentFilter = filterType;
            let filteredResults = [];
            
            switch(filterType) {
                case '成功':
                    filteredResults = globalImportResult.detailed_results.filter(item => item.status === '成功');
                    break;
                case '更新':
                    filteredResults = globalImportResult.detailed_results.filter(item => item.status === '更新');
                    break;
                case '失败':
                    filteredResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
                    break;
                case '全部':
                default:
                    filteredResults = globalImportResult.detailed_results;
                    break;
            }
            
            // 更新过滤显示
            document.getElementById('currentFilterDisplay').textContent = `显示: ${filterType} (${filteredResults.length}条)`;
            
            // 控制错误合并按钮和导出按钮的显示
            const toggleBtn = document.getElementById('toggleErrorGrouping');
            const exportBtn = document.getElementById('exportFailedBtn');
            
            if (filterType === '失败' && filteredResults.length > 0) {
                toggleBtn.style.display = 'inline-flex';
                exportBtn.style.display = 'inline-flex';
            } else {
                toggleBtn.style.display = 'none';
                exportBtn.style.display = 'none';
                // 如果切换到非失败状态，取消错误合并
                if (isErrorGrouped) {
                    isErrorGrouped = false;
                    toggleBtn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
                    toggleTableHeaders(false);
                }
            }
            
            renderImportResults(filteredResults);
        }

        // 切换错误合并
        function toggleErrorGrouping() {
            if (!globalImportResult || currentFilter !== '失败') {
                alert('只能在查看失败结果时合并错误');
                return;
            }
            
            isErrorGrouped = !isErrorGrouped;
            const toggleBtn = document.getElementById('toggleErrorGrouping');
            
            if (isErrorGrouped) {
                toggleBtn.innerHTML = '<i class="fas fa-list mr-1"></i>显示明细';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
            }
            
            toggleTableHeaders(isErrorGrouped);
            
            const failedResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
            renderImportResults(failedResults);
        }

        // 切换表头
        function toggleTableHeaders(showGrouped) {
            const normalHeader = document.getElementById('resultTableHeader');
            const groupedHeader = document.getElementById('groupedResultTableHeader');
            
            if (showGrouped) {
                normalHeader.classList.add('hidden');
                groupedHeader.classList.remove('hidden');
            } else {
                normalHeader.classList.remove('hidden');
                groupedHeader.classList.add('hidden');
            }
        }

        // 渲染合并错误结果
        function renderGroupedErrors(results) {
            const errorGroups = {};
            
            // 按错误信息分组
            results.forEach(item => {
                const errorKey = item.message;
                if (!errorGroups[errorKey]) {
                    errorGroups[errorKey] = {
                        message: errorKey,
                        count: 0,
                        rows: [],
                        status: item.status,
                        items: []
                    };
                }
                errorGroups[errorKey].count++;
                errorGroups[errorKey].rows.push(item.row);
                errorGroups[errorKey].items.push(item);
            });
            
            // 按出现次数排序
            const sortedGroups = Object.values(errorGroups).sort((a, b) => b.count - a.count);
            
            return sortedGroups.map((group, index) => `
                <div class="border-l-4 border-red-400 ${index % 2 === 0 ? 'bg-red-50' : 'bg-white'} hover:bg-red-100 transition-colors">
                    <div class="grid grid-cols-12 gap-4 px-4 py-4 items-center">
                        <div class="col-span-1 text-center">
                            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-red-100 text-red-800 font-bold text-sm border-2 border-red-300">
                                ${group.count}
                            </div>
                        </div>
                        <div class="col-span-2 text-center">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${getResultStatusStyle(group.status)}">
                                <i class="fas fa-times-circle mr-1"></i>${group.status}
                            </span>
                        </div>
                        <div class="col-span-4">
                            <div class="text-sm text-gray-900 font-medium break-words" title="${group.message}">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                ${truncateMessage(group.message, 80)}
                            </div>
                        </div>
                        <div class="col-span-3">
                            <div class="text-xs text-gray-600 space-y-1">
                                <div class="font-medium text-gray-700">涉及行号：</div>
                                <div class="bg-gray-100 rounded px-2 py-1 text-gray-800" title="涉及行号: ${group.rows.join(', ')}">
                                    ${group.rows.length > 8 ? 
                                        group.rows.slice(0, 8).join(', ') + ` 等${group.rows.length}行` : 
                                        group.rows.join(', ')
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2 text-center">
                            <button class="w-full text-xs bg-blue-100 text-blue-700 px-2 py-2 rounded-md hover:bg-blue-200 transition-colors border border-blue-300" 
                                    onclick="showErrorDetails('${group.message.replace(/'/g, "\\'")}', [${group.rows.join(',')}])">
                                <i class="fas fa-search mr-1"></i>查看明细 (${group.count})
                            </button>
                        </div>
                    </div>
                    <div class="px-4 pb-3">
                        <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                            <i class="fas fa-info-circle mr-1 text-blue-500"></i>
                            点击"查看明细"可查看具体的设备信息和错误位置
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 显示错误详情
        function showErrorDetails(errorMessage, rows) {
            if (!globalImportResult) return;
            
            // 找到对应的详细记录
            const detailsItems = globalImportResult.detailed_results.filter(item => 
                item.message === errorMessage && rows.includes(item.row)
            );
            
            // 临时切换到详细视图
            isErrorGrouped = false;
            toggleTableHeaders(false);
            document.getElementById('toggleErrorGrouping').innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
            document.getElementById('currentFilterDisplay').textContent = `显示: 错误详情 (${detailsItems.length}条)`;
            
            renderImportResults(detailsItems);
            
            // 5秒后自动返回合并视图
            setTimeout(() => {
                if (currentFilter === '失败') {
                    isErrorGrouped = true;
                    toggleTableHeaders(true);
                    document.getElementById('toggleErrorGrouping').innerHTML = '<i class="fas fa-list mr-1"></i>显示明细';
                    document.getElementById('currentFilterDisplay').textContent = `显示: 失败 (${globalImportResult.detailed_results.filter(item => item.status === '失败').length}条)`;
                    
                    const failedResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
                    renderImportResults(failedResults);
                }
            }, 5000);
        }

        // 导出失败条目
        async function exportFailedResults() {
            if (!globalImportResult || currentFilter !== '失败') {
                showNotification('只能导出失败的条目', 'warning');
                return;
            }

            try {
                const failedResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
                if (failedResults.length === 0) {
                    showNotification('没有失败的条目可导出', 'info');
                    return;
                }

                // 准备导出数据
                const exportData = failedResults.map(item => ({
                    '行号': item.row,
                    '内部编号': item.internal_id || '',
                    '设备名称': item.name || '',
                    '错误原因': item.message || ''
                }));

                // 创建CSV内容
                const headers = Object.keys(exportData[0]);
                const csvContent = [
                    headers.join(','),
                    ...exportData.map(row => headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // 创建Blob并下载
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `导入失败条目_${new Date().toISOString().split('T')[0]}.csv`;
                
                // 添加到DOM并点击
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理URL对象
                URL.revokeObjectURL(link.href);
                
                showNotification(`${failedResults.length}个失败条目导出成功`, 'success');
            } catch (error) {
                console.error('导出失败条目失败:', error);
                showNotification('导出失败条目失败: ' + error.message, 'error');
            }
        }

        // 截断消息
        function truncateMessage(message, maxLength) {
            if (message.length <= maxLength) return message;
            return message.substring(0, maxLength) + '...';
        }

        // 获取结果状态样式
        function getResultStatusStyle(status) {
            switch (status) {
                case '成功':
                case '更新':
                    return 'bg-green-100 text-green-800';
                case '失败':
                    return 'bg-red-100 text-red-800';
                case '跳过':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // 关闭导入结果模态框
        function closeImportResultModal() {
            document.getElementById('importResultModal').classList.remove('show');
        }
    </script>

    <!-- 导入数据模态框 -->
    <div id="importModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">导入设备数据</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeImportModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 mb-4">操作说明</h4>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>• 请先下载导入模板，按照模板格式填写数据</li>
                            <li>• 支持Excel格式(.xlsx, .xls)</li>
                            <li>• 必填字段：使用部门、设备类别、计量器具名称、型号/规格、检定周期、检定(校准)日期、计量编号、检定方式</li>
                            <li>• 外检设备需要填写证书编号、检定结果、检定机构、证书形式</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. 下载导入模板</label>
                    <button class="w-full bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 hover:bg-gray-50 transition-colors" onclick="downloadTemplate()">
                        <i class="fas fa-download text-gray-600 text-2xl mb-2"></i>
                        <p class="text-gray-700">点击下载设备台账导入模板</p>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. 选择Excel文件</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="importFileInput" class="hidden" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        <i class="fas fa-file-excel text-gray-400 text-3xl mb-3"></i>
                        <p class="text-gray-600 mb-2">点击选择文件或拖拽文件到此处</p>
                        <p class="text-sm text-gray-500">支持 .xlsx, .xls 格式</p>
                        <button class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="document.getElementById('importFileInput').click()">
                            选择文件
                        </button>
                    </div>
                    <div id="selectedFileInfo" class="mt-3 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-800">
                                <i class="fas fa-file-excel mr-2"></i>
                                已选择文件: <span id="selectedFileName"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="overwriteExisting" class="mr-2">
                        <span class="text-sm text-gray-700">覆盖已存在的设备数据（根据计量编号）</span>
                    </label>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeImportModal()">
                        取消
                    </button>
                    <button id="importBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" onclick="performImport()" disabled>
                        <i class="fas fa-upload mr-2"></i>开始导入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入结果模态框 -->
    <div id="importResultModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">导入结果</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeImportResultModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="stats-card bg-green-50 border border-green-200 rounded-lg p-4 text-center cursor-pointer hover:bg-green-100 transition-colors" 
                             data-filter="成功" onclick="filterImportResults('成功')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-check-circle text-green-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-green-600" id="successCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-green-700 mb-1">导入成功</div>
                            <div class="text-xs text-green-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看详情
                            </div>
                        </div>
                        <div class="stats-card bg-blue-50 border border-blue-200 rounded-lg p-4 text-center cursor-pointer hover:bg-blue-100 transition-colors" 
                             data-filter="更新" onclick="filterImportResults('更新')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-sync-alt text-blue-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-blue-600" id="updateCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-blue-700 mb-1">更新成功</div>
                            <div class="text-xs text-blue-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看详情
                            </div>
                        </div>
                        <div class="stats-card bg-red-50 border border-red-200 rounded-lg p-4 text-center cursor-pointer hover:bg-red-100 transition-colors" 
                             data-filter="失败" onclick="filterImportResults('失败')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-times-circle text-red-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-red-600" id="errorCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-red-700 mb-1">导入失败</div>
                            <div class="text-xs text-red-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看详情
                            </div>
                        </div>
                        <div class="stats-card bg-gray-50 border border-gray-200 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-100 transition-colors" 
                             data-filter="全部" onclick="filterImportResults('全部')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-list text-gray-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-gray-600" id="totalCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700 mb-1">总计处理</div>
                            <div class="text-xs text-gray-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看全部
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-medium text-gray-900">详细结果</h4>
                        <div class="flex items-center space-x-3">
                            <span id="currentFilterDisplay" class="text-sm text-gray-600 bg-blue-50 px-3 py-1 rounded-full">显示: 全部结果</span>
                            <button id="toggleErrorGrouping" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition-colors" onclick="toggleErrorGrouping()" style="display: none;">
                                <i class="fas fa-layer-group mr-1"></i>合并相同错误
                            </button>
                            <button id="exportFailedBtn" class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded-full hover:bg-orange-200 transition-colors" onclick="exportFailedResults()" style="display: none;">
                                <i class="fas fa-download mr-1"></i>导出失败条目
                            </button>
                        </div>
                    </div>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <div class="grid grid-cols-12 gap-4 text-sm font-medium text-gray-700" id="resultTableHeader">
                                <div class="col-span-1">行号</div>
                                <div class="col-span-3">计量编号</div>
                                <div class="col-span-3">设备名称</div>
                                <div class="col-span-2">状态</div>
                                <div class="col-span-3">说明</div>
                            </div>
                            <div class="grid grid-cols-12 gap-4 text-sm font-medium text-gray-700 hidden" id="groupedResultTableHeader">
                                <div class="col-span-1">数量</div>
                                <div class="col-span-2">状态</div>
                                <div class="col-span-4">错误信息</div>
                                <div class="col-span-3">涉及行号</div>
                                <div class="col-span-2">操作</div>
                            </div>
                        </div>
                        <div id="importResultsList" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                            <!-- 动态加载导入结果 -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700" onclick="closeImportResultModal()">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 增强的检定信息更新模态框 -->
    <div id="singleCalibrationModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">更新检定信息</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeSingleCalibrationModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- 设备信息展示 -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">设备名称:</span>
                            <span id="singleCalibrationEquipmentName" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">检定方式:</span>
                            <span id="singleCalibrationMethodDisplay" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">内部编号:</span>
                            <span id="singleCalibrationInternalId" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">出厂编号:</span>
                            <span id="singleCalibrationManufacturerId" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">设备型号:</span>
                            <span id="singleCalibrationEquipmentModel" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">检定周期:</span>
                            <span id="singleCalibrationCycle" class="ml-2 text-gray-900">-</span>
                        </div>
                    </div>
                </div>
                <!-- 基础检定信息 -->
                <div class="space-y-4 mb-6">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">基础检定信息</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定日期 <span class="text-red-500">*</span></label>
                            <input type="date" id="singleCalibrationDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定结果 <span class="text-red-500">*</span></label>
                            <select id="singleCalibrationResult" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="toggleDisposalSection()">
                                <option value="合格">合格</option>
                                <option value="不合格">不合格</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- 证书信息（内检外检共有） -->
                <div class="space-y-4 mb-6">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">证书信息</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">证书编号 <span id="certificateNumberRequired" class="text-red-500 hidden">*</span></label>
                            <input type="text" id="singleCertificateNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入证书编号">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">证书形式 <span id="certificateFormRequired" class="text-red-500 hidden">*</span></label>
                            <select id="singleCertificateForm" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">请选择</option>
                                <option value="检定证书">检定证书</option>
                                <option value="校准证书">校准证书</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- 外检专有字段 -->
                <div id="externalCalibrationFields" class="space-y-4 mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">外检信息</h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定机构 <span class="text-red-500">*</span></label>
                            <input type="text" id="singleVerificationAgency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入检定机构名称">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定备注</label>
                            <textarea id="singleExternalCalibrationNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入外检相关备注信息"></textarea>
                        </div>
                    </div>
                </div>
                <!-- 内检备注字段 -->
                <div id="internalCalibrationFields" class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">检定备注</label>
                        <textarea id="singleCalibrationNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入检定相关备注信息"></textarea>
                    </div>
                </div>
                <!-- 设备状态选择（检定合格时显示） -->
                <div id="equipmentStatusSection" class="space-y-4 mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                    <h4 class="text-md font-medium text-blue-900 flex items-center">
                        <i class="fas fa-cog mr-2"></i>设备状态设置
                    </h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">设备状态 <span class="text-blue-500">*</span></label>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="equipmentStatus" value="在用" checked class="mr-2 text-blue-600 focus:ring-blue-500" onchange="toggleEquipmentStatusFields()">
                                    <span class="text-sm font-medium text-gray-700">在用</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="equipmentStatus" value="停用" class="mr-2 text-blue-600 focus:ring-blue-500" onchange="toggleEquipmentStatusFields()">
                                    <span class="text-sm font-medium text-gray-700">停用</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 停用信息（选择停用状态时显示） -->
                    <div id="suspendedSection" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">状态变更时间 <span class="text-blue-500">*</span></label>
                            <input type="date" id="suspendedDate" class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">停用原因</label>
                            <textarea id="suspendedReason" class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入停用原因"></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>提示:</strong> 检定合格时可选择设备状态为"在用"或"停用"
                        </p>
                    </div>
                </div>

                <!-- 报废信息（检定不合格时显示） -->
                <div id="disposalSection" class="space-y-4 mb-6 bg-red-50 border border-red-200 rounded-lg p-4 hidden">
                    <h4 class="text-md font-medium text-red-900 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>报废信息
                    </h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-red-700 mb-2">状态变更时间 <span class="text-red-500">*</span></label>
                            <input type="date" id="singleStatusChangeDate" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-red-700 mb-2">报废原因</label>
                            <textarea id="singleDisposalReason" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="3" placeholder="输入报废原因"></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-warning mr-2"></i>
                            <strong>警告:</strong> 检定不合格将自动将设备状态变更为"报废"
                        </p>
                    </div>
                </div>
                <!-- 系统提示 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        系统将根据设备的检定周期自动计算有效期至日期
                    </p>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-end space-x-3">
                    <button class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors" onclick="closeSingleCalibrationModal()">
                        取消
                    </button>
                    <button id="singleCalibrationBtn" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" onclick="performEnhancedSingleCalibrationUpdate()">
                        <i class="fas fa-calendar-check mr-2"></i>确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框样式 -->
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 1000;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .stats-card.active {
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
        }
    </style>
</body>
</html>