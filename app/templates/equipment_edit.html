<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备编辑 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/tab-session-manager.js"></script>
    <script src="/static/js/notification-manager.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .required-field::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            padding: 24px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-input:disabled, .form-select:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
        }
        .success-message {
            color: #10b981;
            font-size: 12px;
            margin-top: 4px;
        }
        .conditional-field {
            display: none;
        }
        .conditional-field.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部通知容器 -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] space-y-2 max-w-md"></div>
    
    <div class="min-h-screen py-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- 页面头部 -->
            <div class="mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <button onclick="history.back()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">编辑设备信息</h1>
                </div>
                <p id="pageDescription" class="text-gray-600">修改设备的详细信息，带 <span class="text-red-500">*</span> 的字段为必填项</p>
            </div>

            <form id="equipmentForm" onsubmit="saveEquipment(event)">
                <!-- 基本信息 -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        基本信息
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label required-field" for="department">使用部门</label>
                            <select id="department" name="department" class="form-select" required>
                                <option value="">请选择使用部门</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="category">设备类别</label>
                            <select id="category" name="category" class="form-select" required>
                                <option value="">请选择设备类别</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="equipmentName">计量器具名称</label>
                            <select id="equipmentName" name="equipmentName" class="form-select" required onchange="handleEquipmentNameChange()">
                                <option value="">请选择计量器具名称</option>
                            </select>
                            <div class="text-sm text-gray-500 mt-1">请先选择设备类别，然后从预定义名称中选择计量器具名称</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="model">型号/规格</label>
                            <input type="text" id="model" name="model" class="form-input" 
                                   required placeholder="请输入型号或规格">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="accuracy">准确度等级</label>
                            <input type="text" id="accuracy" name="accuracy" class="form-input" 
                                   placeholder="请输入准确度等级">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="measureRange">测量范围</label>
                            <input type="text" id="measureRange" name="measureRange" class="form-input" 
                                   placeholder="请输入测量范围">
                        </div>
                    </div>
                </div>

                <!-- 标识信息 -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-barcode text-green-600 mr-2"></i>
                        标识信息
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label required-field" for="equipmentCode">内部编号</label>
                            <input type="text" id="equipmentCode" name="equipmentCode" class="form-input" 
                                   readonly placeholder="系统自动生成" style="background-color: #f3f4f6;">
                            <div class="text-sm text-gray-500 mt-1">系统根据类别自动生成内部编号，选择好部门和设备类别后即可查看</div>
                            <div id="codeValidation" class="text-sm text-red-500 mt-1" style="display: none;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="installLocation">安装地点</label>
                            <input type="text" id="installLocation" name="installLocation" class="form-input" 
                                   placeholder="请输入安装地点">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="manufacturerId">出厂编号</label>
                            <input type="text" id="manufacturerId" name="manufacturerId" class="form-input" 
                                   placeholder="请输入出厂编号">
                        </div>
                    </div>
                </div>

                <!-- 生产信息 -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-industry text-purple-600 mr-2"></i>
                        生产信息
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label" for="manufacturer">制造厂家</label>
                            <input type="text" id="manufacturer" name="manufacturer" class="form-input" 
                                   placeholder="请输入制造厂家">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="manufactureDate">出厂日期</label>
                            <input type="date" id="manufactureDate" name="manufactureDate" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="originalValue">原值/元</label>
                            <input type="number" id="originalValue" name="originalValue" class="form-input" 
                                   step="0.01" min="0" placeholder="请输入设备原值">
                        </div>
                    </div>
                </div>

                <!-- 检定信息 -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-certificate text-orange-600 mr-2"></i>
                        检定信息
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label required-field" for="calibrationPeriod">检定周期</label>
                            <select id="calibrationPeriod" name="calibrationPeriod" class="form-select" required onchange="calculateValidDate()">
                                <option value="">请选择检定周期</option>
                                <option value="6个月">6个月</option>
                                <option value="12个月">12个月</option>
                                <option value="24个月">24个月</option>
                                <option value="36个月">36个月</option>
                                <option value="随坏随换">随坏随换</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="calibrationDate" id="calibrationDateLabel">检定(校准)日期</label>
                            <input type="date" id="calibrationDate" name="calibrationDate" class="form-input" 
                                   required onchange="calculateValidDate()">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="validUntil">有效期至</label>
                            <input type="date" id="validUntil" name="validUntil" class="form-input" 
                                   readonly disabled>
                            <div class="success-message">系统自动计算</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="calibrationMethod">检定方式</label>
                            <select id="calibrationMethod" name="calibrationMethod" class="form-select" required onchange="toggleExternalFields()">
                                <option value="">请选择检定方式</option>
                                <option value="内检">内检</option>
                                <option value="外检">外检</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="calibrationResult">检定结果</label>
                            <select id="calibrationResult" name="calibrationResult" class="form-select" required onchange="updateStatusBasedOnCalibrationResult()">
                                <option value="合格" selected>合格</option>
                                <option value="不合格">不合格</option>
                            </select>
                        </div>

                        <!-- 外检专属字段 -->
                        <div id="externalFields" class="col-span-1 md:col-span-2 conditional-field">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="form-group">
                                    <label class="form-label required-field" for="certificateNumber">证书编号</label>
                                    <input type="text" id="certificateNumber" name="certificateNumber" class="form-input" 
                                           placeholder="外检时必填">
                                </div>


                                <div class="form-group">
                                    <label class="form-label required-field" for="calibrationOrg">检定机构</label>
                                    <input type="text" id="calibrationOrg" name="calibrationOrg" class="form-input" 
                                           placeholder="外检时必填">
                                </div>

                                <div class="form-group">
                                    <label class="form-label required-field" for="certificateType">证书形式</label>
                                    <select id="certificateType" name="certificateType" class="form-select">
                                        <option value="">请选择证书形式</option>
                                        <option value="校准证书">校准证书</option>
                                        <option value="检定证书">检定证书</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field" for="managementLevel">管理级别</label>
                            <select id="managementLevel" name="managementLevel" class="form-select" required>
                                <option value="">请选择管理级别</option>
                                <option value="A级">A级</option>
                                <option value="B级">B级</option>
                                <option value="C级">C级</option>
                                <option value="-" disabled>- (外检自动设置)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 状态信息 -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-toggle-on text-red-600 mr-2"></i>
                        状态信息
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label required-field" for="equipmentStatus">设备状态</label>
                            <select id="equipmentStatus" name="equipmentStatus" class="form-select" required onchange="toggleStatusChangeDate()">
                                <option value="">请选择设备状态</option>
                                <option value="在用">在用</option>
                                <option value="停用">停用</option>
                                <option value="报废">报废</option>
                            </select>
                        </div>

                        <div id="statusChangeDate" class="form-group conditional-field">
                            <label class="form-label" for="statusChangeTime">状态变更时间</label>
                            <input type="date" id="statusChangeTime" name="statusChangeTime" class="form-input">
                            <div class="success-message">状态变更时自动记录</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="remarks">备注</label>
                        <textarea id="remarks" name="remarks" class="form-textarea" rows="3" 
                                  placeholder="请输入备注信息"></textarea>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex justify-between items-center bg-white rounded-xl shadow-md p-6">
                    <div class="flex gap-4">
                        <button type="button" onclick="history.back()" 
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-arrow-left mr-2"></i>返回
                        </button>
                        
                        <button type="button" onclick="resetForm()" 
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-undo mr-2"></i>重置
                        </button>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="saveAsDraft()" 
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i class="fas fa-save mr-2"></i>保存草稿
                        </button>
                        
                        <button type="submit" 
                                class="btn-primary px-6 py-3 text-white rounded-lg">
                            <i class="fas fa-check mr-2"></i>保存设备
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentEquipmentId = null;
        let allDepartments = [];
        let allCategories = [];
        let isEditMode = false;

        // 加载指定类别的预定义器具名称
        async function loadPredefinedNamesForCategory() {
            const categoryId = document.getElementById('category').value;
            const nameSelect = document.getElementById('equipmentName');
            
            // 清空现有的选项
            nameSelect.innerHTML = '<option value="">请选择计量器具名称</option>';
            
            if (!categoryId) {
                return;
            }

            try {
                // 获取预定义名称和编号映射
                const [namesData, usageData] = await Promise.all([
                    CategoryAPI.getPredefinedNames(categoryId),
                    CategoryAPI.getEquipmentUsage(categoryId)
                ]);
                
                if (namesData.predefined_names && namesData.predefined_names.length > 0) {
                    const predefinedNames = namesData.predefined_names;
                    const nameMapping = usageData.name_mapping || {};
                    
                    // 创建名称和编号的数组，然后按编号排序
                    const nameNumberPairs = predefinedNames.map(name => ({
                        name: name,
                        number: parseInt(nameMapping[name] || '99')
                    }));
                    
                    // 按编号排序
                    nameNumberPairs.sort((a, b) => a.number - b.number);
                    
                    // 添加排序后的选项
                    nameNumberPairs.forEach(pair => {
                        const option = document.createElement('option');
                        option.value = pair.name;
                        option.textContent = `${pair.name} (${pair.number})`;
                        nameSelect.appendChild(option);
                    });
                } else {
                    // 如果没有预定义名称，添加一个提示选项
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "该类别暂无预定义器具名称";
                    option.disabled = true;
                    nameSelect.appendChild(option);
                }
            } catch (error) {
                console.error('加载预定义器具名称失败:', error);
            }
        }

        // 处理计量器具名称选择
        function handleEquipmentNameChange() {
            generateAutoId();
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                const equipmentId = urlParams.get('id');

                // 加载基础数据
                await loadInitialData();

                if (mode === 'add' || !equipmentId) {
                    // 新增模式
                    isEditMode = false;
                    initializePageMode('add');
                } else {
                    // 编辑模式
                    isEditMode = true;
                    currentEquipmentId = parseInt(equipmentId);
                    await loadEquipmentData(currentEquipmentId);
                    initializePageMode('edit');
                }

                // 初始化表单事件
                initializeFormEvents();

            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面加载失败，请刷新页面重试', 'error');
            }
        });

        // 加载基础数据
        async function loadInitialData() {
            try {
                const [departments, categories] = await Promise.all([
                    DepartmentAPI.getDepartments(),
                    CategoryAPI.getCategories()
                ]);

                allDepartments = departments;
                allCategories = categories;

                // 更新下拉选项
                updateSelectOptions();

            } catch (error) {
                console.error('加载基础数据失败:', error);
                throw error;
            }
        }

        // 更新下拉选项
        function updateSelectOptions() {
            // 更新部门下拉框
            const departmentSelect = document.getElementById('department');
            departmentSelect.innerHTML = '<option value="">请选择使用部门</option>';
            allDepartments.forEach(dept => {
                departmentSelect.innerHTML += `<option value="${dept.id}">${dept.name}</option>`;
            });

            // 更新类别下拉框
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '<option value="">请选择设备类别</option>';
            allCategories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        }

        // 加载设备数据
        async function loadEquipmentData(equipmentId) {
            try {
                showNotification('正在加载设备数据...', 'info');
                const equipment = await EquipmentAPI.getEquipment(equipmentId);
                
                // 填充表单数据
                await fillFormData(equipment);
                
                showNotification('设备数据加载成功', 'success');
            } catch (error) {
                console.error('加载设备数据失败:', error);
                showNotification('加载设备数据失败: ' + error.message, 'error');
                throw error;
            }
        }

        // 填充表单数据
        async function fillFormData(equipment) {
            // 基本信息
            document.getElementById('department').value = equipment.department_id;
            document.getElementById('category').value = equipment.category_id;
            
            // 加载该类别的预定义器具名称
            await loadPredefinedNamesForCategory();
            
            // 设置设备名称
            const nameSelect = document.getElementById('equipmentName');
            nameSelect.value = equipment.name;
            
            // 如果当前设备名称不在预定义列表中，添加它
            if (!nameSelect.value) {
                const option = document.createElement('option');
                option.value = equipment.name;
                option.textContent = equipment.name;
                option.selected = true;
                nameSelect.appendChild(option);
            }
            
            document.getElementById('model').value = equipment.model;
            document.getElementById('accuracy').value = equipment.accuracy_level;
            document.getElementById('measureRange').value = equipment.measurement_range || '';

            // 标识信息
            document.getElementById('equipmentCode').value = equipment.internal_id;
            document.getElementById('installLocation').value = equipment.installation_location || '';
            document.getElementById('manufacturerId').value = equipment.manufacturer_id || '';

            // 生产信息
            document.getElementById('manufacturer').value = equipment.manufacturer || '';
            document.getElementById('manufactureDate').value = equipment.manufacture_date || '';
            document.getElementById('originalValue').value = equipment.original_value || '';

            // 检定信息
            document.getElementById('calibrationPeriod').value = equipment.calibration_cycle;
            document.getElementById('calibrationDate').value = equipment.calibration_date;
            document.getElementById('calibrationMethod').value = equipment.calibration_method;
            document.getElementById('calibrationResult').value = equipment.current_calibration_result || '合格';

            // 外检字段
            document.getElementById('certificateNumber').value = equipment.certificate_number || '';
            document.getElementById('calibrationOrg').value = equipment.verification_agency || '';
            document.getElementById('certificateType').value = equipment.certificate_form || '';

            // 管理级别
            document.getElementById('managementLevel').value = equipment.management_level || '';

            // 状态信息
            document.getElementById('equipmentStatus').value = equipment.status;
            document.getElementById('statusChangeTime').value = equipment.status_change_date || '';

            // 备注
            document.getElementById('remarks').value = equipment.notes || '';

            // 计算有效期
            calculateValidDate();
            
            // 初始化外检字段显示
            toggleExternalFields();
            
            // 初始化状态变更时间显示
            toggleStatusChangeDate();
            
            // 初始化检定结果与设备状态的联动
            updateStatusBasedOnCalibrationResult();
        }

        // 初始化页面模式
        function initializePageMode(mode) {
            const pageTitle = document.getElementById('pageTitle');
            const pageDescription = document.getElementById('pageDescription');

            if (!pageTitle || !pageDescription) {
                console.warn('页面标题元素未找到，跳过初始化');
                return;
            }

            if (mode === 'add') {
                pageTitle.textContent = '添加新设备';
                pageDescription.innerHTML = '填写设备的详细信息，带 <span class="text-red-500">*</span> 的字段为必填项';
                
                // 新增模式下清空表单并设置合理的默认值
                const equipmentForm = document.getElementById('equipmentForm');
                if (equipmentForm) {
                    equipmentForm.reset();
                }
                
                // 设置一些合理的默认值
                const elements = {
                    equipmentStatus: document.getElementById('equipmentStatus'),
                    calibrationMethod: document.getElementById('calibrationMethod'),
                    calibrationPeriod: document.getElementById('calibrationPeriod')
                };
                
                if (elements.equipmentStatus) elements.equipmentStatus.value = '在用';
                if (elements.calibrationMethod) elements.calibrationMethod.value = '内检';
                if (elements.calibrationPeriod) elements.calibrationPeriod.value = '12个月';
                // 不设置检定日期的默认值，让用户根据检定周期来决定是否填写
                
                // 清空验证消息
                const codeValidation = document.getElementById('codeValidation');
                if (codeValidation) {
                    codeValidation.textContent = '';
                    codeValidation.style.display = 'none';
                }
                
                // 重新初始化表单状态
                setTimeout(() => {
                    toggleExternalFields();
                    toggleStatusChangeDate();
                    calculateValidDate();
                    updateStatusBasedOnCalibrationResult();
                }, 100);
            } else {
                pageTitle.textContent = '编辑设备信息';
                pageDescription.innerHTML = '修改设备的详细信息，带 <span class="text-red-500">*</span> 的字段为必填项';
            }
        }

        // 初始化表单事件
        function initializeFormEvents() {
            // 检定周期和日期变化时计算有效期
            const elements = {
                calibrationPeriod: document.getElementById('calibrationPeriod'),
                calibrationDate: document.getElementById('calibrationDate'),
                calibrationMethod: document.getElementById('calibrationMethod'),
                equipmentStatus: document.getElementById('equipmentStatus'),
                department: document.getElementById('department'),
                category: document.getElementById('category'),
                equipmentName: document.getElementById('equipmentName')
            };

            // 安全地添加事件监听器
            if (elements.calibrationPeriod) {
                elements.calibrationPeriod.addEventListener('change', calculateValidDate);
            }
            if (elements.calibrationDate) {
                elements.calibrationDate.addEventListener('change', calculateValidDate);
            }

            // 检定方式变化时切换外检字段
            if (elements.calibrationMethod) {
                elements.calibrationMethod.addEventListener('change', toggleExternalFields);
            }

            // 设备状态变化时切换状态变更时间
            if (elements.equipmentStatus) {
                elements.equipmentStatus.addEventListener('change', toggleStatusChangeDate);
            }

            // 部门变化时（不用于自动编号，但可能需要其他逻辑）
            if (elements.department) {
                // 部门变化时不自动生成编号，但保留监听器以备其他用途
                elements.department.addEventListener('change', function() {
                    // 可以在这里添加部门变化时的其他逻辑
                });
            }
            
            // 类别变化时加载预定义器具名称并清空编号
            if (elements.category) {
                elements.category.addEventListener('change', function() {
                    loadPredefinedNamesForCategory();
                    generateAutoId(); // 清空编号
                });
            }
            
            // 设备名称变化时自动生成编号
            if (elements.equipmentName) {
                elements.equipmentName.addEventListener('change', handleEquipmentNameChange);
            }
        }

        // 保存设备
        async function saveEquipment(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            try {
                const formData = collectFormData();
                
                if (isEditMode && currentEquipmentId) {
                    // 更新设备
                    showNotification('正在更新设备信息...', 'info');
                    await EquipmentAPI.updateEquipment(currentEquipmentId, formData);
                    showNotification('设备信息更新成功', 'success');
                } else {
                    // 创建设备
                    showNotification('正在创建设备...', 'info');
                    await EquipmentAPI.createEquipment(formData);
                    showNotification('设备创建成功', 'success');
                }

                // 返回设备管理页面
                setTimeout(() => {
                    window.location.href = '/equipment';
                }, 1000);

            } catch (error) {
                console.error('保存设备失败:', error);
                showNotification('保存失败: ' + error.message, 'error');
            }
        }

        // 收集表单数据
        function collectFormData() {
            const calibrationDate = document.getElementById('calibrationDate').value;
            const calibrationPeriod = document.getElementById('calibrationPeriod').value;
            const calibrationMethod = document.getElementById('calibrationMethod').value;

            // 计算有效期
            let validUntil = null;
            if (calibrationPeriod !== '随坏随换' && calibrationDate) {
                const date = new Date(calibrationDate);
                const months = parseInt(calibrationPeriod.replace('个月', ''));
                date.setMonth(date.getMonth() + months);
                date.setDate(date.getDate() - 1);
                validUntil = date.toISOString().split('T')[0];
            }

            const formData = {
                department_id: parseInt(document.getElementById('department').value),
                category_id: parseInt(document.getElementById('category').value),
                name: document.getElementById('equipmentName').value,
                model: document.getElementById('model').value,
                accuracy_level: document.getElementById('accuracy').value,
                measurement_range: document.getElementById('measureRange').value || null,
                calibration_cycle: calibrationPeriod,
                calibration_date: calibrationDate || null, // 随坏随换设备也可以有检定日期
                calibration_method: calibrationMethod,
                current_calibration_result: document.getElementById('calibrationResult').value,
                internal_id: document.getElementById('equipmentCode').value,
                installation_location: document.getElementById('installLocation').value || null,
                manufacturer_id: document.getElementById('manufacturerId').value || null,
                manufacturer: document.getElementById('manufacturer').value || null,
                manufacture_date: document.getElementById('manufactureDate').value || null,
                original_value: document.getElementById('originalValue').value ? 
                    parseFloat(document.getElementById('originalValue').value) : null,
                status: document.getElementById('equipmentStatus').value,
                status_change_date: document.getElementById('statusChangeTime').value || null,
                notes: document.getElementById('remarks').value || null,
                valid_until: validUntil
            };

            // 外检字段
            if (calibrationMethod === '外检') {
                formData.certificate_number = document.getElementById('certificateNumber').value;
                formData.verification_agency = document.getElementById('calibrationOrg').value;
                formData.certificate_form = document.getElementById('certificateType').value;
                formData.management_level = '-';
            } else {
                formData.management_level = document.getElementById('managementLevel').value;
            }

            return formData;
        }

        // 表单验证
        function validateForm() {
            let requiredFields = [
                'department', 'category', 'equipmentName', 'model',
                'equipmentCode', 'calibrationPeriod', 'calibrationMethod', 'equipmentStatus'
            ];

            // 检查是否需要检定日期
            const calibrationPeriod = document.getElementById('calibrationPeriod').value;
            if (calibrationPeriod !== '随坏随换') {
                requiredFields.push('calibrationDate');
            }

            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.style.borderColor = '#ef4444';
                    isValid = false;
                } else {
                    field.style.borderColor = '#d1d5db';
                }
            });

            // 外检时验证外检字段
            const calibrationMethod = document.getElementById('calibrationMethod').value;
            if (calibrationMethod === '外检') {
                const externalFields = ['certificateNumber', 'calibrationOrg', 'certificateType'];
                let firstInvalidField = null;
                
                externalFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        field.style.borderColor = '#ef4444';
                        isValid = false;
                        if (!firstInvalidField) {
                            firstInvalidField = field;
                        }
                    } else {
                        field.style.borderColor = '#d1d5db';
                    }
                });
                
                // 如果有验证失败的字段，跳转到第一个错误字段
                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }

            // 验证计量编号格式
            const equipmentCode = document.getElementById('equipmentCode').value;
            if (equipmentCode && equipmentCode.length < 3) {
                document.getElementById('equipmentCode').style.borderColor = '#ef4444';
                isValid = false;
            }

            if (!isValid) {
                // 检查是否是外检字段验证失败
                if (calibrationMethod === '外检') {
                    const certificateType = document.getElementById('certificateType');
                    const certificateNumber = document.getElementById('certificateNumber');
                    const calibrationOrg = document.getElementById('calibrationOrg');
                    
                    let missingFields = [];
                    if (!certificateType.value.trim()) missingFields.push('证书形式');
                    if (!certificateNumber.value.trim()) missingFields.push('证书编号');
                    if (!calibrationOrg.value.trim()) missingFields.push('检定机构');
                    
                    if (missingFields.length > 0) {
                        showNotification(`外检设备必须填写：${missingFields.join('、')}`, 'error');
                    } else {
                        showNotification('请填写所有必填字段', 'error');
                    }
                } else {
                    showNotification('请填写所有必填字段', 'error');
                }
            }

            return isValid;
        }

        // 自动生成内部编号
        async function generateAutoId() {
            const categoryId = document.getElementById('category').value;
            const equipmentName = document.getElementById('equipmentName').value;
            const codeInput = document.getElementById('equipmentCode');
            
            // 只有在类别和设备名称都选择时才生成编号
            if (categoryId && equipmentName) {
                try {
                    // 显示加载状态
                    codeInput.value = '正在生成...';
                    
                    // 构建API URL，包含设备名称参数
                    let apiUrl = `/api/equipment/utils/generate-internal-id?category_id=${categoryId}`;
                    if (equipmentName) {
                        apiUrl += `&equipment_name=${encodeURIComponent(equipmentName)}`;
                    }
                    
                    // 调用API生成编号
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        codeInput.value = data.internal_id;
                    } else {
                        codeInput.value = '';
                    }
                } catch (error) {
                    console.error('生成编号失败:', error);
                    codeInput.value = '';
                }
            } else {
                codeInput.value = '';
            }
        }

        // 验证计量编号唯一性
        async function validateEquipmentCode() {
            const code = document.getElementById('equipmentCode').value;
            const validation = document.getElementById('codeValidation');
            
            if (validation) {
                if (code) {
                    if (code.length >= 3) {
                        validation.textContent = '编号格式正确';
                        validation.className = 'text-sm text-green-600 mt-1';
                        validation.style.display = 'block';
                    } else {
                        validation.textContent = '编号至少需要3个字符';
                        validation.className = 'text-sm text-red-500 mt-1';
                        validation.style.display = 'block';
                    }
                } else {
                    validation.textContent = '';
                    validation.style.display = 'none';
                }
            }
        }

        // 重写原有的保存草稿功能
        async function saveAsDraft() {
            try {
                const formData = collectFormData();
                console.log('保存草稿:', formData);
                showNotification('草稿保存成功', 'success');
            } catch (error) {
                showNotification('草稿保存失败', 'error');
            }
        }

        // 重写重置表单功能
        function resetForm() {
            if (confirm('确定要重置表单吗？所有未保存的更改将丢失。')) {
                if (isEditMode && currentEquipmentId) {
                    // 重新加载数据
                    loadEquipmentData(currentEquipmentId);
                } else {
                    // 清空表单
                    document.getElementById('equipmentForm').reset();
                    initializePageMode('add');
                }
                
                // 重新初始化表单状态
                toggleExternalFields();
                toggleStatusChangeDate();
                calculateValidDate();
            }
        }

        // 计算有效期
        function calculateValidDate() {
            const calibrationDate = document.getElementById('calibrationDate').value;
            const calibrationPeriod = document.getElementById('calibrationPeriod').value;
            const validUntilInput = document.getElementById('validUntil');
            const calibrationDateLabel = document.getElementById('calibrationDateLabel');
            const calibrationDateInput = document.getElementById('calibrationDate');
            
            if (calibrationPeriod === '随坏随换') {
                // 随坏随换设备不需要有效期，但检定日期可选填
                validUntilInput.value = '';
                calibrationDateInput.required = false;
                calibrationDateLabel.classList.remove('required-field');
                validUntilInput.placeholder = '随坏随换设备无有效期';
                validUntilInput.disabled = true;
                // 不清空检定日期，让用户可以编辑
            } else {
                // 其他周期需要检定日期
                calibrationDateInput.required = true;
                calibrationDateLabel.classList.add('required-field');
                validUntilInput.placeholder = '';
                validUntilInput.disabled = false;
                
                if (calibrationDate && calibrationPeriod) {
                    const date = new Date(calibrationDate);
                    const months = parseInt(calibrationPeriod.replace('个月', ''));
                    date.setMonth(date.getMonth() + months);
                    date.setDate(date.getDate() - 1); // 减去一天，因为到期当天不算有效
                    validUntilInput.value = date.toISOString().split('T')[0];
                } else {
                    validUntilInput.value = '';
                }
            }
        }

        // 切换外检字段显示
        function toggleExternalFields() {
            const calibrationMethod = document.getElementById('calibrationMethod').value;
            const externalFields = document.getElementById('externalFields');
            const managementLevelSelect = document.getElementById('managementLevel');
            
            if (calibrationMethod === '外检') {
                externalFields.classList.add('show');
                // 设置外检字段为必填
                externalFields.querySelectorAll('input').forEach(input => {
                    input.required = true;
                });
                
                // 如果检定方式为外检，自动设置管理级别为"-"并禁用选择
                if (managementLevelSelect) {
                    managementLevelSelect.value = '-';
                    managementLevelSelect.disabled = true;
                }
            } else {
                externalFields.classList.remove('show');
                // 移除外检字段的必填要求
                externalFields.querySelectorAll('input').forEach(input => {
                    input.required = false;
                    input.value = ''; // 清空值
                });
                
                // 启用管理级别选择
                if (managementLevelSelect) {
                    managementLevelSelect.disabled = false;
                }
            }
        }

        // 根据检定结果更新设备状态
        function updateStatusBasedOnCalibrationResult() {
            const calibrationResult = document.getElementById('calibrationResult').value;
            const equipmentStatus = document.getElementById('equipmentStatus');
            
            if (calibrationResult === '合格') {
                // 检定结果为合格时，默认设置为在用，允许选择在用或停用
                if (!equipmentStatus.value || equipmentStatus.value === '报废') {
                    equipmentStatus.value = '在用';
                }
                // 启用状态选择
                equipmentStatus.disabled = false;
                // 只允许选择在用或停用
                const options = equipmentStatus.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === '报废') {
                        options[i].disabled = true;
                    } else {
                        options[i].disabled = false;
                    }
                }
            } else if (calibrationResult === '不合格') {
                // 检定结果为不合格时，强制设置为报废，不可修改
                equipmentStatus.value = '报废';
                equipmentStatus.disabled = true;
                // 禁用所有选项，只保留报废
                const options = equipmentStatus.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === '报废') {
                        options[i].disabled = false;
                    } else {
                        options[i].disabled = true;
                    }
                }
                // 触发状态变更时间显示
                toggleStatusChangeDate();
            }
        }

        // 切换状态变更时间显示
        function toggleStatusChangeDate() {
            const equipmentStatus = document.getElementById('equipmentStatus').value;
            const statusChangeDate = document.getElementById('statusChangeDate');
            
            if (equipmentStatus === '停用' || equipmentStatus === '报废') {
                statusChangeDate.classList.add('show');
                const statusChangeTime = document.getElementById('statusChangeTime');
                statusChangeTime.required = true;
                // 只在状态变更且没有值时设置为今天
                if (!statusChangeTime.value) {
                    statusChangeTime.value = new Date().toISOString().split('T')[0];
                }
            } else {
                statusChangeDate.classList.remove('show');
                document.getElementById('statusChangeTime').required = false;
            }
        }

      </script>
</body>
</html>