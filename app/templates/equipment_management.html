<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>设备管理 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/api-client.js?v=20250827-1"></script>
    <script src="/static/js/notification-manager.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(2px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        /* 撤回删除模态框样式 */
        .undo-countdown {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .undo-progress {
            transition: width 1s linear;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #667eea;
        }
        .status-badge { @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full; }
        .status-normal { @apply bg-green-100 text-green-800; }
        .status-warning { @apply bg-orange-100 text-orange-800; }
        .status-overdue { @apply bg-red-100 text-red-800; }
        .status-inactive { @apply bg-gray-100 text-gray-800; }
        .row-overdue { @apply bg-red-50 !important; }
        .row-pending { @apply bg-yellow-50 !important; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        
        .equipment-row {
            position: relative;
        }
        
        .equipment-action-btn {
            opacity: 0.8;
        }
        
        /* 统计卡片样式优化 */
        .stats-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent !important;
        }
        
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .stats-card.active {
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部通知容器 -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] space-y-2 max-w-md"></div>
    
    <div class="flex h-screen">
        <!-- 左侧导航栏 -->
        <div class="w-64 gradient-bg shadow-xl fixed left-0 top-0 h-full z-10">
            <div class="flex flex-col h-full">
                <!-- Logo和标题 -->
                <div class="flex items-center justify-center h-16 px-4 border-b border-white/20">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-list text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-lg font-bold">设备台账管理系统</h1>
                    </div>
                </div>

                <!-- 导航菜单 -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="/dashboard" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="/equipment" class="sidebar-item active flex items-center px-4 py-3 text-white rounded-lg">
                        <i class="fas fa-cogs mr-3 text-lg"></i>
                        <span>设备管理</span>
                    </a>
                      <a href="/reports" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="reports-link">
                        <i class="fas fa-chart-bar mr-3 text-lg"></i>
                        <span>统计报表</span>
                    </a>
                    
                    <!-- 系统管理下拉菜单 -->
                    <div class="relative">
                        <button class="sidebar-item flex items-center justify-between w-full px-4 py-3 text-white/90 rounded-lg" id="system-menu-btn">
                            <div class="flex items-center">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                <span>系统管理</span>
                            </div>
                            <i class="fas fa-chevron-down text-sm transition-transform duration-200" id="system-menu-arrow"></i>
                        </button>
                        <div class="ml-4 mt-1 space-y-1 hidden" id="system-submenu">
                            <a href="/categories" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-tags mr-3"></i>
                                <span>设备类别</span>
                            </a>
                            <a href="/departments" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-building mr-3"></i>
                                <span>部门管理</span>
                            </a>
                            <a href="/users" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="users-link">
                                <i class="fas fa-users mr-3"></i>
                                <span>用户管理</span>
                            </a>
                            <a href="/audit" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="audit-link">
                                <i class="fas fa-history mr-3"></i>
                                <span>操作日志</span>
                            </a>
                            <!-- 系统设置 - 仅管理员可见 -->
                            <a href="/settings" class="sidebar-item flex items-center px-4 py-2 text-white rounded-lg text-sm" id="settings-link" style="display: none;">
                                <i class="fas fa-cog mr-3"></i>
                                <span>系统设置</span>
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- 用户信息 -->
                <div class="border-t border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-white text-xl mr-3"></i>
                            <div>
                                <p class="text-white text-base font-medium" id="current-user"></p>
                            </div>
                        </div>
                        <button class="text-white/70 hover:text-white transition-colors" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 ml-64 overflow-hidden">
            <div class="h-full overflow-y-auto">
                <div class="p-8">
            
            <!-- 主要内容 -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">设备管理</h2>
                <p class="text-gray-600">管理所有设备信息，包括设备详情、状态监控和维护计划</p>
            </div>

            <!-- 搜索和筛选 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex flex-col lg:flex-row gap-4 mb-4">
                    <!-- 搜索框 -->
                    <div class="lg:w-1/2">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="搜索设备名称、型号、编号..." 
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- 筛选器 -->
                    <div class="lg:w-3/4 flex flex-wrap gap-1 items-end justify-end">
                        <div class="relative">
                            <select id="department-filter" class="pl-8 pr-6 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-blue-50 text-blue-900">
                                <option value="">全部部门</option>
                            </select>
                            <i class="fas fa-building absolute left-2 top-1/2 transform -translate-y-1/2 text-blue-600"></i>
                        </div>
                        
                        <div class="relative">
                            <select id="category-filter" class="pl-8 pr-6 py-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-green-50 text-green-900">
                                <option value="">全部类别</option>
                            </select>
                            <i class="fas fa-tags absolute left-2 top-1/2 transform -translate-y-1/2 text-green-600"></i>
                        </div>
                        
                          
                        <!-- 开始日期筛选器 -->
                        <div class="relative">
                            <input type="date" id="start-date-filter" placeholder="开始日期" 
                                   class="pl-8 pr-2 py-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50 text-orange-900">
                            <i class="fas fa-calendar-alt absolute left-2 top-1/2 transform -translate-y-1/2 text-orange-600"></i>
                        </div>
                        
                        <!-- 结束日期筛选器 -->
                        <div class="relative">
                            <input type="date" id="end-date-filter" placeholder="结束日期" 
                                   class="pl-8 pr-2 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-red-50 text-red-900">
                            <i class="fas fa-calendar-alt absolute left-2 top-1/2 transform -translate-y-1/2 text-red-600"></i>
                        </div>
                        
                        <!-- 隐藏的状态筛选器，供JavaScript使用 -->
                        <select id="status-filter" class="hidden">
                            <option value="">全部状态</option>
                            <option value="在用">在用</option>
                            <option value="停用">停用</option>
                            <option value="报废">报废</option>
                        </select>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex flex-wrap gap-3">
                    <button class="btn-primary text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200" onclick="addNewEquipment()">
                        <i class="fas fa-plus mr-2"></i>添加设备
                    </button>
                    <button class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1" onclick="exportEquipmentData()">
                        <i class="fas fa-file-excel mr-2"></i>导出数据
                    </button>
                    <button class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1" onclick="importEquipmentData()">
                        <i class="fas fa-file-import mr-2"></i>导入数据
                    </button>
                    
                    <!-- 批量操作 -->
                    <div class="relative">
                        <button id="batchOperationBtn" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-tasks mr-2"></i>批量操作
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div id="batchDropdown" class="hidden absolute top-full left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-t-lg" onclick="batchOperation('delete')">
                                <i class="fas fa-trash text-red-500 mr-2"></i>批量删除
                            </button>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-50" onclick="batchOperation('export')">
                                <i class="fas fa-download text-blue-500 mr-2"></i>批量导出
                            </button>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-50" onclick="batchOperation('move')">
                                <i class="fas fa-arrows-alt text-green-500 mr-2"></i>批量转移
                            </button>
                              <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-b-lg" onclick="batchOperation('calibration')">
                                <i class="fas fa-calendar-alt text-purple-500 mr-2"></i>批量更新检定
                            </button>
                        </div>
                    </div>
                    
                    <!-- 预定义器具名称管理 -->
                    <button class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1" onclick="openPredefinedNamesModal()">
                        <i class="fas fa-list-alt mr-2"></i>器具名称管理
                    </button>
                </div>
            </div>

            <!-- 信息概览卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200" 
                     id="card-total" 
                     data-status="all" 
                     title="点击查看所有设备">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <i class="fas fa-cogs text-2xl text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">设备总数</p>
                            <p class="text-2xl font-bold text-gray-900" id="equipment-total-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200" 
                     id="card-active" 
                     data-status="在用" 
                     title="点击查看正常设备">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i class="fas fa-check-circle text-2xl text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">正常设备</p>
                            <p class="text-2xl font-bold text-gray-900" id="equipment-active-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200" 
                     id="card-monthly-due" 
                     data-status="monthly_due" 
                     title="点击查看待检设备">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100">
                            <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">待检设备</p>
                            <p class="text-2xl font-bold text-gray-900" id="equipment-monthly-due-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200" 
                     id="card-overdue" 
                     data-status="overdue" 
                     title="点击查看超期设备">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100">
                            <i class="fas fa-times-circle text-2xl text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">超期设备</p>
                            <p class="text-2xl font-bold text-gray-900" id="equipment-overdue-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200" 
                     id="card-inactive" 
                     data-status="inactive" 
                     title="点击查看停用报废设备">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-gray-100">
                            <i class="fas fa-ban text-2xl text-gray-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">停用报废</p>
                            <p class="text-2xl font-bold text-gray-900" id="equipment-inactive-count">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 设备列表 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">设备列表</h3>
                        <div class="flex items-center gap-4">
                            <div class="text-sm text-gray-600">
                                已选择 <span id="selectedCount" class="font-semibold text-gray-900">0</span> 台设备
                            </div>
                            <div class="text-sm text-gray-600">
                                共 <span id="total-equipment-count" class="font-semibold text-gray-900">-</span> 台设备
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300" onchange="toggleSelectAll()">
                                </th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">设备信息</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">内部编号</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">出厂编号</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">使用部门</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">有效期至</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">设备状态</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="equipment-table-body">
                            <!-- 动态加载的设备数据 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 统一分页控件 -->
                <div id="pagination-container" class="flex items-center justify-between mt-6">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700">每页显示</span>
                        <select id="page-size" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-700">条</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="prev-page" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                            <i class="fas fa-chevron-left mr-1"></i>上一页
                        </button>
                        <div id="page-numbers" class="flex items-center space-x-1">
                            <!-- 页码按钮将动态生成 -->
                        </div>
                        <button id="next-page" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                            下一页<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700">
                        <span id="page-info">第 1 页，共 1 页</span>
                        <span class="text-gray-500 mx-2">|</span>
                        <span>共 <span id="total-count">0</span> 条</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
    </div>

    <!-- 导出选项模态框 -->
    <div id="exportModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">导出选项</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeExportModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择导出范围</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="exportType" value="all" class="mr-2" checked>
                            <span>导出所有设备数据</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="exportType" value="filtered" class="mr-2">
                            <span>导出当前筛选条件下的设备</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="exportType" value="selected" class="mr-2">
                            <span>导出选中的设备</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeExportModal()">
                        取消
                    </button>
                    <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" onclick="performExport()">
                        <i class="fas fa-download mr-2"></i>开始导出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入数据模态框 -->
    <div id="importModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">导入设备数据</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeImportModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 mb-4">操作说明</h4>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>• 请先下载导入模板，按照模板格式填写数据</li>
                            <li>• 支持Excel格式(.xlsx, .xls)</li>
                            <li>• 必填字段：使用部门、设备类别、计量器具名称、型号/规格、准确度等级、检定周期、检定(校准)日期、出厂编号、检定方式</li>
                            <li>• 出厂编号必须填写且不能重复，用于设备的唯一标识</li>
                            <li>• 检定周期可选值：6个月、12个月、24个月、36个月、随坏随换</li>
                            <li>• 随坏随换设备无需填写检定日期</li>
                            <li>• 外检设备需要填写证书编号、检定结果、检定机构、证书形式</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. 下载导入模板</label>
                    <button class="w-full bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 hover:bg-gray-50 transition-colors" onclick="downloadTemplate()">
                        <i class="fas fa-download text-gray-600 text-2xl mb-2"></i>
                        <p class="text-gray-700">点击下载设备台账导入模板</p>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. 选择Excel文件</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="importFileInput" class="hidden" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        <i class="fas fa-file-excel text-gray-400 text-3xl mb-3"></i>
                        <p class="text-gray-600 mb-2">点击选择文件或拖拽文件到此处</p>
                        <p class="text-sm text-gray-500">支持 .xlsx, .xls 格式</p>
                        <button class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="document.getElementById('importFileInput').click()">
                            选择文件
                        </button>
                    </div>
                    <div id="selectedFileInfo" class="mt-3 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-800">
                                <i class="fas fa-file-excel mr-2"></i>
                                已选择文件: <span id="selectedFileName"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="overwriteExisting" class="mr-2">
                        <span class="text-sm text-gray-700">覆盖已存在的设备数据（根据内部编号）</span>
                    </label>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeImportModal()">
                        取消
                    </button>
                    <button id="importBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" onclick="performImport()" disabled>
                        <i class="fas fa-upload mr-2"></i>开始导入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入结果模态框 -->
    <div id="importResultModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">导入结果</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeImportResultModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="stats-card bg-green-50 border border-green-200 rounded-lg p-4 text-center cursor-pointer hover:bg-green-100 transition-colors" 
                             data-filter="成功" onclick="filterImportResults('成功')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-check-circle text-green-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-green-600" id="successCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-green-700 mb-1">导入成功</div>
                            <div class="text-xs text-green-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看详情
                            </div>
                        </div>
                        <div class="stats-card bg-blue-50 border border-blue-200 rounded-lg p-4 text-center cursor-pointer hover:bg-blue-100 transition-colors" 
                             data-filter="更新" onclick="filterImportResults('更新')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-sync-alt text-blue-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-blue-600" id="updateCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-blue-700 mb-1">更新成功</div>
                            <div class="text-xs text-blue-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看详情
                            </div>
                        </div>
                        <div class="stats-card bg-red-50 border border-red-200 rounded-lg p-4 text-center cursor-pointer hover:bg-red-100 transition-colors" 
                             data-filter="失败" onclick="filterImportResults('失败')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-times-circle text-red-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-red-600" id="errorCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-red-700 mb-1">导入失败</div>
                            <div class="text-xs text-red-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看详情
                            </div>
                        </div>
                        <div class="stats-card bg-gray-50 border border-gray-200 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-100 transition-colors" 
                             data-filter="全部" onclick="filterImportResults('全部')">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-list text-gray-600 text-2xl mr-2"></i>
                                <div class="text-3xl font-bold text-gray-600" id="totalCount">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700 mb-1">总计处理</div>
                            <div class="text-xs text-gray-600 opacity-80">
                                <i class="fas fa-mouse-pointer mr-1"></i>点击查看全部
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-medium text-gray-900">详细结果</h4>
                        <div class="flex items-center space-x-3">
                            <span id="currentFilterDisplay" class="text-sm text-gray-600 bg-blue-50 px-3 py-1 rounded-full">显示: 全部结果</span>
                            <button id="toggleErrorGrouping" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition-colors" onclick="toggleErrorGrouping()" style="display: none;">
                                <i class="fas fa-layer-group mr-1"></i>合并相同错误
                            </button>
                            <button id="exportFailedBtn" class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded-full hover:bg-orange-200 transition-colors" onclick="exportFailedResults()" style="display: none;">
                                <i class="fas fa-download mr-1"></i>导出失败条目
                            </button>
                        </div>
                    </div>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <div class="grid grid-cols-12 gap-4 text-sm font-medium text-gray-700" id="resultTableHeader">
                                <div class="col-span-1">行号</div>
                                <div class="col-span-3">内部编号</div>
                                <div class="col-span-3">设备名称</div>
                                <div class="col-span-2">状态</div>
                                <div class="col-span-3">说明</div>
                            </div>
                            <div class="grid grid-cols-12 gap-4 text-sm font-medium text-gray-700 hidden" id="groupedResultTableHeader">
                                <div class="col-span-1">数量</div>
                                <div class="col-span-2">状态</div>
                                <div class="col-span-4">错误信息</div>
                                <div class="col-span-3">涉及行号</div>
                                <div class="col-span-2">操作</div>
                            </div>
                        </div>
                        <div id="importResultsList" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                            <!-- 动态加载导入结果 -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700" onclick="closeImportResultModal()">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 附件管理模态框 -->
    <div id="attachmentModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">附件管理</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeAttachmentModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-md font-medium text-gray-900">设备: <span id="attachment-equipment-name">-</span></h4>
                        <button class="btn-primary text-white px-4 py-2 rounded-lg text-sm" onclick="uploadAttachment()">
                            <i class="fas fa-upload mr-2"></i>上传附件
                        </button>
                    </div>
                    <input type="file" id="attachmentFileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" multiple>
                </div>
                
                <div class="border rounded-lg">
                    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                        <div class="grid grid-cols-12 gap-4 text-sm font-medium text-gray-700">
                            <div class="col-span-1">#</div>
                            <div class="col-span-4">文件名</div>
                            <div class="col-span-2">文件大小</div>
                            <div class="col-span-2">上传时间</div>
                            <div class="col-span-2">文件类型</div>
                            <div class="col-span-1">操作</div>
                        </div>
                    </div>
                    <div id="attachment-list" class="divide-y divide-gray-200">
                        <!-- 动态加载附件列表 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

      <!-- 批量转移模态框 -->
    <div id="batchTransferModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">批量转移设备</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeBatchTransferModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-4">已选择 <span id="batchTransferCount" class="font-semibold text-gray-900">0</span> 台设备</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">目标部门</label>
                        <select id="targetDepartment" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">请选择目标部门</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeBatchTransferModal()">
                        取消
                    </button>
                    <button id="batchTransferBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" onclick="performBatchTransfer()" disabled>
                        <i class="fas fa-arrows-alt mr-2"></i>确认转移
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 增强的检定信息更新模态框 -->
    <div id="singleCalibrationModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">更新检定信息</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeSingleCalibrationModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- 设备信息展示 -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">设备名称:</span>
                            <span id="singleCalibrationEquipmentName" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">检定方式:</span>
                            <span id="singleCalibrationMethod" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">内部编号:</span>
                            <span id="singleCalibrationInternalId" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">出厂编号:</span>
                            <span id="singleCalibrationManufacturerId" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">设备型号:</span>
                            <span id="singleCalibrationEquipmentModel" class="ml-2 text-gray-900">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">检定周期:</span>
                            <span id="singleCalibrationCycle" class="ml-2 text-gray-900">-</span>
                        </div>
                    </div>
                </div>

                <!-- 基础检定信息 -->
                <div class="space-y-4 mb-6">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">基础检定信息</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定日期 <span class="text-red-500">*</span></label>
                            <input type="date" id="singleCalibrationDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定结果 <span class="text-red-500">*</span></label>
                            <select id="singleCalibrationResult" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="toggleDisposalSection()">
                                <option value="合格">合格</option>
                                <option value="不合格">不合格</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 证书信息（内检外检共有） -->
                <div class="space-y-4 mb-6">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">证书信息</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">证书编号 <span id="certificateNumberRequired" class="text-red-500 hidden">*</span></label>
                            <input type="text" id="singleCertificateNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入证书编号">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">证书形式 <span id="certificateFormRequired" class="text-red-500 hidden">*</span></label>
                            <select id="singleCertificateForm" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">请选择</option>
                                <option value="检定证书">检定证书</option>
                                <option value="校准证书">校准证书</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 外检专有字段 -->
                <div id="externalCalibrationFields" class="space-y-4 mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">外检信息</h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定机构 <span class="text-red-500">*</span></label>
                            <input type="text" id="singleVerificationAgency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入检定机构名称">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检定备注</label>
                            <textarea id="singleExternalCalibrationNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入外检相关备注信息"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 内检备注字段 -->
                <div id="internalCalibrationFields" class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">检定备注</label>
                        <textarea id="singleCalibrationNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入检定相关备注信息"></textarea>
                    </div>
                </div>

                <!-- 报废信息（检定不合格时显示） -->
                <div id="disposalSection" class="space-y-4 mb-6 bg-red-50 border border-red-200 rounded-lg p-4 hidden">
                    <h4 class="text-md font-medium text-red-900 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>报废信息
                    </h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-red-700 mb-2">状态变更时间 <span class="text-red-500">*</span></label>
                            <input type="date" id="singleStatusChangeDate" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-red-700 mb-2">报废原因</label>
                            <textarea id="singleDisposalReason" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="3" placeholder="输入报废原因"></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-warning mr-2"></i>
                            <strong>警告:</strong> 检定不合格将自动将设备状态变更为"报废"
                        </p>
                    </div>
                </div>
                
                <!-- 设备状态选择（检定合格时显示） -->
                <div id="equipmentStatusSection" class="space-y-4 mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                    <h4 class="text-md font-medium text-blue-900 flex items-center">
                        <i class="fas fa-cog mr-2"></i>设备状态设置
                    </h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">设备状态 <span class="text-blue-500">*</span></label>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="equipmentStatus" value="在用" checked class="mr-2 text-blue-600 focus:ring-blue-500" onchange="toggleEquipmentStatusFields()">
                                    <span class="text-sm font-medium text-gray-700">在用</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="equipmentStatus" value="停用" class="mr-2 text-blue-600 focus:ring-blue-500" onchange="toggleEquipmentStatusFields()">
                                    <span class="text-sm font-medium text-gray-700">停用</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="statusChangeDateSection" class="hidden">
                            <label class="block text-sm font-medium text-blue-700 mb-2">状态变更时间 <span class="text-red-500">*</span></label>
                            <input type="date" id="singleActiveStatusChangeDate" class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div id="disposalReasonSection" class="hidden">
                            <label class="block text-sm font-medium text-blue-700 mb-2">停用原因</label>
                            <textarea id="singleActiveDisposalReason" class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入停用原因（选填）"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 文件上传 -->
                <div class="space-y-4 mb-6">
                    <h4 class="text-md font-medium text-gray-900 border-b pb-2">文件附件</h4>
                    
                    <!-- 证书文件上传 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">检定证书附件</label>
                        <div class="flex items-center space-x-4 mb-2">
                            <input type="file" id="singleCertificateFiles" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple class="hidden">
                            <button type="button" onclick="document.getElementById('singleCertificateFiles').click()" class="px-4 py-2 bg-blue-100 text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-200 flex items-center">
                                <i class="fas fa-certificate mr-2"></i>选择证书文件
                            </button>
                            <span id="singleCertificateFileCount" class="text-sm text-gray-500">未选择文件</span>
                        </div>
                        <div id="singleCertificateFileList" class="space-y-1"></div>
                        <p class="text-xs text-gray-500 mt-1">支持PDF、JPG、PNG、DOC、DOCX格式，可选择多个文件，单文件大小不超过10MB</p>
                    </div>
                    
                    <!-- 报废文件上传（仅在检定不合格时显示） -->
                    <div id="disposalFileSection" class="hidden">
                        <label class="block text-sm font-medium text-red-700 mb-2">报废文件附件</label>
                        <div class="flex items-center space-x-4 mb-2">
                            <input type="file" id="singleDisposalFiles" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple class="hidden">
                            <button type="button" onclick="document.getElementById('singleDisposalFiles').click()" class="px-4 py-2 bg-red-100 text-red-700 border border-red-300 rounded-lg hover:bg-red-200 flex items-center">
                                <i class="fas fa-trash-alt mr-2"></i>选择报废文件
                            </button>
                            <span id="singleDisposalFileCount" class="text-sm text-gray-500">未选择文件</span>
                        </div>
                        <div id="singleDisposalFileList" class="space-y-1"></div>
                        <p class="text-xs text-gray-500 mt-1">支持PDF、JPG、PNG、DOC、DOCX格式，可选择多个文件，单文件大小不超过10MB</p>
                    </div>
                </div>

                <!-- 系统提示 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        系统将根据设备的检定周期自动计算有效期至日期
                    </p>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-end space-x-3">
                    <button class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors" onclick="closeSingleCalibrationModal()">
                        取消
                    </button>
                    <button id="singleCalibrationBtn" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" onclick="performEnhancedSingleCalibrationUpdate()">
                        <i class="fas fa-calendar-check mr-2"></i>确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 增强的批量检定更新模态框 -->
    <div id="batchCalibrationModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">批量更新检定信息</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeBatchCalibrationModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- 设备选择信息 -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-gray-700">已选择设备:</span>
                            <span id="batchCalibrationCount" class="ml-2 text-lg font-bold text-blue-600">0</span>
                            <span class="text-sm text-gray-500">台</span>
                        </div>
                        <button onclick="showBatchEquipmentList()" class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-list mr-1"></i>查看设备列表
                        </button>
                    </div>
                </div>

                <!-- 字段选择区域 -->
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 mb-4">选择要批量更新的字段:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- 检定日期 -->
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="updateCalibrationDate" class="batch-field-checkbox" checked disabled>
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">检定日期</span>
                                <p class="text-xs text-gray-500">必填字段</p>
                            </div>
                        </label>

                        <!-- 检定结果 -->
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg bg-blue-50 cursor-not-allowed">
                            <input type="checkbox" id="updateCalibrationResult" class="batch-field-checkbox" checked disabled>
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">检定结果</span>
                                <p class="text-xs text-gray-500">必填字段</p>
                            </div>
                        </label>

                        <!-- 证书编号 -->
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="updateCertificateNumber" class="batch-field-checkbox">
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">证书编号</span>
                                <p class="text-xs text-gray-500">检定证书编号</p>
                            </div>
                        </label>

                        <!-- 证书形式 -->
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="updateCertificateForm" class="batch-field-checkbox">
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">证书形式</span>
                                <p class="text-xs text-gray-500">证书类型</p>
                            </div>
                        </label>

                        <!-- 检定机构 -->
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="updateVerificationAgency" class="batch-field-checkbox">
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">检定机构</span>
                                <p class="text-xs text-gray-500">外检专用</p>
                            </div>
                        </label>

                        <!-- 检定备注 -->
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="updateNotes" class="batch-field-checkbox">
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">检定备注</span>
                                <p class="text-xs text-gray-500">备注信息</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 动态字段输入区域 -->
                <div id="batchFieldInputs" class="space-y-4 mb-6">
                    <!-- 检定日期字段（默认显示） -->
                    <div id="batchCalibrationDateField" class="field-input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            检定日期 <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="batchCalibrationDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>

                    <!-- 检定结果字段（必填字段，默认显示） -->
                    <div id="batchCalibrationResultField" class="field-input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            检定结果 <span class="text-red-500">*</span>
                        </label>
                        <select id="batchCalibrationResult" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>

                    <!-- 证书编号字段 -->
                    <div id="batchCertificateNumberField" class="field-input-group hidden">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">证书编号</label>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="certificateNumberMode" value="unified" checked class="mr-1">
                                    <span class="text-sm text-gray-600">统一值</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="certificateNumberMode" value="individual" class="mr-1">
                                    <span class="text-sm text-gray-600">逐个输入</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 统一值输入 -->
                        <div id="unifiedCertificateNumber">
                            <input type="text" id="batchCertificateNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入证书编号（所有设备使用相同值）">
                        </div>
                        
                        <!-- 个体值输入 -->
                        <div id="individualCertificateNumber" class="hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    为每台设备输入不同的证书编号
                                </p>
                            </div>
                            <div id="certificateNumberList" class="space-y-2 max-h-60 overflow-y-auto">
                                <!-- 动态生成的设备证书编号输入框 -->
                            </div>
                        </div>
                    </div>

                    <!-- 证书形式字段 -->
                    <div id="batchCertificateFormField" class="field-input-group hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">证书形式</label>
                        <select id="batchCertificateForm" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">请选择</option>
                            <option value="检定证书">检定证书</option>
                            <option value="校准证书">校准证书</option>
                        </select>
                    </div>

                    <!-- 检定机构字段 -->
                    <div id="batchVerificationAgencyField" class="field-input-group hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">检定机构</label>
                        <input type="text" id="batchVerificationAgency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入检定机构名称">
                    </div>

                    <!-- 检定备注字段 -->
                    <div id="batchNotesField" class="field-input-group hidden">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">检定备注</label>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="notesMode" value="unified" checked class="mr-1">
                                    <span class="text-sm text-gray-600">统一值</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="notesMode" value="individual" class="mr-1">
                                    <span class="text-sm text-gray-600">逐个输入</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 统一值输入 -->
                        <div id="unifiedNotes">
                            <textarea id="batchNotes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入检定备注（所有设备使用相同内容）"></textarea>
                        </div>
                        
                        <!-- 个体值输入 -->
                        <div id="individualNotes" class="hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    为每台设备输入不同的检定备注
                                </p>
                            </div>
                            <div id="notesList" class="space-y-2 max-h-60 overflow-y-auto">
                                <!-- 动态生成的设备备注输入框 -->
                            </div>
                        </div>
                    </div>

                    <!-- 报废信息（检定不合格时显示） -->
                    <div id="batchDisposalSection" class="space-y-4 mb-6 bg-red-50 border border-red-200 rounded-lg p-4 hidden">
                        <h4 class="text-md font-medium text-red-900 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>报废信息
                        </h4>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-red-700 mb-2">状态变更时间 <span class="text-red-500">*</span></label>
                                <input type="date" id="batchStatusChangeDate" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-red-700 mb-2">报废原因</label>
                                <textarea id="batchDisposalReason" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="3" placeholder="输入报废原因"></textarea>
                            </div>
                        </div>
                        
                        <div class="bg-red-100 border border-red-300 rounded-lg p-3">
                            <p class="text-sm text-red-800">
                                <i class="fas fa-warning mr-2"></i>
                                <strong>警告:</strong> 检定不合格将自动将设备状态变更为"报废"
                            </p>
                        </div>
                    </div>
                
                <!-- 设备状态选择（检定合格时显示） -->
                <div id="batchEquipmentStatusSection" class="space-y-4 mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                    <h4 class="text-md font-medium text-blue-900 flex items-center">
                        <i class="fas fa-cog mr-2"></i>设备状态设置
                    </h4>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">设备状态 <span class="text-blue-500">*</span></label>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="batchEquipmentStatus" value="在用" checked class="mr-2 text-blue-600 focus:ring-blue-500" onchange="toggleBatchEquipmentStatusFields()">
                                    <span class="text-sm font-medium text-gray-700">在用</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="batchEquipmentStatus" value="停用" class="mr-2 text-blue-600 focus:ring-blue-500" onchange="toggleBatchEquipmentStatusFields()">
                                    <span class="text-sm font-medium text-gray-700">停用</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="batchStatusChangeDateSection" class="hidden">
                            <label class="block text-sm font-medium text-blue-700 mb-2">状态变更时间 <span class="text-red-500">*</span></label>
                            <input type="date" id="batchActiveStatusChangeDate" class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div id="batchDisposalReasonSection" class="hidden">
                            <label class="block text-sm font-medium text-blue-700 mb-2">停用原因</label>
                            <textarea id="batchActiveDisposalReason" class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="输入停用原因（选填）"></textarea>
                        </div>
                    </div>
                </div>
                </div>

                <!-- 提示信息 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">批量更新说明</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>检定日期为必填字段，系统将自动计算有效期</li>
                                    <li>只有勾选的字段才会进行批量更新</li>
                                    <li>未勾选的字段将保持设备原有值不变</li>
                                    <li>检定结果为"不合格"时，设备状态将变更为"报废"</li>
                                    <li>检定结果为"合格"时，可选择设备状态为"在用"或"停用"</li>
                                    <li>选择"停用"状态时需要填写状态变更时间</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-end space-x-3">
                    <button class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors" onclick="closeBatchCalibrationModal()">
                        取消
                    </button>
                    <button id="batchCalibrationBtn" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" onclick="performEnhancedBatchCalibrationUpdate()">
                        <i class="fas fa-calendar-check mr-2"></i>批量更新检定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 预定义器具名称管理模态框 -->
    <div id="predefinedNamesModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">预定义器具名称管理</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closePredefinedNamesModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- 类别选择 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择设备类别</label>
                    <select id="predefinedNamesCategorySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="loadPredefinedNames()">
                        <option value="">请选择设备类别</option>
                    </select>
                </div>

                <!-- 添加新器具名称 -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-md font-medium text-gray-900 mb-4">添加新器具名称</h4>
                    <div class="flex gap-4">
                        <input type="text" id="newPredefinedNameInput" placeholder="输入器具名称" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button id="addPredefinedNameBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" onclick="addPredefinedName()" disabled>
                            <i class="fas fa-plus mr-2"></i>添加
                        </button>
                    </div>
                </div>

                <!-- 现有器具名称列表 -->
                <div class="mb-4">
                    <h4 class="text-md font-medium text-gray-900 mb-4">现有器具名称</h4>
                    <div class="bg-white border border-gray-200 rounded-lg">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <div class="grid grid-cols-12 gap-4 text-sm font-medium text-gray-700">
                                <div class="col-span-1">#</div>
                                <div class="col-span-6">器具名称</div>
                                <div class="col-span-3">创建时间</div>
                                <div class="col-span-2">操作</div>
                            </div>
                        </div>
                        <div id="predefinedNamesList" class="divide-y divide-gray-200">
                            <!-- 动态加载器具名称列表 -->
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex justify-end space-x-3 mt-6">
                    <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closePredefinedNamesModal()">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let itemsPerPage = parseInt(localStorage.getItem('equipment_management_page_size') || '20');
        let totalItems = 0;
        let currentFilters = {};
        let currentSort = { field: 'valid_until', order: 'asc' };
        let selectedEquipment = [];
        let departments = [];
        let categories = [];
        let currentEquipmentId = null;

        // 检查 API 客户端是否加载完成
        function checkApiClientLoaded() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.ImportExportAPI && window.EquipmentAPI && window.DepartmentAPI && window.CategoryAPI && window.DashboardAPI && window.AttachmentAPI) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                
                // 10秒后超时
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 10000);
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查用户权限并显示/隐藏系统设置菜单
            function checkUserPermissions() {
                const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
                if (userInfo) {
                    const user = JSON.parse(userInfo);
                    const settingsLink = document.getElementById('settings-link');
                    
                    // 仅当用户是管理员时显示系统设置菜单
                    if (user.is_admin && settingsLink) {
                        settingsLink.style.display = 'flex';
                    } else if (settingsLink) {
                        settingsLink.style.display = 'none';
                    }
                }
            }
            
            // 调用权限检查
            checkUserPermissions();
            
            // 立即显示用户信息，避免闪现
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const currentUserElement = document.getElementById('current-user');
                if (currentUserElement) {
                    currentUserElement.textContent = user.username || '用户';
                    currentUserElement.style.visibility = 'visible'; // 显示用户信息
                }
            }
            
            try {
                // 检查是否有刷新参数，如果有则清除并准备强制刷新
                const urlParams = new URLSearchParams(window.location.search);
                const shouldRefresh = urlParams.has('refresh') || urlParams.has('timestamp');
                
                if (shouldRefresh) {
                    // 清除URL参数以避免重复刷新
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    console.log('检测到刷新参数，将强制刷新设备数据');
                }
                
                // 等待 API 客户端加载完成
                await checkApiClientLoaded();
                
                // 再次检查 ImportExportAPI 是否存在
                if (!window.ImportExportAPI) {
                    console.error('ImportExportAPI 未定义，请检查 api-client.js 是否正确加载');
                    showNotification('API 客户端加载失败，请刷新页面重试', 'error');
                    return;
                }
                
                await initializePage();
                
                // 设置默认显示正常设备（在用状态）
                const statusFilter = document.getElementById('status-filter');
                if (statusFilter) {
                    statusFilter.value = '在用';
                }
                
                await loadEquipmentData();
                setupEventListeners();
                
                if (shouldRefresh) {
                    showNotification('页面数据已刷新', 'success');
                }
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败，请刷新页面重试', 'error');
            }
        });

        // 初始化页面
        async function initializePage() {
            try {
                // 设置页面大小选择控件的默认值
                const pageSizeSelect = document.getElementById('page-size');
                if (pageSizeSelect) {
                    pageSizeSelect.value = itemsPerPage;
                }
                
                // 加载部门和类别数据
                const [departmentsData, categoriesData] = await Promise.all([
                    DepartmentAPI.getDepartments(),
                    CategoryAPI.getCategories()
                ]);
                
                departments = departmentsData;
                categories = categoriesData;
                
                // 填充筛选器
                populateFilters();
                
                // 加载仪表盘统计数据
                await loadDashboardStats();
                
                // 延迟更新设备到期背景色，确保DOM已渲染
                setTimeout(() => {
                    updateEquipmentExpiryBackground();
                }, 100);
                
            } catch (error) {
                console.error('初始化失败:', error);
                showNotification('初始化失败: ' + error.message, 'error');
            }
        }

        // 填充筛选器
        function populateFilters() {
            const departmentFilter = document.getElementById('department-filter');
            const categoryFilter = document.getElementById('category-filter');
            
            // 清空现有选项
            departmentFilter.innerHTML = '<option value="">全部部门</option>';
            categoryFilter.innerHTML = '<option value="">全部类别</option>';
            
            // 添加部门选项
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                departmentFilter.appendChild(option);
            });
            
            // 添加类别选项
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                
                // 创建带有图标的文本内容
                const icon = getCategoryIcon(cat.name);
                const iconColor = getIconColor(cat.name);
                option.innerHTML = `<i class="fas ${icon} ${iconColor} mr-2"></i>${cat.name}`;
                categoryFilter.appendChild(option);
            });
        }

        // 加载仪表盘统计数据
        async function loadDashboardStats() {
            try {
                const stats = await DashboardAPI.getStats();
                
                // 更新统计卡片
                document.getElementById('equipment-total-count').textContent = stats.total_equipment_count;
                document.getElementById('equipment-active-count').textContent = stats.active_equipment_count;
                document.getElementById('equipment-monthly-due-count').textContent = stats.monthly_due_count;
                document.getElementById('equipment-overdue-count').textContent = stats.overdue_count;
                document.getElementById('equipment-inactive-count').textContent = stats.inactive_count;
                document.getElementById('total-equipment-count').textContent = stats.total_equipment_count;
                
            } catch (error) {
                console.error('加载统计数据失败:', error);
                // 显示默认值
                document.getElementById('equipment-total-count').textContent = '-';
                document.getElementById('equipment-active-count').textContent = '-';
                document.getElementById('equipment-monthly-due-count').textContent = '-';
                document.getElementById('equipment-overdue-count').textContent = '-';
                document.getElementById('equipment-inactive-count').textContent = '-';
                document.getElementById('total-equipment-count').textContent = '-';
            }
        }

        // 设置统计卡片点击事件
        function setupStatCardClickHandlers() {
            // 防抖机制：避免快速重复点击
            let isProcessing = false;
            
            // 记录每个卡片的点击状态，避免重复通知
            const cardNotificationStatus = {
                'card-total': false,
                'card-active': false,
                'card-monthly-due': false,
                'card-overdue': false,
                'card-inactive': false
            };
            
            // 卡片视觉反馈函数
            function addCardFeedback(card) {
                card.style.transform = 'scale(0.95)';
                card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                setTimeout(() => {
                    card.style.transform = '';
                    card.style.boxShadow = '';
                }, 150);
            }
            
            // 智能通知函数：每个卡片类型只显示一次通知
            function showSmartNotification(cardId, message, type = 'info') {
                // 只在第一次点击时显示通知
                if (!cardNotificationStatus[cardId]) {
                    showNotification(message, type);
                    cardNotificationStatus[cardId] = true;
                }
            }
            
            // 防抖点击处理函数
            function handleCardClick(card, cardId, action) {
                if (isProcessing) return;
                
                isProcessing = true;
                addCardFeedback(card);
                
                try {
                    action();
                } finally {
                    setTimeout(() => {
                        isProcessing = false;
                    }, 300);
                }
            }
            
            // 设备总数卡片
            const totalCard = document.getElementById('card-total');
            if (totalCard) {
                totalCard.addEventListener('click', function() {
                    handleCardClick(totalCard, 'card-total', () => {
                        resetAllFilters();
                        currentPage = 1;
                        loadEquipmentData();
                        showSmartNotification('card-total', '显示所有设备', 'info');
                    });
                });
            }
            
            // 正常设备卡片
            const activeCard = document.getElementById('card-active');
            if (activeCard) {
                activeCard.addEventListener('click', function() {
                    handleCardClick(activeCard, 'card-active', () => {
                        resetAllFilters();
                        const statusFilter = document.getElementById('status-filter');
                        if (statusFilter) {
                            statusFilter.value = '在用';
                            currentPage = 1;
                            loadEquipmentData();
                            showSmartNotification('card-active', '显示正常设备', 'info');
                        }
                    });
                });
            }
            
            // 待检设备卡片
            const monthlyDueCard = document.getElementById('card-monthly-due');
            if (monthlyDueCard) {
                monthlyDueCard.addEventListener('click', function() {
                    handleCardClick(monthlyDueCard, 'card-monthly-due', () => {
                        resetAllFilters();
                        const today = new Date();
                        // 计算本月最后一天
                        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        const startDateFilter = document.getElementById('start-date-filter');
                        const endDateFilter = document.getElementById('end-date-filter');
                        
                        if (startDateFilter && endDateFilter) {
                            // 格式化日期为 YYYY-MM-DD
                            const formatDate = (date) => {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                return `${year}-${month}-${day}`;
                            };
                            
                            startDateFilter.value = formatDate(today);
                            endDateFilter.value = formatDate(lastDay);
                            currentPage = 1;
                            loadEquipmentData();
                            showSmartNotification('card-monthly-due', '显示待检设备', 'info');
                        }
                    });
                });
            }
            
            // 超期设备卡片
            const overdueCard = document.getElementById('card-overdue');
            if (overdueCard) {
                overdueCard.addEventListener('click', function() {
                    handleCardClick(overdueCard, 'card-overdue', () => {
                        resetAllFilters();
                        const today = new Date();
                        const startDateFilter = document.getElementById('start-date-filter');
                        const endDateFilter = document.getElementById('end-date-filter');
                        
                        if (startDateFilter && endDateFilter) {
                            endDateFilter.value = today.toISOString().split('T')[0];
                            currentPage = 1;
                            loadEquipmentData();
                            showSmartNotification('card-overdue', '显示超期设备', 'info');
                        }
                    });
                });
            }
            
            // 停用报废设备卡片
            const inactiveCard = document.getElementById('card-inactive');
            if (inactiveCard) {
                inactiveCard.addEventListener('click', function() {
                    handleCardClick(inactiveCard, 'card-inactive', () => {
                        resetAllFilters();
                        const statusFilter = document.getElementById('status-filter');
                        if (statusFilter) {
                            // 重置点击计数，实现停用和报废的循环切换
                            inactiveCard.clickCount = (inactiveCard.clickCount || 0) + 1;
                            
                            if (inactiveCard.clickCount % 2 === 1) {
                                statusFilter.value = '停用';
                                loadEquipmentData();
                                showSmartNotification('card-inactive', '显示停用设备', 'info');
                            } else {
                                statusFilter.value = '报废';
                                loadEquipmentData();
                                showSmartNotification('card-inactive', '显示报废设备', 'info');
                            }
                        }
                    });
                });
            }
        }
        
        // 重置所有筛选条件
        function resetAllFilters() {
            const filters = ['department-filter', 'category-filter', 'start-date-filter', 'end-date-filter'];
            filters.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                }
            });
            
            // 重置状态筛选器
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) {
                statusFilter.value = '';
            }
        }

        // 加载设备数据
        async function loadEquipmentData() {
            try {
                // 移除加载中的通知，直接加载数据
                
                // 构建筛选条件
                const filters = buildFilters();
                
                
                // 确认默认状态筛选器值
                const statusFilter = document.getElementById('status-filter');
                console.log('状态筛选器当前值:', statusFilter.value);
                console.log('状态筛选器是否选择了"在用":', statusFilter.value === '在用');
                
                // 获取设备数据
                let response;
                if (filters.query) {
                    // 如果有搜索查询，使用搜索接口
                    console.log('使用搜索接口');
                    response = await EquipmentAPI.searchEquipments(filters, {
                        skip: (currentPage - 1) * itemsPerPage,
                        limit: itemsPerPage,
                        sort_field: currentSort.field,
                        sort_order: currentSort.order
                    });
                } else {
                    // 否则使用筛选接口
                    console.log('使用筛选接口');
                    response = await EquipmentAPI.filterEquipments(filters, {
                        skip: (currentPage - 1) * itemsPerPage,
                        limit: itemsPerPage,
                        sort_field: currentSort.field,
                        sort_order: currentSort.order
                    });
                }
                
                const { items, total } = response;
                totalItems = total;
                
                console.log('API响应数据:');
                console.log('- 返回设备数量:', items.length);
                console.log('- 总设备数量:', total);
                console.log('- 当前页码范围:', (currentPage - 1) * itemsPerPage + 1, '-', currentPage * itemsPerPage);
                
                // 检查是否有待检设备：从当前日期到月底
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const currentDay = now.getDate();
                
                const monthlyDueEquipments = items.filter(equipment => {
                    if (!equipment.valid_until) return false;
                    
                    const expiryDate = new Date(equipment.valid_until);
                    // 检查设备是否在当前月份，且日期大于等于当前日期
                    return expiryDate.getMonth() === currentMonth && 
                           expiryDate.getFullYear() === currentYear &&
                           expiryDate.getDate() >= currentDay;
                });
                
                console.log('本月待检设备检查:');
                console.log('- 本月待检设备数量:', monthlyDueEquipments.length);
                console.log('- 当前月份:', currentMonth + 1);
                console.log('- 当前年份:', currentYear);
                
                if (monthlyDueEquipments.length > 0) {
                    console.log('本月待检设备详情:');
                    monthlyDueEquipments.forEach((equipment, index) => {
                        console.log(`  ${index + 1}. ${equipment.name} - 有效期至: ${equipment.valid_until}`);
                    });
                }
                
                // 渲染设备表格
                renderEquipmentTable(items);
                
                // 更新分页
                updatePagination();
                
                // 更新设备到期背景色
                updateEquipmentExpiryBackground();
                
                showNotification('设备数据加载成功', 'success');
                
            } catch (error) {
                console.error('加载设备数据失败:', error);
                showNotification('加载设备数据失败: ' + error.message, 'error');
                renderEquipmentTable([]); // 显示空表格
            }
        }

        // 构建筛选条件
        function buildFilters() {
            const filters = {};
            
            const departmentId = document.getElementById('department-filter').value;
            const categoryId = document.getElementById('category-filter').value;
            const searchQuery = document.getElementById('search-input').value.trim();
            const startDate = document.getElementById('start-date-filter').value;
            const endDate = document.getElementById('end-date-filter').value;
            
            // 获取状态筛选器（可能不存在，因为已经从HTML中移除）
            const statusFilter = document.getElementById('status-filter');
            const status = statusFilter ? statusFilter.value : '';
            
            console.log('筛选器原始值:');
            console.log('- 部门ID:', departmentId);
            console.log('- 类别ID:', categoryId);
            console.log('- 状态:', status);
            console.log('- 搜索查询:', searchQuery);
            console.log('- 开始日期:', startDate);
            console.log('- 结束日期:', endDate);
            
            if (departmentId) filters.department_id = parseInt(departmentId);
            if (categoryId) filters.category_id = parseInt(categoryId);
            if (status) filters.status = status;
            if (searchQuery) filters.query = searchQuery;
            if (startDate) filters.next_calibration_start = startDate;
            if (endDate) filters.next_calibration_end = endDate;
            
            console.log('构建的筛选条件:', filters);
            
            return filters;
        }

        // 渲染设备表格
        function renderEquipmentTable(equipments) {
            const tableBody = document.getElementById('equipment-table-body');
            
            if (!equipments || equipments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            暂无设备数据
                        </td>
                    </tr>
                `;
                return;
            }
            
            // 后端已经正确处理了排序，直接使用返回的数据
            const sortedEquipments = equipments;
            
            tableBody.innerHTML = sortedEquipments.map(equipment => {
                const departmentName = equipment.department ? equipment.department.name : '未知部门';
                const categoryName = equipment.category ? equipment.category.name : '其他';
                const accuracyLevel = equipment.accuracy_level || '未设置';
                const measurementRange = equipment.measurement_range || '未设置';
                const calibrationMethod = equipment.calibration_method || '内检';
                
                return `
                    <tr class="hover:bg-gray-50 equipment-row" data-expiry-date="${equipment.valid_until || ''}" data-calibration-cycle="${equipment.calibration_cycle || ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <input type="checkbox" class="equipment-checkbox rounded border-gray-300" 
                                   value="${equipment.id}" onchange="updateSelectedCount()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-left">
                            <div class="flex items-center">
                                <div class="h-10 w-10 flex-shrink-0">
                                    <div class="h-10 w-10 rounded-full ${getCategoryColor(categoryName)} flex items-center justify-center">
                                        <i class="fas ${getCategoryIcon(categoryName)} ${getIconColor(categoryName)}"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${equipment.name || '未知设备'}</div>
                                    <div class="text-sm text-gray-500">型号: ${equipment.model || '未知'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left">${equipment.internal_id || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left">${equipment.manufacturer_id || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left">${departmentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left">${formatDate(equipment.valid_until, equipment.calibration_cycle)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusStyle(equipment.status)}">${equipment.status || '未知'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2 text-center">
                            <button class="equipment-action-btn text-gray-600 hover:text-gray-900 relative" title="管理附件" 
                                    onclick="manageAttachments('${equipment.id}', '${equipment.name || '设备'}')"
                                    data-equipment-id="${equipment.id}">
                                <i class="fas fa-paperclip"></i>
                                <span class="attachment-count absolute -top-2 -right-2 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center loading">-</span>
                            </button>
                            <button class="equipment-action-btn text-indigo-600 hover:text-indigo-900" title="查看详情" onclick="viewEquipment('${equipment.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="equipment-action-btn text-green-600 hover:text-green-900" title="编辑" onclick="editEquipment('${equipment.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="equipment-action-btn text-purple-600 hover:text-purple-900" title="更新检定" onclick="updateCalibrationDate('${equipment.id}')">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                            <button class="equipment-action-btn text-red-600 hover:text-red-900" title="删除" onclick="deleteEquipment('${equipment.id}', '${equipment.name || '设备'}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // 加载附件数量
            setTimeout(() => loadEquipmentAttachmentCounts(sortedEquipments.map(eq => eq.id)), 200);
        }

        // 加载设备附件数量
        async function loadEquipmentAttachmentCounts(equipmentIds) {
            try {
                const promises = equipmentIds.map(async (id) => {
                    try {
                        const attachments = await AttachmentAPI.getEquipmentAttachments(id);
                        updateEquipmentAttachmentCount(id, attachments.length);
                    } catch (error) {
                        console.error(`加载设备 ${id} 附件数量失败:`, error);
                        updateEquipmentAttachmentCount(id, 0);
                    }
                });
                
                await Promise.all(promises);
            } catch (error) {
                console.error('批量加载附件数量失败:', error);
            }
        }

        // 更新设备附件数量显示
        function updateEquipmentAttachmentCount(equipmentId, count) {
            const button = document.querySelector(`button[data-equipment-id="${equipmentId}"] .attachment-count`);
            if (button) {
                button.textContent = count;
                button.classList.remove('loading');
                
                // 根据附件数量更新样式
                if (count === 0) {
                    button.classList.add('bg-gray-400');
                    button.classList.remove('bg-blue-500');
                } else {
                    button.classList.add('bg-blue-500');
                    button.classList.remove('bg-gray-400');
                }
                
                // 更新title属性
                button.parentElement.title = `管理附件 (${count}个文件)`;
            }
        }

        // 更新设备到期背景色
        function updateEquipmentExpiryBackground() {
            const equipmentRows = document.querySelectorAll('.equipment-row');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentDay = now.getDate();
            
            
            let overdueCount = 0;
            let monthlyDueCount = 0;
            let normalCount = 0;
            
            equipmentRows.forEach(row => {
                const expiryDateStr = row.getAttribute('data-expiry-date');
                if (!expiryDateStr) {
                    console.log('设备行没有有效期日期:', row);
                    return;
                }
                
                // 解析日期，支持多种格式
                let expiryDate;
                if (expiryDateStr.includes('T')) {
                    // ISO格式 (2025-08-07T00:00:00)
                    expiryDate = new Date(expiryDateStr);
                } else {
                    // 简单格式 (2025-08-07)
                    const [year, month, day] = expiryDateStr.split('-').map(num => parseInt(num, 10));
                    expiryDate = new Date(year, month - 1, day);
                }
                
                if (isNaN(expiryDate.getTime())) {
                    console.log('无效的日期格式:', expiryDateStr);
                    return;
                }
                
                // 获取设备名称用于调试
                const equipmentName = row.querySelector('td:nth-child(2) .text-sm.font-medium')?.textContent || '未知设备';
                
                // 获取设备状态
                const statusCell = row.querySelector('td:nth-child(3) span');
                const equipmentStatus = statusCell ? statusCell.textContent.trim() : '';
                
                // 检查设备状态
                const isOverdue = expiryDate < now;
                const isMonthlyDue = expiryDate.getMonth() === currentMonth && 
                                   expiryDate.getFullYear() === currentYear &&
                                   expiryDate.getDate() >= currentDay;
                
                console.log(`设备: ${equipmentName}`);
                console.log(`  状态: ${equipmentStatus}`);
                console.log(`  有效期: ${expiryDate.toLocaleString()}`);
                console.log(`  是否超期: ${isOverdue}`);
                console.log(`  是否本月待检: ${isMonthlyDue}`);
                
                // 移除现有的背景色类
                row.classList.remove('bg-red-50', 'bg-yellow-50', 'bg-gray-50', 'bg-red-100', 'bg-yellow-100', 'bg-green-100');
                
                // 优先级：停用/报废 > 本月待检 > 超期 > 正常
                if (equipmentStatus === '停用' || equipmentStatus === '报废') {
                    // 停用或报废 - 淡灰色背景（最高优先级）
                    row.classList.add('bg-gray-50');
                    normalCount++;
                    console.log(`  -> 标记为${equipmentStatus}（灰色背景）`);
                }
                else if (isMonthlyDue) {
                    // 本月待检 - 淡黄色背景
                    row.classList.add('bg-yellow-50');
                    monthlyDueCount++;
                    console.log(`  -> 标记为本月待检（黄色背景）`);
                }
                else if (isOverdue) {
                    // 超期未检 - 淡红色背景（只有在用设备才会检查超期）
                    row.classList.add('bg-red-50');
                    overdueCount++;
                    console.log(`  -> 标记为超期（红色背景）`);
                }
                else {
                    // 正常在用状态 - 无背景色
                    normalCount++;
                    console.log(`  -> 正常状态（无背景色）`);
                }
            });
            
            console.log('=== 背景色统计 ===');
            console.log(`超期设备: ${overdueCount} 台`);
            console.log(`本月待检设备: ${monthlyDueCount} 台`);
            console.log(`正常设备: ${normalCount} 台`);
            console.log(`总计: ${overdueCount + monthlyDueCount + normalCount} 台`);
        }

        // 获取设备状态样式
        function getStatusStyle(status) {
            switch(status) {
                case '在用': return 'bg-green-100 text-green-800';
                case '停用': return 'bg-gray-100 text-gray-800';
                case '报废': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // 获取设备类别图标
        function getCategoryIcon(categoryName) {
            const iconMap = {
                // 大类名称映射
                '温度环境类': 'fa-temperature-half',
                '长度/几何量类': 'fa-ruler',
                '质量称量类': 'fa-weight-scale',
                '时间测量类': 'fa-stopwatch',
                '容量测量类': 'fa-vial',
                '压力测量类': 'fa-gauge',
                '电学测试类': 'fa-bolt',
                '光学测试类': 'fa-eye',
                '环境试验类': 'fa-cloud-sun',
                '化学分析类': 'fa-flask',
                '涂层检测类': 'fa-paint-roller',
                '粘度流变类': 'fa-droplet',
                '流量测量类': 'fa-gear',
                '样品制备类': 'fa-brush',
                '计量标准类': 'fa-gavel',
                '信号处理与显示类': 'fa-tv',
                
                // 具体设备名称（作为备选）
                '温湿度计': 'fa-temperature-half',
                '玻璃液体温度计': 'fa-temperature-high',
                '温湿度表': 'fa-temperature-low',
                '工作用玻璃温度计': 'fa-temperature-three-quarters',
                '迷你温湿度计': 'fa-temperature-quarter',
                '数显温度计': 'fa-temperature-arrow-up',
                '双金属温度计': 'fa-temperature-empty',
                
                // 长度/几何量类
                '钢直尺': 'fa-ruler',
                '外径千分尺': 'fa-ruler-combined',
                '游标卡尺': 'fa-ruler-horizontal',
                '杠杆千分尺': 'fa-ruler-vertical',
                '钢卷尺': 'fa-tape',
                '深度千分尺': 'fa-ruler',
                '刀口尺': 'fa-slash',
                '刀口直角尺': 'fa-square',
                '高度游标卡尺': 'fa-ruler-vertical',
                '塞尺': 'fa-grip-lines',
                '数显千分尺': 'fa-calculator',
                '数显卡尺': 'fa-mobile-screen',
                '深度游标卡尺': 'fa-ruler-vertical',
                '条式水平仪': 'fa-level',
                '内径百分表': 'fa-circle-notch',
                '磁性位移测量仪': 'fa-magnet',
                '立式光学计': 'fa-eye',
                '百分表': 'fa-gauge-high',
                '表面粗糙度比较样块': 'fa-grip',
                
                // 质量称量类
                '案秤': 'fa-weight-scale',
                '电子秤': 'fa-scale-balanced',
                '电子台秤': 'fa-scale-unbalanced',
                '工业天平': 'fa-weight-hanging',
                '电子天平': 'fa-balance-scale-right',
                '电子计数秤': 'fa-calculator',
                '防爆电子秤': 'fa-shield-halved',
                '数字式电子汽车衡': 'fa-truck',
                '砝码': 'fa-weight',
                
                // 时间测量类
                '电子秒表': 'fa-stopwatch',
                
                // 容量测量类
                '分度吸量管': 'fa-droplet',
                '酸式滴定管': 'fa-flask',
                '碱式滴定管': 'fa-flask-vial',
                '量杯': 'fa-mug-hot',
                '量筒': 'fa-test-tube',
                '单标线吸量管': 'fa-droplet',
                '酸碱两用聚四氟滴定管': 'fa-flask',
                '单标线容量瓶': 'fa-bottle-droplet',
                '可调移液器': 'fa-pipette',
                '移液枪': 'fa-syringe',
                
                // 压力测量类
                '压力表': 'fa-gauge',
                '乙炔压力表': 'fa-gauge-high',
                '氧压力表': 'fa-gauge-simple-high',
                '氢气压力表': 'fa-gauge-simple',
                '氩气压力表': 'fa-gauge-max',
                '氮气压力表': 'fa-gauge-min',
                '氦气压力表': 'fa-gauge-simple-min',
                '电接点压力表': 'fa-plug',
                '抗震压力表': 'fa-gauge-circle-bolt',
                '耐震压力表': 'fa-gauge-circle-exclamation',
                '精密真空表': 'fa-gauge-circle-minus',
                '精密压力表': 'fa-gauge-circle-plus',
                '数字式差压计': 'fa-gauge-circle-arrow-down',
                
                // 电学测试类
                '耐压测试仪': 'fa-bolt',
                '绝缘电阻表': 'fa-plug-circle-bolt',
                '数字多用表': 'fa-multimeter',
                'MT500P多路温度记录仪': 'fa-chart-line',
                '高绝缘电阻测试仪': 'fa-plug-circle-exclamation',
                '旋转式直流电阻箱': 'fa-dharmachakra',
                '转换开关': 'fa-toggle-on',
                '表面电阻测试仪': 'fa-square-nfi',
                
                // 光学测试类
                '色差仪': 'fa-palette',
                '白度仪': 'fa-circle-half-stroke',
                '标准光源对色灯箱': 'fa-lightbulb',
                '目视比色箱': 'fa-eye',
                '黑白格玻璃板': 'fa-chess-board',
                '铁钴比色计': 'fa-vial',
                '光泽度仪': 'fa-star',
                '阿贝折射仪': 'fa-water',
                '反射率测定仪': 'fa-sun',
                
                // 环境试验类
                '氙灯老化试验箱': 'fa-sun-bright',
                '紫外老化试验箱': 'fa-sun-plant-wilt',
                '盐雾试验机': 'fa-smog',
                '高低温交变湿热实验箱': 'fa-cloud-rain',
                '紫外综合试验箱': 'fa-cloud-sun',
                
                // 化学分析类
                '气相色谱仪': 'fa-chart-column',
                '紫外可见分光光度计': 'fa-wave-square',
                '紫外分光光度计': 'fa-wave-pulse',
                '原子吸收分光光度计': 'fa-atom',
                'ICP发射光谱仪': 'fa-satellite-dish',
                '凝胶色谱仪': 'fa-dna',
                '化学需氧量（COD）快速测定仪': 'fa-flask-vial',
                '水分测试仪': 'fa-droplet-slash',
                '自动快速平衡法微量闪点测试仪': 'fa-fire-flame-curved',
                '笔试PH计': 'fa-pen-ruler',
                '微量水分测定仪': 'fa-droplet',
                'PH计': 'fa-flask-round-poison',
                
                // 涂层检测类
                '铅笔硬度计': 'fa-pencil',
                '数显卡规式测厚仪': 'fa-ruler-combined',
                '磁性测厚仪': 'fa-magnet',
                '百格板': 'fa-grid-3x3',
                '漆膜划格器': 'fa-grid-2-plus',
                '漆膜柔韧性测定仪': 'fa-wave-square',
                '漆膜弹性试验仪': 'fa-expand',
                '干燥时间试验器': 'fa-hourglass-half',
                '漆膜回粘性测定器': 'fa-hand-back-fist',
                '杯突实验仪': 'fa-bowl-food',
                '磨耗仪': 'fa-circle-notch',
                '建筑涂料耐洗刷仪': 'fa-brush',
                '流挂仪': 'fa-water',
                '漆膜干燥测定仪': 'fa-hourglass',
                '摩擦系数仪': 'fa-arrows-up-down-left-right',
                '涂层测厚仪': 'fa-ruler-horizontal',
                '厚漆腻子稠度测定仪': 'fa-fill-drip',
                '比重杯': 'fa-beaker',
                '摆杆式硬度试验计': 'fa-gavel',
                '附着力测试仪': 'fa-hand',
                '简支梁冲击试验机': 'fa-hammer',
                '微机控制电子万能试验机': 'fa-computer',
                '颗粒强度测定仪': 'fa-circle-dot',
                '汽车密封条磨耗试验机': 'fa-car',
                
                // 粘度流变类
                'ISO流出杯': 'fa-fill-drip',
                '涂-1#粘度杯': 'fa-fill',
                '涂-4#粘度杯': 'fa-droplet',
                '斯托默粘度计': 'fa-tachometer-alt',
                '旋转粘度计': 'fa-rotate',
                '数字式粘度计': 'fa-mobile-button',
                '粘度杯': 'fa-bottle-droplet',
                
                // 流量测量类
                '罗茨流量计': 'fa-gear',
                '腰轮流量计': 'fa-cog',
                '齿轮流量计': 'fa-gears',
                '智能浮子流量计': 'fa-circle-up',
                
                // 样品制备类
                '湿膜制备器': 'fa-brush',
                '涂膜器': 'fa-paint-roller',
                '漆膜制备器': 'fa-paintbrush',
                '腻子涂刮器': 'fa-scraper',
                '可调式制备器（数显式）': 'fa-sliders',
                
                // 计量标准类
                '标准铂电阻温度计': 'fa-temperature-high',
                'M1级砝码': 'fa-weight',
                '标准水银温度计': 'fa-temperature-high',
                '标准水槽': 'fa-bath',
                '标准油槽': 'fa-oil-can',
                
                // 信号处理与显示类
                '温度变送器': 'fa-broadcast-tower',
                '压力变送器': 'fa-satellite-dish',
                '压力液位变送器': 'fa-satellite',
                '智能变送器': 'fa-microchip',
                '数显表': 'fa-display',
                '无纸记录仪': 'fa-chart-simple',
                '雷达液位计': 'fa-satellite-dish'
            };
            return iconMap[categoryName] || 'fa-cogs';
        }

        // 获取图标颜色
        function getIconColor(categoryName) {
            const colorMap = {
                // 大类名称映射
                '温度环境类': 'text-red-600',
                '长度/几何量类': 'text-blue-600',
                '质量称量类': 'text-green-600',
                '时间测量类': 'text-purple-600',
                '容量测量类': 'text-cyan-600',
                '压力测量类': 'text-orange-600',
                '电学测试类': 'text-yellow-600',
                '光学测试类': 'text-pink-600',
                '环境试验类': 'text-indigo-600',
                '化学分析类': 'text-amber-600',
                '涂层检测类': 'text-rose-600',
                '粘度流变类': 'text-lime-600',
                '流量测量类': 'text-emerald-600',
                '样品制备类': 'text-teal-600',
                '计量标准类': 'text-fuchsia-600',
                '信号处理与显示类': 'text-sky-600',
                
                // 温度环境类 - 红色系
                '温湿度计': 'text-red-600',
                '玻璃液体温度计': 'text-red-500',
                '温湿度表': 'text-red-700',
                '工作用玻璃温度计': 'text-red-800',
                '迷你温湿度计': 'text-red-400',
                '数显温度计': 'text-red-600',
                '双金属温度计': 'text-red-500',
                
                // 长度/几何量类 - 蓝色系
                '钢直尺': 'text-blue-600',
                '外径千分尺': 'text-blue-700',
                '游标卡尺': 'text-blue-500',
                '杠杆千分尺': 'text-blue-800',
                '钢卷尺': 'text-blue-400',
                '深度千分尺': 'text-blue-600',
                '刀口尺': 'text-blue-700',
                '刀口直角尺': 'text-blue-800',
                '高度游标卡尺': 'text-blue-600',
                '塞尺': 'text-blue-500',
                '数显千分尺': 'text-blue-400',
                '数显卡尺': 'text-blue-600',
                '深度游标卡尺': 'text-blue-700',
                '条式水平仪': 'text-blue-800',
                '内径百分表': 'text-blue-500',
                '磁性位移测量仪': 'text-blue-600',
                '立式光学计': 'text-blue-400',
                '百分表': 'text-blue-700',
                '表面粗糙度比较样块': 'text-blue-800',
                
                // 质量称量类 - 绿色系
                '案秤': 'text-green-600',
                '电子秤': 'text-green-500',
                '电子台秤': 'text-green-700',
                '工业天平': 'text-green-800',
                '电子天平': 'text-green-400',
                '电子计数秤': 'text-green-600',
                '防爆电子秤': 'text-green-500',
                '数字式电子汽车衡': 'text-green-700',
                '砝码': 'text-green-800',
                
                // 时间测量类 - 紫色系
                '电子秒表': 'text-purple-600',
                
                // 容量测量类 - 青色系
                '分度吸量管': 'text-cyan-600',
                '酸式滴定管': 'text-cyan-500',
                '碱式滴定管': 'text-cyan-700',
                '量杯': 'text-cyan-800',
                '量筒': 'text-cyan-400',
                '单标线吸量管': 'text-cyan-600',
                '酸碱两用聚四氟滴定管': 'text-cyan-500',
                '单标线容量瓶': 'text-cyan-700',
                '可调移液器': 'text-cyan-800',
                '移液枪': 'text-cyan-400',
                
                // 压力测量类 - 橙色系
                '压力表': 'text-orange-600',
                '乙炔压力表': 'text-orange-500',
                '氧压力表': 'text-orange-700',
                '氢气压力表': 'text-orange-800',
                '氩气压力表': 'text-orange-400',
                '氮气压力表': 'text-orange-600',
                '氦气压力表': 'text-orange-500',
                '电接点压力表': 'text-orange-700',
                '抗震压力表': 'text-orange-800',
                '耐震压力表': 'text-orange-400',
                '精密真空表': 'text-orange-600',
                '精密压力表': 'text-orange-500',
                '数字式差压计': 'text-orange-700',
                
                // 电学测试类 - 黄色系
                '耐压测试仪': 'text-yellow-600',
                '绝缘电阻表': 'text-yellow-500',
                '数字多用表': 'text-yellow-700',
                'MT500P多路温度记录仪': 'text-yellow-800',
                '高绝缘电阻测试仪': 'text-yellow-400',
                '旋转式直流电阻箱': 'text-yellow-600',
                '转换开关': 'text-yellow-500',
                '表面电阻测试仪': 'text-yellow-700',
                
                // 光学测试类 - 粉色系
                '色差仪': 'text-pink-600',
                '白度仪': 'text-pink-500',
                '标准光源对色灯箱': 'text-pink-700',
                '目视比色箱': 'text-pink-800',
                '黑白格玻璃板': 'text-pink-400',
                '铁钴比色计': 'text-pink-600',
                '光泽度仪': 'text-pink-500',
                '阿贝折射仪': 'text-pink-700',
                '反射率测定仪': 'text-pink-800',
                
                // 环境试验类 - 靛蓝色系
                '氙灯老化试验箱': 'text-indigo-600',
                '紫外老化试验箱': 'text-indigo-500',
                '盐雾试验机': 'text-indigo-700',
                '高低温交变湿热实验箱': 'text-indigo-800',
                '紫外综合试验箱': 'text-indigo-400',
                
                // 化学分析类 - 琥珀色系
                '气相色谱仪': 'text-amber-600',
                '紫外可见分光光度计': 'text-amber-500',
                '紫外分光光度计': 'text-amber-700',
                '原子吸收分光光度计': 'text-amber-800',
                'ICP发射光谱仪': 'text-amber-400',
                '凝胶色谱仪': 'text-amber-600',
                '化学需氧量（COD）快速测定仪': 'text-amber-500',
                '水分测试仪': 'text-amber-700',
                '自动快速平衡法微量闪点测试仪': 'text-amber-800',
                '笔试PH计': 'text-amber-400',
                '微量水分测定仪': 'text-amber-600',
                'PH计': 'text-amber-500',
                
                // 涂层检测类 - 玫瑰色系
                '铅笔硬度计': 'text-rose-600',
                '数显卡规式测厚仪': 'text-rose-500',
                '磁性测厚仪': 'text-rose-700',
                '百格板': 'text-rose-800',
                '漆膜划格器': 'text-rose-400',
                '漆膜柔韧性测定仪': 'text-rose-600',
                '漆膜弹性试验仪': 'text-rose-500',
                '干燥时间试验器': 'text-rose-700',
                '漆膜回粘性测定器': 'text-rose-800',
                '杯突实验仪': 'text-rose-400',
                '磨耗仪': 'text-rose-600',
                '建筑涂料耐洗刷仪': 'text-rose-500',
                '流挂仪': 'text-rose-700',
                '漆膜干燥测定仪': 'text-rose-800',
                '摩擦系数仪': 'text-rose-400',
                '涂层测厚仪': 'text-rose-600',
                '厚漆腻子稠度测定仪': 'text-rose-500',
                '比重杯': 'text-rose-700',
                '摆杆式硬度试验计': 'text-rose-800',
                '附着力测试仪': 'text-rose-400',
                '简支梁冲击试验机': 'text-rose-600',
                '微机控制电子万能试验机': 'text-rose-500',
                '颗粒强度测定仪': 'text-rose-700',
                '汽车密封条磨耗试验机': 'text-rose-800',
                
                // 粘度流变类 - 石灰色系
                'ISO流出杯': 'text-lime-600',
                '涂-1#粘度杯': 'text-lime-500',
                '涂-4#粘度杯': 'text-lime-700',
                '斯托默粘度计': 'text-lime-800',
                '旋转粘度计': 'text-lime-400',
                '数字式粘度计': 'text-lime-600',
                '粘度杯': 'text-lime-500',
                
                // 流量测量类 - 翠绿色系
                '罗茨流量计': 'text-emerald-600',
                '腰轮流量计': 'text-emerald-500',
                '齿轮流量计': 'text-emerald-700',
                '智能浮子流量计': 'text-emerald-800',
                
                // 样品制备类 - 蓝绿色系
                '湿膜制备器': 'text-teal-600',
                '涂膜器': 'text-teal-500',
                '漆膜制备器': 'text-teal-700',
                '腻子涂刮器': 'text-teal-800',
                '可调式制备器（数显式）': 'text-teal-400',
                
                // 计量标准类 - 紫红色系
                '标准铂电阻温度计': 'text-fuchsia-600',
                'M1级砝码': 'text-fuchsia-500',
                '标准水银温度计': 'text-fuchsia-700',
                '标准水槽': 'text-fuchsia-800',
                '标准油槽': 'text-fuchsia-400',
                
                // 信号处理与显示类 - 天蓝色系
                '温度变送器': 'text-sky-600',
                '压力变送器': 'text-sky-500',
                '压力液位变送器': 'text-sky-700',
                '智能变送器': 'text-sky-800',
                '数显表': 'text-sky-400',
                '无纸记录仪': 'text-sky-600',
                '雷达液位计': 'text-sky-500'
            };
            return colorMap[categoryName] || 'text-gray-600';
        }

        // 获取类别背景色
        function getCategoryColor(categoryName) {
            const colorMap = {
                // 大类名称映射
                '温度环境类': 'bg-red-100',
                '长度/几何量类': 'bg-blue-100',
                '质量称量类': 'bg-green-100',
                '时间测量类': 'bg-purple-100',
                '容量测量类': 'bg-cyan-100',
                '压力测量类': 'bg-orange-100',
                '电学测试类': 'bg-yellow-100',
                '光学测试类': 'bg-pink-100',
                '环境试验类': 'bg-indigo-100',
                '化学分析类': 'bg-amber-100',
                '涂层检测类': 'bg-rose-100',
                '粘度流变类': 'bg-lime-100',
                '流量测量类': 'bg-emerald-100',
                '样品制备类': 'bg-teal-100',
                '计量标准类': 'bg-fuchsia-100',
                '信号处理与显示类': 'bg-sky-100',
                
                // 温度环境类 - 红色系
                '温湿度计': 'bg-red-100',
                '玻璃液体温度计': 'bg-red-50',
                '温湿度表': 'bg-red-200',
                '工作用玻璃温度计': 'bg-red-300',
                '迷你温湿度计': 'bg-red-25',
                '数显温度计': 'bg-red-100',
                '双金属温度计': 'bg-red-50',
                
                // 长度/几何量类 - 蓝色系
                '钢直尺': 'bg-blue-100',
                '外径千分尺': 'bg-blue-50',
                '游标卡尺': 'bg-blue-200',
                '杠杆千分尺': 'bg-blue-300',
                '钢卷尺': 'bg-blue-25',
                '深度千分尺': 'bg-blue-100',
                '刀口尺': 'bg-blue-50',
                '刀口直角尺': 'bg-blue-200',
                '高度游标卡尺': 'bg-blue-300',
                '塞尺': 'bg-blue-25',
                '数显千分尺': 'bg-blue-100',
                '数显卡尺': 'bg-blue-50',
                '深度游标卡尺': 'bg-blue-200',
                '条式水平仪': 'bg-blue-300',
                '内径百分表': 'bg-blue-25',
                '磁性位移测量仪': 'bg-blue-100',
                '立式光学计': 'bg-blue-50',
                '百分表': 'bg-blue-200',
                '表面粗糙度比较样块': 'bg-blue-300',
                
                // 质量称量类 - 绿色系
                '案秤': 'bg-green-100',
                '电子秤': 'bg-green-50',
                '电子台秤': 'bg-green-200',
                '工业天平': 'bg-green-300',
                '电子天平': 'bg-green-25',
                '电子计数秤': 'bg-green-100',
                '防爆电子秤': 'bg-green-50',
                '数字式电子汽车衡': 'bg-green-200',
                '砝码': 'bg-green-300',
                
                // 时间测量类 - 紫色系
                '电子秒表': 'bg-purple-100',
                
                // 容量测量类 - 青色系
                '分度吸量管': 'bg-cyan-100',
                '酸式滴定管': 'bg-cyan-50',
                '碱式滴定管': 'bg-cyan-200',
                '量杯': 'bg-cyan-300',
                '量筒': 'bg-cyan-25',
                '单标线吸量管': 'bg-cyan-100',
                '酸碱两用聚四氟滴定管': 'bg-cyan-50',
                '单标线容量瓶': 'bg-cyan-200',
                '可调移液器': 'bg-cyan-300',
                '移液枪': 'bg-cyan-25',
                
                // 压力测量类 - 橙色系
                '压力表': 'bg-orange-100',
                '乙炔压力表': 'bg-orange-50',
                '氧压力表': 'bg-orange-200',
                '氢气压力表': 'bg-orange-300',
                '氩气压力表': 'bg-orange-25',
                '氮气压力表': 'bg-orange-100',
                '氦气压力表': 'bg-orange-50',
                '电接点压力表': 'bg-orange-200',
                '抗震压力表': 'bg-orange-300',
                '耐震压力表': 'bg-orange-25',
                '精密真空表': 'bg-orange-100',
                '精密压力表': 'bg-orange-50',
                '数字式差压计': 'bg-orange-200',
                
                // 电学测试类 - 黄色系
                '耐压测试仪': 'bg-yellow-100',
                '绝缘电阻表': 'bg-yellow-50',
                '数字多用表': 'bg-yellow-200',
                'MT500P多路温度记录仪': 'bg-yellow-300',
                '高绝缘电阻测试仪': 'bg-yellow-25',
                '旋转式直流电阻箱': 'bg-yellow-100',
                '转换开关': 'bg-yellow-50',
                '表面电阻测试仪': 'bg-yellow-200',
                
                // 光学测试类 - 粉色系
                '色差仪': 'bg-pink-100',
                '白度仪': 'bg-pink-50',
                '标准光源对色灯箱': 'bg-pink-200',
                '目视比色箱': 'bg-pink-300',
                '黑白格玻璃板': 'bg-pink-25',
                '铁钴比色计': 'bg-pink-100',
                '光泽度仪': 'bg-pink-50',
                '阿贝折射仪': 'bg-pink-200',
                '反射率测定仪': 'bg-pink-300',
                
                // 环境试验类 - 靛蓝色系
                '氙灯老化试验箱': 'bg-indigo-100',
                '紫外老化试验箱': 'bg-indigo-50',
                '盐雾试验机': 'bg-indigo-200',
                '高低温交变湿热实验箱': 'bg-indigo-300',
                '紫外综合试验箱': 'bg-indigo-25',
                
                // 化学分析类 - 琥珀色系
                '气相色谱仪': 'bg-amber-100',
                '紫外可见分光光度计': 'bg-amber-50',
                '紫外分光光度计': 'bg-amber-200',
                '原子吸收分光光度计': 'bg-amber-300',
                'ICP发射光谱仪': 'bg-amber-25',
                '凝胶色谱仪': 'bg-amber-100',
                '化学需氧量（COD）快速测定仪': 'bg-amber-50',
                '水分测试仪': 'bg-amber-200',
                '自动快速平衡法微量闪点测试仪': 'bg-amber-300',
                '笔试PH计': 'bg-amber-25',
                '微量水分测定仪': 'bg-amber-100',
                'PH计': 'bg-amber-50',
                
                // 涂层检测类 - 玫瑰色系
                '铅笔硬度计': 'bg-rose-100',
                '数显卡规式测厚仪': 'bg-rose-50',
                '磁性测厚仪': 'bg-rose-200',
                '百格板': 'bg-rose-300',
                '漆膜划格器': 'bg-rose-25',
                '漆膜柔韧性测定仪': 'bg-rose-100',
                '漆膜弹性试验仪': 'bg-rose-50',
                '干燥时间试验器': 'bg-rose-200',
                '漆膜回粘性测定器': 'bg-rose-300',
                '杯突实验仪': 'bg-rose-25',
                '磨耗仪': 'bg-rose-100',
                '建筑涂料耐洗刷仪': 'bg-rose-50',
                '流挂仪': 'bg-rose-200',
                '漆膜干燥测定仪': 'bg-rose-300',
                '摩擦系数仪': 'bg-rose-25',
                '涂层测厚仪': 'bg-rose-100',
                '厚漆腻子稠度测定仪': 'bg-rose-50',
                '比重杯': 'bg-rose-200',
                '摆杆式硬度试验计': 'bg-rose-300',
                '附着力测试仪': 'bg-rose-25',
                '简支梁冲击试验机': 'bg-rose-100',
                '微机控制电子万能试验机': 'bg-rose-50',
                '颗粒强度测定仪': 'bg-rose-200',
                '汽车密封条磨耗试验机': 'bg-rose-300',
                
                // 粘度流变类 - 石灰色系
                'ISO流出杯': 'bg-lime-100',
                '涂-1#粘度杯': 'bg-lime-50',
                '涂-4#粘度杯': 'bg-lime-200',
                '斯托默粘度计': 'bg-lime-300',
                '旋转粘度计': 'bg-lime-25',
                '数字式粘度计': 'bg-lime-100',
                '粘度杯': 'bg-lime-50',
                
                // 流量测量类 - 翠绿色系
                '罗茨流量计': 'bg-emerald-100',
                '腰轮流量计': 'bg-emerald-50',
                '齿轮流量计': 'bg-emerald-200',
                '智能浮子流量计': 'bg-emerald-300',
                
                // 样品制备类 - 蓝绿色系
                '湿膜制备器': 'bg-teal-100',
                '涂膜器': 'bg-teal-50',
                '漆膜制备器': 'bg-teal-200',
                '腻子涂刮器': 'bg-teal-300',
                '可调式制备器（数显式）': 'bg-teal-25',
                
                // 计量标准类 - 紫红色系
                '标准铂电阻温度计': 'bg-fuchsia-100',
                'M1级砝码': 'bg-fuchsia-50',
                '标准水银温度计': 'bg-fuchsia-200',
                '标准水槽': 'bg-fuchsia-300',
                '标准油槽': 'bg-fuchsia-25',
                
                // 信号处理与显示类 - 天蓝色系
                '温度变送器': 'bg-sky-100',
                '压力变送器': 'bg-sky-50',
                '压力液位变送器': 'bg-sky-200',
                '智能变送器': 'bg-sky-300',
                '数显表': 'bg-sky-25',
                '无纸记录仪': 'bg-sky-100',
                '雷达液位计': 'bg-sky-50'
            };
            return colorMap[categoryName] || 'bg-gray-100';
        }

        // 格式化日期或显示检定周期
        function formatDate(dateString, calibrationCycle) {
            // 如果是随坏随换设备，显示"随坏随换"
            if (calibrationCycle === '随坏随换') {
                return '随坏随换';
            }
            
            if (!dateString) return '-';
            
            // 如果是ISO 8601格式（包含T），转换为本地时间格式
            if (dateString.includes('T')) {
                let date;
                
                // 检查是否包含时区信息
                if (dateString.includes('Z')) {
                    // UTC时间（带Z后缀）
                    date = new Date(dateString);
                } else if (dateString.includes('+')) {
                    // 带时区偏移的时间
                    date = new Date(dateString);
                } else {
                    // 没有时区信息，假设是UTC时间
                    date = new Date(dateString + 'Z');
                }
                
                if (isNaN(date.getTime())) return dateString; // 如果日期无效，返回原字符串
                
                // 格式化为本地时间：YYYY-MM-DD HH:mm:ss
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
            
            // 如果不是ISO格式，直接返回
            return dateString;
        }

        // 更新分页
        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('total-count').textContent = totalItems;
            
            // 更新按钮状态
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // 生成页码按钮
            generatePageNumbers(currentPage, totalPages);
        }

        // 生成页码按钮
        function generatePageNumbers(currentPage, totalPages) {
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一页
            if (startPage > 1) {
                pageNumbersContainer.appendChild(createPageButton(1, currentPage));
                if (startPage > 2) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
            }
            
            // 页码按钮
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersContainer.appendChild(createPageButton(i, currentPage));
            }
            
            // 最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                pageNumbersContainer.appendChild(createPageButton(totalPages, currentPage));
            }
        }
        
        // 创建页码按钮
        function createPageButton(pageNum, currentPage) {
            const button = document.createElement('button');
            button.className = `px-3 py-2 border text-sm font-medium rounded-lg transition-colors ${
                pageNum === currentPage 
                    ? 'bg-blue-500 text-white border-blue-500' 
                    : 'border-gray-300 text-gray-700 hover:bg-gray-50'
            }`;
            button.textContent = pageNum;
            button.onclick = () => changePage(pageNum);
            return button;
        }
        
        // 创建省略号
        function createEllipsis() {
            const span = document.createElement('span');
            span.className = 'px-3 py-2 text-gray-500';
            span.textContent = '...';
            return span;
        }

        // 切换页面
        async function changePage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            await loadEquipmentData();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 搜索输入框
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadEquipmentData();
                }, 500);
            });
            
            // 筛选器
            ['department-filter', 'category-filter', 'start-date-filter', 'end-date-filter'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    currentPage = 1;
                    loadEquipmentData();
                });
            });
            
            // 页面大小选择控件
            const pageSizeSelect = document.getElementById('page-size');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function() {
                    itemsPerPage = parseInt(this.value);
                    currentPage = 1;
                    // 保存每页显示条数到本地存储
                    localStorage.setItem('equipment_management_page_size', this.value);
                    loadEquipmentData();
                });
            }
            
            // 批量操作下拉菜单
            const batchOperationBtn = document.getElementById('batchOperationBtn');
            const batchDropdown = document.getElementById('batchDropdown');
            
            batchOperationBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                batchDropdown.classList.toggle('hidden');
            });
            
            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', function() {
                batchDropdown.classList.add('hidden');
            });
            
            // 侧边栏导航
            setupSidebarNavigation();
            
            // 统计卡片点击事件
            setupStatCardClickHandlers();
        }

        // 设置侧边栏导航
        function setupSidebarNavigation() {
            // 系统管理下拉菜单
            const systemMenuBtn = document.getElementById('system-menu-btn');
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            
            if (systemMenuBtn) {
                systemMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    systemSubmenu.classList.toggle('hidden');
                    
                    if (systemSubmenu.classList.contains('hidden')) {
                        systemMenuArrow.style.transform = 'rotate(0deg)';
                    } else {
                        systemMenuArrow.style.transform = 'rotate(180deg)';
                    }
                });
            }
            
            // 退出登录
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('确定要退出登录吗？')) {
                        // 先调用后端登出API销毁会话
                        const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                        if (token) {
                            fetch('/api/auth/logout', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Logout response:', data);
                            })
                            .catch(error => {
                                console.error('Logout error:', error);
                            })
                            .finally(() => {
                                // 清除本地存储
                                sessionStorage.removeItem('access_token');
                                sessionStorage.removeItem('refresh_token');
                                sessionStorage.removeItem('user_info');
                                localStorage.removeItem('access_token');
                                localStorage.removeItem('refresh_token');
                                localStorage.removeItem('user_info');
                                window.location.href = '/login';
                            });
                        } else {
                            // 如果没有token，直接清除并跳转
                            sessionStorage.removeItem('access_token');
                            sessionStorage.removeItem('refresh_token');
                            sessionStorage.removeItem('user_info');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            localStorage.removeItem('user_info');
                            window.location.href = '/login';
                        }
                    }
                });
            }
        }

        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const equipmentCheckboxes = document.querySelectorAll('.equipment-checkbox');
            
            equipmentCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        // 更新选中数量
        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // 更新批量操作按钮状态
            const batchOperationBtn = document.getElementById('batchOperationBtn');
            batchOperationBtn.disabled = selectedCount === 0;
            
            // 更新全选框状态
            const totalCheckboxes = document.querySelectorAll('.equipment-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === totalCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // 添加新设备
        function addNewEquipment() {
            window.location.href = '/equipment/edit?mode=add';
        }

        // 查看设备详情
        function viewEquipment(equipmentId) {
            window.location.href = `/equipment/view?id=${equipmentId}`;
        }

        // 编辑设备
        function editEquipment(equipmentId) {
            window.location.href = `/equipment/edit?id=${equipmentId}`;
        }

        // 更新检定
        async function updateCalibrationDate(equipmentId) {
            try {
                // 获取设备信息用于通知
                const equipment = await EquipmentAPI.getEquipment(equipmentId);
                
                // 构建通知消息
                let notificationMessage = `正在处理 ${equipment.name}`;
                if (equipment.internal_id && equipment.internal_id !== '-') {
                    notificationMessage += `（${equipment.internal_id}）`;
                }
                notificationMessage += ' 的检定...';
                
                showNotification(notificationMessage, 'info');
                
                // 打开单个设备检定日期更新模态框
                openSingleCalibrationModal(equipmentId);
                
            } catch (error) {
                console.error('获取设备信息失败:', error);
                // 即使获取设备信息失败，也要打开模态框
                openSingleCalibrationModal(equipmentId);
            }
        }

        // 删除设备相关变量
        let currentDeleteEquipmentId = null;
        let currentBatchDeleteIds = [];
        let currentDeleteAttachmentId = null;
        let currentDeletePredefinedName = null;
        
        // 撤回删除相关变量
        let undoDeleteTimeout = null;
        let undoDeleteEquipmentId = null;
        let undoDeleteEquipmentName = null;
        let undoDeleteOriginalData = null;

        // 删除设备
        function deleteEquipment(equipmentId, equipmentName) {
            currentDeleteEquipmentId = equipmentId;
            document.getElementById('deleteEquipmentName').textContent = equipmentName;
            document.getElementById('deleteEquipmentWarning').classList.add('hidden');
            document.getElementById('deleteEquipmentModal').classList.add('show');
        }

        // 确认删除设备
        async function confirmDeleteEquipment() {
            if (!currentDeleteEquipmentId) return;
            
            const equipmentName = document.getElementById('deleteEquipmentName').textContent;
            
            try {
                // 先获取设备原始数据
                const equipmentResponse = await EquipmentAPI.getEquipment(currentDeleteEquipmentId);
                undoDeleteOriginalData = equipmentResponse;
                
                // 标记设备为待删除状态
                const markForDeletionData = {
                    status: '停用',
                    status_change_date: new Date().toISOString().split('T')[0],
                    disposal_reason: '准备删除，可撤回操作',
                    notes: (equipmentResponse.notes || '') + '\n[系统标记] 设备准备删除，可撤回操作'
                };
                
                await EquipmentAPI.updateEquipment(currentDeleteEquipmentId, markForDeletionData);
                
                // 保存撤回信息
                undoDeleteEquipmentId = currentDeleteEquipmentId;
                undoDeleteEquipmentName = equipmentName;
                
                // 关闭删除确认模态框
                closeDeleteEquipmentModal();
                
                // 显示撤回模态框
                showUndoDeleteModal();
                
                // 开始10秒倒计时
                startUndoCountdown();
                
                showNotification(`设备 ${equipmentName} 已标记为删除，10秒后永久删除`, 'warning');
                
            } catch (error) {
                console.error('标记设备删除失败:', error);
                showNotification('标记设备删除失败: ' + error.message, 'error');
            }
        }

        // 关闭设备删除确认模态框
        function closeDeleteEquipmentModal() {
            document.getElementById('deleteEquipmentModal').classList.remove('show');
            currentDeleteEquipmentId = null;
        }

        // 显示撤回删除模态框
        function showUndoDeleteModal() {
            document.getElementById('undoDeleteEquipmentName').textContent = undoDeleteEquipmentName;
            document.getElementById('undoDeleteModal').classList.add('show');
        }

        // 关闭撤回删除模态框
        function closeUndoDeleteModal() {
            document.getElementById('undoDeleteModal').classList.remove('show');
            if (undoDeleteTimeout) {
                clearTimeout(undoDeleteTimeout);
                undoDeleteTimeout = null;
            }
            // 立即删除设备
            if (undoDeleteEquipmentId) {
                performActualDelete();
            }
        }

        // 开始撤回倒计时
        function startUndoCountdown() {
            let timeLeft = 10;
            const countdownElement = document.getElementById('undoCountdown');
            const progressElement = document.getElementById('undoProgress');
            
            // 更新倒计时显示
            function updateCountdown() {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                progressElement.style.width = (timeLeft * 10) + '%';
                
                if (timeLeft <= 0) {
                    // 倒计时结束，执行实际删除
                    performActualDelete();
                } else {
                    // 继续倒计时
                    undoDeleteTimeout = setTimeout(updateCountdown, 1000);
                }
            }
            
            // 开始倒计时
            undoDeleteTimeout = setTimeout(updateCountdown, 1000);
        }

        // 执行实际删除
        async function performActualDelete() {
            if (!undoDeleteEquipmentId) return;
            
            try {
                await EquipmentAPI.deleteEquipment(undoDeleteEquipmentId);
                showNotification(`设备 ${undoDeleteEquipmentName} 已永久删除`, 'success');
                
                // 清理撤回相关变量
                clearUndoDeleteData();
                
                // 重新加载数据
                loadEquipmentData();
                loadDashboardStats();
                
            } catch (error) {
                console.error('删除设备失败:', error);
                showNotification('删除设备失败: ' + error.message, 'error');
            }
        }

        // 撤销删除设备
        async function undoDeleteEquipment() {
            if (!undoDeleteEquipmentId || !undoDeleteOriginalData) return;
            
            try {
                // 恢复设备原始状态
                const restoreData = {
                    ...undoDeleteOriginalData,
                    // 移除系统标记
                    notes: undoDeleteOriginalData.notes ? 
                        undoDeleteOriginalData.notes.replace('\n[系统标记] 设备准备删除，可撤回操作', '') : 
                        undoDeleteOriginalData.notes
                };
                
                // 如果原状态不是停用，恢复原状态
                if (undoDeleteOriginalData.status !== '停用') {
                    restoreData.status = undoDeleteOriginalData.status;
                }
                
                // 如果原处置原因不是准备删除，恢复原处置原因
                if (undoDeleteOriginalData.disposal_reason !== '准备删除，可撤回操作') {
                    restoreData.disposal_reason = undoDeleteOriginalData.disposal_reason;
                } else {
                    restoreData.disposal_reason = null;
                }
                
                await EquipmentAPI.updateEquipment(undoDeleteEquipmentId, restoreData);
                
                showNotification(`设备 ${undoDeleteEquipmentName} 已恢复`, 'success');
                
                // 清理撤回相关变量
                clearUndoDeleteData();
                
                // 重新加载数据
                loadEquipmentData();
                loadDashboardStats();
                
            } catch (error) {
                console.error('恢复设备失败:', error);
                showNotification('恢复设备失败: ' + error.message, 'error');
            }
        }

        // 清理撤回相关数据
        function clearUndoDeleteData() {
            if (undoDeleteTimeout) {
                clearTimeout(undoDeleteTimeout);
                undoDeleteTimeout = null;
            }
            undoDeleteEquipmentId = null;
            undoDeleteEquipmentName = null;
            undoDeleteOriginalData = null;
            document.getElementById('undoDeleteModal').classList.remove('show');
        }

        // 批量操作
        function batchOperation(operation) {
            const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showNotification('请先选择要操作的设备', 'warning');
                return;
            }
            
            switch (operation) {
                case 'delete':
                    openBatchDeleteModal(selectedIds);
                    break;
                case 'export':
                    performBatchExport(selectedIds);
                    break;
                case 'move':
                    openBatchTransferModal(selectedIds);
                    break;
                  case 'calibration':
                    openBatchCalibrationModal(selectedIds);
                    break;
            }
        }

        // 打开批量删除确认模态框
        function openBatchDeleteModal(equipmentIds) {
            currentBatchDeleteIds = equipmentIds;
            document.getElementById('batchDeleteCount').textContent = equipmentIds.length;
            document.getElementById('batchDeleteModal').classList.add('show');
        }

        // 确认批量删除
        async function confirmBatchDelete() {
            if (!currentBatchDeleteIds || currentBatchDeleteIds.length === 0) return;
            
            try {
                showNotification('正在批量删除设备...', 'info');
                
                await EquipmentAPI.batchDelete({ equipment_ids: currentBatchDeleteIds });
                
                showNotification(`成功删除 ${currentBatchDeleteIds.length} 台设备`, 'success');
                closeBatchDeleteModal();
                loadEquipmentData(); // 重新加载数据
                await loadDashboardStats(); // 刷新统计数据
            } catch (error) {
                console.error('批量删除失败:', error);
                showNotification('批量删除失败: ' + error.message, 'error');
            }
        }

        // 关闭批量删除确认模态框
        function closeBatchDeleteModal() {
            document.getElementById('batchDeleteModal').classList.remove('show');
            currentBatchDeleteIds = [];
        }

        // 执行批量删除
        async function performBatchDelete(equipmentIds) {
            try {
                showNotification('正在批量删除设备...', 'info');
                
                await EquipmentAPI.batchDelete({ equipment_ids: equipmentIds });
                
                showNotification(`成功删除 ${equipmentIds.length} 台设备`, 'success');
                loadEquipmentData(); // 重新加载数据
                await loadDashboardStats(); // 刷新统计数据
                
            } catch (error) {
                console.error('批量删除失败:', error);
                showNotification('批量删除失败: ' + error.message, 'error');
            }
        }

        // 执行批量导出
        async function performBatchExport(equipmentIds) {
            try {
                showNotification('正在批量导出设备数据...', 'info');
                
                await EquipmentAPI.batchExport({ equipment_ids: equipmentIds });
                
                showNotification('设备数据导出成功', 'success');
                
            } catch (error) {
                console.error('批量导出失败:', error);
                showNotification('批量导出失败: ' + error.message, 'error');
            }
        }

        // 打开批量转移模态框
        function openBatchTransferModal(equipmentIds) {
            document.getElementById('batchTransferCount').textContent = equipmentIds.length;
            document.getElementById('targetDepartment').value = '';
            document.getElementById('batchTransferBtn').disabled = true;
            document.getElementById('batchTransferModal').classList.add('show');
            
            // 存储选中的设备ID
            window.batchTransferEquipmentIds = equipmentIds;
            
            // 加载部门列表
            loadDepartmentsForTransfer();
        }

        // 关闭批量转移模态框
        function closeBatchTransferModal() {
            document.getElementById('batchTransferModal').classList.remove('show');
            window.batchTransferEquipmentIds = null;
        }

        // 加载部门列表用于转移
        function loadDepartmentsForTransfer() {
            try {
                const select = document.getElementById('targetDepartment');
                select.innerHTML = '<option value="">请选择目标部门</option>';
                
                if (departments && departments.length > 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        select.appendChild(option);
                    });
                } else {
                    showNotification('部门列表为空，请刷新页面重试', 'warning');
                }
            } catch (error) {
                console.error('加载部门列表失败:', error);
                showNotification('加载部门列表失败', 'error');
            }
        }

        // 执行批量转移
        async function performBatchTransfer() {
            const targetDepartmentId = document.getElementById('targetDepartment').value;
            
            if (!targetDepartmentId) {
                showNotification('请选择目标部门', 'warning');
                return;
            }
            
            try {
                showNotification('正在批量转移设备...', 'info');
                document.getElementById('batchTransferBtn').disabled = true;
                
                const requestData = {
                    equipment_ids: window.batchTransferEquipmentIds,
                    target_department_id: parseInt(targetDepartmentId)
                };
                
                await EquipmentAPI.batchTransfer(requestData);
                
                showNotification(`成功转移 ${window.batchTransferEquipmentIds.length} 台设备`, 'success');
                closeBatchTransferModal();
                loadEquipmentData(); // 重新加载数据
                await loadDashboardStats(); // 刷新统计数据
                
            } catch (error) {
                console.error('批量转移失败:', error);
                showNotification('批量转移失败: ' + error.message, 'error');
            } finally {
                document.getElementById('batchTransferBtn').disabled = false;
            }
        }

        // 打开批量检定日期更新模态框
        function openBatchCalibrationModal(equipmentIds) {
            document.getElementById('batchCalibrationCount').textContent = equipmentIds.length;
            
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('batchCalibrationDate').value = today;
            
            // 重置所有复选框（除了检定日期和检定结果）
            document.querySelectorAll('.batch-field-checkbox').forEach(checkbox => {
                if (checkbox.id !== 'updateCalibrationDate' && checkbox.id !== 'updateCalibrationResult') {
                    checkbox.checked = false;
                }
            });
            
            // 重置所有输入字段的显示状态
            resetBatchFieldInputs();
            
            // 设置字段选择事件监听器
            setupBatchFieldListeners();
            
            document.getElementById('batchCalibrationBtn').disabled = false;
            document.getElementById('batchCalibrationModal').classList.add('show');
            
            // 存储选中的设备ID和详细信息
            window.batchCalibrationEquipmentIds = equipmentIds;
            window.batchCalibrationEquipmentData = equipmentIds.map(id => {
                const row = document.querySelector(`input[value="${id}"]`).closest('tr');
                return {
                    id: id,
                    name: row.querySelector('.text-sm.font-medium.text-gray-900').textContent,
                    model: row.cells[2].textContent.trim(),
                    department: row.cells[3].textContent.trim(),
                    calibration_method: row.cells[7]?.textContent.trim() || '内检'
                };
            });
        }

        // 关闭批量检定更新模态框
        function closeBatchCalibrationModal() {
            document.getElementById('batchCalibrationModal').classList.remove('show');
            window.batchCalibrationEquipmentIds = null;
            window.batchCalibrationEquipmentData = null;
            resetBatchFieldInputs();
        }

        // 重置批量字段输入显示状态
        function resetBatchFieldInputs() {
            // 隐藏所有字段输入（除了检定日期和检定结果）
            document.querySelectorAll('.field-input-group').forEach(field => {
                if (field.id !== 'batchCalibrationDateField' && field.id !== 'batchCalibrationResultField') {
                    field.classList.add('hidden');
                }
            });
            
            // 清空所有输入字段的值
            document.getElementById('batchCalibrationResult').value = '合格';
            document.getElementById('batchCertificateNumber').value = '';
            document.getElementById('batchCertificateForm').value = '';
            document.getElementById('batchVerificationAgency').value = '';
            document.getElementById('batchNotes').value = '';
            
            // 重置证书编号模式
            const unifiedRadio = document.querySelector('input[name="certificateNumberMode"][value="unified"]');
            if (unifiedRadio) {
                unifiedRadio.checked = true;
            }
            
            // 隐藏报废信息部分
            const batchDisposalSection = document.getElementById('batchDisposalSection');
            if (batchDisposalSection) {
                batchDisposalSection.classList.add('hidden');
            }
            document.getElementById('unifiedCertificateNumber').classList.remove('hidden');
            document.getElementById('individualCertificateNumber').classList.add('hidden');
            document.getElementById('certificateNumberList').innerHTML = '';
            
            // 重置备注模式
            const unifiedNotesRadio = document.querySelector('input[name="notesMode"][value="unified"]');
            if (unifiedNotesRadio) {
                unifiedNotesRadio.checked = true;
            }
            document.getElementById('unifiedNotes').classList.remove('hidden');
            document.getElementById('individualNotes').classList.add('hidden');
            document.getElementById('notesList').innerHTML = '';
        }

        // 设置批量字段选择监听器
        function setupBatchFieldListeners() {
            const fieldMappings = {
                'updateCertificateNumber': 'batchCertificateNumberField',
                'updateCertificateForm': 'batchCertificateFormField',
                'updateVerificationAgency': 'batchVerificationAgencyField',
                'updateNotes': 'batchNotesField'
            };
            
            Object.keys(fieldMappings).forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                const fieldId = fieldMappings[checkboxId];
                
                checkbox.addEventListener('change', function() {
                    const fieldElement = document.getElementById(fieldId);
                    if (this.checked) {
                        fieldElement.classList.remove('hidden');
                        // 如果是证书编号字段，需要特殊处理
                        if (checkboxId === 'updateCertificateNumber') {
                            setupCertificateNumberMode();
                            // 联动选择证书形式
                            const certificateFormCheckbox = document.getElementById('updateCertificateForm');
                            if (certificateFormCheckbox && !certificateFormCheckbox.checked) {
                                certificateFormCheckbox.checked = true;
                                document.getElementById('batchCertificateFormField').classList.remove('hidden');
                            }
                        } else if (checkboxId === 'updateCertificateForm') {
                            // 联动选择证书编号
                            const certificateNumberCheckbox = document.getElementById('updateCertificateNumber');
                            if (certificateNumberCheckbox && !certificateNumberCheckbox.checked) {
                                certificateNumberCheckbox.checked = true;
                                document.getElementById('batchCertificateNumberField').classList.remove('hidden');
                                setupCertificateNumberMode();
                            }
                        } else if (checkboxId === 'updateNotes') {
                            // 设置备注模式
                            setupNotesMode();
                        }
                    } else {
                        fieldElement.classList.add('hidden');
                        // 取消选择时也要联动取消对方
                        if (checkboxId === 'updateCertificateNumber') {
                            const certificateFormCheckbox = document.getElementById('updateCertificateForm');
                            if (certificateFormCheckbox && certificateFormCheckbox.checked) {
                                certificateFormCheckbox.checked = false;
                                document.getElementById('batchCertificateFormField').classList.add('hidden');
                            }
                        } else if (checkboxId === 'updateCertificateForm') {
                            const certificateNumberCheckbox = document.getElementById('updateCertificateNumber');
                            if (certificateNumberCheckbox && certificateNumberCheckbox.checked) {
                                certificateNumberCheckbox.checked = false;
                                document.getElementById('batchCertificateNumberField').classList.add('hidden');
                            }
                        }
                    }
                });
            });

            // 设置证书编号模式切换监听器
            document.querySelectorAll('input[name="certificateNumberMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleCertificateNumberMode(this.value);
                });
            });
            
            // 设置备注模式切换监听器
            document.querySelectorAll('input[name="notesMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleNotesMode(this.value);
                });
            });
            
            // 设置批量检定结果变化监听器
            const batchCalibrationResult = document.getElementById('batchCalibrationResult');
            if (batchCalibrationResult) {
                batchCalibrationResult.addEventListener('change', function() {
                    toggleBatchDisposalSection(this.value);
                });
                // 初始化时检查一次
                toggleBatchDisposalSection(batchCalibrationResult.value);
            }
        }

        // 设置证书编号模式
        function setupCertificateNumberMode() {
            const selectedMode = document.querySelector('input[name="certificateNumberMode"]:checked').value;
            toggleCertificateNumberMode(selectedMode);
        }

        // 切换证书编号输入模式
        function toggleCertificateNumberMode(mode) {
            const unifiedSection = document.getElementById('unifiedCertificateNumber');
            const individualSection = document.getElementById('individualCertificateNumber');
            
            if (mode === 'individual') {
                unifiedSection.classList.add('hidden');
                individualSection.classList.remove('hidden');
                generateIndividualCertificateInputs();
            } else {
                unifiedSection.classList.remove('hidden');
                individualSection.classList.add('hidden');
            }
        }

        // 设置备注模式
        function setupNotesMode() {
            const selectedMode = document.querySelector('input[name="notesMode"]:checked').value;
            toggleNotesMode(selectedMode);
        }

        // 切换备注输入模式
        function toggleNotesMode(mode) {
            const unifiedSection = document.getElementById('unifiedNotes');
            const individualSection = document.getElementById('individualNotes');
            
            if (mode === 'individual') {
                unifiedSection.classList.add('hidden');
                individualSection.classList.remove('hidden');
                generateIndividualNotesInputs();
            } else {
                unifiedSection.classList.remove('hidden');
                individualSection.classList.add('hidden');
            }
        }

        // 生成个体备注输入框
        function generateIndividualNotesInputs() {
            if (!window.batchCalibrationEquipmentData) return;
            
            const container = document.getElementById('notesList');
            container.innerHTML = '';
            
            window.batchCalibrationEquipmentData.forEach((equipment, index) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border';
                inputGroup.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-sm font-medium">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-900">${equipment.name}</div>
                        <div class="text-xs text-gray-500">${equipment.model} - ${equipment.department}</div>
                    </div>
                    <div class="flex-1">
                        <textarea rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent individual-notes-input resize-none" 
                                  placeholder="输入检定备注" 
                                  data-equipment-id="${equipment.id}"></textarea>
                    </div>
                `;
                container.appendChild(inputGroup);
            });
        }

        // 生成个体证书编号输入框
        function generateIndividualCertificateInputs() {
            if (!window.batchCalibrationEquipmentData) return;
            
            const container = document.getElementById('certificateNumberList');
            container.innerHTML = '';
            
            window.batchCalibrationEquipmentData.forEach((equipment, index) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border';
                inputGroup.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-medium">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-900">${equipment.name}</div>
                        <div class="text-xs text-gray-500">${equipment.model} - ${equipment.department}</div>
                    </div>
                    <div class="flex-1">
                        <input type="text" 
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent individual-certificate-input" 
                               placeholder="输入证书编号" 
                               data-equipment-id="${equipment.id}">
                    </div>
                `;
                container.appendChild(inputGroup);
            });
        }

        // 显示批量设备列表
        function showBatchEquipmentList() {
            if (!window.batchCalibrationEquipmentData) return;
            
            let listHtml = '<div class="space-y-2 max-h-60 overflow-y-auto">';
            window.batchCalibrationEquipmentData.forEach(equipment => {
                listHtml += `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <div>
                            <span class="font-medium text-gray-900">${equipment.name}</span>
                            <span class="text-sm text-gray-500 ml-2">${equipment.model}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            <span>${equipment.department}</span>
                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-600 rounded">${equipment.calibration_method}</span>
                        </div>
                    </div>
                `;
            });
            listHtml += '</div>';
            
            showNotification(`
                <div>
                    <h3 class="font-medium mb-2">选中的设备列表 (${window.batchCalibrationEquipmentData.length} 台):</h3>
                    ${listHtml}
                </div>
            `, 'info', 8000);
        }

        // 预定义器具名称管理相关函数
        function openPredefinedNamesModal() {
            // 加载设备类别
            loadCategoriesForPredefinedNames();
            document.getElementById('predefinedNamesModal').classList.add('show');
        }

        function closePredefinedNamesModal() {
            document.getElementById('predefinedNamesModal').classList.remove('show');
            document.getElementById('predefinedNamesCategorySelect').value = '';
            document.getElementById('newPredefinedNameInput').value = '';
            document.getElementById('predefinedNamesList').innerHTML = '';
        }

        async function loadCategoriesForPredefinedNames() {
            try {
                const response = await CategoryAPI.getCategories();
                const select = document.getElementById('predefinedNamesCategorySelect');
                select.innerHTML = '<option value="">请选择设备类别</option>';
                
                response.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    
                    // 创建带有图标的文本内容
                    const icon = getCategoryIcon(category.name);
                    const iconColor = getIconColor(category.name);
                    option.innerHTML = `<i class="fas ${icon} ${iconColor} mr-2"></i>${category.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载设备类别失败:', error);
                showNotification('加载设备类别失败', 'error');
            }
        }

        async function loadPredefinedNames() {
            const categoryId = document.getElementById('predefinedNamesCategorySelect').value;
            if (!categoryId) {
                document.getElementById('predefinedNamesList').innerHTML = '';
                document.getElementById('addPredefinedNameBtn').disabled = true;
                return;
            }

            try {
                const response = await CategoryAPI.getPredefinedNames(categoryId);
                const listContainer = document.getElementById('predefinedNamesList');
                listContainer.innerHTML = '';

                const names = response.predefined_names || [];
                if (names.length === 0) {
                    listContainer.innerHTML = '<div class="px-4 py-8 text-center text-gray-500">暂无预定义器具名称</div>';
                    return;
                }

                names.forEach((name, index) => {
                    const row = document.createElement('div');
                    row.className = 'px-4 py-3 hover:bg-gray-50';
                    row.innerHTML = `
                        <div class="grid grid-cols-12 gap-4 items-center">
                            <div class="col-span-1 text-sm text-gray-500">${index + 1}</div>
                            <div class="col-span-6 text-sm font-medium text-gray-900">${name}</div>
                            <div class="col-span-3 text-sm text-gray-500">-</div>
                            <div class="col-span-2">
                                <button class="text-red-600 hover:text-red-800 text-sm" onclick="deletePredefinedName('${encodeURIComponent(name)}')">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(row);
                });

                document.getElementById('addPredefinedNameBtn').disabled = false;
            } catch (error) {
                console.error('加载预定义器具名称失败:', error);
                showNotification('加载预定义器具名称失败', 'error');
            }
        }

        async function addPredefinedName() {
            const categoryId = document.getElementById('predefinedNamesCategorySelect').value;
            const name = document.getElementById('newPredefinedNameInput').value.trim();

            if (!categoryId) {
                showNotification('请选择设备类别', 'warning');
                return;
            }

            if (!name) {
                showNotification('请输入器具名称', 'warning');
                return;
            }

            try {
                await CategoryAPI.addPredefinedName(categoryId, name);
                showNotification('添加成功', 'success');
                document.getElementById('newPredefinedNameInput').value = '';
                await loadPredefinedNames();
            } catch (error) {
                console.error('添加预定义器具名称失败:', error);
                showNotification('添加失败', 'error');
            }
        }

        function deletePredefinedName(name) {
            currentDeletePredefinedName = decodeURIComponent(name);
            document.getElementById('deletePredefinedName').textContent = currentDeletePredefinedName;
            document.getElementById('deletePredefinedNameModal').classList.add('show');
        }

        // 确认删除预定义器具名称
        async function confirmDeletePredefinedName() {
            if (!currentDeletePredefinedName) return;
            
            try {
                const categoryId = document.getElementById('predefinedNamesCategorySelect').value;
                await CategoryAPI.removePredefinedName(categoryId, currentDeletePredefinedName);
                showNotification('删除成功', 'success');
                closeDeletePredefinedNameModal();
                await loadPredefinedNames();
            } catch (error) {
                console.error('删除预定义器具名称失败:', error);
                showNotification('删除失败', 'error');
            }
        }

        // 关闭预定义器具名称删除确认模态框
        function closeDeletePredefinedNameModal() {
            document.getElementById('deletePredefinedNameModal').classList.remove('show');
            currentDeletePredefinedName = null;
        }

        // 监听输入框变化
        document.addEventListener('DOMContentLoaded', function() {
            const newPredefinedNameInput = document.getElementById('newPredefinedNameInput');
            if (newPredefinedNameInput) {
                newPredefinedNameInput.addEventListener('input', function() {
                    const addBtn = document.getElementById('addPredefinedNameBtn');
                    if (addBtn) {
                        addBtn.disabled = !this.value.trim();
                    }
                });
            }
        });

        // 打开单个设备检定日期更新模态框
        async function openSingleCalibrationModal(equipmentId) {
            try {
                // 立即显示模态框，提升用户体验
                const modal = document.getElementById('singleCalibrationModal');
                modal.classList.add('show');
                
                // 设置默认值
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('singleCalibrationDate').value = today;
                document.getElementById('singleCalibrationResult').value = '合格';
                document.getElementById('singleStatusChangeDate').value = today;
                
                // 存储设备ID
                window.singleCalibrationEquipmentId = equipmentId;
                
                // 异步获取设备信息并填充
                setTimeout(async () => {
                    try {
                        const equipment = await EquipmentAPI.getEquipment(equipmentId);
                        
                        // 填充设备信息显示区域
                        document.getElementById('singleCalibrationEquipmentName').textContent = equipment.name;
                        document.getElementById('singleCalibrationMethod').textContent = equipment.calibration_method || '内检';
                        document.getElementById('singleCalibrationInternalId').textContent = equipment.internal_id || '-';
                        document.getElementById('singleCalibrationManufacturerId').textContent = equipment.manufacturer_id || '-';
                        document.getElementById('singleCalibrationEquipmentModel').textContent = equipment.model;
                        document.getElementById('singleCalibrationCycle').textContent = equipment.calibration_cycle;
                        
                        // 存储设备数据
                        window.singleCalibrationEquipmentData = equipment;
                        
                        // 根据检定方式显示/隐藏相关字段
                        const calibrationMethod = equipment.calibration_method || '内检';
                        toggleCalibrationFields(calibrationMethod);
                        
                        // 重置表单和设置验证
                        resetCalibrationForm();
                        setupRealTimeValidation();
                        setupFileUploadListeners();
                        setupCertificateFieldsValidation();
                        
                        // 如果是外检设备，获取上次的外检信息并自动填充
                        if (calibrationMethod === '外检') {
                            try {
                                const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                                if (!token) {
                                    console.warn('未找到认证token，无法获取上次外检信息');
                                    return;
                                }
                                
                                const response = await fetch(`/api/calibration/equipment/${equipmentId}/last-external-info`, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                
                                console.log('获取上次外检信息响应状态:', response.status);
                                
                                if (response.ok) {
                                    const lastExternalInfo = await response.json();
                                    console.log('获取到的上次外检信息:', lastExternalInfo);
                                    
                                    if (lastExternalInfo.success) {
                                        // 自动填充上次的外检信息（证书编号除外，因为每次都要新的）
                                        const verificationAgencyField = document.getElementById('singleVerificationAgency');
                                        const certificateFormField = document.getElementById('singleCertificateForm');
                                        
                                        if (verificationAgencyField && lastExternalInfo.verification_agency) {
                                            verificationAgencyField.value = lastExternalInfo.verification_agency;
                                            console.log('✅ 自动填充检定机构:', lastExternalInfo.verification_agency);
                                        }
                                        
                                        if (certificateFormField && lastExternalInfo.certificate_form) {
                                            certificateFormField.value = lastExternalInfo.certificate_form;
                                            console.log('✅ 自动填充证书形式:', lastExternalInfo.certificate_form);
                                        }
                                        
                                        // 显示提示信息（包含来源）
                                        if (lastExternalInfo.verification_agency || lastExternalInfo.certificate_form) {
                                            const sourceText = lastExternalInfo.source === 'history' ? '历史记录' : '设备信息';
                                            showNotification(`已自动填充外检信息（来源：${sourceText}）`, 'info');
                                        }
                                    } else {
                                        console.log('该设备暂无外检信息记录:', lastExternalInfo.message);
                                        // 对于没有外检信息的情况，可以提供一些默认选项
                                        const certificateFormField = document.getElementById('singleCertificateForm');
                                        if (certificateFormField && !certificateFormField.value) {
                                            // 如果设备是外检但没有证书形式，可以设置一个常见的默认值
                                            certificateFormField.value = '检定证书';
                                            console.log('⚠️  设置默认证书形式为：检定证书');
                                        }
                                    }
                                } else {
                                    const errorText = await response.text();
                                    console.error('获取上次外检信息失败:', response.status, errorText);
                                }
                            } catch (error) {
                                console.warn('获取上次外检信息失败:', error);
                                // 获取失败不影响正常流程，只是无法自动填充
                            }
                        }
                        
                        // 启用提交按钮
                        document.getElementById('singleCalibrationBtn').disabled = false;
                        
                    } catch (error) {
                        console.error('获取设备信息失败:', error);
                        showNotification('获取设备信息失败: ' + error.message, 'error');
                        // 即使获取设备信息失败，也要保持模态框打开
                    }
                }, 50); // 50ms延迟，确保模态框已经完全显示
                
            } catch (error) {
                console.error('打开模态框失败:', error);
                showNotification('打开模态框失败: ' + error.message, 'error');
            }
        }

        // 关闭单个设备检定日期更新模态框
        function closeSingleCalibrationModal() {
            document.getElementById('singleCalibrationModal').classList.remove('show');
            window.singleCalibrationEquipmentId = null;
        }

        // 设置证书信息相互依赖监听器（内检设备）
        function setupCertificateFieldsValidation() {
            const certificateNumberField = document.getElementById('singleCertificateNumber');
            const certificateFormField = document.getElementById('singleCertificateForm');
            
            if (!certificateNumberField || !certificateFormField) return;
            
            // 证书编号输入监听器
            certificateNumberField.addEventListener('input', function() {
                const hasNumber = this.value.trim() !== '';
                if (hasNumber) {
                    // 如果填写了证书编号，证书形式变为必填
                    certificateFormField.required = true;
                    document.getElementById('certificateFormRequired').classList.remove('hidden');
                } else {
                    // 如果清空证书编号，且证书形式也没选择，则都不必填
                    if (certificateFormField.value === '') {
                        certificateFormField.required = false;
                        document.getElementById('certificateFormRequired').classList.add('hidden');
                    }
                }
            });
            
            // 证书形式选择监听器
            certificateFormField.addEventListener('change', function() {
                const hasForm = this.value !== '';
                if (hasForm) {
                    // 如果选择了证书形式，证书编号变为必填
                    certificateNumberField.required = true;
                    document.getElementById('certificateNumberRequired').classList.remove('hidden');
                } else {
                    // 如果清空证书形式，且证书编号也没填，则都不必填
                    if (certificateNumberField.value.trim() === '') {
                        certificateNumberField.required = false;
                        document.getElementById('certificateNumberRequired').classList.add('hidden');
                    }
                }
            });
        }

        // 根据检定方式切换字段显示
        function toggleCalibrationFields(calibrationMethod) {
            const externalFields = document.getElementById('externalCalibrationFields');
            const internalFields = document.getElementById('internalCalibrationFields');
            const certificateNumberRequired = document.getElementById('certificateNumberRequired');
            const certificateFormRequired = document.getElementById('certificateFormRequired');
            
            if (calibrationMethod === '外检') {
                // 显示外检字段，隐藏内检字段
                if (externalFields) externalFields.classList.remove('hidden');
                if (internalFields) internalFields.style.display = 'none';
                
                // 显示必填标记
                if (certificateNumberRequired) certificateNumberRequired.classList.remove('hidden');
                if (certificateFormRequired) certificateFormRequired.classList.remove('hidden');
                
                // 设置外检必填字段
                const certificateNumberField = document.getElementById('singleCertificateNumber');
                const verificationAgencyField = document.getElementById('singleVerificationAgency');
                const certificateFormField = document.getElementById('singleCertificateForm');
                
                if (certificateNumberField) certificateNumberField.required = true;
                if (verificationAgencyField) verificationAgencyField.required = true;
                if (certificateFormField) certificateFormField.required = true;
            } else {
                // 显示内检字段，隐藏外检字段
                if (externalFields) externalFields.classList.add('hidden');
                if (internalFields) internalFields.style.display = 'block';
                
                // 隐藏必填标记
                if (certificateNumberRequired) certificateNumberRequired.classList.add('hidden');
                if (certificateFormRequired) certificateFormRequired.classList.add('hidden');
                
                // 清除外检必填字段
                const certificateNumberField = document.getElementById('singleCertificateNumber');
                const verificationAgencyField = document.getElementById('singleVerificationAgency');
                const certificateFormField = document.getElementById('singleCertificateForm');
                
                if (certificateNumberField) certificateNumberField.required = false;
                if (verificationAgencyField) verificationAgencyField.required = false;
                if (certificateFormField) certificateFormField.required = false;
            }
        }

        // 重置检定表单
        function resetCalibrationForm() {
            // 清空表单字段（需要检查元素是否存在）
            const elementsToReset = [
                'singleCalibrationNotes',
                'singleExternalCalibrationNotes',
                'singleCertificateNumber', 
                'singleCertificateForm',
                'singleVerificationAgency',
                'singleDisposalReason'
            ];
            
            elementsToReset.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                }
            });
            
            // 隐藏报废信息区域
            toggleDisposalSection(false);
            
            // 清空文件选择
            const certificateFilesInput = document.getElementById('singleCertificateFiles');
            const disposalFilesInput = document.getElementById('singleDisposalFiles');
            
            if (certificateFilesInput) {
                certificateFilesInput.value = '';
                certificateFilesInput.dispatchEvent(new Event('change'));
            }
            
            if (disposalFilesInput) {
                disposalFilesInput.value = '';
                disposalFilesInput.dispatchEvent(new Event('change'));
            }
        }

        // 设置文件上传事件监听器
        function setupFileUploadListeners() {
            // 证书文件选择监听器
            const certificateFilesInput = document.getElementById('singleCertificateFiles');
            if (certificateFilesInput) {
                certificateFilesInput.addEventListener('change', function() {
                    handleFileSelection(this, 'singleCertificateFileCount', 'singleCertificateFileList', 'certificate');
                });
            }

            // 报废文件选择监听器
            const disposalFilesInput = document.getElementById('singleDisposalFiles');
            if (disposalFilesInput) {
                disposalFilesInput.addEventListener('change', function() {
                    handleFileSelection(this, 'singleDisposalFileCount', 'singleDisposalFileList', 'disposal');
                });
            }
        }

        // 处理文件选择
        function handleFileSelection(input, countElementId, listElementId, fileType) {
            const files = input.files;
            const countElement = document.getElementById(countElementId);
            const listElement = document.getElementById(listElementId);

            // 更新文件数量显示
            if (countElement) {
                if (files.length === 0) {
                    countElement.textContent = '未选择文件';
                } else {
                    countElement.textContent = `已选择 ${files.length} 个文件`;
                }
            }

            // 更新文件列表显示
            if (listElement) {
                listElement.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between bg-gray-50 px-3 py-2 rounded border text-sm';
                    
                    // 文件大小检查
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    const isValidSize = file.size <= maxSize;
                    const sizeClass = isValidSize ? 'text-green-600' : 'text-red-600';
                    
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-file mr-2 text-gray-500"></i>
                            <span class="${isValidSize ? 'text-gray-900' : 'text-red-600'}">${file.name}</span>
                            <span class="ml-2 ${sizeClass}">(${formatFileSize(file.size)})</span>
                        </div>
                        <button type="button" onclick="removeFile('${input.id}', ${i})" class="text-red-500 hover:text-red-700 ml-2">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    listElement.appendChild(fileItem);
                }
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 移除文件（模拟）
        function removeFile(inputId, index) {
            // 由于HTML5 file input的限制，我们不能直接移除文件
            // 这里我们重置整个input并提示用户重新选择
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                input.dispatchEvent(new Event('change'));
                showNotification('文件已清空，请重新选择需要的文件', 'info');
            }
        }

        // 切换报废信息区域显示
        function toggleDisposalSection(show = null) {
            const disposalSection = document.getElementById('disposalSection');
            const disposalFileSection = document.getElementById('disposalFileSection');
            const equipmentStatusSection = document.getElementById('equipmentStatusSection');
            const calibrationResult = document.getElementById('singleCalibrationResult').value;
            
            const shouldShowDisposal = show !== null ? show : (calibrationResult === '不合格');
            const shouldShowStatus = calibrationResult === '合格';
            
            // 报废信息区域（不合格时显示）
            if (disposalSection) {
                if (shouldShowDisposal) {
                    disposalSection.classList.remove('hidden');
                    // 设置默认的状态变更时间为今天
                    const today = new Date().toISOString().split('T')[0];
                    const statusChangeDateField = document.getElementById('singleStatusChangeDate');
                    if (statusChangeDateField && !statusChangeDateField.value) {
                        statusChangeDateField.value = today;
                    }
                    // 设置默认的报废原因
                    const disposalReasonField = document.getElementById('singleDisposalReason');
                    if (disposalReasonField && !disposalReasonField.value.trim()) {
                        disposalReasonField.value = '检定不合格报废';
                    }
                } else {
                    disposalSection.classList.add('hidden');
                }
            }
            
            if (disposalFileSection) {
                if (shouldShowDisposal) {
                    disposalFileSection.classList.remove('hidden');
                } else {
                    disposalFileSection.classList.add('hidden');
                }
            }
            
            // 设备状态选择区域（合格时显示）
            if (equipmentStatusSection) {
                if (shouldShowStatus) {
                    equipmentStatusSection.classList.remove('hidden');
                    // 默认选择在用状态
                    document.querySelector('input[name="equipmentStatus"][value="在用"]').checked = true;
                    toggleEquipmentStatusFields();
                } else {
                    equipmentStatusSection.classList.add('hidden');
                }
            }
        }
        
        // 切换设备状态字段显示
        function toggleEquipmentStatusFields() {
            const selectedStatus = document.querySelector('input[name="equipmentStatus"]:checked')?.value || '在用';
            const statusChangeDateSection = document.getElementById('statusChangeDateSection');
            const disposalReasonSection = document.getElementById('disposalReasonSection');
            
            if (selectedStatus === '停用') {
                // 显示状态变更时间和停用原因字段
                if (statusChangeDateSection) {
                    statusChangeDateSection.classList.remove('hidden');
                    // 设置默认值为今天
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('singleActiveStatusChangeDate').value = today;
                }
                if (disposalReasonSection) {
                    disposalReasonSection.classList.remove('hidden');
                }
            } else {
                // 隐藏状态变更时间和停用原因字段
                if (statusChangeDateSection) {
                    statusChangeDateSection.classList.add('hidden');
                }
                if (disposalReasonSection) {
                    disposalReasonSection.classList.add('hidden');
                }
            }
        }

        // 切换批量报废信息区域显示
        function toggleBatchDisposalSection(calibrationResult) {
            const disposalSection = document.getElementById('batchDisposalSection');
            const equipmentStatusSection = document.getElementById('batchEquipmentStatusSection');
            
            const shouldShowDisposal = calibrationResult === '不合格';
            const shouldShowStatus = calibrationResult === '合格';
            
            // 报废信息区域（不合格时显示）
            if (disposalSection) {
                if (shouldShowDisposal) {
                    disposalSection.classList.remove('hidden');
                    // 设置默认的状态变更时间为今天
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('batchStatusChangeDate').value = today;
                    // 设置默认的报废原因
                    const disposalReasonField = document.getElementById('batchDisposalReason');
                    if (disposalReasonField && !disposalReasonField.value.trim()) {
                        disposalReasonField.value = '检定不合格报废';
                    }
                } else {
                    disposalSection.classList.add('hidden');
                }
            }
            
            // 设备状态选择区域（合格时显示）
            if (equipmentStatusSection) {
                if (shouldShowStatus) {
                    equipmentStatusSection.classList.remove('hidden');
                    // 默认选择在用状态
                    document.querySelector('input[name="batchEquipmentStatus"][value="在用"]').checked = true;
                    toggleBatchEquipmentStatusFields();
                } else {
                    equipmentStatusSection.classList.add('hidden');
                }
            }
        }
        
        // 切换批量设备状态字段显示
        function toggleBatchEquipmentStatusFields() {
            const selectedStatus = document.querySelector('input[name="batchEquipmentStatus"]:checked')?.value || '在用';
            const statusChangeDateSection = document.getElementById('batchStatusChangeDateSection');
            const disposalReasonSection = document.getElementById('batchDisposalReasonSection');
            
            if (selectedStatus === '停用') {
                // 显示状态变更时间和停用原因字段
                if (statusChangeDateSection) {
                    statusChangeDateSection.classList.remove('hidden');
                    // 设置默认值为今天
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('batchActiveStatusChangeDate').value = today;
                }
                if (disposalReasonSection) {
                    disposalReasonSection.classList.remove('hidden');
                }
            } else {
                // 隐藏状态变更时间和停用原因字段
                if (statusChangeDateSection) {
                    statusChangeDateSection.classList.add('hidden');
                }
                if (disposalReasonSection) {
                    disposalReasonSection.classList.add('hidden');
                }
            }
        }

        // 执行增强版单个设备检定更新
        async function performEnhancedSingleCalibrationUpdate() {
            const calibrationDate = document.getElementById('singleCalibrationDate').value;
            const calibrationResult = document.getElementById('singleCalibrationResult').value;
            
            if (!calibrationDate) {
                showNotification('请选择检定日期', 'warning');
                return;
            }
            
            // 根据设备检定方式验证必填字段
            const equipment = window.singleCalibrationEquipmentData;
            const calibrationMethod = equipment.calibration_method || '内检';
            
            if (calibrationMethod === '外检') {
                const certificateNumber = document.getElementById('singleCertificateNumber').value.trim();
                const verificationAgency = document.getElementById('singleVerificationAgency').value.trim();
                const certificateForm = document.getElementById('singleCertificateForm').value.trim();
                
                let hasErrors = false;
                
                if (!certificateNumber) {
                    showFieldError(document.getElementById('singleCertificateNumber'), '证书编号为必填项');
                    hasErrors = true;
                }
                if (!verificationAgency) {
                    showFieldError(document.getElementById('singleVerificationAgency'), '检定机构为必填项');
                    hasErrors = true;
                }
                if (!certificateForm) {
                    showFieldError(document.getElementById('singleCertificateForm'), '证书形式为必填项');
                    hasErrors = true;
                }
                
                if (hasErrors) {
                    showNotification('请填写所有必填字段', 'warning');
                    return;
                }
            } else {
                // 内检设备的证书信息相互依赖验证
                const certificateNumber = document.getElementById('singleCertificateNumber').value.trim();
                const certificateForm = document.getElementById('singleCertificateForm').value.trim();
                
                // 证书编号和证书形式要么都不填，要么都填
                const hasNumber = certificateNumber !== '';
                const hasForm = certificateForm !== '';
                
                if (hasNumber && !hasForm) {
                    showFieldError(document.getElementById('singleCertificateForm'), '填写证书编号时证书形式为必填项');
                    showNotification('证书编号和证书形式必须同时填写或同时留空', 'warning');
                    return;
                }
                
                if (hasForm && !hasNumber) {
                    showFieldError(document.getElementById('singleCertificateNumber'), '选择证书形式时证书编号为必填项');
                    showNotification('证书编号和证书形式必须同时填写或同时留空', 'warning');
                    return;
                }
            }
            
            // 检定结果验证
            if (calibrationResult === '不合格') {
                // 检定不合格时验证报废信息
                const statusChangeDate = document.getElementById('singleStatusChangeDate').value;
                if (!statusChangeDate) {
                    showNotification('检定不合格时状态变更时间为必填项', 'warning');
                    return;
                }
            } else if (calibrationResult === '合格') {
                // 检定合格时验证设备状态选择
                const selectedStatus = document.querySelector('input[name="equipmentStatus"]:checked')?.value || '在用';
                if (selectedStatus === '停用') {
                    const statusChangeDate = document.getElementById('singleActiveStatusChangeDate').value;
                    if (!statusChangeDate) {
                        showNotification('设备停用时状态变更时间为必填项', 'warning');
                        return;
                    }
                }
            }
            
            try {
                showNotification('正在更新检定信息...', 'info');
                document.getElementById('singleCalibrationBtn').disabled = true;
                
                // 构建请求数据
                const requestData = {
                    calibration_date: calibrationDate,
                    calibration_result: calibrationResult,
                    notes: document.getElementById('singleCalibrationNotes').value.trim() || null
                };
                
                // 添加证书字段（内检和外检都可能有证书信息）
                const certificateNumber = document.getElementById('singleCertificateNumber')?.value.trim() || '';
                const certificateForm = document.getElementById('singleCertificateForm')?.value.trim() || '';
                
                if (certificateNumber) {
                    requestData.certificate_number = certificateNumber;
                }
                if (certificateForm) {
                    requestData.certificate_form = certificateForm;
                }
                
                // 添加外检特有字段
                if (calibrationMethod === '外检') {
                    requestData.verification_agency = document.getElementById('singleVerificationAgency').value.trim();
                    
                    // 添加外检备注
                    const externalNotes = document.getElementById('singleExternalCalibrationNotes').value.trim();
                    if (externalNotes) {
                        requestData.notes = externalNotes;
                    }
                } else if (calibrationMethod === '内检') {
                    // 添加内检备注
                    const internalNotes = document.getElementById('singleCalibrationNotes').value.trim();
                    if (internalNotes) {
                        requestData.notes = internalNotes;
                    }
                }
                
                // 添加状态相关字段
                if (calibrationResult === '不合格') {
                    // 检定不合格：报废状态
                    const statusChangeDate = document.getElementById('singleStatusChangeDate').value;
                    const disposalReason = document.getElementById('singleDisposalReason').value.trim();
                    
                    // 确保必填字段有值
                    requestData.status_change_date = statusChangeDate || new Date().toISOString().split('T')[0];
                    requestData.disposal_reason = disposalReason || '检定不合格报废';
                } else if (calibrationResult === '合格') {
                    // 检定合格：根据用户选择设置设备状态
                    const selectedStatus = document.querySelector('input[name="equipmentStatus"]:checked')?.value || '在用';
                    requestData.equipment_status = selectedStatus;
                    
                    if (selectedStatus === '停用') {
                        requestData.status_change_date = document.getElementById('singleActiveStatusChangeDate').value;
                        requestData.disposal_reason = document.getElementById('singleActiveDisposalReason').value.trim() || null;
                    }
                }
                
                // 获取文件
                const certificateFiles = document.getElementById('singleCertificateFiles').files;
                const disposalFiles = document.getElementById('singleDisposalFiles').files;
                
                // 检查是否有文件上传，如果有则使用带文件上传的API
                const hasFiles = certificateFiles.length > 0 || (calibrationResult === '不合格' && disposalFiles.length > 0);
                
                let response;
                const currentToken = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                
                if (hasFiles) {
                    // 使用FormData进行文件上传
                    const formData = new FormData();
                    
                    // 添加基础字段
                    formData.append('calibration_date', calibrationDate);
                    formData.append('calibration_result', calibrationResult);
                    
                    // 添加可选字段
                    if (requestData.notes) formData.append('notes', requestData.notes);
                    if (requestData.certificate_number) formData.append('certificate_number', requestData.certificate_number);
                    if (requestData.certificate_form) formData.append('certificate_form', requestData.certificate_form);
                    if (requestData.verification_agency) formData.append('verification_agency', requestData.verification_agency);
                    if (requestData.equipment_status) formData.append('equipment_status', requestData.equipment_status);
                    if (requestData.status_change_date) formData.append('status_change_date', requestData.status_change_date);
                    if (requestData.disposal_reason) formData.append('disposal_reason', requestData.disposal_reason);
                    
                    // 添加证书文件
                    for (let i = 0; i < certificateFiles.length; i++) {
                        formData.append('certificate_files', certificateFiles[i]);
                    }
                    
                    // 添加报废文件
                    if (calibrationResult === '不合格') {
                        for (let i = 0; i < disposalFiles.length; i++) {
                            formData.append('disposal_files', disposalFiles[i]);
                        }
                    }
                    
                    response = await fetch(`/api/calibration/equipment/${window.singleCalibrationEquipmentId}/update-with-files`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        },
                        body: formData
                    });
                } else {
                    // 无文件上传，使用原始API
                    response = await fetch(`/api/calibration/equipment/${window.singleCalibrationEquipmentId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`
                        },
                        body: JSON.stringify(requestData)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '更新检定信息失败');
                }
                
                const result = await response.json();
                
                showNotification('检定信息更新成功', 'success');
                closeSingleCalibrationModal();
                loadEquipmentData(); // 重新加载数据
                await loadDashboardStats(); // 刷新统计数据
                
            } catch (error) {
                console.error('检定信息更新失败:', error);
                showNotification('检定信息更新失败: ' + error.message, 'error');
                document.getElementById('singleCalibrationBtn').disabled = false;
            }
        }

        // 执行单个设备检定日期更新（保持兼容性）
        async function performSingleCalibrationUpdate() {
            await performEnhancedSingleCalibrationUpdate();
        }

        // 设置实时验证
        function setupRealTimeValidation() {
            const form = document.getElementById('singleCalibrationModal');
            if (!form) return;

            // 为所有必填字段添加验证
            const requiredFields = [
                'singleCertificateNumber',
                'singleCertificateForm', 
                'singleVerificationAgency'
            ];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // 移除旧的事件监听器（如果存在）
                    field.removeEventListener('blur', validateField);
                    field.removeEventListener('input', clearFieldError);
                    
                    // 添加新的事件监听器
                    field.addEventListener('blur', validateField);
                    field.addEventListener('input', clearFieldError);
                }
            });
        }

        // 单个字段验证
        function validateField(event) {
            const field = event.target;
            const equipment = window.singleCalibrationEquipmentData;
            
            if (!equipment) return;
            
            const calibrationMethod = equipment.calibration_method || '内检';
            
            // 只对外检设备验证必填字段
            if (calibrationMethod === '外检' && field.required && !field.value.trim()) {
                showFieldError(field, getFieldLabel(field.id) + '为必填项');
            }
        }

        // 清除字段错误
        function clearFieldError(event) {
            const field = event.target;
            hideFieldError(field);
        }

        // 显示字段错误
        function showFieldError(field, message) {
            // 移除已存在的错误提示
            hideFieldError(field);
            
            // 创建错误提示元素
            const errorElement = document.createElement('div');
            errorElement.className = 'field-error text-red-600 text-sm mt-1';
            errorElement.textContent = message;
            errorElement.setAttribute('data-field-error', field.id);
            
            // 添加错误样式
            field.classList.add('border-red-500', 'focus:ring-red-500');
            field.classList.remove('border-gray-300', 'focus:ring-blue-500');
            
            // 插入错误提示
            field.parentElement.appendChild(errorElement);
        }

        // 隐藏字段错误
        function hideFieldError(field) {
            // 移除错误样式
            field.classList.remove('border-red-500', 'focus:ring-red-500');
            field.classList.add('border-gray-300', 'focus:ring-blue-500');
            
            // 移除错误提示
            const errorElement = field.parentElement.querySelector(`[data-field-error="${field.id}"]`);
            if (errorElement) {
                errorElement.remove();
            }
        }

        // 获取字段标签名称
        function getFieldLabel(fieldId) {
            const labelMap = {
                'singleCertificateNumber': '证书编号',
                'singleCertificateForm': '证书形式',
                'singleVerificationAgency': '检定机构',
                'singleStatusChangeDate': '状态变更时间'
            };
            return labelMap[fieldId] || '该字段';
        }

        // 执行批量检定日期更新
        // 增强的批量检定更新函数
        async function performEnhancedBatchCalibrationUpdate() {
            // 验证必填字段
            const calibrationDate = document.getElementById('batchCalibrationDate').value;
            if (!calibrationDate) {
                showNotification('请选择检定日期', 'warning');
                return;
            }
            
            // 检定结果验证
            const calibrationResult = document.getElementById('batchCalibrationResult').value;
            if (calibrationResult === '不合格') {
                // 检定不合格时验证报废信息
                const statusChangeDate = document.getElementById('batchStatusChangeDate').value;
                if (!statusChangeDate) {
                    showNotification('检定不合格时，状态变更时间为必填项', 'warning');
                    return;
                }
            } else if (calibrationResult === '合格') {
                // 检定合格时验证设备状态选择
                const selectedStatus = document.querySelector('input[name="batchEquipmentStatus"]:checked')?.value || '在用';
                if (selectedStatus === '停用') {
                    const statusChangeDate = document.getElementById('batchActiveStatusChangeDate').value;
                    if (!statusChangeDate) {
                        showNotification('设备停用时状态变更时间为必填项', 'warning');
                        return;
                    }
                }
            }
            
            try {
                showNotification('正在批量更新检定信息...', 'info');
                document.getElementById('batchCalibrationBtn').disabled = true;
                
                // 构建所有设备的检定更新数据
                const calibrationUpdates = window.batchCalibrationEquipmentIds.map((equipmentId, index) => {
                    const updateData = {
                        calibration_date: calibrationDate,
                        calibration_result: '合格' // 默认值
                    };
                    
                    // 根据选中的字段添加相应的数据
                    if (document.getElementById('updateCalibrationResult').checked) {
                        updateData.calibration_result = document.getElementById('batchCalibrationResult').value;
                    }
                    
                    if (document.getElementById('updateCertificateNumber').checked) {
                        const certificateNumberMode = document.querySelector('input[name="certificateNumberMode"]:checked').value;
                        
                        if (certificateNumberMode === 'individual') {
                            // 个体模式：从对应的输入框获取证书编号
                            const individualInput = document.querySelector(`input[data-equipment-id="${equipmentId}"]`);
                            if (individualInput && individualInput.value.trim()) {
                                updateData.certificate_number = individualInput.value.trim();
                            }
                        } else {
                            // 统一模式：所有设备使用相同的证书编号
                            const certificateNumber = document.getElementById('batchCertificateNumber').value.trim();
                            if (certificateNumber) {
                                updateData.certificate_number = certificateNumber;
                            }
                        }
                    }
                    
                    if (document.getElementById('updateCertificateForm').checked) {
                        const certificateForm = document.getElementById('batchCertificateForm').value;
                        if (certificateForm) {
                            updateData.certificate_form = certificateForm;
                        }
                    }
                    
                    if (document.getElementById('updateVerificationAgency').checked) {
                        const agency = document.getElementById('batchVerificationAgency').value.trim();
                        if (agency) {
                            updateData.verification_agency = agency;
                        }
                    }
                    
                    if (document.getElementById('updateNotes').checked) {
                        const notesMode = document.querySelector('input[name="notesMode"]:checked').value;
                        if (notesMode === 'unified') {
                            const notes = document.getElementById('batchNotes').value.trim();
                            if (notes) {
                                updateData.notes = notes;
                            }
                        } else {
                            // 个别输入模式：获取当前设备的特定备注
                            const individualNotesInput = document.querySelector(`.individual-notes-input[data-equipment-id="${equipment.id}"]`);
                            if (individualNotesInput) {
                                const individualNotes = individualNotesInput.value.trim();
                                if (individualNotes) {
                                    updateData.notes = individualNotes;
                                }
                            }
                        }
                    }
                    
                    // 添加状态相关字段
                    if (updateData.calibration_result === '不合格') {
                        // 检定不合格：报废状态
                        const statusChangeDate = document.getElementById('batchStatusChangeDate').value;
                        const disposalReason = document.getElementById('batchDisposalReason').value.trim();
                        
                        // 确保必填字段有值
                        updateData.status_change_date = statusChangeDate || new Date().toISOString().split('T')[0];
                        updateData.disposal_reason = disposalReason || updateData.notes || '检定不合格报废';
                    } else if (updateData.calibration_result === '合格') {
                        // 检定合格：根据用户选择设置设备状态
                        const selectedStatus = document.querySelector('input[name="batchEquipmentStatus"]:checked')?.value || '在用';
                        updateData.equipment_status = selectedStatus;
                        
                        if (selectedStatus === '停用') {
                            updateData.status_change_date = document.getElementById('batchActiveStatusChangeDate').value;
                            updateData.disposal_reason = document.getElementById('batchActiveDisposalReason').value.trim() || updateData.notes || '设备停用';
                        }
                    }
                    
                    return updateData;
                });
                
                // 构建批量更新请求
                const batchUpdateData = {
                    equipment_ids: window.batchCalibrationEquipmentIds,
                    calibration_updates: calibrationUpdates
                };
                
                // 调用新的批量更新API
                const response = await fetch('/api/calibration/equipment/batch-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(batchUpdateData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '批量更新失败');
                }
                
                const response_data = await response.json();
                
                // 从API响应中提取results数组
                const results = response_data.results || [];
                const successCount = response_data.success_count || 0;
                const errorCount = response_data.failed_count || 0;
                
                if (errorCount > 0) {
                    const errorMessages = results
                        .filter(r => !r.success)
                        .map(r => `设备ID ${r.equipment_id}: ${r.message}`)
                        .join('<br>');
                    
                    showNotification(`
                        <div>
                            <div class="font-medium mb-2">批量更新完成</div>
                            <div>成功: ${successCount} 台，失败: ${errorCount} 台</div>
                            <div class="mt-2 text-sm">失败详情:<br>${errorMessages}</div>
                        </div>
                    `, 'warning', 10000);
                } else {
                    showNotification(`成功批量更新 ${successCount} 台设备的检定信息`, 'success');
                }
                
                closeBatchCalibrationModal();
                loadEquipmentData(); // 重新加载数据
                await loadDashboardStats(); // 刷新统计数据
                
            } catch (error) {
                console.error('批量检定更新失败:', error);
                showNotification('批量检定更新失败: ' + error.message, 'error');
                document.getElementById('batchCalibrationBtn').disabled = false;
            }
        }

        // 获取认证令牌
        function getAuthToken() {
            // 从sessionStorage或localStorage获取令牌
            return sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
        }

        // 管理附件
        function manageAttachments(equipmentId, equipmentName) {
            currentEquipmentId = equipmentId;
            document.getElementById('attachment-equipment-name').textContent = equipmentName;
            document.getElementById('attachmentModal').classList.add('show');
            loadAttachmentsForModal(equipmentId);
        }

        // 关闭附件管理模态框
        function closeAttachmentModal() {
            document.getElementById('attachmentModal').classList.remove('show');
            currentEquipmentId = null;
        }

        // 加载附件列表
        async function loadAttachments(equipmentId) {
            try {
                const attachments = await AttachmentAPI.getEquipmentAttachments(equipmentId);
                renderAttachmentList(attachments);
            } catch (error) {
                console.error('加载附件失败:', error);
                renderAttachmentList([]);
            }
        }

        // 加载附件列表（模态框专用）
        async function loadAttachmentsForModal(equipmentId) {
            try {
                const attachments = await AttachmentAPI.getEquipmentAttachments(equipmentId);
                renderModalAttachmentList(attachments);
            } catch (error) {
                console.error('加载附件失败:', error);
                renderModalAttachmentList([]);
            }
        }

        // 渲染附件列表
        function renderAttachmentList(attachments) {
            const attachmentList = document.getElementById('attachment-list');
            
            if (!attachments || attachments.length === 0) {
                attachmentList.innerHTML = `
                    <div class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-paperclip text-4xl mb-4"></i>
                        <p>暂无附件</p>
                    </div>
                `;
                return;
            }
            
            attachmentList.innerHTML = attachments.map((attachment, index) => `
                <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center">
                    <div class="col-span-1 text-sm text-gray-500">${index + 1}</div>
                    <div class="col-span-4">
                        <div class="flex items-center">
                            <i class="fas ${getFileIcon(attachment.file_type)} text-blue-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-900">${attachment.original_filename}</span>
                        </div>
                    </div>
                    <div class="col-span-2 text-sm text-gray-500">${formatFileSize(attachment.file_size)}</div>
                    <div class="col-span-2 text-sm text-gray-500">${formatDate(attachment.created_at, null)}</div>
                    <div class="col-span-2">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getFileTypeStyle(attachment.file_type)}">
                            ${attachment.file_type ? attachment.file_type.toUpperCase() : 'UNKNOWN'}
                        </span>
                    </div>
                    <div class="col-span-1 flex justify-center space-x-2">
                        ${isPreviewable(attachment.file_type) ? `
                        <button class="text-green-600 hover:text-green-900" title="预览" onclick="previewAttachment(${attachment.id}, '${attachment.original_filename}', '${attachment.file_type}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ` : ''}
                        <button class="text-blue-600 hover:text-blue-900" title="下载" onclick="downloadAttachment(${attachment.id}, '${attachment.original_filename}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-900" title="删除" onclick="deleteAttachment(${attachment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染附件列表（模态框专用）
        function renderModalAttachmentList(attachments) {
            const attachmentList = document.getElementById('attachment-list');
            
            if (!attachments || attachments.length === 0) {
                attachmentList.innerHTML = `
                    <div class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-paperclip text-4xl mb-4"></i>
                        <p>暂无附件</p>
                    </div>
                `;
                return;
            }
            
            attachmentList.innerHTML = attachments.map((attachment, index) => `
                <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center">
                    <div class="col-span-1 text-sm text-gray-500">${index + 1}</div>
                    <div class="col-span-4">
                        <div class="flex items-center">
                            <i class="fas ${getFileIcon(attachment.file_type)} text-blue-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-900">${attachment.original_filename}</span>
                        </div>
                    </div>
                    <div class="col-span-2 text-sm text-gray-500">${formatFileSize(attachment.file_size)}</div>
                    <div class="col-span-2 text-sm text-gray-500">${formatDate(attachment.created_at, null)}</div>
                    <div class="col-span-2">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getFileTypeStyle(attachment.file_type)}">
                            ${attachment.file_type ? attachment.file_type.toUpperCase() : 'UNKNOWN'}
                        </span>
                    </div>
                    <div class="col-span-1 flex justify-center space-x-2">
                        ${isPreviewable(attachment.file_type) ? `
                        <button class="text-green-600 hover:text-green-900" title="预览" onclick="previewAttachment(${attachment.id}, '${attachment.original_filename}', '${attachment.file_type}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ` : ''}
                        <button class="text-blue-600 hover:text-blue-900" title="下载" onclick="downloadAttachment(${attachment.id}, '${attachment.original_filename}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-900" title="删除" onclick="deleteAttachment(${attachment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 获取文件图标
        function getFileIcon(fileType) {
            const iconMap = {
                'pdf': 'fa-file-pdf',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel'
            };
            return iconMap[fileType.toLowerCase()] || 'fa-file';
        }

        // 获取文件类型样式
        function getFileTypeStyle(fileType) {
            const styleMap = {
                'pdf': 'bg-red-100 text-red-800',
                'jpg': 'bg-green-100 text-green-800',
                'jpeg': 'bg-green-100 text-green-800',
                'png': 'bg-green-100 text-green-800',
                'doc': 'bg-blue-100 text-blue-800',
                'docx': 'bg-blue-100 text-blue-800',
                'xls': 'bg-yellow-100 text-yellow-800',
                'xlsx': 'bg-yellow-100 text-yellow-800'
            };
            return styleMap[fileType.toLowerCase()] || 'bg-gray-100 text-gray-800';
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes) return '-';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        // 检查文件类型是否支持预览
        function isPreviewable(fileType) {
            if (!fileType) return false;
            const previewableTypes = ['PDF', 'JPG', 'JPEG', 'PNG', 'GIF'];
            return previewableTypes.includes(fileType.toUpperCase());
        }
        // 预览附件
        async function previewAttachment(attachmentId, filename, fileType) {
            try {
                const previewUrl = await AttachmentAPI.previewAttachment(attachmentId);
                
                // 创建预览模态框
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 flex flex-col">
                        <div class="flex items-center justify-between p-4 border-b">
                            <h3 class="text-lg font-semibold">预览: ${filename}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 p-4 overflow-auto">
                            ${fileType.toUpperCase() === 'PDF' ? 
                                `<iframe src="${previewUrl}" class="w-full h-full min-h-[600px] border-none"></iframe>` :
                                `<img src="${previewUrl}" class="max-w-full max-h-full mx-auto" alt="${filename}" />`
                            }
                        </div>
                        <div class="p-4 border-t bg-gray-50">
                            <div class="flex justify-end space-x-2">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    关闭
                                </button>
                                <button onclick="downloadAttachment(${attachmentId}, '${filename}'); this.closest('.fixed').remove();" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    下载
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 点击背景关闭
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('预览失败:', error);
                showNotification('预览失败: ' + error.message, 'error');
            }
        }

        // 上传附件
        function uploadAttachment() {
            document.getElementById('attachmentFileInput').click();
        }

        // 处理文件上传
        document.getElementById('attachmentFileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            try {
                showNotification('正在上传附件...', 'info');
                
                const uploadPromises = Array.from(files).map(file => {
                    return AttachmentAPI.uploadAttachment(currentEquipmentId, file);
                });
                
                await Promise.all(uploadPromises);
                
                showNotification('附件上传成功', 'success');
                loadAttachmentsForModal(currentEquipmentId); // 重新加载模态框附件列表
                
                // 更新附件数量显示
                const attachments = await AttachmentAPI.getEquipmentAttachments(currentEquipmentId);
                updateEquipmentAttachmentCount(currentEquipmentId, attachments.length);
                
            } catch (error) {
                console.error('附件上传失败:', error);
                showNotification('附件上传失败: ' + error.message, 'error');
            }
            
            // 清空文件输入框
            e.target.value = '';
        });

        // 下载附件
        function downloadAttachment(attachmentId, filename) {
            AttachmentAPI.downloadAttachment(attachmentId, filename)
                .then(() => {
                    showNotification('附件下载成功', 'success');
                })
                .catch(error => {
                    console.error('附件下载失败:', error);
                    showNotification('附件下载失败: ' + error.message, 'error');
                });
        }

        // 删除附件
        function deleteAttachment(attachmentId) {
            currentDeleteAttachmentId = attachmentId;
            document.getElementById('deleteAttachmentModal').classList.add('show');
        }

        // 确认删除附件
        async function confirmDeleteAttachment() {
            if (!currentDeleteAttachmentId) return;
            
            try {
                await AttachmentAPI.deleteAttachment(currentDeleteAttachmentId);
                showNotification('附件删除成功', 'success');
                closeDeleteAttachmentModal();
                loadAttachmentsForModal(currentEquipmentId); // 重新加载模态框附件列表
                
                // 更新附件数量显示
                const attachments = await AttachmentAPI.getEquipmentAttachments(currentEquipmentId);
                updateEquipmentAttachmentCount(currentEquipmentId, attachments.length);
            } catch (error) {
                console.error('附件删除失败:', error);
                showNotification('附件删除失败: ' + error.message, 'error');
            }
        }

        // 关闭附件删除确认模态框
        function closeDeleteAttachmentModal() {
            document.getElementById('deleteAttachmentModal').classList.remove('show');
            currentDeleteAttachmentId = null;
        }

        // 点击模态框外部关闭
        document.getElementById('attachmentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAttachmentModal();
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAttachmentModal();
                closeExportModal();
                closeImportModal();
                closeImportResultModal();
                closeBatchStatusModal();
                closeBatchCalibrationModal();
                closeSingleCalibrationModal();
            }
        });

        // 单个设备检定日期更新模态框事件监听
        document.getElementById('singleCalibrationDate').addEventListener('change', function() {
            const singleCalibrationBtn = document.getElementById('singleCalibrationBtn');
            singleCalibrationBtn.disabled = !this.value;
        });

        // 批量检定日期更新模态框事件监听
        document.getElementById('batchCalibrationDate').addEventListener('change', function() {
            const batchCalibrationBtn = document.getElementById('batchCalibrationBtn');
            batchCalibrationBtn.disabled = !this.value;
        });

        // 批量转移模态框事件监听
        document.getElementById('targetDepartment').addEventListener('change', function() {
            const batchTransferBtn = document.getElementById('batchTransferBtn');
            batchTransferBtn.disabled = !this.value;
        });

        // 导出设备数据
        function exportEquipmentData() {
            document.getElementById('exportModal').classList.add('show');
        }

        // 关闭导出模态框
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        // 执行导出操作
        async function performExport() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            
            try {
                showNotification('正在准备导出数据...', 'info');
                closeExportModal();
                
                const filters = buildFilters();
                
                switch (exportType) {
                    case 'all':
                        await ImportExportAPI.exportAll();
                        break;
                    case 'filtered':
                        await ImportExportAPI.exportFiltered(filters);
                        break;
                    case 'selected':
                        const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
                        const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                        
                        if (selectedIds.length === 0) {
                            showNotification('请先选择要导出的设备', 'warning');
                            return;
                        }
                        
                        // 使用批量导出API来导出选中的设备
                        await EquipmentAPI.batchExport({ equipment_ids: selectedIds });
                        break;
                }
                
                showNotification('设备数据导出成功', 'success');
                
            } catch (error) {
                console.error('导出失败:', error);
                showNotification('导出失败: ' + error.message, 'error');
            }
        }

        // 导入设备数据
        function importEquipmentData() {
            document.getElementById('importModal').classList.add('show');
        }

        // 关闭导入模态框
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
            // 重置表单
            document.getElementById('importFileInput').value = '';
            document.getElementById('selectedFileInfo').classList.add('hidden');
            document.getElementById('importBtn').disabled = true;
            document.getElementById('overwriteExisting').checked = false;
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('selectedFileName').textContent = file.name;
                document.getElementById('selectedFileInfo').classList.remove('hidden');
                document.getElementById('importBtn').disabled = false;
            }
        }

        // 下载导入模板
        async function downloadTemplate() {
            try {
                showNotification('正在下载导入模板...', 'info');
                await ImportExportAPI.downloadTemplate();
                showNotification('导入模板下载成功', 'success');
            } catch (error) {
                console.error('模板下载失败:', error);
                showNotification('模板下载失败: ' + error.message, 'error');
            }
        }

        // 执行导入操作
        // 导入功能全局变量 - 必须在函数调用之前声明
        let globalImportResult = null;
        let currentFilter = '全部';
        let isErrorGrouped = false;

        async function performImport() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('请选择要导入的Excel文件', 'warning');
                return;
            }
            
            const overwrite = document.getElementById('overwriteExisting').checked;
            console.log('上传文件参数:', {
                filename: file.name,
                overwrite: overwrite,
                overwriteType: typeof overwrite
            });
            
            try {
                showNotification('正在导入数据，请稍候...', 'info');
                document.getElementById('importBtn').disabled = true;
                
                const result = await ImportExportAPI.uploadImportFile(file, overwrite);
                console.log('导入结果:', result);
                showImportResult(result);
                closeImportModal();
                
                // 重新加载设备数据
                await loadEquipmentData();
                await loadDashboardStats(); // 刷新统计数据
                
            } catch (error) {
                console.error('导入失败:', error);
                showNotification('导入失败: ' + error.message, 'error');
                document.getElementById('importBtn').disabled = false;
            }
        }

        // 显示导入结果

        function showImportResult(result) {
            globalImportResult = result; // 保存结果供过滤使用
            currentFilter = '全部';
            isErrorGrouped = false;
            
            document.getElementById('successCount').textContent = result.success_count;
            document.getElementById('updateCount').textContent = result.update_count;
            document.getElementById('errorCount').textContent = result.error_count;
            document.getElementById('totalCount').textContent = result.summary.total_rows;
            
            // 重置统计卡片状态 - 默认选中"全部"
            document.querySelectorAll('.stats-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.filter === '全部') {
                    card.classList.add('active');
                }
            });
            
            // 初始化控制按钮状态
            document.getElementById('toggleErrorGrouping').style.display = 'none';
            document.getElementById('exportFailedBtn').style.display = 'none';
            
            // 更新过滤显示
            document.getElementById('currentFilterDisplay').textContent = `显示: 全部结果 (${result.detailed_results.length}条)`;
            document.getElementById('toggleErrorGrouping').innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
            
            renderImportResults(result.detailed_results);
            document.getElementById('importResultModal').classList.add('show');
        }

        // 渲染导入结果
        function renderImportResults(results) {
            const resultsList = document.getElementById('importResultsList');
            
            if (isErrorGrouped && currentFilter === '失败') {
                // 显示合并后的错误结果
                resultsList.innerHTML = renderGroupedErrors(results);
            } else {
                // 显示普通结果
                resultsList.innerHTML = results.map(item => `
                    <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center">
                        <div class="col-span-1 text-sm text-gray-500">${item.row}</div>
                        <div class="col-span-3 text-sm font-medium text-gray-900">${item.internal_id}</div>
                        <div class="col-span-3 text-sm text-gray-900">${item.name}</div>
                        <div class="col-span-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getResultStatusStyle(item.status)}">
                                ${item.status}
                            </span>
                        </div>
                        <div class="col-span-3 text-sm text-gray-600" title="${item.message}">${truncateMessage(item.message, 50)}</div>
                    </div>
                `).join('');
            }
        }

        // 过滤导入结果
        function filterImportResults(filterType) {
            if (!globalImportResult) return;
            
            // 更新统计卡片的激活状态
            document.querySelectorAll('.stats-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.filter === filterType) {
                    card.classList.add('active');
                }
            });
            
            currentFilter = filterType;
            let filteredResults = [];
            
            switch(filterType) {
                case '成功':
                    filteredResults = globalImportResult.detailed_results.filter(item => item.status === '成功');
                    break;
                case '更新':
                    filteredResults = globalImportResult.detailed_results.filter(item => item.status === '更新');
                    break;
                case '失败':
                    filteredResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
                    break;
                case '全部':
                default:
                    filteredResults = globalImportResult.detailed_results;
                    break;
            }
            
            // 更新过滤显示
            document.getElementById('currentFilterDisplay').textContent = `显示: ${filterType} (${filteredResults.length}条)`;
            
            // 控制错误合并按钮和导出按钮的显示
            const toggleBtn = document.getElementById('toggleErrorGrouping');
            const exportBtn = document.getElementById('exportFailedBtn');
            
            if (filterType === '失败' && filteredResults.length > 0) {
                toggleBtn.style.display = 'inline-flex';
                exportBtn.style.display = 'inline-flex';
            } else {
                toggleBtn.style.display = 'none';
                exportBtn.style.display = 'none';
                // 如果切换到非失败状态，取消错误合并
                if (isErrorGrouped) {
                    isErrorGrouped = false;
                    toggleBtn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
                    toggleTableHeaders(false);
                }
            }
            
            renderImportResults(filteredResults);
        }

        // 切换错误合并
        function toggleErrorGrouping() {
            if (!globalImportResult || currentFilter !== '失败') {
                alert('只能在查看失败结果时合并错误');
                return;
            }
            
            isErrorGrouped = !isErrorGrouped;
            const toggleBtn = document.getElementById('toggleErrorGrouping');
            
            if (isErrorGrouped) {
                toggleBtn.innerHTML = '<i class="fas fa-list mr-1"></i>显示明细';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
            }
            
            toggleTableHeaders(isErrorGrouped);
            
            const failedResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
            renderImportResults(failedResults);
        }

        // 切换表头
        function toggleTableHeaders(showGrouped) {
            const normalHeader = document.getElementById('resultTableHeader');
            const groupedHeader = document.getElementById('groupedResultTableHeader');
            
            if (showGrouped) {
                normalHeader.classList.add('hidden');
                groupedHeader.classList.remove('hidden');
            } else {
                normalHeader.classList.remove('hidden');
                groupedHeader.classList.add('hidden');
            }
        }

        // 渲染合并错误结果
        function renderGroupedErrors(results) {
            const errorGroups = {};
            
            // 按错误信息分组
            results.forEach(item => {
                const errorKey = item.message;
                if (!errorGroups[errorKey]) {
                    errorGroups[errorKey] = {
                        message: errorKey,
                        count: 0,
                        rows: [],
                        status: item.status,
                        items: []
                    };
                }
                errorGroups[errorKey].count++;
                errorGroups[errorKey].rows.push(item.row);
                errorGroups[errorKey].items.push(item);
            });
            
            // 按出现次数排序
            const sortedGroups = Object.values(errorGroups).sort((a, b) => b.count - a.count);
            
            return sortedGroups.map((group, index) => `
                <div class="border-l-4 border-red-400 ${index % 2 === 0 ? 'bg-red-50' : 'bg-white'} hover:bg-red-100 transition-colors">
                    <div class="grid grid-cols-12 gap-4 px-4 py-4 items-center">
                        <div class="col-span-1 text-center">
                            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-red-100 text-red-800 font-bold text-sm border-2 border-red-300">
                                ${group.count}
                            </div>
                        </div>
                        <div class="col-span-2 text-center">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${getResultStatusStyle(group.status)}">
                                <i class="fas fa-times-circle mr-1"></i>${group.status}
                            </span>
                        </div>
                        <div class="col-span-4">
                            <div class="text-sm text-gray-900 font-medium break-words" title="${group.message}">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                ${truncateMessage(group.message, 80)}
                            </div>
                        </div>
                        <div class="col-span-3">
                            <div class="text-xs text-gray-600 space-y-1">
                                <div class="font-medium text-gray-700">涉及行号：</div>
                                <div class="bg-gray-100 rounded px-2 py-1 text-gray-800" title="涉及行号: ${group.rows.join(', ')}">
                                    ${group.rows.length > 8 ? 
                                        group.rows.slice(0, 8).join(', ') + ` 等${group.rows.length}行` : 
                                        group.rows.join(', ')
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2 text-center">
                            <button class="w-full text-xs bg-blue-100 text-blue-700 px-2 py-2 rounded-md hover:bg-blue-200 transition-colors border border-blue-300" 
                                    onclick="showErrorDetails('${group.message.replace(/'/g, "\\'")}', [${group.rows.join(',')}])">
                                <i class="fas fa-search mr-1"></i>查看明细 (${group.count})
                            </button>
                        </div>
                    </div>
                    <div class="px-4 pb-3">
                        <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                            <i class="fas fa-info-circle mr-1 text-blue-500"></i>
                            点击"查看明细"可查看具体的设备信息和错误位置
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 显示错误详情
        function showErrorDetails(errorMessage, rows) {
            if (!globalImportResult) return;
            
            // 找到对应的详细记录
            const detailsItems = globalImportResult.detailed_results.filter(item => 
                item.message === errorMessage && rows.includes(item.row)
            );
            
            // 临时切换到详细视图
            isErrorGrouped = false;
            toggleTableHeaders(false);
            document.getElementById('toggleErrorGrouping').innerHTML = '<i class="fas fa-layer-group mr-1"></i>合并相同错误';
            document.getElementById('currentFilterDisplay').textContent = `显示: 错误详情 (${detailsItems.length}条)`;
            
            renderImportResults(detailsItems);
            
            // 5秒后自动返回合并视图
            setTimeout(() => {
                if (currentFilter === '失败') {
                    isErrorGrouped = true;
                    toggleTableHeaders(true);
                    document.getElementById('toggleErrorGrouping').innerHTML = '<i class="fas fa-list mr-1"></i>显示明细';
                    document.getElementById('currentFilterDisplay').textContent = `显示: 失败 (${globalImportResult.detailed_results.filter(item => item.status === '失败').length}条)`;
                    
                    const failedResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
                    renderImportResults(failedResults);
                }
            }, 5000);
        }

        // 导出失败条目
        async function exportFailedResults() {
            if (!globalImportResult || currentFilter !== '失败') {
                showNotification('只能导出失败的条目', 'warning');
                return;
            }

            try {
                const failedResults = globalImportResult.detailed_results.filter(item => item.status === '失败');
                if (failedResults.length === 0) {
                    showNotification('没有失败的条目可导出', 'info');
                    return;
                }

                // 准备导出数据
                const exportData = failedResults.map(item => ({
                    '行号': item.row,
                    '内部编号': item.internal_id || '',
                    '设备名称': item.name || '',
                    '错误原因': item.message || ''
                }));

                // 创建CSV内容
                const headers = Object.keys(exportData[0]);
                const csvContent = [
                    headers.join(','),
                    ...exportData.map(row => headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // 创建Blob并下载
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `导入失败条目_${new Date().toISOString().split('T')[0]}.csv`;
                
                // 添加到DOM并点击
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理URL对象
                URL.revokeObjectURL(link.href);
                
                showNotification(`${failedResults.length}个失败条目导出成功`, 'success');
            } catch (error) {
                console.error('导出失败条目失败:', error);
                showNotification('导出失败条目失败: ' + error.message, 'error');
            }
        }

        // 截断消息
        function truncateMessage(message, maxLength) {
            if (message.length <= maxLength) return message;
            return message.substring(0, maxLength) + '...';
        }

        // 获取结果状态样式
        function getResultStatusStyle(status) {
            switch (status) {
                case '成功':
                case '更新':
                    return 'bg-green-100 text-green-800';
                case '失败':
                    return 'bg-red-100 text-red-800';
                case '跳过':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // 关闭导入结果模态框
        function closeImportResultModal() {
            document.getElementById('importResultModal').classList.remove('show');
        }

        // 安全添加事件监听器的函数
        function safeAddEventListener(elementId, eventType, handler) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(eventType, handler);
            }
        }

        // 点击模态框外部关闭
        safeAddEventListener('exportModal', 'click', function(e) {
            if (e.target === this) {
                closeExportModal();
            }
        });

        safeAddEventListener('importModal', 'click', function(e) {
            if (e.target === this) {
                closeImportModal();
            }
        });

        safeAddEventListener('importResultModal', 'click', function(e) {
            if (e.target === this) {
                closeImportResultModal();
            }
        });

        // 单个设备检定日期更新模态框点击外部关闭
        safeAddEventListener('singleCalibrationModal', 'click', function(e) {
            if (e.target === this) {
                closeSingleCalibrationModal();
            }
        });

        // 批量检定日期更新模态框点击外部关闭
        safeAddEventListener('batchCalibrationModal', 'click', function(e) {
            if (e.target === this) {
                closeBatchCalibrationModal();
            }
        });

        // 批量转移模态框点击外部关闭
        safeAddEventListener('batchTransferModal', 'click', function(e) {
            if (e.target === this) {
                closeBatchTransferModal();
            }
        });

        // 预定义器具名称管理模态框点击外部关闭
        safeAddEventListener('predefinedNamesModal', 'click', function(e) {
            if (e.target === this) {
                closePredefinedNamesModal();
            }
        });

        // 设备删除确认模态框点击外部关闭
        safeAddEventListener('deleteEquipmentModal', 'click', function(e) {
            if (e.target === this) {
                closeDeleteEquipmentModal();
            }
        });

        // 附件删除确认模态框点击外部关闭
        safeAddEventListener('deleteAttachmentModal', 'click', function(e) {
            if (e.target === this) {
                closeDeleteAttachmentModal();
            }
        });

        // 预定义名称删除确认模态框点击外部关闭
        safeAddEventListener('deletePredefinedNameModal', 'click', function(e) {
            if (e.target === this) {
                closeDeletePredefinedNameModal();
            }
        });

        // 批量删除确认模态框点击外部关闭
        safeAddEventListener('batchDeleteModal', 'click', function(e) {
            if (e.target === this) {
                closeBatchDeleteModal();
            }
        });
        
        safeAddEventListener('undoDeleteModal', 'click', function(e) {
            if (e.target === this) {
                closeUndoDeleteModal();
            }
        });
    </script>

    <!-- 设备删除确认模态框 -->
    <div id="deleteEquipmentModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认删除设备</h3>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">您确定要删除设备 "<span id="deleteEquipmentName" class="font-medium text-gray-900"></span>" 吗？</p>
                            <p class="text-sm text-red-600 mt-1">删除后无法恢复，请谨慎操作。</p>
                            <p id="deleteEquipmentWarning" class="text-sm text-orange-600 mt-1 hidden"></p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeDeleteEquipmentModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmDeleteEquipment()">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量删除确认模态框 -->
    <div id="batchDeleteModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认批量删除</h3>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">您确定要删除选中的 <span id="batchDeleteCount" class="font-medium text-gray-900">0</span> 台设备吗？</p>
                            <p class="text-sm text-red-600 mt-1">批量删除后无法恢复，请谨慎操作。</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeBatchDeleteModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmBatchDelete()">
                        <i class="fas fa-trash mr-2"></i>批量删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 附件删除确认模态框 -->
    <div id="deleteAttachmentModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认删除附件</h3>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">您确定要删除这个附件吗？</p>
                            <p class="text-sm text-red-600 mt-1">删除后无法恢复，请谨慎操作。</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeDeleteAttachmentModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmDeleteAttachment()">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 预定义名称删除确认模态框 -->
    <div id="deletePredefinedNameModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认删除预定义名称</h3>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">您确定要删除预定义器具名称 "<span id="deletePredefinedName" class="font-medium text-gray-900"></span>" 吗？</p>
                            <p class="text-sm text-red-600 mt-1">删除后无法恢复，请谨慎操作。</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeDeletePredefinedNameModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmDeletePredefinedName()">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设备删除撤回模态框 -->
    <div id="undoDeleteModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">设备删除确认</h3>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-clock text-orange-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">设备 "<span id="undoDeleteEquipmentName" class="font-medium text-gray-900"></span>" 已标记为删除</p>
                            <p class="text-sm text-orange-600 mt-1">将在 <span id="undoCountdown" class="font-medium text-orange-700">10</span> 秒后永久删除</p>
                            <p class="text-sm text-blue-600 mt-1">您可以在此期间撤销删除操作</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="undoProgress" class="bg-orange-600 h-2 rounded-full transition-all duration-1000" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="undoDeleteEquipment()">
                        <i class="fas fa-undo mr-2"></i>撤销删除
                    </button>
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeUndoDeleteModal()">
                        立即删除
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>