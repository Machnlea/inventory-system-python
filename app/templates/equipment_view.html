<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备详情 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/notification-manager.js"></script>
    <script src="/static/js/tab-session-manager.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .info-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 500;
            color: #374151;
            min-width: 140px;
        }
        .info-value {
            color: #1f2937;
            font-weight: 400;
            text-align: right;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }
        .status-normal { background-color: #d1fae5; color: #065f46; }
        .status-warning { background-color: #fed7aa; color: #9a3412; }
        .status-danger { background-color: #fecaca; color: #991b1b; }
        .status-inactive { background-color: #f3f4f6; color: #374151; }
        .equipment-photo {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .equipment-photo:hover {
            border-color: #6366f1;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }
        .equipment-photo:active {
            transform: scale(0.98);
        }
          .attachment-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        .attachment-item:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        .timeline-item {
            position: relative;
            padding-left: 32px;
            padding-bottom: 24px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid #e5e7eb;
            background: white;
        }
        .timeline-dot.success { border-color: #10b981; }
        .timeline-dot.warning { border-color: #f59e0b; }
        .timeline-dot.danger { border-color: #ef4444; }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }
        .modal.show {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 1 !important;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部通知容器 -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] space-y-2 w-72"></div>
    
    <div class="min-h-screen py-8">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- 页面头部 -->
            <div class="mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <button onclick="goBackToEquipmentList()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold text-gray-900">设备详情</h1>
                        <p class="text-gray-600 mt-1">查看设备的完整信息和历史记录</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="editEquipmentBtn" onclick="editEquipment()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <i class="fas fa-edit mr-2"></i>编辑设备
                        </button>
                        <button onclick="printDetails()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i class="fas fa-print mr-2"></i>打印
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- 主要信息 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 基本信息 -->
                    <div class="info-card">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                            基本信息
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="info-row">
                                <span class="info-label">计量器具名称</span>
                                <span id="equipmentName" class="info-value font-semibold text-lg">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">计量编号</span>
                                <span id="equipmentSerial" class="info-value font-mono bg-gray-100 px-3 py-1 rounded">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">出厂编号</span>
                                <span id="equipmentFactorySerial" class="info-value font-mono bg-blue-50 px-3 py-1 rounded">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">型号/规格</span>
                                <span id="equipmentModel" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">使用部门</span>
                                <span id="equipmentDepartment" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">设备类别</span>
                                <span id="equipmentCategory" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">准确度等级</span>
                                <span id="equipmentAccuracy" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">测量范围</span>
                                <span id="equipmentRange" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">安装地点</span>
                                <span id="installationLocation" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">分度值</span>
                                <span id="equipmentDivision" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">设备状态</span>
                                <span id="equipmentStatus" class="status-badge status-normal">加载中...</span>
                            </div>
                            <div class="info-row" id="statusChangeDateRow" style="display: none;">
                                <span class="info-label">状态变更日期</span>
                                <span id="statusChangeDate" class="info-value">加载中...</span>
                            </div>
                        </div>
                    </div>

                    <!-- 生产信息 -->
                    <div class="info-card">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-industry text-purple-600 mr-3"></i>
                            生产信息
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="info-row">
                                <span class="info-label">制造厂家</span>
                                <span id="manufacturer" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">出厂日期</span>
                                <span id="manufactureDate" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">原值</span>
                                <span id="originalValue" class="info-value font-semibold text-green-600">加载中...</span>
                            </div>
                        </div>
                    </div>

                    <!-- 检定信息 -->
                    <div class="info-card">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-certificate text-orange-600 mr-3"></i>
                            检定信息
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="info-row">
                                <span class="info-label">检定周期</span>
                                <span id="calibrationCycle" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">检定(校准)日期</span>
                                <span id="calibrationDate" class="info-value">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">有效期至</span>
                                <span id="validUntil" class="info-value font-semibold text-orange-600">加载中...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">检定方式</span>
                                <span id="calibrationMethod" class="info-value">加载中...</span>
                            </div>
                            
                            <!-- 内检设备证书字段 - 默认隐藏 -->
                            <div id="internalInspectionFields" class="space-y-4" style="display: none;">
                                <div class="info-row">
                                    <span class="info-label">证书编号</span>
                                    <span id="certificateNumber" class="info-value">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">证书形式</span>
                                    <span id="certificateForm" class="info-value">-</span>
                                </div>
                            </div>

                            <!-- 外检设备字段 - 默认隐藏 -->
                            <div id="externalInspectionFields" class="space-y-4" style="display: none;">
                                <div class="info-row">
                                    <span class="info-label">检定机构</span>
                                    <span id="verificationAgency" class="info-value">-</span>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">管理级别</span>
                                <span id="managementLevel" class="info-value">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">加载中...</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 检定历史 -->
                    <div class="info-card">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-history text-green-600 mr-3"></i>
                            检定历史
                            <button onclick="loadCalibrationHistory()" class="ml-auto px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                        </h2>
                        
                        <div id="calibrationHistoryContainer" class="space-y-4">
                            <div class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                                <p class="text-gray-500">正在加载检定历史...</p>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button onclick="openCalibrationHistoryModal()" 
                                    class="w-full text-center py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                <i class="fas fa-external-link-alt mr-2"></i>查看完整检定记录
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 侧边信息 -->
                <div class="space-y-6">
                    <!-- 设备照片 -->
                    <div class="info-card">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-image text-indigo-600 mr-2"></i>
                            设备照片
                        </h2>
                        
                        <div class="text-center">
                            <img id="equipmentPhoto" 
                                 src="/static/images/placeholder-equipment.svg" 
                                 alt="设备照片" 
                                 class="equipment-photo mx-auto mb-4 cursor-pointer hover:opacity-80 transition-opacity"
                                 onclick="previewPhoto()">
                            <input type="file" id="photoUploadInput" class="hidden" accept="image/*" onchange="handlePhotoUpload(event)">
                            <button onclick="triggerPhotoUpload()" class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-camera mr-1"></i>更新照片
                            </button>
                        </div>
                    </div>

                    <!-- 设备备注 -->
                    <div class="info-card">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>
                            设备备注
                        </h2>
                        
                        <div class="space-y-3">
                            <div id="equipmentNotes" class="text-gray-700 text-sm leading-relaxed bg-gray-50 p-4 rounded-lg min-h-[100px]">
                                <!-- 备注内容将在这里显示 -->
                            </div>
                            <div class="flex justify-between items-center">
                                <button onclick="editNotes()" class="text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit mr-1"></i>编辑备注
                                </button>
                                <span id="notesStatus" class="text-xs text-gray-500">
                                    <!-- 备注状态信息 -->
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 快速操作 -->
                    <div class="info-card">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-bolt text-yellow-600 mr-2"></i>
                            快速操作
                        </h2>
                        
                        <div class="space-y-3">
                            <button onclick="manageAttachments(currentEquipmentId)" 
                                    class="w-full py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors duration-200 text-sm">
                                <i class="fas fa-paperclip mr-2"></i>管理附件
                                <span id="attachmentCountBadge" class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs ml-2">0个</span>
                            </button>
                            
                            <button onclick="scheduleCalibration(currentEquipmentId)" 
                                    class="w-full py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors duration-200 text-sm">
                                <i class="fas fa-calendar-plus mr-2"></i>安排检定
                            </button>
                            
                            <button onclick="recordMaintenance(currentEquipmentId)" 
                                    class="w-full py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors duration-200 text-sm">
                                <i class="fas fa-wrench mr-2"></i>记录维护
                            </button>
                            
                            <button onclick="transferEquipment(currentEquipmentId)" 
                                    class="w-full py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors duration-200 text-sm">
                                <i class="fas fa-exchange-alt mr-2"></i>设备转移
                            </button>
                            
                            <button onclick="reportIssue(currentEquipmentId)" 
                                    class="w-full py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors duration-200 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>报告问题
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 照片预览模态框 -->
    <div id="photoPreviewModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-image text-indigo-600 mr-2"></i>设备照片预览
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closePhotoPreview()">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="px-6 py-4 overflow-y-auto" style="max-height: 70vh;">
                <div class="text-center mb-4">
                    <img id="photoPreviewImage" src="" alt="设备照片" class="max-w-full max-h-[60vh] mx-auto rounded-lg shadow-lg">
                </div>
                <div class="text-center text-sm text-gray-600">
                    <div id="photoFileName" class="font-medium mb-1"></div>
                    <div id="photoFileSize" class="text-gray-500"></div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors btn-click-effect" onclick="closePhotoPreview()">
                    关闭
                </button>
                <button type="button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors btn-click-effect" onclick="downloadCurrentPhoto()">
                    <i class="fas fa-download mr-2"></i>下载照片
                </button>
            </div>
        </div>
    </div>

    <!-- 附件管理模态框 -->
    <div id="attachmentModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" id="attachmentModalTitle">
                        <i class="fas fa-paperclip text-blue-600 mr-2"></i>设备附件管理
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeAttachmentModal()">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-1">设备编号: <span id="attachmentEquipmentId" class="font-mono font-semibold"></span></p>
            </div>
            
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        支持格式: PDF, JPG, PNG, DOCX | 
                        当前附件: <span id="attachmentCount" class="font-semibold">0</span> 个
                    </div>
                    <button onclick="triggerFileUpload()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm btn-click-effect">
                        <i class="fas fa-plus mr-2"></i>添加附件
                    </button>
                </div>
                <!-- 隐藏的文件上传输入 -->
                <input type="file" id="attachmentFileInput" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png,.docx" onchange="handleFileUpload(event)">
            </div>
            
            <div class="px-6 py-4 overflow-y-auto" style="max-height: 400px;">
                <div id="attachmentList" class="space-y-3">
                    <!-- 附件列表将在这里动态生成 -->
                </div>
                
                <!-- 空状态 -->
                <div id="attachmentEmptyState" class="text-center py-12">
                    <i class="fas fa-paperclip text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500 mb-2">暂无附件</p>
                    <p class="text-sm text-gray-400">点击"添加附件"按钮上传设备相关文件</p>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors btn-click-effect" onclick="closeAttachmentModal()">
                    关闭
                </button>
                <button type="button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors btn-click-effect" onclick="saveAttachments()">
                    <i class="fas fa-save mr-2"></i>保存更改
                </button>
            </div>
        </div>
    </div>

    <!-- 附件预览模态框 -->
    <div id="attachmentPreviewModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-5xl w-full mx-4 max-h-[95vh] overflow-hidden flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" id="previewModalTitle">
                        <i class="fas fa-eye text-green-600 mr-2"></i>附件预览
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closePreviewModal()">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="px-6 py-4 overflow-y-auto flex-1">
                <div id="previewContent" class="text-center h-full">
                    <!-- 预览内容将在这里显示 -->
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center flex-shrink-0">
                <button type="button" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors" onclick="downloadCurrentAttachment()">
                    <i class="fas fa-download mr-2"></i>下载附件
                </button>
                <button type="button" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" onclick="closePreviewModal()">
                    关闭预览
                </button>
            </div>
        </div>
    </div>

    <!-- 备注编辑模态框 -->
    <div id="notesEditModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>编辑设备备注
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeNotesEditModal()">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注内容</label>
                    <textarea id="notesTextarea" 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" 
                              rows="6" 
                              placeholder="请输入设备备注信息..."></textarea>
                    <div class="mt-2 text-sm text-gray-500">
                        <span id="notesCharCount">0</span> / 500 字符
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        备注可用于记录设备的特殊说明、维护记录、使用注意事项等
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" onclick="closeNotesEditModal()">
                            取消
                        </button>
                        <button type="button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" onclick="saveNotes()">
                            <i class="fas fa-save mr-2"></i>保存备注
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentEquipmentId = null;
        let equipmentData = null;
        let currentEquipmentForAttachments = null;
        let currentPreviewAttachment = null;
        let currentNotes = null;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const equipmentId = urlParams.get('id');

                if (!equipmentId) {
                    showNotification('未指定设备ID', 'error');
                    setTimeout(() => {
                        window.location.href = '/equipment';
                    }, 2000);
                    return;
                }

                currentEquipmentId = parseInt(equipmentId);
                
                // 加载设备数据
                await loadEquipmentData(currentEquipmentId);
                
                // 渲染设备信息
                renderEquipmentInfo();
                
                // 加载设备照片
                await loadEquipmentPhoto();
                
                // 更新附件计数
                await updateAttachmentCount(currentEquipmentId);
                
                // 加载检定历史
                await loadCalibrationHistory();
                
                // 设置模态框事件监听器
                setupModalEventListeners();
                
                // 设置备注输入监听器
                setupNotesInputListeners();
                
                console.log('设备详情页面加载完成');

            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面加载失败，请刷新页面重试', 'error');
            }
        });

        // 加载设备数据
        async function loadEquipmentData(equipmentId) {
            try {
                showNotification('正在加载设备数据...', 'info');
                equipmentData = await EquipmentAPI.getEquipment(equipmentId);
                showNotification('设备数据加载成功', 'success');
            } catch (error) {
                console.error('加载设备数据失败:', error);
                showNotification('加载设备数据失败: ' + error.message, 'error');
                throw error;
            }
        }

        // 加载设备照片
        async function loadEquipmentPhoto() {
            try {
                // 获取设备附件列表
                const attachments = await AttachmentAPI.getEquipmentAttachments(currentEquipmentId);
                
                // 查找图片类型的附件（优先查找最新的图片）
                const imageAttachments = attachments.filter(att => 
                    ['jpg', 'jpeg', 'png', 'gif'].includes(att.file_type?.toLowerCase())
                ).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                if (imageAttachments.length > 0) {
                    // 使用最新的图片作为设备照片
                    const photoAttachment = imageAttachments[0];
                    const photoElement = document.getElementById('equipmentPhoto');
                    
                    // 获取预览URL
                    const previewUrl = await AttachmentAPI.previewAttachment(photoAttachment.id);
                    photoElement.src = previewUrl;
                    
                    // 保存当前照片信息
                    currentEquipmentPhoto = {
                        id: photoAttachment.id,
                        filename: photoAttachment.filename,
                        original_filename: photoAttachment.original_filename,
                        file_path: photoAttachment.file_path,
                        file_type: photoAttachment.file_type,
                        file_size: photoAttachment.file_size
                    };
                    
                    console.log('设备照片加载成功:', currentEquipmentPhoto);
                } else {
                    // 没有找到图片附件，使用默认占位图
                    const photoElement = document.getElementById('equipmentPhoto');
                    photoElement.src = '/static/images/no-photo.svg';
                    currentEquipmentPhoto = null;
                    console.log('设备没有照片附件');
                }
            } catch (error) {
                console.error('加载设备照片失败:', error);
                // 加载失败时使用默认占位图
                const photoElement = document.getElementById('equipmentPhoto');
                photoElement.src = '/static/images/load-error.svg';
                currentEquipmentPhoto = null;
            }
        }

        // 渲染设备信息
        function renderEquipmentInfo() {
            if (!equipmentData) return;

            try {
                // 基本信息
                document.getElementById('equipmentName').textContent = equipmentData.name || '-';
                document.getElementById('equipmentModel').textContent = equipmentData.model || '-';
                document.getElementById('equipmentSerial').textContent = equipmentData.internal_id || '-';
                document.getElementById('equipmentFactorySerial').textContent = equipmentData.manufacturer_id || '-';
                document.getElementById('equipmentDepartment').textContent = equipmentData.department?.name || '-';
                document.getElementById('equipmentCategory').textContent = equipmentData.category?.name || '-';
                document.getElementById('equipmentAccuracy').textContent = equipmentData.accuracy_level || '-';
                document.getElementById('equipmentRange').textContent = equipmentData.measurement_range || '-';
                document.getElementById('equipmentDivision').textContent = equipmentData.scale_value || '-';

                // 检定信息
                document.getElementById('calibrationCycle').textContent = equipmentData.calibration_cycle || '-';
                document.getElementById('calibrationDate').textContent = equipmentData.calibration_date ? 
                    new Date(equipmentData.calibration_date).toLocaleDateString('zh-CN') : '-';
                document.getElementById('validUntil').textContent = equipmentData.valid_until ? 
                    new Date(equipmentData.valid_until).toLocaleDateString('zh-CN') : '-';
                document.getElementById('calibrationMethod').textContent = equipmentData.calibration_method || '-';
                
                // 根据检定方式显示不同的字段
                const internalInspectionFields = document.getElementById('internalInspectionFields');
                const externalInspectionFields = document.getElementById('externalInspectionFields');
                
                if (equipmentData.calibration_method === '内检') {
                    // 内检设备：总是显示证书编号和证书形式
                    internalInspectionFields.style.display = 'block';
                    externalInspectionFields.style.display = 'none';
                    
                    // 填充内检证书字段数据
                    document.getElementById('certificateNumber').textContent = equipmentData.certificate_number || '-';
                    document.getElementById('certificateForm').textContent = equipmentData.certificate_form || '-';
                } else if (equipmentData.calibration_method === '外检') {
                    // 外检设备：显示检定结果和检定机构，以及证书信息
                    internalInspectionFields.style.display = 'block';
                    externalInspectionFields.style.display = 'block';
                    
                    // 填充证书字段数据
                    document.getElementById('certificateNumber').textContent = equipmentData.certificate_number || '-';
                    document.getElementById('certificateForm').textContent = equipmentData.certificate_form || '-';
                    
                    // 填充外检特有字段数据
                    document.getElementById('verificationAgency').textContent = equipmentData.verification_agency || '-';
                } else {
                    // 隐藏所有额外字段
                    internalInspectionFields.style.display = 'none';
                    externalInspectionFields.style.display = 'none';
                }

                // 管理级别
                const managementLevelElement = document.getElementById('managementLevel');
                if (equipmentData.management_level) {
                    managementLevelElement.innerHTML = `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${equipmentData.management_level}</span>`;
                } else {
                    managementLevelElement.textContent = '-';
                }

                // 生产信息
                document.getElementById('manufacturer').textContent = equipmentData.manufacturer || '-';
                document.getElementById('manufactureDate').textContent = equipmentData.manufacture_date ? 
                    new Date(equipmentData.manufacture_date).toLocaleDateString('zh-CN') : '-';
                if (equipmentData.original_value) {
                    document.getElementById('originalValue').textContent = `¥${parseFloat(equipmentData.original_value).toFixed(2)}`;
                } else {
                    document.getElementById('originalValue').textContent = '-';
                }

                // 安装信息
                document.getElementById('installationLocation').textContent = equipmentData.installation_location || '-';

                // 状态信息
                const statusElement = document.getElementById('equipmentStatus');
                statusElement.textContent = equipmentData.status || '-';
                statusElement.className = `status-badge ${getStatusClass(equipmentData.status)}`;
                
                // 状态变更日期（仅在非"在用"状态时显示）
                const statusChangeDateRow = document.getElementById('statusChangeDateRow');
                const statusChangeDateElement = document.getElementById('statusChangeDate');
                
                if (equipmentData.status && equipmentData.status !== '在用' && equipmentData.status_change_date) {
                    statusChangeDateRow.style.display = 'flex';
                    statusChangeDateElement.textContent = new Date(equipmentData.status_change_date).toLocaleDateString('zh-CN');
                } else {
                    statusChangeDateRow.style.display = 'none';
                    statusChangeDateElement.textContent = '-';
                }

                // 备注信息
                currentNotes = equipmentData.notes || '';
                const notesElement = document.getElementById('equipmentNotes');
                const notesStatusElement = document.getElementById('notesStatus');
                
                if (currentNotes && currentNotes.trim()) {
                    notesElement.innerHTML = currentNotes.replace(/\n/g, '<br>');
                    notesStatusElement.textContent = `最后更新: ${equipmentData.notes_updated_at ? new Date(equipmentData.notes_updated_at).toLocaleDateString('zh-CN') : '未知'}`;
                } else {
                    notesElement.innerHTML = '<span class="text-gray-400 italic">暂无备注</span>';
                    notesStatusElement.textContent = '点击编辑备注';
                }

                // 更新编辑按钮的设备ID
                const editButton = document.querySelector('button[onclick^="editEquipment"]');
                if (editButton) {
                    editButton.setAttribute('onclick', `editEquipment(${equipmentData.id})`);
                }

                console.log('设备信息渲染完成:', equipmentData);
                
            } catch (error) {
                console.error('渲染设备信息时出错:', error);
                showNotification('渲染设备信息失败', 'error');
            }
        }

        // 获取状态样式类
        function getStatusClass(status) {
            const statusMap = {
                '在用': 'status-normal',
                '停用': 'status-inactive',
                '报废': 'status-danger'
            };
            return statusMap[status] || 'status-inactive';
        }

  
        // 获取文件图标
        function getFileIcon(type) {
            const iconMap = {
                'pdf': '<i class="fas fa-file-pdf text-red-500 text-lg"></i>',
                'jpg': '<i class="fas fa-file-image text-green-500 text-lg"></i>',
                'jpeg': '<i class="fas fa-file-image text-green-500 text-lg"></i>',
                'png': '<i class="fas fa-file-image text-green-500 text-lg"></i>',
                'docx': '<i class="fas fa-file-word text-blue-500 text-lg"></i>'
            };
            return iconMap[type] || '<i class="fas fa-file text-gray-500 text-lg"></i>';
        }

      
      
        // 编辑设备
        function editEquipment() {
            if (currentEquipmentId) {
                window.location.href = `/equipment/edit?id=${currentEquipmentId}`;
            } else {
                showNotification('设备ID无效', 'error');
            }
        }


        // 下载附件
        async function downloadAttachment(attachmentId, filename) {
            try {
                showNotification('正在下载附件...', 'info');
                await AttachmentAPI.downloadAttachment(attachmentId, filename);
                showNotification('附件下载成功', 'success');
            } catch (error) {
                showNotification('附件下载失败: ' + error.message, 'error');
            }
        }

        // 移除重复的变量声明，已在上文定义

        // 平滑显示模态框
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // 强制重排以确保过渡效果生效
                modal.offsetHeight;
                modal.classList.remove('hidden');
                // 添加一个微小的延迟来确保过渡效果开始
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.style.pointerEvents = 'auto';
                }, 10);
            }
        }

        // 平滑隐藏模态框
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                // 等待过渡完成后隐藏
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // 管理附件
        function manageAttachments(equipmentId) {
            console.log('管理附件:', equipmentId);
            currentEquipmentForAttachments = equipmentId;
            newAttachments = [];
            deletedAttachments = [];
            
            // 设置模态框标题
            document.getElementById('attachmentEquipmentId').textContent = equipmentId;
            
            // 加载附件数据
            loadAttachmentsForModal(equipmentId);
            
            // 显示模态框
            showModal('attachmentModal');
        }

        // 查看检定记录
        function viewCalibrationHistory(equipmentId) {
            console.log('查看检定记录:', equipmentId);
            alert('跳转到检定记录页面 (开发中)');
        }

        // 安排检定
        function scheduleCalibration(equipmentId) {
            console.log('安排检定:', equipmentId);
            if (confirm('确定要为此设备安排检定吗？')) {
                alert('检定安排功能开发中...');
            }
        }

        // 记录维护
        function recordMaintenance(equipmentId) {
            console.log('记录维护:', equipmentId);
            alert('维护记录功能开发中...');
        }

        // 设备转移
        function transferEquipment(equipmentId) {
            console.log('设备转移:', equipmentId);
            const newDepartment = prompt('请输入要转移到的部门:');
            if (newDepartment) {
                alert(`设备将转移到 ${newDepartment} (功能开发中)`);
            }
        }

        // 报告问题
        function reportIssue(equipmentId) {
            console.log('报告问题:', equipmentId);
            const issue = prompt('请描述问题:');
            if (issue) {
                alert('问题已提交 (功能开发中)');
            }
        }

        // 打印详情
        function printDetails() {
            window.print();
        }

        // 返回到设备管理页面
        function goBackToEquipmentList() {
            // 直接返回到设备管理页面，保持搜索状态
            window.location.href = '/equipment';
        }

        // 页面加载完成后的初始化（已合并到主初始化函数中）

        // ========== 附件管理功能 ==========

        // 加载附件数据（模态框使用）
        async function loadAttachmentsForModal(equipmentId) {
            try {
                showNotification('正在加载附件...', 'info');
                const attachments = await AttachmentAPI.getEquipmentAttachments(equipmentId);
                renderModalAttachmentList(attachments);
                showNotification('附件加载成功', 'success');
            } catch (error) {
                console.error('加载附件失败:', error);
                showNotification('加载附件失败: ' + error.message, 'error');
                document.getElementById('attachmentList').innerHTML = 
                    '<div class="text-gray-500 text-center py-4">加载附件失败</div>';
            }
        }

        // 渲染附件列表（模态框使用）
        function renderModalAttachmentList(attachments) {
            const attachmentList = document.getElementById('attachmentList');
            const emptyState = document.getElementById('attachmentEmptyState');
            const attachmentCount = document.getElementById('attachmentCount');

            // 确保attachments是数组
            const attachmentsArray = Array.isArray(attachments) ? attachments : [];
            
            attachmentCount.textContent = attachmentsArray.length;

            if (attachmentsArray.length === 0) {
                attachmentList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            attachmentList.style.display = 'block';
            emptyState.style.display = 'none';

            attachmentList.innerHTML = attachmentsArray.map(attachment => {
                // 获取文件类型 - 优先使用file_type字段，否则从文件名提取
                const fileType = attachment.file_type || (attachment.original_filename || attachment.filename).split('.').pop().toLowerCase();
                
                return `
                <div class="attachment-item border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-attachment-id="${attachment.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <div class="flex-shrink-0 mr-4">
                                ${getFileIcon(fileType.toLowerCase())}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-900 truncate">${attachment.original_filename || attachment.filename}</div>
                                <div class="text-xs text-gray-500">
                                    ${formatFileSize(attachment.file_size)} • 上传于 ${new Date(attachment.created_at).toLocaleDateString('zh-CN')}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button onclick="previewAttachment(${attachment.id}, '${attachment.original_filename || attachment.filename}', '${fileType}')" 
                                    class="text-green-600 hover:text-green-800 p-2 rounded-full hover:bg-green-50 transition-colors" 
                                    title="预览">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="downloadAttachmentById(${attachment.id})" 
                                    class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-colors" 
                                    title="下载">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="deleteAttachment(${attachment.id})" 
                                    class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition-colors" 
                                    title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;}).join('');
        }

        // 获取文件图标
        function getFileIcon(type) {
            const iconMap = {
                'pdf': '<i class="fas fa-file-pdf text-red-500 text-2xl"></i>',
                'jpg': '<i class="fas fa-file-image text-green-500 text-2xl"></i>',
                'jpeg': '<i class="fas fa-file-image text-green-500 text-2xl"></i>',
                'png': '<i class="fas fa-file-image text-green-500 text-2xl"></i>',
                'docx': '<i class="fas fa-file-word text-blue-500 text-2xl"></i>'
            };
            return iconMap[type] || '<i class="fas fa-file text-gray-500 text-2xl"></i>';
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

      
        // 触发文件上传
        function triggerFileUpload() {
            document.getElementById('attachmentFileInput').click();
        }

        // 处理文件上传
        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                // 验证文件类型
                const allowedTypes = ['pdf', 'jpg', 'jpeg', 'png', 'docx'];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExtension)) {
                    showNotification(`不支持的文件格式: ${file.name}\\n支持的格式: PDF, JPG, PNG, DOCX`, 'error');
                    continue;
                }

                // 验证文件大小 (100MB限制)
                if (file.size > 100 * 1024 * 1024) {
                    showNotification(`文件过大: ${file.name}\\n文件大小不能超过 100MB`, 'error');
                    continue;
                }

                try {
                    showNotification(`正在上传: ${file.name}`, 'info');
                    
                    // 上传文件
                    await AttachmentAPI.uploadAttachment(currentEquipmentForAttachments, file, (progress) => {
                        console.log(`上传进度: ${progress}%`);
                    });
                    
                    showNotification(`文件上传成功: ${file.name}`, 'success');
                    
                } catch (error) {
                    console.error('文件上传失败:', error);
                    showNotification(`文件上传失败: ${file.name} - ${error.message}`, 'error');
                }
            }

            // 清空文件输入
            event.target.value = '';

            // 重新加载附件列表
            await loadAttachmentsForModal(currentEquipmentForAttachments);
        }

        // 预览附件
        async function previewAttachment(attachmentId, filename, fileType) {
            try {
                const previewUrl = await AttachmentAPI.previewAttachment(attachmentId);
                
                // 创建预览模态框
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 flex flex-col">
                        <div class="flex items-center justify-between p-4 border-b">
                            <h3 class="text-lg font-semibold">预览: ${filename}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 p-4 overflow-auto">
                            ${fileType && fileType.toUpperCase() === 'PDF' ? 
                                `<iframe src="${previewUrl}" class="w-full h-full min-h-[600px] border-none"></iframe>` :
                                `<img src="${previewUrl}" class="max-w-full max-h-full mx-auto" alt="${filename}" />`
                            }
                        </div>
                        <div class="p-4 border-t bg-gray-50">
                            <div class="flex justify-end space-x-2">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    关闭
                                </button>
                                <button onclick="downloadAttachmentById(${attachmentId}); this.closest('.fixed').remove();" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    下载
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 点击背景关闭
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('预览失败:', error);
                showNotification('预览失败: ' + error.message, 'error');
            }
        }

        // 关闭预览模态框
        function closePreviewModal() {
            hideModal('attachmentPreviewModal');
            currentPreviewAttachment = null;
        }

        // 下载当前预览的附件
        async function downloadCurrentAttachment() {
            if (!currentPreviewAttachment) return;
            
            try {
                showNotification('正在下载附件...', 'info');
                const filename = currentPreviewAttachment.original_filename || currentPreviewAttachment.filename;
                await AttachmentAPI.downloadAttachment(currentPreviewAttachment.id, filename);
                showNotification('附件下载成功', 'success');
            } catch (error) {
                console.error('下载附件失败:', error);
                showNotification('下载附件失败: ' + error.message, 'error');
            }
        }

        // 根据ID下载附件
        async function downloadAttachmentById(attachmentId) {
            try {
                showNotification('正在下载附件...', 'info');
                
                // 首先获取附件信息来得到文件名
                const attachment = await AttachmentAPI.getAttachment(attachmentId);
                const filename = attachment.original_filename || attachment.filename;
                
                // 使用AttachmentAPI进行下载
                await AttachmentAPI.downloadAttachment(attachmentId, filename);
                
                showNotification('附件下载成功', 'success');
            } catch (error) {
                console.error('下载附件失败:', error);
                showNotification('下载附件失败: ' + error.message, 'error');
            }
        }

        // 删除附件（旧版本，保留以兼容性）
        async function deleteAttachment(attachmentId) {
            if (!confirm('确定要删除这个附件吗？')) return;

            try {
                showNotification('正在删除附件...', 'info');
                await AttachmentAPI.deleteAttachment(attachmentId);
                showNotification('附件删除成功', 'success');
                
                // 重新加载附件列表
                await loadAttachmentsForModal(currentEquipmentForAttachments);
            } catch (error) {
                console.error('删除附件失败:', error);
                showNotification('删除附件失败: ' + error.message, 'error');
            }
        }

        // 关闭附件管理模态框
        function closeAttachmentModal() {
            hideModal('attachmentModal');
            currentEquipmentForAttachments = null;
            newAttachments = [];
            deletedAttachments = [];
        }

        // 保存附件更改
        function saveAttachments() {
            // 现在附件是实时上传的，所以这里只需要关闭模态框
            showNotification('附件管理已完成', 'success');
            closeAttachmentModal();
            
            // 重新更新附件计数
            updateAttachmentCount(currentEquipmentId);
        }

        // 照片相关功能
        let currentEquipmentPhoto = null;

        // 触发照片上传
        function triggerPhotoUpload() {
            document.getElementById('photoUploadInput').click();
        }

        // 处理照片上传
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                showNotification('请选择图片文件', 'error');
                return;
            }

            // 验证文件大小（限制为5MB）
            if (file.size > 5 * 1024 * 1024) {
                showNotification('图片文件大小不能超过5MB', 'error');
                return;
            }

            try {
                showNotification('正在上传照片...', 'info');
                
                // 使用AttachmentAPI上传照片
                const result = await AttachmentAPI.uploadAttachment(currentEquipmentId, file, (progress) => {
                    console.log(`上传进度: ${progress}%`);
                });

                // 更新照片显示
                const photoElement = document.getElementById('equipmentPhoto');
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoElement.src = e.target.result;
                    currentEquipmentPhoto = {
                        id: result.id,
                        filename: result.filename,
                        original_filename: result.original_filename || file.name,
                        file_path: result.file_path,
                        file_type: file.type,
                        file_size: file.size
                    };
                };
                reader.readAsDataURL(file);

                showNotification('照片上传成功', 'success');
                
                // 清空文件输入
                event.target.value = '';
                
            } catch (error) {
                console.error('照片上传失败:', error);
                showNotification('照片上传失败: ' + error.message, 'error');
            }
        }

        // 预览照片
        function previewPhoto() {
            if (!currentEquipmentPhoto) {
                showNotification('没有可预览的照片', 'error');
                return;
            }

            const previewImage = document.getElementById('photoPreviewImage');
            const photoFileName = document.getElementById('photoFileName');
            const photoFileSize = document.getElementById('photoFileSize');
            
            // 使用重新获取的预览URL确保图片能正确显示
            AttachmentAPI.previewAttachment(currentEquipmentPhoto.id)
                .then(previewUrl => {
                    previewImage.src = previewUrl;
                    photoFileName.textContent = currentEquipmentPhoto.original_filename || '设备照片';
                    photoFileSize.textContent = `文件大小: ${formatFileSize(currentEquipmentPhoto.file_size || 0)}`;
                    
                    // 显示预览模态框
                    showModal('photoPreviewModal');
                })
                .catch(error => {
                    console.error('获取照片预览失败:', error);
                    showNotification('照片预览失败', 'error');
                });
        }

        // 关闭照片预览
        function closePhotoPreview() {
            hideModal('photoPreviewModal');
        }

        // 下载当前照片
        async function downloadCurrentPhoto() {
            if (!currentEquipmentPhoto) {
                showNotification('没有可下载的照片', 'error');
                return;
            }

            try {
                showNotification('正在下载照片...', 'info');
                
                // 使用AttachmentAPI下载照片
                const filename = currentEquipmentPhoto.original_filename || '设备照片.jpg';
                await AttachmentAPI.downloadAttachment(currentEquipmentPhoto.id, filename);

                showNotification('照片下载成功', 'success');
            } catch (error) {
                console.error('照片下载失败:', error);
                showNotification('照片下载失败: ' + error.message, 'error');
            }
        }

        // 更新附件计数显示
        async function updateAttachmentCount(equipmentId) {
            try {
                const attachments = await AttachmentAPI.getEquipmentAttachments(equipmentId);
                const count = Array.isArray(attachments) ? attachments.length : 0;
                
                // 更新详情页面上的附件计数
                const attachmentBadge = document.getElementById('attachmentCountBadge');
                if (attachmentBadge) {
                    attachmentBadge.textContent = `${count}个`;
                }
                
                console.log(`附件计数更新：设备${equipmentId}有${count}个附件`);
            } catch (error) {
                console.error('更新附件计数失败:', error);
                // 错误时显示0个，避免显示undefined
                const attachmentBadge = document.getElementById('attachmentCountBadge');
                if (attachmentBadge) {
                    attachmentBadge.textContent = '0个';
                }
            }
        }

        // ESC键关闭模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const attachmentModal = document.getElementById('attachmentModal');
                const previewModal = document.getElementById('attachmentPreviewModal');
                
                if (!previewModal.classList.contains('hidden')) {
                    closePreviewModal();
                } else if (!attachmentModal.classList.contains('hidden')) {
                    closeAttachmentModal();
                }
            }
        });

        // 设置模态框事件监听器
        function setupModalEventListeners() {
            const attachmentModal = document.getElementById('attachmentModal');
            if (attachmentModal) {
                attachmentModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeAttachmentModal();
                    }
                });
            }
            
            const attachmentPreviewModal = document.getElementById('attachmentPreviewModal');
            if (attachmentPreviewModal) {
                attachmentPreviewModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closePreviewModal();
                    }
                });
            }
            
            const notesEditModal = document.getElementById('notesEditModal');
            if (notesEditModal) {
                notesEditModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeNotesEditModal();
                    }
                });
            }
            
            const deleteAttachmentModal = document.getElementById('deleteAttachmentModal');
            if (deleteAttachmentModal) {
                deleteAttachmentModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeDeleteAttachmentModal();
                    }
                });
            }
        }

        // ========== 备注管理功能 ==========

        // 编辑备注
        function editNotes() {
            const notesTextarea = document.getElementById('notesTextarea');
            const notesCharCount = document.getElementById('notesCharCount');
            
            // 设置当前备注内容
            notesTextarea.value = currentNotes || '';
            updateNotesCharCount();
            
            // 显示编辑模态框
            showModal('notesEditModal');
            
            // 聚焦到文本框
            setTimeout(() => {
                notesTextarea.focus();
            }, 100);
        }

        // 关闭备注编辑模态框
        function closeNotesEditModal() {
            hideModal('notesEditModal');
        }

        // 保存备注
        async function saveNotes() {
            const notesTextarea = document.getElementById('notesTextarea');
            const newNotes = notesTextarea.value.trim();
            
            try {
                showNotification('正在保存备注...', 'info');
                
                // 调用API保存备注 - 使用通用的设备更新端点
                // 优先从sessionStorage获取token（支持多标签页独立登录）
                const accessToken = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                const response = await fetch(`/api/equipment/${currentEquipmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        notes: newNotes
                    })
                });

                if (!response.ok) {
                    throw new Error('备注保存失败');
                }

                const result = await response.json();
                
                // 更新本地数据
                currentNotes = newNotes;
                equipmentData.notes = newNotes;
                equipmentData.notes_updated_at = result.notes_updated_at;
                
                // 更新显示
                const notesElement = document.getElementById('equipmentNotes');
                const notesStatusElement = document.getElementById('notesStatus');
                
                if (newNotes) {
                    notesElement.innerHTML = newNotes.replace(/\n/g, '<br>');
                    notesStatusElement.textContent = `最后更新: ${new Date(result.notes_updated_at).toLocaleDateString('zh-CN')}`;
                } else {
                    notesElement.innerHTML = '<span class="text-gray-400 italic">暂无备注</span>';
                    notesStatusElement.textContent = '点击编辑备注';
                }
                
                // 关闭模态框
                closeNotesEditModal();
                
                showNotification('备注保存成功', 'success');
                
            } catch (error) {
                console.error('保存备注失败:', error);
                showNotification('保存备注失败: ' + error.message, 'error');
            }
        }

        // 更新字符计数
        function updateNotesCharCount() {
            const notesTextarea = document.getElementById('notesTextarea');
            const notesCharCount = document.getElementById('notesCharCount');
            const charCount = notesTextarea.value.length;
            
            notesCharCount.textContent = charCount;
            
            // 字符数限制提醒
            if (charCount > 500) {
                notesCharCount.className = 'text-red-500 font-medium';
            } else if (charCount > 400) {
                notesCharCount.className = 'text-yellow-500 font-medium';
            } else {
                notesCharCount.className = '';
            }
        }

        // 设置备注输入监听器
        function setupNotesInputListeners() {
            const notesTextarea = document.getElementById('notesTextarea');
            if (notesTextarea) {
                notesTextarea.addEventListener('input', updateNotesCharCount);
                notesTextarea.addEventListener('paste', function() {
                    setTimeout(updateNotesCharCount, 10);
                });
            }
        }

        // ESC键关闭备注编辑模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const notesEditModal = document.getElementById('notesEditModal');
                if (!notesEditModal.classList.contains('hidden')) {
                    closeNotesEditModal();
                }
            }
        });

        // 点击模态框外部关闭（已合并到setupModalEventListeners函数中）

        // 检定历史相关函数
        
        // 加载检定历史
        async function loadCalibrationHistory() {
            try {
                const container = document.getElementById('calibrationHistoryContainer');
                
                // 显示加载状态
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">正在加载检定历史...</p>
                    </div>
                `;
                
                // 调用API获取检定历史
                const currentToken = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                const response = await fetch(`/api/calibration/equipment/${currentEquipmentId}/history?limit=5`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取检定历史失败');
                }
                
                const calibrationHistories = await response.json();
                
                // 渲染检定历史时间线
                renderCalibrationHistoryTimeline(calibrationHistories);
                
            } catch (error) {
                console.error('加载检定历史失败:', error);
                const container = document.getElementById('calibrationHistoryContainer');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-500 mb-4">加载检定历史失败</p>
                        <button onclick="loadCalibrationHistory()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            重试
                        </button>
                    </div>
                `;
            }
        }
        
        // 渲染检定历史时间线
        function renderCalibrationHistoryTimeline(histories) {
            const container = document.getElementById('calibrationHistoryContainer');
            
            if (!histories || histories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-3xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">暂无检定历史记录</p>
                    </div>
                `;
                return;
            }
            
            // 构建时间线HTML
            let timelineHtml = '';
            
            histories.forEach((history, index) => {
                const isLatest = index === 0;
                const isOldest = index === histories.length - 1;
                const dotClass = getCalibrationStatusDotClass(history.calibration_result);
                const resultClass = getCalibrationResultClass(history.calibration_result);
                
                const displayTitle = isLatest ? '最新检定' : 
                                   isOldest && histories.length > 2 ? '首次检定' : '历史检定';
                
                // 检查是否已被回滚
                const isRolledBack = history.is_rolled_back;
                const rollbackBadge = isRolledBack ? 
                    `<span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full ml-2">
                        <i class="fas fa-undo mr-1"></i>已回滚
                    </span>` : '';

                timelineHtml += `
                    <div class="timeline-item ${isRolledBack ? 'opacity-75' : ''}">
                        <div class="timeline-dot ${dotClass} ${isRolledBack ? 'ring-2 ring-orange-300' : ''}"></div>
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-gray-900">
                                    ${displayTitle}
                                    ${rollbackBadge}
                                </div>
                                <div class="text-sm text-gray-600">${formatDate(history.calibration_date)}</div>
                                ${history.valid_until ? `<div class="text-xs text-gray-500">有效期至: ${formatDate(history.valid_until)}</div>` : ''}
                                ${isRolledBack && history.rolled_back_at ? 
                                    `<div class="text-xs text-orange-600 mt-1">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        回滚时间: ${formatDateTime(history.rolled_back_at)}
                                    </div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium ${resultClass} ${isRolledBack ? 'line-through' : ''}">${history.calibration_result}</div>
                                <div class="text-xs text-gray-500">${history.calibration_method}</div>
                                ${history.certificate_number ? `<div class="text-xs text-gray-400">证书: ${history.certificate_number}</div>` : ''}
                                ${history.certificate_form ? `<div class="text-xs text-gray-400">形式: ${history.certificate_form}</div>` : ''}
                            </div>
                        </div>
                        ${history.notes ? `<div class="mt-2 text-xs text-gray-600 bg-gray-50 p-2 rounded">${history.notes}</div>` : ''}
                        ${isRolledBack && history.rollback_reason ? 
                            `<div class="mt-2 text-xs text-orange-700 bg-orange-50 p-2 rounded border-l-2 border-orange-300">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                回滚原因: ${history.rollback_reason}
                            </div>` : ''}
                        <div class="mt-2 flex flex-wrap gap-2" id="calibration-attachments-${history.id}">
                            <!-- 附件按钮将在这里动态加载 -->
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = timelineHtml;
            
            // 异步加载每个检定历史记录的附件
            histories.forEach(async (history) => {
                await loadCalibrationAttachments(history.id, currentEquipmentId);
            });
        }
        
        // 加载检定历史记录的附件
        async function loadCalibrationAttachments(historyId, equipmentId) {
            try {
                const currentToken = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                const response = await fetch(`/api/attachments/equipment/${equipmentId}/attachments`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    console.warn(`无法加载检定历史 ${historyId} 的附件`);
                    return;
                }
                
                const attachments = await response.json();
                
                // 筛选属于此检定历史记录的附件
                const calibrationAttachments = attachments.filter(attachment => 
                    attachment.calibration_history_id === historyId
                );
                
                const attachmentContainer = document.getElementById(`calibration-attachments-${historyId}`);
                if (!attachmentContainer) return;
                
                if (calibrationAttachments.length === 0) {
                    // 没有附件时隐藏容器
                    attachmentContainer.style.display = 'none';
                    return;
                }
                
                // 构建附件按钮HTML
                let attachmentHtml = '';
                calibrationAttachments.forEach(attachment => {
                    const isImage = ['jpg', 'jpeg', 'png', 'gif'].includes(
                        attachment.file_type ? attachment.file_type.toLowerCase() : ''
                    );
                    const isPdf = attachment.file_type && attachment.file_type.toLowerCase() === 'pdf';
                    
                    attachmentHtml += `
                        <div class="inline-flex items-center text-xs bg-gray-100 hover:bg-gray-200 rounded px-2 py-1 cursor-pointer transition-colors"
                             onclick="previewCalibrationAttachment(${attachment.id}, '${attachment.original_filename}', '${attachment.file_type}')">
                            <i class="fas ${isImage ? 'fa-image' : isPdf ? 'fa-file-pdf' : 'fa-file'} text-gray-600 mr-1"></i>
                            <span class="text-gray-700">${attachment.original_filename}</span>
                        </div>
                    `;
                });
                
                attachmentContainer.innerHTML = attachmentHtml;
                attachmentContainer.style.display = 'flex';
                
            } catch (error) {
                console.error('加载检定附件失败:', error);
            }
        }
        
        // 预览检定附件
        async function previewCalibrationAttachment(attachmentId, filename, fileType) {
            try {
                const previewUrl = await AttachmentAPI.previewAttachment(attachmentId);
                
                // 创建预览模态框
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 flex flex-col">
                        <div class="flex items-center justify-between p-4 border-b">
                            <h3 class="text-lg font-semibold">预览检定附件: ${filename}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 p-4 overflow-auto">
                            ${fileType && fileType.toUpperCase() === 'PDF' ? 
                                `<iframe src="${previewUrl}" class="w-full h-full min-h-[600px] border-none"></iframe>` :
                                `<img src="${previewUrl}" class="max-w-full max-h-full mx-auto" alt="${filename}" />`
                            }
                        </div>
                        <div class="p-4 border-t flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg">
                                关闭
                            </button>
                            <a href="${previewUrl}" download="${filename}" 
                               class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                <i class="fas fa-download mr-2"></i>下载
                            </a>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 点击背景关闭
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('预览检定附件失败:', error);
                showNotification('预览附件失败: ' + error.message, 'error');
            }
        }
        
        // 获取检定状态对应的时间线点样式
        function getCalibrationStatusDotClass(result) {
            switch(result) {
                case '合格': return 'success';
                case '不合格': return 'danger';
                default: return 'warning';
            }
        }
        
        // 获取检定结果对应的文字样式
        function getCalibrationResultClass(result) {
            switch(result) {
                case '合格': return 'text-green-600';
                case '不合格': return 'text-red-600';
                default: return 'text-yellow-600';
            }
        }
        
        // 格式化日期显示
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // 格式化日期时间为中文格式
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            // 数据库存储的是UTC时间，需要添加UTC标识符然后转换为本地时间
            const utcDate = new Date(dateString + 'Z'); // 添加Z表示UTC时间
            return utcDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Asia/Shanghai' // 明确指定中国时区
            });
        }
        
        // 打开完整检定历史模态框
        async function openCalibrationHistoryModal() {
            try {
                showNotification('正在加载完整检定历史...', 'info');
                
                // 获取完整的检定历史记录
                const currentToken = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                const response = await fetch(`/api/calibration/equipment/${currentEquipmentId}/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取完整检定历史失败');
                }
                
                const allHistories = await response.json();
                
                // 创建模态框HTML
                const modalHTML = `
                    <div id="calibrationHistoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
                        <div class="modal-content bg-white rounded-lg shadow-xl max-w-7xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-900">
                                    <i class="fas fa-history mr-2 text-indigo-600"></i>
                                    完整检定历史记录 - ${equipmentData.name}
                                </h3>
                                <button onclick="closeCalibrationHistoryModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                ${renderFullCalibrationHistory(allHistories)}
                            </div>
                        </div>
                    </div>
                `;
                
                // 将模态框添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 添加点击背景关闭模态框的事件
                const modal = document.getElementById('calibrationHistoryModal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeCalibrationHistoryModal();
                        }
                    });
                }
                
                // 加载模态框中的附件
                setTimeout(() => {
                    allHistories.forEach(async (history) => {
                        await loadModalCalibrationAttachments(history.id, currentEquipmentId);
                    });
                }, 100);
                
            } catch (error) {
                console.error('打开检定历史模态框失败:', error);
                showNotification('加载检定历史失败: ' + error.message, 'error');
            }
        }
        
        // 关闭检定历史模态框
        function closeCalibrationHistoryModal() {
            const modal = document.getElementById('calibrationHistoryModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 渲染完整检定历史记录
        function renderFullCalibrationHistory(histories) {
            if (!histories || histories.length === 0) {
                return `
                    <div class="text-center py-12">
                        <i class="fas fa-history text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">暂无检定历史记录</h3>
                        <p class="text-gray-500">该设备还没有检定历史记录</p>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-medium text-gray-900">检定历史记录 (${histories.length} 条)</h4>
                        <div class="text-sm text-gray-500">
                            最近更新: ${formatDateTime(histories[0]?.created_at)}
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">检定日期</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">有效期至</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">检定方式</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">检定结果</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">回滚状态</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书编号</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书形式</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">检定机构</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">附件</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">记录时间</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${histories.map(history => `
                                    <tr class="hover:bg-gray-50 ${history.is_rolled_back ? 'bg-orange-50' : ''}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 ${history.is_rolled_back ? 'line-through text-gray-500' : ''}">
                                            ${formatDate(history.calibration_date)}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${history.is_rolled_back ? 'line-through text-gray-500' : ''}">
                                            ${formatDate(history.valid_until)}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${history.calibration_method === '内检' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'} ${history.is_rolled_back ? 'opacity-60' : ''}">
                                                ${history.calibration_method}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${history.calibration_result === '合格' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} ${history.is_rolled_back ? 'opacity-60 line-through' : ''}">
                                                ${history.calibration_result}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            ${history.is_rolled_back ? 
                                                `<div class="flex flex-col">
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800 mb-1">
                                                        <i class="fas fa-undo mr-1"></i>已回滚
                                                    </span>
                                                    ${history.rolled_back_at ? 
                                                        `<span class="text-xs text-gray-500">${formatDateTime(history.rolled_back_at)}</span>` : ''
                                                    }
                                                    ${history.rollback_reason ? 
                                                        `<span class="text-xs text-orange-600 mt-1" title="${history.rollback_reason}">
                                                            <i class="fas fa-info-circle mr-1"></i>原因
                                                        </span>` : ''
                                                    }
                                                </div>` : 
                                                `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    <i class="fas fa-check mr-1"></i>有效
                                                </span>`
                                            }
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${history.is_rolled_back ? 'line-through text-gray-500' : ''}">
                                            ${history.certificate_number || '-'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${history.is_rolled_back ? 'line-through text-gray-500' : ''}">
                                            ${history.certificate_form || '-'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${history.is_rolled_back ? 'line-through text-gray-500' : ''}">
                                            ${history.verification_agency || '-'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <div id="modal-attachments-${history.id}" class="flex flex-wrap gap-1">
                                                <span class="text-gray-400 text-xs">加载中...</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs">
                                            <div class="space-y-1">
                                                ${history.notes ? 
                                                    `<div class="truncate ${history.is_rolled_back ? 'line-through text-gray-500' : ''}" title="${history.notes}">
                                                        ${history.notes}
                                                    </div>` : 
                                                    '<span class="text-gray-400">-</span>'
                                                }
                                                ${history.is_rolled_back && history.rollback_reason ? 
                                                    `<div class="text-xs text-orange-700 bg-orange-50 p-1 rounded border-l-2 border-orange-300" title="${history.rollback_reason}">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                                        回滚原因: ${history.rollback_reason.length > 20 ? history.rollback_reason.substring(0, 20) + '...' : history.rollback_reason}
                                                    </div>` : ''
                                                }
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ${formatDateTime(history.created_at)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // 加载模态框中检定历史记录的附件
        async function loadModalCalibrationAttachments(historyId, equipmentId) {
            try {
                const currentToken = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                const response = await fetch(`/api/attachments/equipment/${equipmentId}/attachments`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    console.warn(`无法加载检定历史 ${historyId} 的附件`);
                    return;
                }
                
                const attachments = await response.json();
                
                // 筛选属于此检定历史记录的附件
                const calibrationAttachments = attachments.filter(attachment => 
                    attachment.calibration_history_id === historyId
                );
                
                const attachmentContainer = document.getElementById(`modal-attachments-${historyId}`);
                if (!attachmentContainer) return;
                
                if (calibrationAttachments.length === 0) {
                    attachmentContainer.innerHTML = '<span class="text-gray-400 text-xs">无附件</span>';
                    return;
                }
                
                // 构建附件按钮HTML
                let attachmentHtml = '';
                calibrationAttachments.forEach(attachment => {
                    const isImage = ['jpg', 'jpeg', 'png', 'gif'].includes(
                        attachment.file_type ? attachment.file_type.toLowerCase() : ''
                    );
                    const isPdf = attachment.file_type && attachment.file_type.toLowerCase() === 'pdf';
                    
                    attachmentHtml += `
                        <div class="inline-flex items-center text-xs bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded px-2 py-1 cursor-pointer transition-colors mr-1 mb-1"
                             onclick="previewCalibrationAttachment(${attachment.id}, '${attachment.original_filename}', '${attachment.file_type}')"
                             title="点击预览或下载 ${attachment.original_filename}">
                            <i class="fas ${isImage ? 'fa-image' : isPdf ? 'fa-file-pdf' : 'fa-file'} text-blue-600 mr-1"></i>
                            <span class="text-blue-700">${attachment.original_filename.length > 15 ? attachment.original_filename.substring(0, 12) + '...' : attachment.original_filename}</span>
                        </div>
                    `;
                });
                
                attachmentContainer.innerHTML = attachmentHtml;
                
            } catch (error) {
                console.error('加载模态框检定附件失败:', error);
                const attachmentContainer = document.getElementById(`modal-attachments-${historyId}`);
                if (attachmentContainer) {
                    attachmentContainer.innerHTML = '<span class="text-red-400 text-xs">加载失败</span>';
                }
            }
        }

        // 删除附件相关变量
        let currentDeleteAttachmentId = null;

        // 删除附件
        function deleteAttachment(attachmentId) {
            currentDeleteAttachmentId = attachmentId;
            showModal('deleteAttachmentModal');
        }

        // 确认删除附件
        async function confirmDeleteAttachment() {
            if (!currentDeleteAttachmentId) return;
            
            try {
                showNotification('正在删除附件...', 'info');
                await AttachmentAPI.deleteAttachment(currentDeleteAttachmentId);
                showNotification('附件删除成功', 'success');
                closeDeleteAttachmentModal();
                
                // 重新加载附件列表
                await loadAttachmentsForModal(currentEquipmentForAttachments);
            } catch (error) {
                console.error('删除附件失败:', error);
                showNotification('删除附件失败: ' + error.message, 'error');
            }
        }

        // 关闭附件删除确认模态框
        function closeDeleteAttachmentModal() {
            hideModal('deleteAttachmentModal');
            currentDeleteAttachmentId = null;
        }

        // 附件删除确认模态框点击外部关闭（已合并到setupModalEventListeners函数中）
        
    </script>
    <script src="/static/js/tailwind-components.js"></script>

    <!-- 附件删除确认模态框 -->
    <div id="deleteAttachmentModal" class="modal hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认删除附件</h3>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">您确定要删除这个附件吗？</p>
                            <p class="text-sm text-red-600 mt-1">删除后无法恢复，请谨慎操作。</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeDeleteAttachmentModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmDeleteAttachment()">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>