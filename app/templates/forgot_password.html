<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘记密码 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/notification-manager.js?v=2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(2px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.completed {
            background: #10B981;
            color: white;
        }
        .step-indicator.active {
            background: #3B82F6;
            color: white;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center">
    <!-- 通知容器 -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] space-y-2"></div>

    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 fade-in">
        <!-- Logo和标题 -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-full mb-4">
                <i class="fas fa-key text-2xl text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">重置密码</h1>
            <p class="text-white/70">管理员密码找回</p>
        </div>

        <!-- 步骤指示器 -->
        <div class="flex items-center justify-center space-x-4 mb-8">
            <div class="step-indicator active w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-sm font-semibold">
                1
            </div>
            <div class="w-8 h-0.5 bg-gray-400"></div>
            <div class="step-indicator w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-sm font-semibold">
                2
            </div>
            <div class="w-8 h-0.5 bg-gray-400"></div>
            <div class="step-indicator w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-sm font-semibold">
                3
            </div>
        </div>

        <!-- 步骤1：输入用户名 -->
        <div id="step1" class="step active">
            <h3 class="text-lg font-semibold text-white mb-4 text-center">第一步：输入管理员用户名</h3>
            <form id="usernameForm" class="space-y-6">
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">
                        <i class="fas fa-user mr-2"></i>
                        管理员用户名
                    </label>
                    <input
                        type="text"
                        id="username"
                        required
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                        placeholder="请输入管理员用户名"
                        autocomplete="username"
                    >
                </div>
                
                <button
                    type="submit"
                    class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-arrow-right mr-2"></i>
                    下一步
                </button>
            </form>
        </div>

        <!-- 步骤2：回答安全问题 -->
        <div id="step2" class="step">
            <h3 class="text-lg font-semibold text-white mb-4 text-center">第二步：回答安全问题</h3>
            <div class="bg-blue-50/10 border border-blue-200/20 rounded-lg p-4 mb-6">
                <p id="securityQuestion" class="text-white text-sm"></p>
            </div>
            
            <form id="securityForm" class="space-y-6">
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">
                        <i class="fas fa-question-circle mr-2"></i>
                        您的答案
                    </label>
                    <input
                        type="text"
                        id="securityAnswer"
                        required
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                        placeholder="请输入答案"
                    >
                </div>
                
                <div class="flex space-x-3">
                    <button
                        type="button"
                        id="backToStep1"
                        class="flex-1 bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-700"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>
                        上一步
                    </button>
                    <button
                        type="submit"
                        class="flex-1 btn-primary text-white font-semibold py-3 px-4 rounded-lg"
                    >
                        <i class="fas fa-arrow-right mr-2"></i>
                        下一步
                    </button>
                </div>
            </form>
        </div>

        <!-- 步骤3：设置新密码 -->
        <div id="step3" class="step">
            <h3 class="text-lg font-semibold text-white mb-4 text-center">第三步：设置新密码</h3>
            
            <form id="resetPasswordForm" class="space-y-4">
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">新密码</label>
                    <div class="relative">
                        <input
                            type="password"
                            id="newPassword"
                            required
                            class="w-full px-4 py-3 pr-12 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400"
                            placeholder="请输入新密码（6位以上）"
                        >
                        <button
                            type="button"
                            id="toggleNewPassword"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/50 hover:text-white"
                        >
                            <i class="fas fa-eye" id="newEyeIcon"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">确认密码</label>
                    <div class="relative">
                        <input
                            type="password"
                            id="confirmPassword"
                            required
                            class="w-full px-4 py-3 pr-12 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400"
                            placeholder="请再次输入新密码"
                        >
                        <button
                            type="button"
                            id="toggleConfirmPassword"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/50 hover:text-white"
                        >
                            <i class="fas fa-eye" id="confirmEyeIcon"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-blue-50/10 border border-blue-200/20 rounded-lg p-3">
                    <h4 class="text-white font-medium text-sm mb-2">密码要求：</h4>
                    <ul class="text-xs space-y-2">
                        <li id="lengthCheck" class="flex items-center">
                            <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                            <span class="text-white/70">至少6个字符长度</span>
                        </li>
                        <li id="matchCheck" class="flex items-center">
                            <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                            <span class="text-white/70">两次密码输入一致</span>
                        </li>
                    </ul>
                </div>

                <div class="flex space-x-3">
                    <button
                        type="button"
                        id="backToStep2"
                        class="flex-1 bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-700"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>
                        上一步
                    </button>
                    <button
                        type="submit"
                        class="flex-1 btn-primary text-white font-semibold py-3 px-4 rounded-lg"
                    >
                        <i class="fas fa-save mr-2"></i>
                        重置密码
                    </button>
                </div>
            </form>
        </div>

        <!-- 返回登录链接 -->
        <div class="mt-8 text-center">
            <a href="/login" class="text-white/70 hover:text-white transition-colors text-sm">
                <i class="fas fa-arrow-left mr-1"></i>
                返回登录页面
            </a>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUsername = '';
        let resetToken = '';

        // 通知函数
        
        // 步骤切换函数
        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNumber}`).classList.add('active');
            
            // 更新步骤指示器
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index < stepNumber - 1) {
                    indicator.classList.add('completed');
                } else if (index === stepNumber - 1) {
                    indicator.classList.add('active');
                }
            });
        }

        // 密码显示/隐藏切换功能
        function setupPasswordToggle(toggleId, inputId, iconId) {
            document.getElementById(toggleId).addEventListener('click', function() {
                const passwordInput = document.getElementById(inputId);
                const eyeIcon = document.getElementById(iconId);
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.className = 'fas fa-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.className = 'fas fa-eye';
                }
            });
        }

        setupPasswordToggle('toggleNewPassword', 'newPassword', 'newEyeIcon');
        setupPasswordToggle('toggleConfirmPassword', 'confirmPassword', 'confirmEyeIcon');

        // 密码验证函数
        function updatePasswordCheck(checkId, isValid) {
            const checkElement = document.getElementById(checkId);
            const icon = checkElement.querySelector('i');
            const text = checkElement.querySelector('span');
            
            if (isValid) {
                icon.className = 'fas fa-check text-green-500 mr-2 w-4';
                text.className = 'text-green-400';
            } else {
                icon.className = 'fas fa-times text-red-500 mr-2 w-4';
                text.className = 'text-white/70';
            }
        }

        function validatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // 检查长度
            updatePasswordCheck('lengthCheck', newPassword.length >= 6);
            
            // 检查密码匹配
            if (newPassword && confirmPassword) {
                updatePasswordCheck('matchCheck', newPassword === confirmPassword);
            } else {
                updatePasswordCheck('matchCheck', false);
            }
            
            return newPassword.length >= 6 && 
                   newPassword === confirmPassword && 
                   confirmPassword !== '';
        }

        // 为密码字段添加实时验证
        document.getElementById('newPassword').addEventListener('input', validatePassword);
        document.getElementById('confirmPassword').addEventListener('input', validatePassword);

        // 步骤1：获取安全问题
        document.getElementById('usernameForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showNotification('请输入用户名', 'error');
                return;
            }

            currentUsername = username;

            try {
                const response = await fetch('/api/users/forgot-password/security-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: username })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('securityQuestion').textContent = data.security_question;
                    showStep(2);
                    showNotification('请回答安全问题', 'info');
                } else {
                    showNotification(data.detail || '获取安全问题失败', 'error');
                }
            } catch (error) {
                console.error('获取安全问题错误:', error);
                showNotification('网络错误，请稍后再试', 'error');
            }
        });

        // 步骤2：验证安全答案
        document.getElementById('securityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const securityAnswer = document.getElementById('securityAnswer').value.trim();
            if (!securityAnswer) {
                showNotification('请输入安全问题的答案', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users/forgot-password/verify-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: currentUsername,
                        security_answer: securityAnswer
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resetToken = data.reset_token;
                    showStep(3);
                    showNotification('安全答案验证成功，请设置新密码', 'success');
                } else {
                    showNotification(data.detail || '安全答案验证失败', 'error');
                }
            } catch (error) {
                console.error('验证安全答案错误:', error);
                showNotification('网络错误，请稍后再试', 'error');
            }
        });

        // 步骤3：重置密码
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validatePassword()) {
                showNotification('请确保密码满足所有要求', 'error');
                return;
            }

            const newPassword = document.getElementById('newPassword').value;

            try {
                const response = await fetch('/api/users/forgot-password/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: currentUsername,
                        reset_token: resetToken,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('密码重置成功！即将跳转到登录页面...', 'success');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showNotification(data.detail || '密码重置失败', 'error');
                }
            } catch (error) {
                console.error('重置密码错误:', error);
                showNotification('网络错误，请稍后再试', 'error');
            }
        });

        // 返回按钮事件
        document.getElementById('backToStep1').addEventListener('click', () => showStep(1));
        document.getElementById('backToStep2').addEventListener('click', () => showStep(2));
    </script>
</body>
</html>