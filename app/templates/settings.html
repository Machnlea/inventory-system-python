<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统设置 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/session-manager.js?v=2"></script>
    <script src="/static/js/api-client.js?v=20250918-1"></script>
    <script src="/static/js/notification-manager.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(2px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #667eea;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 设置页面卡片样式优化 */
        .settings-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }
        .settings-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        .settings-header {
            padding: 1.5rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(to right, #f9fafb, #ffffff);
        }
        .settings-content {
            padding: 1.5rem 1.5rem;
        }
        .settings-content .space-y-4 > * + * {
            margin-top: 1rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: transparent;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .form-select:focus {
            outline: none;
            border-color: transparent;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        
        /* 管理工具卡片样式 */
        .management-tool-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: all 0.2s ease-in-out;
        }
        .management-tool-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        .form-checkbox {
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #3b82f6;
            transition: color 0.2s ease-in-out;
        }
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .btn-action {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn-action:hover {
            transform: translateY(-2px);
        }
        .btn-save {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            color: white;
        }
        .btn-save:hover {
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }
        .btn-reset {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-reset:hover {
            background-color: #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* 设置项分组样式 */
        .setting-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .setting-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .setting-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- 主容器 -->
    <div class="flex h-screen">
        <!-- 左侧导航栏 -->
        <div class="w-64 gradient-bg shadow-xl fixed left-0 top-0 h-full z-10">
            <div class="flex flex-col h-full">
                <!-- Logo和标题 -->
                <div class="flex items-center justify-center h-16 px-4 border-b border-white/20">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-list text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-lg font-bold">设备台账管理系统</h1>
                    </div>
                </div>

                <!-- 导航菜单 -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="/dashboard" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="/equipment" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-cogs mr-3 text-lg"></i>
                        <span>设备管理</span>
                    </a>
                          <a href="/reports" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="reports-link">
                        <i class="fas fa-chart-bar mr-3 text-lg"></i>
                        <span>统计报表</span>
                    </a>
                    
                    <!-- 系统管理下拉菜单 -->
                    <div class="relative">
                        <button class="sidebar-item flex items-center justify-between w-full px-4 py-3 text-white/90 rounded-lg" id="system-menu-btn" aria-label="展开系统管理菜单" aria-expanded="false">
                            <div class="flex items-center">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                <span>系统管理</span>
                            </div>
                            <i class="fas fa-chevron-down text-sm transition-transform duration-200" id="system-menu-arrow"></i>
                        </button>
                        <div class="ml-4 mt-1 space-y-1 hidden" id="system-submenu">
                            <a href="/categories" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="categories-link">
                                <i class="fas fa-tags mr-3"></i>
                                <span>设备类别</span>
                            </a>
                            <a href="/departments" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-building mr-3"></i>
                                <span>部门管理</span>
                            </a>
                            <a href="/users" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-users mr-3"></i>
                                <span>用户管理</span>
                            </a>
                            <a href="/audit" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="audit-link">
                                <i class="fas fa-history mr-3"></i>
                                <span>操作日志</span>
                            </a>
                            <!-- 系统设置 - 仅管理员可见 -->
                            <a href="/settings" class="sidebar-item flex items-center px-4 py-2 text-white rounded-lg text-sm" id="settings-link" style="display: none;">
                                <i class="fas fa-cog mr-3"></i>
                                <span>系统设置</span>
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- 用户信息 -->
                <div class="border-t border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-white text-xl mr-3"></i>
                            <div>
                                <p class="text-white text-base font-medium" id="current-user"></p>
                            </div>
                        </div>
                        <button class="text-white/70 hover:text-white transition-colors" id="logout-btn" aria-label="退出登录">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="flex-1 flex flex-col overflow-hidden ml-64">
            <!-- 顶部导航 -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="flex items-center justify-between px-6 py-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">系统设置</h2>
                        <p class="text-gray-600 mt-1">管理系统配置和参数</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">管理员</span>
                        <img src="https://ui-avatars.com/api/?name=admin&background=667eea&color=fff" alt="用户头像" class="w-8 h-8 rounded-full">
                    </div>
                </div>
            </header>

            <!-- 设置内容 -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
                <div class="max-w-4xl mx-auto">
                    <!-- 界面设置 -->
                    <div class="settings-card mb-6 fade-in">
                        <div class="settings-header">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-palette mr-2 text-purple-600"></i>
                                界面设置
                            </h3>
                        </div>
                        <div class="settings-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="setting-label">主题模式</label>
                                    <select id="themeMode" class="form-select">
                                        <option value="light" selected>浅色主题</option>
                                        <option value="dark">深色主题</option>
                                        <option value="auto">跟随系统</option>
                                    </select>
                                </div>
                              </div>
                        </div>
                    </div>

                    <!-- 安全设置 -->
                    <div class="settings-card mb-6 fade-in">
                        <div class="settings-header">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-shield-alt mr-2 text-green-600"></i>
                                安全设置
                            </h3>
                        </div>
                        <div class="settings-content">
                            <!-- 安全问题设置 -->
                            <div class="setting-group">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-md font-semibold text-gray-800">密码重置安全问题</h4>
                                    <span id="securityQuestionStatus" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">未设置</span>
                                </div>
                                
                                <div id="securityQuestionDisplay" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                                    <p class="text-sm text-blue-700 mb-2">当前安全问题：</p>
                                    <p id="currentSecurityQuestion" class="text-gray-700 font-medium"></p>
                                </div>
                                
                                <!-- 修改安全问题按钮（独立于表单外） -->
                                <div id="updateSecurityQuestionBtn" class="hidden mb-4">
                                    <button id="updateSecurityQuestion" onclick="showUpdateSecurityQuestion()" 
                                            class="btn-action btn-save">
                                        <i class="fas fa-edit mr-1"></i>
                                        修改安全问题
                                    </button>
                                </div>
                                
                                <div id="securityQuestionForm" class="space-y-4">
                                    <div>
                                        <label class="setting-label">安全问题</label>
                                        <input type="text" id="securityQuestion" placeholder="请输入您的安全问题，例如：您的出生地是哪里？"
                                               class="form-input">
                                    </div>
                                    <div>
                                        <label class="setting-label">安全答案</label>
                                        <input type="text" id="securityAnswer" placeholder="请输入安全问题的答案"
                                               class="form-input">
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="saveSecurityQuestion" onclick="saveSecurityQuestion()" 
                                                class="btn-action btn-save">
                                            <i class="fas fa-save mr-1"></i>
                                            <span id="saveSecurityQuestionText">设置安全问题</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                    <div class="flex">
                                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-0.5"></i>
                                        <div class="text-sm text-yellow-700">
                                            <p class="font-medium">重要提醒：</p>
                                            <ul class="mt-1 list-disc list-inside">
                                                <li>安全问题用于管理员忘记密码时的身份验证</li>
                                                <li>请设置只有您知道答案的问题</li>
                                                <li>答案不区分大小写，但请记住准确内容</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="setting-label">会话超时时间（小时）</label>
                                    <input type="number" id="sessionTimeout" value="2" min="1" max="24"
                                           class="form-input">
                                </div>
                                <div>
                                    <label class="setting-label">密码最小长度</label>
                                    <input type="number" id="minPasswordLength" value="6" min="4" max="20"
                                           class="form-input">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableTwoFactor" class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">启用双因素认证</span>
                                    </label>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableLoginLog" checked class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">记录登录日志</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 设备管理设置 -->
  
                    <!-- 通知设置 -->
                    <div class="settings-card mb-6 fade-in">
                        <div class="settings-header">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-bell mr-2 text-yellow-600"></i>
                                通知设置
                            </h3>
                        </div>
                        <div class="settings-content">
                            <div class="space-y-4">
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableEmailNotification" checked class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">启用邮件通知</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableExpirationReminder" checked class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">设备到期提醒</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableCalibrationReminder" checked class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">检定提醒</span>
                                    </label>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="setting-label">提醒提前天数</label>
                                        <input type="number" id="reminderDays" value="7" min="1" max="30"
                                               class="form-input">
                                    </div>
                                    <div>
                                        <label class="setting-label">SMTP服务器</label>
                                        <input type="text" id="smtpServer" placeholder="smtp.example.com"
                                               class="form-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 数据管理设置 -->
                    <div class="settings-card mb-6 fade-in">
                        <div class="settings-header">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-database mr-2 text-purple-600"></i>
                                数据管理设置
                            </h3>
                        </div>
                        <div class="settings-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableAutoBackup" checked class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">启用自动备份</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableAutoCleanup" class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">启用自动清理</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="setting-label">备份频率</label>
                                    <select id="backupFrequency" class="form-select">
                                        <option value="daily">每日</option>
                                        <option value="weekly" selected>每周</option>
                                        <option value="monthly">每月</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="setting-label">备份保留天数</label>
                                    <input type="number" id="backupRetention" value="30" min="7" max="365"
                                           class="form-input">
                                </div>
                                <div>
                                    <label class="setting-label">备份路径</label>
                                    <input type="text" id="backupPath" value="./backups"
                                           class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统管理工具 -->
                    <div class="settings-card mb-6 fade-in">
                        <div class="settings-header">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-tools mr-2 text-indigo-600"></i>
                                系统管理工具
                            </h3>
                        </div>
                        <div class="settings-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- 日志管理 -->
                                <div class="management-tool-card">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-file-alt text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">日志管理</h4>
                                            <p class="text-sm text-gray-500">查看系统日志</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">
                                        查看和分析系统运行日志、错误日志、安全日志和API访问日志
                                    </p>
                                    <button onclick="openLogViewer()" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                        <i class="fas fa-external-link-alt mr-2"></i>
                                        打开日志查看器
                                    </button>
                                </div>

                                <!-- 系统监控 -->
                                <div class="management-tool-card">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-chart-line text-green-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">系统监控</h4>
                                            <p class="text-sm text-gray-500">性能监控</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">
                                        监控系统性能、资源使用情况和运行状态
                                    </p>
                                    <button onclick="showSystemStats()" class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                        <i class="fas fa-tachometer-alt mr-2"></i>
                                        查看系统状态
                                    </button>
                                </div>

                                <!-- 数据库管理 -->
                                <div class="management-tool-card">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-database text-purple-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">数据库管理</h4>
                                            <p class="text-sm text-gray-500">数据维护</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">
                                        数据库备份、恢复和优化工具
                                    </p>
                                    <button onclick="showDatabaseTools()" class="w-full bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors">
                                        <i class="fas fa-wrench mr-2"></i>
                                        数据库工具
                                    </button>
                                </div>

                                <!-- 安全审计 -->
                                <div class="management-tool-card">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-shield-alt text-red-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">安全审计</h4>
                                            <p class="text-sm text-gray-500">安全检查</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">
                                        查看安全事件、登录记录和权限审计
                                    </p>
                                    <button onclick="showSecurityAudit()" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors">
                                        <i class="fas fa-search mr-2"></i>
                                        安全审计
                                    </button>
                                </div>

                                <!-- 系统清理 -->
                                <div class="management-tool-card">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-broom text-yellow-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">系统清理</h4>
                                            <p class="text-sm text-gray-500">清理工具</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">
                                        清理临时文件、过期日志和无用数据
                                    </p>
                                    <button onclick="showCleanupTools()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition-colors">
                                        <i class="fas fa-trash-alt mr-2"></i>
                                        清理工具
                                    </button>
                                </div>

                                <!-- API文档 -->
                                <div class="management-tool-card">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-book text-indigo-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">API文档</h4>
                                            <p class="text-sm text-gray-500">开发文档</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">
                                        查看系统API文档和接口说明
                                    </p>
                                    <button onclick="openApiDocs()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition-colors">
                                        <i class="fas fa-external-link-alt mr-2"></i>
                                        API文档
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex justify-end space-x-4">
                        <button onclick="resetSettings()" class="btn-action btn-reset">
                            <i class="fas fa-undo mr-2"></i>
                            重置默认
                        </button>
                        <button onclick="saveSettings()" class="btn-action btn-save">
                            <i class="fas fa-save mr-2"></i>
                            保存设置
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 显示通知 - 使用统一通知管理器
        function showNotification(message, type = 'info') {
            // 优先使用全局通知管理器
            if (window.notificationManager) {
                window.notificationManager.show(message, type);
                return;
            }
            
            // 备用实现：如果通知管理器未加载
            const container = document.getElementById('notification-container');
            if (!container) {
                const newContainer = document.createElement('div');
                newContainer.id = 'notification-container';
                newContainer.className = 'fixed top-4 right-4 z-[9999] space-y-2 w-72';
                document.body.appendChild(newContainer);
            }
            
            const notification = document.createElement('div');
            
            // 设置颜色方案 - 基于统一样式设计
            const colors = {
                success: {
                    bg: 'bg-white',
                    border: 'border-l-green-500',
                    icon: 'fas fa-check-circle text-green-600',
                    text: 'text-green-900'
                },
                error: {
                    bg: 'bg-white',
                    border: 'border-l-red-500',
                    icon: 'fas fa-exclamation-circle text-red-600',
                    text: 'text-red-900'
                },
                warning: {
                    bg: 'bg-white',
                    border: 'border-l-yellow-500',
                    icon: 'fas fa-exclamation-triangle text-yellow-600',
                    text: 'text-yellow-900'
                },
                info: {
                    bg: 'bg-white',
                    border: 'border-l-blue-500',
                    icon: 'fas fa-info-circle text-blue-600',
                    text: 'text-blue-900'
                }
            };
            
            const colorScheme = colors[type] || colors.info;
            
            notification.className = `${colorScheme.bg} ${colorScheme.border} border-l-4 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            notification.style.marginBottom = '12px';
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="${colorScheme.icon} text-xl mr-3"></i>
                    <span class="${colorScheme.text} font-medium">${message}</span>
                    <div class="ml-auto pl-3">
                        <button onclick="this.closest('.transform').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            const targetContainer = document.getElementById('notification-container');
            targetContainer.appendChild(notification);
            
            // 触发动画
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 3秒后自动消失
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        
        // 加载安全问题状态
        async function loadSecurityQuestionStatus() {
            try {
                const response = await fetch('/api/users/security-question/status', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    const statusEl = document.getElementById('securityQuestionStatus');
                    const displayEl = document.getElementById('securityQuestionDisplay');
                    const questionEl = document.getElementById('currentSecurityQuestion');
                    const saveBtn = document.getElementById('saveSecurityQuestion');
                    const updateBtnContainer = document.getElementById('updateSecurityQuestionBtn');
                    const saveText = document.getElementById('saveSecurityQuestionText');

                    if (data.has_security_question) {
                        statusEl.textContent = '已设置';
                        statusEl.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
                        displayEl.classList.remove('hidden');
                        questionEl.textContent = data.security_question;
                        
                        // 显示修改按钮，隐藏表单
                        updateBtnContainer.classList.remove('hidden');
                        document.getElementById('securityQuestionForm').style.display = 'none';
                    } else {
                        statusEl.textContent = '未设置';
                        statusEl.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-700';
                        displayEl.classList.add('hidden');
                        
                        // 隐藏修改按钮，显示设置表单
                        updateBtnContainer.classList.add('hidden');
                        document.getElementById('securityQuestionForm').style.display = 'block';
                        saveText.textContent = '设置安全问题';
                    }
                }
            } catch (error) {
                console.error('加载安全问题状态失败:', error);
            }
        }

        // 保存安全问题
        async function saveSecurityQuestion() {
            const question = document.getElementById('securityQuestion').value.trim();
            const answer = document.getElementById('securityAnswer').value.trim();

            if (!question || !answer) {
                showNotification('请填写安全问题和答案', 'error');
                return;
            }

            if (question.length < 5) {
                showNotification('安全问题至少需要5个字符', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users/security-question/setup', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        security_question: question,
                        security_answer: answer
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(data.message, 'success');
                    
                    // 清空输入框
                    document.getElementById('securityQuestion').value = '';
                    document.getElementById('securityAnswer').value = '';
                    
                    // 重新加载状态
                    await loadSecurityQuestionStatus();
                } else {
                    const errorData = await response.json();
                    showNotification(errorData.detail || '设置安全问题失败', 'error');
                }
            } catch (error) {
                console.error('设置安全问题失败:', error);
                showNotification('网络错误，请稍后再试', 'error');
            }
        }

        // 显示修改安全问题表单
        function showUpdateSecurityQuestion() {
            const formEl = document.getElementById('securityQuestionForm');
            const updateBtnContainer = document.getElementById('updateSecurityQuestionBtn');
            const saveText = document.getElementById('saveSecurityQuestionText');

            // 隐藏修改按钮，显示表单
            updateBtnContainer.classList.add('hidden');
            formEl.style.display = 'block';
            saveText.textContent = '更新安全问题';
            
            // 将现有问题填入表单
            const currentQuestion = document.getElementById('currentSecurityQuestion').textContent;
            document.getElementById('securityQuestion').value = currentQuestion;
            document.getElementById('securityAnswer').value = '';
            document.getElementById('securityAnswer').focus();
        }

        // 加载设置
        async function loadSettings() {
            try {
                const response = await SystemAPI.getSettings();
                const settings = response.data || response;
                
                // 填充表单
                document.getElementById('themeMode').value = settings.themeMode || 'light';
                document.getElementById('sessionTimeout').value = settings.sessionTimeout || 2;
                document.getElementById('minPasswordLength').value = settings.minPasswordLength || 6;
                document.getElementById('enableTwoFactor').checked = settings.enableTwoFactor || false;
                document.getElementById('enableLoginLog').checked = settings.enableLoginLog !== false;
                
                  
                // 通知设置
                document.getElementById('enableEmailNotification').checked = settings.enableEmailNotification !== false;
                document.getElementById('enableExpirationReminder').checked = settings.enableExpirationReminder !== false;
                document.getElementById('enableCalibrationReminder').checked = settings.enableCalibrationReminder !== false;
                document.getElementById('reminderDays').value = settings.reminderDays || 7;
                document.getElementById('smtpServer').value = settings.smtpServer || '';
                
                // 数据管理设置
                document.getElementById('enableAutoBackup').checked = settings.enableAutoBackup !== false;
                document.getElementById('enableAutoCleanup').checked = settings.enableAutoCleanup || false;
                document.getElementById('backupFrequency').value = settings.backupFrequency || 'weekly';
                document.getElementById('backupRetention').value = settings.backupRetention || 30;
                document.getElementById('backupPath').value = settings.backupPath || './backups';
                
                showNotification('设置加载成功', 'success');
                
            } catch (error) {
                console.error('加载设置失败:', error);
                showNotification('加载设置失败: ' + (error.message || '网络错误'), 'error');
            }
        }

        // 保存设置
        async function saveSettings() {
            try {
                const settings = {
                    // 界面设置
                    themeMode: document.getElementById('themeMode').value,
                    
                    // 安全设置
                    sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                    minPasswordLength: parseInt(document.getElementById('minPasswordLength').value),
                    enableTwoFactor: document.getElementById('enableTwoFactor').checked,
                    enableLoginLog: document.getElementById('enableLoginLog').checked,
                    
                       
                    // 通知设置
                    enableEmailNotification: document.getElementById('enableEmailNotification').checked,
                    enableExpirationReminder: document.getElementById('enableExpirationReminder').checked,
                    enableCalibrationReminder: document.getElementById('enableCalibrationReminder').checked,
                    reminderDays: parseInt(document.getElementById('reminderDays').value),
                    smtpServer: document.getElementById('smtpServer').value,
                    
                    // 数据管理设置
                    enableAutoBackup: document.getElementById('enableAutoBackup').checked,
                    enableAutoCleanup: document.getElementById('enableAutoCleanup').checked,
                    backupFrequency: document.getElementById('backupFrequency').value,
                    backupRetention: parseInt(document.getElementById('backupRetention').value),
                    backupPath: document.getElementById('backupPath').value
                };

                const response = await SystemAPI.updateSettings(settings);
                showNotification('设置保存成功', 'success');
                
            } catch (error) {
                console.error('保存设置失败:', error);
                const errorMessage = error.response?.data?.detail || error.message || '保存设置失败';
                showNotification('保存设置失败: ' + errorMessage, 'error');
            }
        }

        // 重置设置
        async function resetSettings() {
            if (confirm('确定要重置所有设置为默认值吗？此操作不可撤销。')) {
                try {
                    const response = await SystemAPI.resetSettings();
                    const defaultSettings = response.data || response.settings;
                    
                    // 重新加载页面以应用默认设置
                    await loadSettings();
                    showNotification('设置已重置为默认值', 'success');
                    
                } catch (error) {
                    console.error('重置设置失败:', error);
                    const errorMessage = error.response?.data?.detail || error.message || '重置设置失败';
                    showNotification('重置设置失败: ' + errorMessage, 'error');
                }
            }
        }

  
        // 添加输入验证
        function addInputValidation() {

            // 会话超时验证
            const sessionTimeoutInput = document.getElementById('sessionTimeout');
            sessionTimeoutInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1 || value > 24) {
                    this.setCustomValidity('会话超时时间必须在1-24小时之间');
                } else {
                    this.setCustomValidity('');
                }
            });

            // 密码长度验证
            const minPasswordLengthInput = document.getElementById('minPasswordLength');
            minPasswordLengthInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 4 || value > 20) {
                    this.setCustomValidity('密码最小长度必须在4-20之间');
                } else {
                    this.setCustomValidity('');
                }
            });

            // 提醒天数验证
            const reminderDaysInput = document.getElementById('reminderDays');
            reminderDaysInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1 || value > 30) {
                    this.setCustomValidity('提醒提前天数必须在1-30之间');
                } else {
                    this.setCustomValidity('');
                }
            });

            // 备份保留天数验证
            const backupRetentionInput = document.getElementById('backupRetention');
            backupRetentionInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 7 || value > 365) {
                    this.setCustomValidity('备份保留天数必须在7-365之间');
                } else {
                    this.setCustomValidity('');
                }
            });
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 首先检查用户权限
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                
                // 如果不是管理员，重定向到仪表盘
                if (!user.is_admin) {
                    window.location.href = '/dashboard';
                    return;
                }
            } else {
                // 如果未登录，重定向到登录页面
                window.location.href = '/login';
                return;
            }
            
            checkUserPermissions(); // 检查用户权限
            addInputValidation();
            loadSettings();
            loadSecurityQuestionStatus();
            setupSidebarNavigation();
            setCurrentPageActive();
        });

        // 检查用户权限并显示/隐藏系统设置菜单
        function checkUserPermissions() {
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const settingsLink = document.getElementById('settings-link');
                
                // 仅当用户是管理员时显示系统设置菜单
                if (user.is_admin && settingsLink) {
                    settingsLink.style.display = 'flex';
                } else if (settingsLink) {
                    settingsLink.style.display = 'none';
                }
            }
        }

        // 设置侧边栏导航
        function setupSidebarNavigation() {
            // 系统管理下拉菜单
            const systemMenuBtn = document.getElementById('system-menu-btn');
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            
            if (systemMenuBtn) {
                systemMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 切换子菜单显示
                    systemSubmenu.classList.toggle('hidden');
                    
                    // 旋转箭头
                    if (systemSubmenu.classList.contains('hidden')) {
                        systemMenuArrow.style.transform = 'rotate(0deg)';
                    } else {
                        systemMenuArrow.style.transform = 'rotate(180deg)';
                    }
                });
            }
            
            // 退出登录
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('确定要退出登录吗？')) {
                        // 先调用后端登出API销毁会话
                        const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                        if (token) {
                            fetch('/api/auth/logout', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Logout response:', data);
                            })
                            .catch(error => {
                                console.error('Logout error:', error);
                            })
                            .finally(() => {
                                // 清除本地存储
                                sessionStorage.removeItem('access_token');
                                sessionStorage.removeItem('refresh_token');
                                sessionStorage.removeItem('user_info');
                                localStorage.removeItem('access_token');
                                localStorage.removeItem('refresh_token');
                                localStorage.removeItem('user_info');
                                
                                // 跳转到登录页面
                                window.location.href = '/login';
                            });
                        } else {
                            // 如果没有token，直接清除并跳转
                            sessionStorage.removeItem('access_token');
                            sessionStorage.removeItem('refresh_token');
                            sessionStorage.removeItem('user_info');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            localStorage.removeItem('user_info');
                            
                            // 跳转到登录页面
                            window.location.href = '/login';
                        }
                    }
                });
            }
            
            // 检查登录状态
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const currentUserElement = document.getElementById('current-user');
                if (currentUserElement) {
                    currentUserElement.textContent = user.username || '用户';
                    currentUserElement.style.visibility = 'visible'; // 显示用户信息
                }
            }
        }

        // 系统管理工具函数
        async function openLogViewer() {
            try {
                const response = await api.get('/api/logs/stats?hours=24');
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between p-6 border-b">
                            <h3 class="text-xl font-semibold">日志管理</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <!-- 统计信息 -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-blue-600">总日志数</p>
                                            <p class="text-2xl font-bold text-blue-700">${response.total_logs || 0}</p>
                                        </div>
                                        <i class="fas fa-file-alt text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-red-600">错误数</p>
                                            <p class="text-2xl font-bold text-red-700">${response.errors || 0}</p>
                                        </div>
                                        <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-yellow-600">安全事件</p>
                                            <p class="text-2xl font-bold text-yellow-700">${response.security_events || 0}</p>
                                        </div>
                                        <i class="fas fa-shield-alt text-yellow-600 text-xl"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-green-600">API请求</p>
                                            <p class="text-2xl font-bold text-green-700">${response.api_requests || 0}</p>
                                        </div>
                                        <i class="fas fa-exchange-alt text-green-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 快速操作 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <button onclick="viewLogType('errors')" class="p-4 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                                        <span class="font-medium">错误日志</span>
                                    </div>
                                    <p class="text-sm text-gray-600">查看系统错误</p>
                                </button>
                                
                                <button onclick="viewLogType('security')" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg hover:bg-yellow-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-shield-alt text-yellow-600 mr-2"></i>
                                        <span class="font-medium">安全日志</span>
                                    </div>
                                    <p class="text-sm text-gray-600">查看安全事件</p>
                                </button>
                                
                                <button onclick="viewLogType('api')" class="p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exchange-alt text-green-600 mr-2"></i>
                                        <span class="font-medium">API日志</span>
                                    </div>
                                    <p class="text-sm text-gray-600">查看API访问</p>
                                </button>
                                
                                <button onclick="window.open('/logs', '_blank')" class="p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-external-link-alt text-blue-600 mr-2"></i>
                                        <span class="font-medium">完整日志</span>
                                    </div>
                                    <p class="text-sm text-gray-600">打开日志页面</p>
                                </button>
                            </div>
                            
                            <!-- 日志预览区域 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium mb-3">最新日志预览</h4>
                                <div class="bg-gray-900 text-green-400 p-4 rounded-md h-64 overflow-y-auto font-mono text-sm" id="logPreview">
                                    <div class="text-center text-gray-500 mt-20">
                                        点击上方按钮查看日志
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50">
                            <div class="flex justify-end">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    关闭
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('获取日志信息失败:', error);
                showNotification('获取日志信息失败: ' + error.message, 'error');
            }
        }

        // 查看特定类型的日志
        async function viewLogType(type) {
            try {
                const response = await api.get(`/api/logs/${type}?hours=24`);
                const logPreview = document.getElementById('logPreview');
                
                if (!response.logs || response.logs.length === 0) {
                    logPreview.innerHTML = '<div class="text-center text-gray-500 mt-20">没有找到日志</div>';
                    return;
                }
                
                let html = '';
                response.logs.forEach(log => {
                    const timestamp = log.timestamp || 'N/A';
                    const level = log.level || 'INFO';
                    const message = log.message || 'N/A';
                    const logger = log.logger || 'unknown';
                    
                    html += `<div class="mb-2 p-2 border-l-2 border-gray-600">`;
                    html += `<div class="flex items-start space-x-2">`;
                    html += `<span class="text-gray-400 text-xs">[${timestamp}]</span>`;
                    html += `<span class="text-${level === 'ERROR' ? 'red' : level === 'WARNING' ? 'yellow' : 'green'}-400 font-bold text-xs">${level}</span>`;
                    html += `<span class="text-blue-400 text-xs">${logger}</span>`;
                    html += `</div>`;
                    html += `<div class="mt-1 text-sm">${escapeHtml(message)}</div>`;
                    html += `</div>`;
                });
                
                logPreview.innerHTML = html;
                logPreview.scrollTop = 0;
                
            } catch (error) {
                console.error('获取日志失败:', error);
                showNotification('获取日志失败: ' + error.message, 'error');
            }
        }

        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function showSystemStats() {
            try {
                const response = await api.get('/api/system/status');
                
                // 创建系统状态模态框
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 overflow-y-auto">
                        <div class="flex items-center justify-between p-6 border-b">
                            <h3 class="text-xl font-semibold">系统状态监控</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- CPU使用率 -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-blue-900">CPU使用率</h4>
                                        <i class="fas fa-microchip text-blue-600"></i>
                                    </div>
                                    <div class="text-2xl font-bold text-blue-700">${response.cpu.cpu_percent.toFixed(1)}%</div>
                                    <div class="text-sm text-blue-600">核心数: ${response.cpu.cpu_count}</div>
                                </div>
                                
                                <!-- 内存使用率 -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-green-900">内存使用率</h4>
                                        <i class="fas fa-memory text-green-600"></i>
                                    </div>
                                    <div class="text-2xl font-bold text-green-700">${response.memory.percent.toFixed(1)}%</div>
                                    <div class="text-sm text-green-600">${formatBytes(response.memory.used)} / ${formatBytes(response.memory.total)}</div>
                                </div>
                                
                                <!-- 磁盘使用率 -->
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-purple-900">磁盘使用率</h4>
                                        <i class="fas fa-hdd text-purple-600"></i>
                                    </div>
                                    <div class="text-2xl font-bold text-purple-700">${response.disk.percent.toFixed(1)}%</div>
                                    <div class="text-sm text-purple-600">${formatBytes(response.disk.used)} / ${formatBytes(response.disk.total)}</div>
                                </div>
                                
                                <!-- 数据库状态 -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-yellow-900">数据库状态</h4>
                                        <i class="fas fa-database text-yellow-600"></i>
                                    </div>
                                    <div class="text-lg font-bold ${response.database.status === 'connected' ? 'text-green-700' : 'text-red-700'}">
                                        ${response.database.status === 'connected' ? '已连接' : '未连接'}
                                    </div>
                                    <div class="text-sm text-yellow-600">${response.database.message}</div>
                                </div>
                                
                                <!-- 日志文件 -->
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-indigo-900">日志文件</h4>
                                        <i class="fas fa-file-alt text-indigo-600"></i>
                                    </div>
                                    <div class="text-2xl font-bold text-indigo-700">${response.logs.total_files}</div>
                                    <div class="text-sm text-indigo-600">个日志文件</div>
                                </div>
                                
                                <!-- 上传文件 -->
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-red-900">上传文件</h4>
                                        <i class="fas fa-upload text-red-600"></i>
                                    </div>
                                    <div class="text-2xl font-bold text-red-700">${response.uploads.total_files}</div>
                                    <div class="text-sm text-red-600">${formatBytes(response.uploads.total_size)}</div>
                                </div>
                            </div>
                            
                            <!-- 系统信息 -->
                            <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium text-gray-900 mb-3">系统信息</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><strong>操作系统:</strong> ${response.system.platform} ${response.system.platform_release}</div>
                                    <div><strong>主机名:</strong> ${response.system.hostname}</div>
                                    <div><strong>架构:</strong> ${response.system.architecture}</div>
                                    <div><strong>Python版本:</strong> ${response.system.python_version}</div>
                                    <div><strong>进程ID:</strong> ${response.process.pid}</div>
                                    <div><strong>线程数:</strong> ${response.process.num_threads}</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50">
                            <div class="flex justify-end">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    关闭
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 点击背景关闭
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('获取系统状态失败:', error);
                showNotification('获取系统状态失败: ' + error.message, 'error');
            }
        }
        
        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function showDatabaseTools() {
            try {
                const response = await api.get('/api/system/database/status');
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between p-6 border-b">
                            <h3 class="text-xl font-semibold">数据库管理工具</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <!-- 数据库状态 -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-medium mb-3">数据库状态</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong>连接状态:</strong> <span class="text-green-600">已连接</span></div>
                                    <div><strong>数据库类型:</strong> SQLite</div>
                                    <div><strong>表数量:</strong> ${response.tables_count || 0}</div>
                                    <div><strong>数据库大小:</strong> ${formatBytes(response.database_size || 0)}</div>
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onclick="performDatabaseBackup()" class="p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-download text-blue-600 mr-2"></i>
                                        <span class="font-medium">创建备份</span>
                                    </div>
                                    <p class="text-sm text-gray-600">备份当前数据库</p>
                                </button>
                                
                                <button onclick="performDatabaseOptimize()" class="p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-wrench text-green-600 mr-2"></i>
                                        <span class="font-medium">优化数据库</span>
                                    </div>
                                    <p class="text-sm text-gray-600">清理和优化数据库</p>
                                </button>
                                
                                <button onclick="showDatabaseStatistics()" class="p-4 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                                        <span class="font-medium">数据统计</span>
                                    </div>
                                    <p class="text-sm text-gray-600">查看数据库统计信息</p>
                                </button>
                                
                                <button onclick="showBackupHistory()" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg hover:bg-yellow-100 transition-colors">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-history text-yellow-600 mr-2"></i>
                                        <span class="font-medium">备份历史</span>
                                    </div>
                                    <p class="text-sm text-gray-600">查看备份记录</p>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('获取数据库状态失败:', error);
                showNotification('获取数据库状态失败: ' + error.message, 'error');
            }
        }

        async function showSecurityAudit() {
            try {
                const response = await api.get('/api/system/security/audit');
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between p-6 border-b">
                            <h3 class="text-xl font-semibold">安全审计</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <!-- 安全概览 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-green-600">今日登录</p>
                                            <p class="text-2xl font-bold text-green-700">${response.today_logins || 0}</p>
                                        </div>
                                        <i class="fas fa-sign-in-alt text-green-600 text-xl"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-yellow-600">失败登录</p>
                                            <p class="text-2xl font-bold text-yellow-700">${response.failed_logins || 0}</p>
                                        </div>
                                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-red-600">安全事件</p>
                                            <p class="text-2xl font-bold text-red-700">${response.security_events || 0}</p>
                                        </div>
                                        <i class="fas fa-shield-alt text-red-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 权限审计 -->
                            <div>
                                <h4 class="font-medium mb-3">权限审计</h4>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-600">管理员用户数</p>
                                            <p class="text-lg font-semibold">${response.admin_users_count || 0}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">普通用户数</p>
                                            <p class="text-lg font-semibold">${response.normal_users_count || 0}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">有权限用户数</p>
                                            <p class="text-lg font-semibold">${response.users_with_permissions || 0}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">无权限用户数</p>
                                            <p class="text-lg font-semibold">${response.users_without_permissions || 0}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50">
                            <div class="flex justify-end">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    关闭
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('获取安全审计信息失败:', error);
                showNotification('获取安全审计信息失败: ' + error.message, 'error');
            }
        }

        async function showCleanupTools() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b">
                        <h3 class="text-xl font-semibold">系统清理工具</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <!-- 清理选项 -->
                            <div class="space-y-3">
                                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                    <input type="checkbox" id="cleanLogs" class="mr-3" checked>
                                    <div class="flex-1">
                                        <div class="font-medium">清理过期日志</div>
                                        <div class="text-sm text-gray-500">删除30天前的日志文件</div>
                                    </div>
                                </label>
                                
                                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                    <input type="checkbox" id="cleanTemp" class="mr-3" checked>
                                    <div class="flex-1">
                                        <div class="font-medium">清理临时文件</div>
                                        <div class="text-sm text-gray-500">删除系统临时文件和缓存</div>
                                    </div>
                                </label>
                                
                                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                    <input type="checkbox" id="cleanUploads" class="mr-3">
                                    <div class="flex-1">
                                        <div class="font-medium">清理孤立上传文件</div>
                                        <div class="text-sm text-gray-500">删除未关联到设备的上传文件</div>
                                    </div>
                                </label>
                                
                                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                    <input type="checkbox" id="cleanSessions" class="mr-3">
                                    <div class="flex-1">
                                        <div class="font-medium">清理过期会话</div>
                                        <div class="text-sm text-gray-500">删除过期的用户会话数据</div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- 警告信息 -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-0.5"></i>
                                    <div class="text-sm text-yellow-700">
                                        <p class="font-medium">注意事项：</p>
                                        <ul class="mt-1 list-disc list-inside">
                                            <li>清理操作不可撤销，请谨慎选择</li>
                                            <li>建议在系统维护时间进行清理</li>
                                            <li>清理前会自动创建备份</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t bg-gray-50">
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                取消
                            </button>
                            <button onclick="performSystemCleanup()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                <i class="fas fa-broom mr-2"></i>
                                开始清理
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openApiDocs() {
            // 在新标签页中打开API文档
            window.open('/docs', '_blank');
        }

        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 执行数据库备份
        async function performDatabaseBackup() {
            try {
                // 显示备份选项对话框
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-md w-full mx-4">
                        <div class="flex items-center justify-between p-6 border-b">
                            <h3 class="text-xl font-semibold">创建数据库备份</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="mb-4">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="includeFiles" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-gray-700">同时备份上传的文件（证书、文档等）</span>
                                </label>
                                <p class="text-sm text-gray-500 mt-2 ml-7">
                                    选择此项会将所有上传的文件一起打包到备份中，备份文件会更大但更完整
                                </p>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    取消
                                </button>
                                <button onclick="confirmDatabaseBackup()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    开始备份
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('显示备份选项失败:', error);
                showNotification('显示备份选项失败: ' + error.message, 'error');
            }
        }

        // 确认并执行数据库备份
        async function confirmDatabaseBackup() {
            const includeFiles = document.getElementById('includeFiles').checked;
            const modal = document.querySelector('.fixed.z-\\[3000\\]');
            
            try {
                // 更新模态框显示进度
                modal.querySelector('.p-6').innerHTML = `
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-700">${includeFiles ? '正在创建完整备份（数据库+文件）...' : '正在创建数据库备份...'}</p>
                    </div>
                `;

                // 创建FormData发送表单数据
                const formData = new FormData();
                formData.append('include_files', includeFiles);
                
                // 直接使用fetch方式，避免API客户端版本问题
                const headers = api.getHeaders();
                delete headers['Content-Type'];  // 让浏览器自动设置multipart/form-data
                
                const response = await fetch('/api/system/database/backup', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '备份失败');
                }
                
                const result = await response.json();
                console.log('备份结果:', result);

                // 显示成功结果
                modal.querySelector('.p-6').innerHTML = `
                    <div class="text-center">
                        <div class="text-green-600 text-4xl mb-4">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-2">备份创建成功</h4>
                        <p class="text-gray-600 mb-4">备份文件: ${result.backup_file}</p>
                        <p class="text-sm text-gray-500 mb-4">文件大小: ${formatBytes(result.backup_size)}</p>
                        ${includeFiles ? `<p class="text-sm text-blue-600 mb-4"><i class="fas fa-info-circle"></i> 备份包含数据库和所有上传文件 (${result.files_count || 0} 个文件)</p>` : ''}
                        ${includeFiles && result.compression_ratio ? `<p class="text-sm text-green-600 mb-4">压缩率: ${result.compression_ratio}%</p>` : ''}
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            完成
                        </button>
                    </div>
                `;

                showNotification('数据库备份创建成功', 'success');
            } catch (error) {
                console.error('数据库备份失败:', error);
                modal.querySelector('.p-6').innerHTML = `
                    <div class="text-center">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-2">备份失败</h4>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                            关闭
                        </button>
                    </div>
                `;
                showNotification('数据库备份失败: ' + error.message, 'error');
            }
        }

        // 执行系统清理
        async function performSystemCleanup() {
            const cleanOptions = {
                clean_logs: document.getElementById('cleanLogs').checked,
                clean_temp: document.getElementById('cleanTemp').checked,
                clean_uploads: document.getElementById('cleanUploads').checked,
                clean_sessions: document.getElementById('cleanSessions').checked
            };

            if (!Object.values(cleanOptions).some(v => v)) {
                showNotification('请至少选择一个清理选项', 'warning');
                return;
            }

            if (!confirm('确定要执行系统清理吗？此操作不可撤销。')) {
                return;
            }

            try {
                showNotification('正在执行系统清理...', 'info');
                const response = await api.post('/api/system/cleanup', cleanOptions);
                showNotification('系统清理完成', 'success');
                
                // 关闭模态框
                document.querySelector('.fixed.inset-0').remove();
            } catch (error) {
                console.error('系统清理失败:', error);
                showNotification('系统清理失败: ' + error.message, 'error');
            }
        }

        // 执行数据库优化
        async function performDatabaseOptimize() {
            try {
                showNotification('正在优化数据库...', 'info');
                const response = await api.post('/api/system/database/optimize');
                showNotification('数据库优化完成', 'success');
            } catch (error) {
                console.error('数据库优化失败:', error);
                showNotification('数据库优化失败: ' + error.message, 'error');
            }
        }

        // 显示数据库统计信息 - 独立模态框
        async function showDatabaseStatistics() {
            try {
                showNotification('正在获取数据库统计信息...', 'info');
                console.log('开始调用统计API...');
                const response = await api.get('/api/system/database/statistics');
                console.log('统计API完整响应:', response);
                
                if (!response) {
                    throw new Error('API响应为空');
                }
                
                const stats = response.statistics || {};
                
                let statsHtml = `
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">数据库统计信息</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">数据库概览</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="text-sm text-gray-500">数据库大小</div>
                                        <div class="text-lg font-medium">${stats.size_info?.file_size_mb || 'N/A'} MB</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="text-sm text-gray-500">总记录数</div>
                                        <div class="text-lg font-medium">${stats.records?.total_records || 0}</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="text-sm text-gray-500">表数量</div>
                                        <div class="text-lg font-medium">${Object.keys(stats.tables || {}).length}</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="text-sm text-gray-500">文件路径</div>
                                        <div class="text-sm font-medium">${stats.size_info?.file_path || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">表统计</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">表名</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">记录数</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">索引数</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${Object.entries(stats.tables || {}).map(([table, info]) => `
                                                <tr>
                                                    <td class="px-4 py-2 text-sm text-gray-900">${table}</td>
                                                    <td class="px-4 py-2 text-sm text-gray-900">${info.record_count || 'ERROR'}</td>
                                                    <td class="px-4 py-2 text-sm text-gray-900">${stats.indexes[table]?.length || 0}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 创建模态框 - 使用更高的z-index确保显示在数据库管理工具上方
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
                modal.innerHTML = statsHtml;
                document.body.appendChild(modal);
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('获取数据库统计信息失败:', error);
                showNotification('获取数据库统计信息失败: ' + error.message, 'error');
            }
        }

        // 隐藏数据库工具内容区域
        function hideDatabaseToolsContent() {
            const contentArea = document.getElementById('database-tools-content');
            contentArea.classList.add('hidden');
        }

        // 在数据库管理工具模态框中显示备份历史
        async function showBackupHistoryInModal() {
            try {
                showNotification('正在获取备份历史...', 'info');
                console.log('开始调用备份API...');
                const response = await api.get('/api/system/database/backups');
                console.log('备份API完整响应:', response);
                
                if (!response) {
                    throw new Error('API响应为空');
                }
                
                const backups = response.backups || [];
                
                // 显示内容区域
                const contentArea = document.getElementById('database-tools-content');
                const contentTitle = document.getElementById('content-title');
                const contentBody = document.getElementById('content-body');
                
                contentTitle.textContent = '备份历史';
                
                let historyHtml = `
                    ${backups.length === 0 ? 
                        '<div class="text-center text-gray-500 py-8">暂无备份记录</div>' :
                        `<div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">文件名</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">备份时间</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">文件大小</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${backups.map(backup => `
                                        <tr>
                                            <td class="px-4 py-2 text-sm text-gray-900">
                                                <div class="flex items-center">
                                                    ${backup.is_complete_backup ? 
                                                        '<i class="fas fa-file-archive text-green-600 mr-2" title="完整备份（数据库+文件）"></i>' : 
                                                        '<i class="fas fa-database text-blue-600 mr-2" title="仅数据库备份"></i>'
                                                    }
                                                    ${backup.file_name}
                                                </div>
                                            </td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${new Date(backup.created_at).toLocaleString()}</td>
                                            <td class="px-4 py-2 text-sm text-gray-900">
                                                <span class="${backup.is_complete_backup ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                                    ${backup.file_size_mb} MB
                                                </span>
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <button onclick="downloadBackup('${backup.file_name}')" class="text-blue-600 hover:text-blue-800 mr-2" title="下载备份文件">
                                                    <i class="fas fa-download"></i> 下载
                                                </button>
                                                <button onclick="deleteBackupInModal('${backup.file_name}')" class="text-red-600 hover:text-red-800" title="删除备份文件">
                                                    <i class="fas fa-trash"></i> 删除
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`
                    }
                `;
                
                contentBody.innerHTML = historyHtml;
                contentArea.classList.remove('hidden');
                
            } catch (error) {
                console.error('获取备份历史失败:', error);
                showNotification('获取备份历史失败: ' + error.message, 'error');
            }
        }

        // 显示备份历史 - 独立模态框
        async function showBackupHistory() {
            try {
                // 检查是否已经存在备份历史模态框
                const existingModal = document.querySelector('.fixed.z-\\[3000\\].bg-black.bg-opacity-50');
                if (existingModal && existingModal.querySelector('.text-xl.font-bold.text-gray-800')?.textContent === '备份历史') {
                    // 如果已存在，先移除旧的
                    existingModal.remove();
                }
                
                showNotification('正在获取备份历史...', 'info');
                console.log('开始调用备份API...');
                const response = await api.get('/api/system/database/backups');
                console.log('备份API完整响应:', response);
                
                if (!response) {
                    throw new Error('API响应为空');
                }
                
                const backups = response.backups || [];
                
                let historyHtml = `
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">备份历史</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        ${backups.length === 0 ? 
                            '<div class="text-center text-gray-500 py-8">暂无备份记录</div>' :
                            `<div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">文件名</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">备份时间</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">文件大小</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${backups.map(backup => `
                                            <tr>
                                                <td class="px-4 py-2 text-sm text-gray-900">
                                                    <div class="flex items-center">
                                                        ${backup.is_complete_backup ? 
                                                            '<i class="fas fa-file-archive text-green-600 mr-2" title="完整备份（数据库+文件）"></i>' : 
                                                            '<i class="fas fa-database text-blue-600 mr-2" title="仅数据库备份"></i>'
                                                        }
                                                        ${backup.file_name}
                                                    </div>
                                                </td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${new Date(backup.created_at).toLocaleString()}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">
                                                    <span class="${backup.is_complete_backup ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                                        ${backup.file_size_mb} MB
                                                    </span>
                                                </td>
                                                <td class="px-4 py-2 text-sm">
                                                    <button onclick="downloadBackup('${backup.file_name}')" class="text-blue-600 hover:text-blue-800 mr-2" title="下载备份文件">
                                                        <i class="fas fa-download"></i> 下载
                                                    </button>
                                                    <button onclick="deleteBackup('${backup.file_name}')" class="text-red-600 hover:text-red-800" title="删除备份文件">
                                                        <i class="fas fa-trash"></i> 删除
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>`
                        }
                    </div>
                `;
                
                // 创建模态框 - 使用更高的z-index确保显示在数据库管理工具上方
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
                modal.innerHTML = historyHtml;
                document.body.appendChild(modal);
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('获取备份历史失败:', error);
                showNotification('获取备份历史失败: ' + error.message, 'error');
            }
        }

        // 在模态框中删除备份文件
        async function deleteBackupInModal(filename) {
            if (!confirm(`确定要删除备份文件 "${filename}" 吗？此操作不可撤销。`)) {
                return;
            }
            
            try {
                showNotification('正在删除备份文件...', 'info');
                await api.delete(`/api/system/database/backups/${filename}`);
                showNotification('备份文件删除成功', 'success');
                
                // 刷新备份历史
                showBackupHistoryInModal();
            } catch (error) {
                console.error('删除备份失败:', error);
                showNotification('删除备份失败: ' + error.message, 'error');
            }
        }

        // 下载备份文件
        async function downloadBackup(filename) {
            try {
                showNotification('正在准备下载...', 'info');
                
                // 获取认证令牌
                const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('未找到认证令牌，请重新登录');
                }
                
                console.log('正在使用令牌下载:', token.substring(0, 20) + '...');
                
                // 首先测试令牌是否有效
                const testUrl = `/api/system/database/backups/test-token?token=${encodeURIComponent(token)}`;
                const testResponse = await fetch(testUrl);
                const testResult = await testResponse.json();
                
                console.log('令牌测试结果:', testResult);
                
                if (testResult.status !== 'success') {
                    throw new Error(`令牌验证失败: ${testResult.message}`);
                }
                
                // 使用fetch获取文件
                const downloadUrl = `/api/system/database/backups/${filename}/download-with-token?token=${encodeURIComponent(token)}`;
                
                console.log('下载URL:', downloadUrl);
                
                const response = await fetch(downloadUrl);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('下载响应错误:', errorData);
                    throw new Error(errorData.detail || '下载失败');
                }
                
                // 获取文件内容
                const blob = await response.blob();
                console.log('文件大小:', blob.size, 'bytes');
                
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理URL对象
                window.URL.revokeObjectURL(url);
                
                showNotification('备份文件下载成功', 'success');
            } catch (error) {
                console.error('下载备份失败:', error);
                showNotification('下载备份失败: ' + error.message, 'error');
            }
        }

        // 删除备份文件
        async function deleteBackup(filename) {
            if (!confirm(`确定要删除备份文件 "${filename}" 吗？此操作不可撤销。`)) {
                return;
            }
            
            try {
                showNotification('正在删除备份文件...', 'info');
                await api.delete(`/api/system/database/backups/${filename}`);
                showNotification('备份文件删除成功', 'success');
                
                // 检查是否存在备份历史模态框，如果存在则刷新内容，否则创建新的
                const existingModal = document.querySelector('.fixed.z-\\[3000\\].bg-black.bg-opacity-50');
                if (existingModal && existingModal.querySelector('.text-xl.font-bold.text-gray-800')?.textContent === '备份历史') {
                    // 刷新现有模态框的内容
                    await refreshBackupHistoryModal();
                } else {
                    // 创建新的模态框
                    await showBackupHistory();
                }
            } catch (error) {
                console.error('删除备份失败:', error);
                showNotification('删除备份失败: ' + error.message, 'error');
            }
        }

        // 刷新备份历史模态框内容
        async function refreshBackupHistoryModal() {
            try {
                showNotification('正在刷新备份历史...', 'info');
                const response = await api.get('/api/system/database/backups');
                const backups = response.backups || [];
                
                // 找到现有的模态框并更新内容
                const existingModal = document.querySelector('.fixed.z-\\[3000\\].bg-black.bg-opacity-50');
                if (!existingModal) {
                    return;
                }
                
                const modalContent = existingModal.querySelector('.bg-white');
                if (!modalContent) {
                    return;
                }
                
                // 生成新的内容
                let newContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">备份历史</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    ${backups.length === 0 ? 
                        '<div class="text-center text-gray-500 py-8">暂无备份记录</div>' :
                        `<div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">文件名</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">备份时间</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">文件大小</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${backups.map(backup => `
                                        <tr>
                                            <td class="px-4 py-2 text-sm text-gray-900">
                                                <div class="flex items-center">
                                                    ${backup.is_complete_backup ? 
                                                        '<i class="fas fa-file-archive text-green-600 mr-2" title="完整备份（数据库+文件）"></i>' : 
                                                        '<i class="fas fa-database text-blue-600 mr-2" title="仅数据库备份"></i>'
                                                    }
                                                    ${backup.file_name}
                                                </div>
                                            </td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${new Date(backup.created_at).toLocaleString()}</td>
                                            <td class="px-4 py-2 text-sm text-gray-900">
                                                <span class="${backup.is_complete_backup ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                                    ${backup.file_size_mb} MB
                                                </span>
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <button onclick="downloadBackup('${backup.file_name}')" class="text-blue-600 hover:text-blue-800 mr-2" title="下载备份文件">
                                                    <i class="fas fa-download"></i> 下载
                                                </button>
                                                <button onclick="deleteBackup('${backup.file_name}')" class="text-red-600 hover:text-red-800" title="删除备份文件">
                                                    <i class="fas fa-trash"></i> 删除
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`
                    }
                `;
                
                // 更新模态框内容
                modalContent.innerHTML = newContent;
                
                showNotification('备份历史已刷新', 'success');
            } catch (error) {
                console.error('刷新备份历史失败:', error);
                showNotification('刷新备份历史失败: ' + error.message, 'error');
            }
        }

        // 设置当前页面激活状态
        function setCurrentPageActive() {
            // 展开系统管理下拉菜单
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            const systemMenuBtn = document.getElementById('system-menu-btn');
            
            if (systemSubmenu && systemMenuArrow) {
                systemSubmenu.classList.remove('hidden');
                systemMenuArrow.style.transform = 'rotate(180deg)';
            }
            
            // 激活系统管理菜单
            if (systemMenuBtn) {
                systemMenuBtn.classList.add('active');
            }
            
            // 激活系统设置子菜单项
            const settingsLink = document.getElementById('settings-link');
            if (settingsLink) {
                settingsLink.classList.add('active');
            }
        }
    </script>
</body>
</html>