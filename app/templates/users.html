<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/session-manager.js"></script>
    <script src="/static/js/api-client.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #667eea;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部通知容器 -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] space-y-2 max-w-md"></div>
    
    <div class="flex h-screen">
        <!-- 左侧导航栏 -->
        <div class="w-64 gradient-bg shadow-xl fixed left-0 top-0 h-full z-10">
            <div class="flex flex-col h-full">
                <!-- Logo和标题 -->
                <div class="flex items-center justify-center h-16 px-4 border-b border-white/20">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-list text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-lg font-bold">设备台账管理系统</h1>
                    </div>
                </div>

                <!-- 导航菜单 -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="/dashboard" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="/equipment" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-cogs mr-3 text-lg"></i>
                        <span>设备管理</span>
                    </a>
                        <a href="/reports" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="reports-link">
                        <i class="fas fa-chart-bar mr-3 text-lg"></i>
                        <span>统计报表</span>
                    </a>
                    
                    <!-- 系统管理下拉菜单 -->
                    <div class="relative">
                        <button class="sidebar-item flex items-center justify-between w-full px-4 py-3 text-white/90 rounded-lg" id="system-menu-btn" aria-label="展开系统管理菜单" aria-expanded="false">
                            <div class="flex items-center">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                <span>系统管理</span>
                            </div>
                            <i class="fas fa-chevron-down text-sm transition-transform duration-200" id="system-menu-arrow"></i>
                        </button>
                        <div class="ml-4 mt-1 space-y-1 hidden" id="system-submenu">
                            <a href="/categories" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-tags mr-3"></i>
                                <span>设备类别</span>
                            </a>
                            <a href="/departments" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-building mr-3"></i>
                                <span>部门管理</span>
                            </a>
                            <a href="/users" class="sidebar-item active flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-users mr-3"></i>
                                <span>用户管理</span>
                            </a>
                            <a href="/audit" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="audit-link">
                                <i class="fas fa-history mr-3"></i>
                                <span>操作日志</span>
                            </a>
                            <a href="/settings" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="settings-link">
                                <i class="fas fa-cog mr-3"></i>
                                <span>系统设置</span>
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- 用户信息 -->
                <div class="border-t border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-white text-xl mr-3"></i>
                            <div>
                                <p class="text-white text-sm font-medium" id="current-user">用户</p>
                                <p class="text-white/70 text-xs">在线</p>
                            </div>
                        </div>
                        <button class="text-white/70 hover:text-white transition-colors" id="logout-btn" aria-label="退出登录">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 ml-64 overflow-hidden">
            <div class="h-full overflow-y-auto">
                <div class="p-8">
            
            <!-- 主要内容 -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">用户管理</h2>
                <p class="text-gray-600">管理系统用户账户、权限和访问控制</p>
            </div>

            <!-- 操作栏 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="搜索用户名..." 
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex gap-3">
                        <button class="btn-primary text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200" onclick="openCreateUserModal()" aria-label="创建新用户">
                            <i class="fas fa-plus mr-2"></i>创建用户
                        </button>
                    </div>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <i class="fas fa-users text-2xl text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">用户总数</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-users-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i class="fas fa-user-shield text-2xl text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">管理员用户</p>
                            <p class="text-2xl font-bold text-gray-900" id="admin-users-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100">
                            <i class="fas fa-user text-2xl text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">普通用户</p>
                            <p class="text-2xl font-bold text-gray-900" id="normal-users-count">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户列表 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">用户列表</h3>
                        <div class="text-sm text-gray-600">
                            共 <span id="users-total-count" class="font-semibold text-gray-900">-</span> 个用户
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">用户信息</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">权限等级</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">管理权限</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">详情</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">创建时间</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="users-table-body">
                            <!-- 动态加载的用户数据 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 统一分页控件 -->
                <div id="pagination-container" class="flex items-center justify-between mt-6 px-6 pb-6">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700">每页显示</span>
                        <select id="page-size" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-700">条</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="prev-page" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                            <i class="fas fa-chevron-left mr-1"></i>上一页
                        </button>
                        <div id="page-numbers" class="flex items-center space-x-1">
                            <!-- 页码按钮将动态生成 -->
                        </div>
                        <button id="next-page" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                            下一页<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700">
                        <span id="page-info">第 1 页，共 1 页</span>
                        <span class="text-gray-500 mx-2">|</span>
                        <span>共 <span id="total-count">0</span> 条</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
    </div>

    <!-- 创建/编辑用户模态框 -->
    <div id="userModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title">创建用户</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeUserModal()" aria-label="关闭对话框">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="user-form">
                    <div class="mb-4">
                        <label for="user-username" class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                        <input type="text" id="user-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入用户名" required>
                    </div>
                    
                    <div class="mb-4" id="password-field">
                        <label for="user-password" class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="user-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入密码" required>
                        <div id="password-requirements" class="text-xs text-gray-500 mt-1">
                            密码要求：至少6位，包含字母和数字
                        </div>
                    </div>
                    
                    <div class="mb-4" id="change-password-field" style="display: none;">
                        <label class="flex items-center mb-2">
                            <input type="checkbox" id="change-password" class="mr-2 rounded border-gray-300">
                            <span class="text-sm text-gray-700">修改密码</span>
                        </label>
                        <div id="new-password-fields" style="display: none;">
                            <div class="mb-3">
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                                <input type="password" id="new-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入新密码">
                                <div class="text-xs text-gray-500 mt-1">密码要求：至少6位，包含字母和数字</div>
                            </div>
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                                <input type="password" id="confirm-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请再次输入新密码">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="user-is-admin" class="flex items-center">
                            <input type="checkbox" id="user-is-admin" class="mr-2 rounded border-gray-300">
                            <span class="text-sm text-gray-700">管理员权限</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">管理员拥有系统的完整访问权限</p>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeUserModal()">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" id="save-user-btn">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="deleteUserModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
            </div>
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-700">您确定要删除用户 <span id="delete-user-name" class="font-semibold"></span> 吗？</p>
                        <p class="text-sm text-gray-500 mt-1">此操作不可恢复。</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeDeleteUserModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmDeleteUser()">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
  
    <!-- 管理用户器具权限模态框 -->
    <div id="userEquipmentPermissionsModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[85vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">管理用户器具权限</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeUserEquipmentPermissionsModal()" aria-label="关闭对话框">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">用户: <span id="equipment-permission-user-name" class="font-semibold"></span></p>
                    <p class="text-xs text-gray-500">选择该用户可以管理的具体器具</p>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-gray-700">设备类别</label>
                        <select id="category-select" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadCategoryEquipment()">
                            <option value="">选择类别</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div id="equipment-permission-stats" class="mb-3">
                        <!-- 权限统计将在这里显示 -->
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-gray-700">器具列表</label>
                        <div class="flex space-x-2">
                            <button type="button" class="text-xs text-blue-600 hover:text-blue-800" onclick="selectAllEquipment()">
                                全选
                            </button>
                            <button type="button" class="text-xs text-gray-600 hover:text-gray-800" onclick="clearAllEquipment()">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-3 max-h-64 overflow-y-auto bg-gray-50" id="equipment-checkboxes">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-info-circle mr-2"></i>
                            请先选择一个设备类别
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeUserEquipmentPermissionsModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="saveUserEquipmentPermissions()">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUsers = [];
        let editingUserId = null;
        let deletingUserId = null;
        let managingCategoriesUserId = null;
        let managingEquipmentPermissionsUserId = null;
        let allCategories = [];
        let equipmentManagedStatus = [];
        let currentPage = 1;
        let itemsPerPage = parseInt(localStorage.getItem('users_page_size') || '20');
        let totalItems = 0;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializePage();
                setupEventListeners();
                loadUsersData();
                loadCategories();
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败，请刷新页面重试', 'error');
            }
        });

        // 初始化页面
        function initializePage() {
            // 设置系统管理菜单展开状态
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            if (systemSubmenu && systemMenuArrow) {
                systemSubmenu.classList.remove('hidden');
                systemMenuArrow.style.transform = 'rotate(180deg)';
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 搜索输入框
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterUsers();
                }, 300);
            });

            // 用户表单提交
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);

            // 密码修改复选框
            const changePasswordCheckbox = document.getElementById('change-password');
            if (changePasswordCheckbox) {
                changePasswordCheckbox.addEventListener('change', function() {
                    const newPasswordFields = document.getElementById('new-password-fields');
                    const newPassword = document.getElementById('new-password');
                    const confirmPassword = document.getElementById('confirm-password');
                    
                    if (this.checked) {
                        newPasswordFields.style.display = 'block';
                        newPassword.required = true;
                        confirmPassword.required = true;
                    } else {
                        newPasswordFields.style.display = 'none';
                        newPassword.required = false;
                        confirmPassword.required = false;
                        newPassword.value = '';
                        confirmPassword.value = '';
                        // 清除验证样式
                        newPassword.classList.remove('border-red-500', 'border-green-500');
                        newPassword.classList.add('border-gray-300');
                        confirmPassword.classList.remove('border-red-500', 'border-green-500');
                        confirmPassword.classList.add('border-gray-300');
                    }
                });
            }

            // 密码输入实时验证
            const passwordInputs = ['user-password', 'new-password', 'confirm-password'];
            passwordInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function() {
                        validatePassword(inputId, this.value);
                    });
                }
            });

            // 侧边栏导航
            setupSidebarNavigation();

            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeUserModal();
                    closeDeleteUserModal();
                    closeUserEquipmentPermissionsModal();
                }
            });

            // 点击模态框外部关闭
            document.getElementById('userModal').addEventListener('click', function(e) {
                if (e.target === this) closeUserModal();
            });

            document.getElementById('deleteUserModal').addEventListener('click', function(e) {
                if (e.target === this) closeDeleteUserModal();
            });

            document.getElementById('userEquipmentPermissionsModal').addEventListener('click', function(e) {
                if (e.target === this) closeUserEquipmentPermissionsModal();
            });
            
            // 分页事件监听器
            setupPaginationEventListeners();
        }

        // 设置侧边栏导航
        function setupSidebarNavigation() {
            // 系统管理下拉菜单
            const systemMenuBtn = document.getElementById('system-menu-btn');
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            
            if (systemMenuBtn) {
                systemMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    systemSubmenu.classList.toggle('hidden');
                    
                    if (systemSubmenu.classList.contains('hidden')) {
                        systemMenuArrow.style.transform = 'rotate(0deg)';
                    } else {
                        systemMenuArrow.style.transform = 'rotate(180deg)';
                    }
                });
            }
            
            // 退出登录
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('确定要退出登录吗？')) {
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        localStorage.removeItem('user_info');
                        window.location.href = '/login';
                    }
                });
            }
            
            // 检查登录状态
            const userInfo = localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const currentUserElement = document.getElementById('current-user');
                if (currentUserElement) {
                    currentUserElement.textContent = user.username || '用户';
                }
            }
        }

        // 加载用户数据
        async function loadUsersData() {
            try {
                showNotification('正在加载用户数据...', 'info');
                
                // 使用分页参数加载用户数据
                const skip = (currentPage - 1) * itemsPerPage;
                const response = await fetch(`/api/users/?skip=${skip}&limit=${itemsPerPage}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                currentUsers = users;
                
                // 获取总用户数用于分页
                const totalResponse = await fetch('/api/users/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (totalResponse.ok) {
                    const allUsers = await totalResponse.json();
                    totalItems = allUsers.length;
                    updateUsersStats(allUsers);
                } else {
                    totalItems = users.length;
                    updateUsersStats(users);
                }
                
                renderUsersTable(users);
                updatePagination();
                
                // 加载当前页用户的设备类别
                for (const user of users) {
                    loadUserCategories(user.id);
                }
                
                showNotification('用户数据加载成功', 'success');
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                showNotification('加载用户数据失败: ' + error.message, 'error');
                renderUsersTable([]);
            }
        }

        // 加载所有设备类别
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                allCategories = await response.json();
                
            } catch (error) {
                console.error('加载设备类别失败:', error);
                showNotification('加载设备类别失败: ' + error.message, 'error');
            }
        }

        // 加载用户的权限信息（类别权限 + 器具权限）
        async function loadUserCategories(userId) {
            try {
                // 并行加载类别权限和器具权限
                const [categoriesResponse, equipmentResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok) {
                    throw new Error(`加载类别权限失败: HTTP ${categoriesResponse.status}`);
                }
                if (!equipmentResponse.ok) {
                    throw new Error(`加载器具权限失败: HTTP ${equipmentResponse.status}`);
                }

                const userCategories = await categoriesResponse.json();
                const equipmentPermissions = await equipmentResponse.json();
                
                // 保存权限数据到全局变量
                if (!window.userPermissionsData) {
                    window.userPermissionsData = {};
                }
                window.userPermissionsData[userId] = {
                    category_permissions: userCategories,
                    equipment_permissions: equipmentPermissions
                };
                
                updateUserPermissionsDisplay(userId, userCategories, equipmentPermissions);
                
                // 更新删除按钮状态
                updateUserDeleteButton(userId);
                
            } catch (error) {
                console.error('加载用户权限失败:', error);
                const categoryElement = document.getElementById(`user-categories-${userId}`);
                if (categoryElement) {
                    categoryElement.innerHTML = '<span class="text-gray-400">加载失败</span>';
                }
            }
        }

        // 加载用户权限信息并更新显示
        async function loadUserPermissions(userId) {
            try {
                // 并行加载类别权限和器具权限
                const [categoriesResponse, equipmentResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok || !equipmentResponse.ok) {
                    throw new Error('Failed to load user permissions');
                }

                const userCategories = await categoriesResponse.json();
                const equipmentPermissions = await equipmentResponse.json();
                
                // 更新权限显示
                updateUserPermissionsDisplay(userId, userCategories, equipmentPermissions);
                
                // 更新删除按钮状态
                updateUserDeleteButton(userId);
                
            } catch (error) {
                console.error('加载用户权限失败:', error);
                const categoryElement = document.getElementById(`user-categories-${userId}`);
                if (categoryElement) {
                    categoryElement.innerHTML = '<span class="text-red-500">权限加载失败</span>';
                }
            }
        }

        // 更新用户权限显示（类别权限 + 器具权限）
        function updateUserPermissionsDisplay(userId, userCategories, equipmentPermissions) {
            const categoryElement = document.getElementById(`user-categories-${userId}`);
            if (!categoryElement) return;
            
            // 查找该用户是否为管理员
            const user = currentUsers.find(u => u.id === userId);
            const isAdmin = user && user.is_admin;
            
            if (isAdmin) {
                // 管理员显示所有权限
                categoryElement.innerHTML = '<span class="text-sm text-purple-600 font-medium">全部权限</span>';
            } else {
                const hasCategoryPermissions = userCategories && userCategories.length > 0;
                const hasEquipmentPermissions = equipmentPermissions && equipmentPermissions.length > 0;
                
                if (!hasCategoryPermissions && !hasEquipmentPermissions) {
                    categoryElement.innerHTML = '<span class="text-gray-400">无权限</span>';
                } else {
                    let permissionTexts = [];
                    let fullPermissionText = '';
                    
                    // 添加类别权限
                    if (hasCategoryPermissions) {
                        const categoryNames = userCategories.map(uc => uc.category.name);
                        const displayNames = categoryNames.slice(0, 2);
                        if (categoryNames.length > 2) {
                            permissionTexts.push(`${displayNames.join(', ')}+${categoryNames.length - 2}`);
                        } else {
                            permissionTexts.push(displayNames.join(', '));
                        }
                        fullPermissionText += `类别: ${categoryNames.join(', ')}`;
                    }
                    
                    // 添加器具权限
                    if (hasEquipmentPermissions) {
                        const equipmentNames = equipmentPermissions.map(ep => ep.equipment_name);
                        const displayNames = equipmentNames.slice(0, 3);
                        if (equipmentPermissions.length > 3) {
                            permissionTexts.push(`${displayNames.join(', ')}+${equipmentPermissions.length - 3}`);
                        } else {
                            permissionTexts.push(displayNames.join(', '));
                        }
                        if (fullPermissionText) fullPermissionText += ' | ';
                        fullPermissionText += `器具: ${equipmentNames.join(', ')}`;
                    }
                    
                    const displayText = permissionTexts.join(', ');
                    
                    // 如果权限被截断，添加Tooltip
                    if ((hasCategoryPermissions && userCategories.length > 2) || 
                        (hasEquipmentPermissions && equipmentPermissions.length > 3)) {
                        categoryElement.innerHTML = `
                            <div class="relative inline-block group">
                                <span class="text-sm text-gray-900 cursor-help border-b border-dotted border-gray-400">${displayText}</span>
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                                    <div class="text-center">${fullPermissionText}</div>
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        categoryElement.innerHTML = `<span class="text-sm text-gray-900">${displayText}</span>`;
                    }
                }
            }
            
            // 更新删除按钮状态
            updateUserDeleteButton(userId);
        }

        // 更新用户删除按钮状态
        function updateUserDeleteButton(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) {
                return;
            }
            
            // 找到该用户行的操作列
            const userRow = document.querySelector(`#user-categories-${userId}`).closest('tr');
            if (!userRow) {
                console.log('User row not found');
                return;
            }
            
            const actionCell = userRow.querySelector('td:last-child');
            if (!actionCell) {
                console.log('Action cell not found');
                return;
            }
            
            // 重新生成删除按钮
            const deleteButtonHTML = getUserDeleteButton(user);
            
            // 找到删除按钮并替换
            const deleteButton = actionCell.querySelector('button[onclick*="deleteUser"]');
            if (deleteButton) {
                deleteButton.outerHTML = deleteButtonHTML;
            }
        }

        // 渲染用户表格
        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            暂无用户数据
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 flex-shrink-0">
                                <div class="h-10 w-10 rounded-full ${user.is_admin ? 'bg-purple-100' : 'bg-blue-100'} flex items-center justify-center">
                                    <i class="fas ${user.is_admin ? 'fa-user-shield text-purple-600' : 'fa-user text-blue-600'}"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.username}</div>
                                <div class="text-sm text-gray-500">ID: ${user.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            user.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                        }">
                            ${user.is_admin ? '管理员' : '普通用户'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="text-sm text-gray-900" id="user-categories-${user.id}">
                            <span class="text-gray-400">加载中...</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center">
                            <button onclick="togglePermissionDetails(${user.id})" 
                                    class="text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-50 transition-colors"
                                    title="查看完整权限信息"
                                    id="permission-detail-btn-${user.id}">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                        ${formatDateTime(user.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center justify-center space-x-2">
                            ${getUserPermissionManagementButtons(user)}
                            ${getUserEditButton(user)}
                            ${getUserDeleteButton(user)}
                        </div>
                    </td>
                </tr>
                <tr id="permission-details-${user.id}" class="hidden">
                    <td colspan="6" class="px-6 py-4 bg-gray-50">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-gray-900">
                                    <i class="fas fa-key mr-2 text-blue-600"></i>
                                    ${user.username} 的完整权限信息
                                </h4>
                                <button onclick="togglePermissionDetails(${user.id})" 
                                        class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="permission-details-content-${user.id}" class="space-y-3">
                                <div class="text-sm text-gray-500">正在加载权限信息...</div>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 检查用户是否可以删除
        function canDeleteUser(user) {
            const currentUser = JSON.parse(localStorage.getItem('user_info') || '{}');
            
            // 检查是否为当前登录用户
            if (currentUser.id === user.id) {
                return { canDelete: false, reason: '无法删除当前登录用户' };
            }
            
            // 检查用户是否为系统管理员（不能删除最后一个管理员）
            if (user.is_admin) {
                const adminUsers = currentUsers.filter(u => u.is_admin).length;
                if (adminUsers <= 1) {
                    return { canDelete: false, reason: '系统至少需要保留一个管理员用户' };
                }
            }
            
            // 检查用户是否有权限（器具权限）
            const userPermissions = window.userPermissionsData ? window.userPermissionsData[user.id] : null;
            if (userPermissions && userPermissions.equipment_permissions && userPermissions.equipment_permissions.length > 0) {
                return { canDelete: false, reason: '该用户管理着器具，无法删除' };
            }
            
            return { canDelete: true, reason: '' };
        }

        // 获取用户权限管理按钮
        function getUserPermissionManagementButtons(user) {
            const currentUser = JSON.parse(localStorage.getItem('user_info') || '{}');
            
            // 如果是管理员账号，显示灰色不可点击的按钮
            if (user.is_admin) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="管理员拥有所有权限，无需管理" disabled>
                        <i class="fas fa-tools mr-1"></i>器具权限
                    </button>
                `;
            }
            
            // 如果是当前登录用户，显示灰色不可点击的按钮
            if (currentUser.id === user.id) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="无法管理自己的权限" disabled>
                        <i class="fas fa-tools mr-1"></i>器具权限
                    </button>
                `;
            }
            
            // 普通用户显示正常的权限管理按钮（只保留器具权限管理）
            return `
                <button class="text-purple-600 hover:text-purple-900 px-2 py-1 rounded text-sm" onclick="manageUserEquipmentPermissions(${user.id}, '${user.username}')" title="管理器具权限">
                    <i class="fas fa-tools mr-1"></i>器具权限
                </button>
            `;
        }
        
        // 获取用户编辑按钮
        function getUserEditButton(user) {
            const currentUser = JSON.parse(localStorage.getItem('user_info') || '{}');
            
            // 如果是管理员账号，显示灰色不可点击的按钮
            if (user.is_admin) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="无法编辑管理员账号" disabled>
                        <i class="fas fa-edit mr-1"></i>编辑
                    </button>
                `;
            }
            
            // 如果是当前登录用户，显示灰色不可点击的按钮
            if (currentUser.id === user.id) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="无法编辑自己的账号" disabled>
                        <i class="fas fa-edit mr-1"></i>编辑
                    </button>
                `;
            }
            
            // 普通用户显示正常的编辑按钮
            return `
                <button class="text-green-600 hover:text-green-900 px-2 py-1 rounded text-sm" onclick="editUser(${user.id})" title="编辑用户信息">
                    <i class="fas fa-edit mr-1"></i>编辑
                </button>
            `;
        }

        // 获取用户删除按钮
        function getUserDeleteButton(user) {
            const deleteCheck = canDeleteUser(user);
            
            if (!deleteCheck.canDelete) {
                return `<button class="text-gray-400 cursor-not-allowed" title="${deleteCheck.reason}" disabled>
                    <i class="fas fa-trash mr-1"></i>删除
                </button>`;
            }
            
            return `<button class="text-red-600 hover:text-red-900" onclick="deleteUser(${user.id}, '${user.username}')">
                <i class="fas fa-trash mr-1"></i>删除
            </button>`;
        }

        // 更新用户统计
        function updateUsersStats(users) {
            const totalUsers = users.length;
            const adminUsers = users.filter(user => user.is_admin).length;
            const normalUsers = totalUsers - adminUsers;
            
            document.getElementById('total-users-count').textContent = totalUsers;
            document.getElementById('admin-users-count').textContent = adminUsers;
            document.getElementById('normal-users-count').textContent = normalUsers;
            document.getElementById('users-total-count').textContent = totalUsers;
        }

        // 筛选用户
        function filterUsers() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchQuery) {
                renderUsersTable(currentUsers);
                return;
            }
            
            const filteredUsers = currentUsers.filter(user =>
                user.username.toLowerCase().includes(searchQuery)
            );
            
            renderUsersTable(filteredUsers);
            
            // 更新分页信息显示
            const totalCountElement = document.getElementById('total-count');
            if (totalCountElement) {
                totalCountElement.textContent = filteredUsers.length;
            }
        }

        // 打开创建用户模态框
        function openCreateUserModal() {
            editingUserId = null;
            document.getElementById('modal-title').textContent = '创建用户';
            document.getElementById('user-form').reset();
            document.getElementById('password-field').style.display = 'block';
            document.getElementById('user-password').required = true;
            document.getElementById('change-password-field').style.display = 'none';
            document.getElementById('save-user-btn').innerHTML = '<i class="fas fa-save mr-2"></i>创建';
            document.getElementById('userModal').classList.add('show');
        }

        // 编辑用户
        function editUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            document.getElementById('modal-title').textContent = '编辑用户';
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-is-admin').checked = user.is_admin;
            
            // 编辑用户时显示密码修改选项
            document.getElementById('password-field').style.display = 'none';
            document.getElementById('user-password').required = false;
            document.getElementById('change-password-field').style.display = 'block';
            document.getElementById('change-password').checked = false;
            document.getElementById('new-password-fields').style.display = 'none';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('new-password').required = false;
            document.getElementById('confirm-password').required = false;
            
            document.getElementById('save-user-btn').innerHTML = '<i class="fas fa-save mr-2"></i>保存';
            document.getElementById('userModal').classList.add('show');
        }

        // 关闭用户模态框
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
            editingUserId = null;
        }

        // 密码验证函数
        function validatePassword(inputId, password) {
            const input = document.getElementById(inputId);
            const requirementsDiv = document.getElementById(inputId === 'user-password' ? 'password-requirements' : 
                                                          (inputId === 'new-password' ? 'new-password' : 'confirm-password') + '-requirements');
            
            if (!password) {
                input.classList.remove('border-red-500', 'border-green-500');
                input.classList.add('border-gray-300');
                return true;
            }
            
            // 验证密码规则：至少6位，包含字母和数字
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasMinLength = password.length >= 6;
            
            if (hasLetter && hasNumber && hasMinLength) {
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
                return true;
            } else {
                input.classList.remove('border-green-500');
                input.classList.add('border-red-500');
                return false;
            }
        }
        
        // 处理用户表单提交
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value;
            const changePassword = document.getElementById('change-password')?.checked || false;
            const newPassword = document.getElementById('new-password')?.value || '';
            const confirmPassword = document.getElementById('confirm-password')?.value || '';
            const isAdmin = document.getElementById('user-is-admin').checked;
            
            if (!username) {
                showNotification('请输入用户名', 'warning');
                return;
            }
            
            // 创建用户时密码验证
            if (!editingUserId) {
                if (!password) {
                    showNotification('请输入密码', 'warning');
                    return;
                }
                if (!validatePassword('user-password', password)) {
                    showNotification('密码不符合要求：至少6位，包含字母和数字', 'warning');
                    return;
                }
            }
            
            // 编辑用户时密码修改验证
            if (editingUserId && changePassword) {
                if (!newPassword) {
                    showNotification('请输入新密码', 'warning');
                    return;
                }
                if (!validatePassword('new-password', newPassword)) {
                    showNotification('新密码不符合要求：至少6位，包含字母和数字', 'warning');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showNotification('两次输入的密码不一致', 'warning');
                    return;
                }
            }
            
            try {
                document.getElementById('save-user-btn').disabled = true;
                
                const userData = {
                    username,
                    is_admin: isAdmin
                };
                
                if (!editingUserId) {
                    // 创建用户
                    userData.password = password;
                } else if (changePassword) {
                    // 编辑用户且修改密码
                    userData.password = newPassword;
                }
                
                let response;
                if (editingUserId) {
                    // 更新用户
                    response = await fetch(`/api/users/${editingUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                } else {
                    // 创建用户
                    response = await fetch('/api/users/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                showNotification(editingUserId ? '用户更新成功' : '用户创建成功', 'success');
                closeUserModal();
                await loadUsersData();
                
            } catch (error) {
                console.error('保存用户失败:', error);
                showNotification('保存用户失败: ' + error.message, 'error');
            } finally {
                document.getElementById('save-user-btn').disabled = false;
            }
        }

        // 删除用户
        function deleteUser(userId, username) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) {
                showNotification('用户不存在', 'error');
                return;
            }
            
            const deleteCheck = canDeleteUser(user);
            if (!deleteCheck.canDelete) {
                showNotification(deleteCheck.reason, 'warning');
                return;
            }
            
            // 通过验证，显示删除确认对话框
            deletingUserId = userId;
            document.getElementById('delete-user-name').textContent = username;
            document.getElementById('deleteUserModal').classList.add('show');
        }

        // 关闭删除用户模态框
        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('show');
            deletingUserId = null;
        }

        // 确认删除用户
        async function confirmDeleteUser() {
            if (!deletingUserId) return;
            
            try {
                const response = await fetch(`/api/users/${deletingUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                showNotification('用户删除成功', 'success');
                closeDeleteUserModal();
                await loadUsersData();
                
            } catch (error) {
                console.error('删除用户失败:', error);
                showNotification('删除用户失败: ' + error.message, 'error');
            }
        }

        // 格式化日期时间为北京时间
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            
            const date = new Date(dateTimeString);
            if (isNaN(date.getTime())) return dateTimeString;
            
            // 数据库返回的是UTC时间，直接转换为北京时间 (UTC+8)
            const beijingOffset = 8 * 60 * 60 * 1000; // 北京时间偏移量（毫秒）
            const beijingDate = new Date(date.getTime() + beijingOffset);
            
            return beijingDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 管理用户设备类别
        async function manageUserCategories(userId, username) {
            managingCategoriesUserId = userId;
            document.getElementById('category-user-name').textContent = username;
            
            try {
                // 并行加载用户当前的设备类别和所有类别的管理状态
                const [userCategoriesResponse, managedStatusResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/users/categories/managed-status', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!userCategoriesResponse.ok) {
                    throw new Error(`HTTP ${userCategoriesResponse.status}: ${userCategoriesResponse.statusText}`);
                }

                if (!managedStatusResponse.ok) {
                    throw new Error(`HTTP ${managedStatusResponse.status}: ${managedStatusResponse.statusText}`);
                }

                const userCategories = await userCategoriesResponse.json();
                const managedStatus = await managedStatusResponse.json();
                
                // 保存管理状态到全局变量
                window.categoriesManagedStatus = managedStatus;
                
                renderCategoriesCheckboxes(userCategories);
                document.getElementById('userCategoriesModal').classList.add('show');
                
            } catch (error) {
                console.error('加载用户设备类别失败:', error);
                showNotification('加载用户设备类别失败: ' + error.message, 'error');
            }
        }

        // 渲染设备类别复选框
        function renderCategoriesCheckboxes(userCategories) {
            const container = document.getElementById('categories-checkboxes');
            
            if (!allCategories || allCategories.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">暂无设备类别</p>';
                return;
            }

            const userCategoryIds = userCategories.map(uc => uc.category_id);
            
            container.innerHTML = allCategories.map(category => {
                const isChecked = userCategoryIds.includes(category.id);
                // 检查该类别是否已被其他用户管理
                const isManagedByOthers = isCategoryManagedByOtherUser(category.id, userCategoryIds);
                return `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded cursor-pointer ${isChecked ? 'bg-blue-50 border-l-4 border-blue-500' : ''} ${isManagedByOthers ? 'opacity-50 cursor-not-allowed' : ''}">
                        <input type="checkbox" 
                               class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2" 
                               value="${category.id}"
                               ${isChecked ? 'checked' : ''}
                               ${isManagedByOthers ? 'disabled' : ''}
                               id="category-${category.id}"
                               onchange="updateCategoryStyle(${category.id}, this.checked)">
                        <div class="flex-1">
                            <span class="text-sm font-medium ${isChecked ? 'text-blue-900' : 'text-gray-700'}">${category.name}</span>
                            ${isManagedByOthers ? '<span class="text-xs text-red-500 ml-2">(已被管理)</span>' : ''}
                        </div>
                    </label>
                `;
            }).join('');
            
            // 更新权限统计
            updatePermissionStats(userCategories.length);
        }

        // 检查类别是否被其他用户管理
        function isCategoryManagedByOtherUser(categoryId, currentUserCategoryIds) {
            if (!window.categoriesManagedStatus) return false;
            
            const categoryStatus = window.categoriesManagedStatus.find(status => status.category_id === categoryId);
            if (!categoryStatus) return false;
            
            // 如果该类别被管理，且不是由当前用户管理
            return categoryStatus.is_managed && !currentUserCategoryIds.includes(categoryId);
        }

        // 更新类别样式
        function updateCategoryStyle(categoryId, isChecked) {
            const checkbox = document.getElementById(`category-${categoryId}`);
            if (!checkbox) return;
            
            const label = checkbox.closest('label');
            if (!label) return;
            
            if (isChecked) {
                label.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
                label.classList.remove('hover:bg-gray-100');
                const nameSpan = label.querySelector('span');
                if (nameSpan) {
                    nameSpan.classList.add('text-blue-900');
                    nameSpan.classList.remove('text-gray-700');
                }
            } else {
                label.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                label.classList.add('hover:bg-gray-100');
                const nameSpan = label.querySelector('span');
                if (nameSpan) {
                    nameSpan.classList.remove('text-blue-900');
                    nameSpan.classList.add('text-gray-700');
                }
            }
            
            // 更新权限统计
            const checkedCount = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]:checked').length;
            updatePermissionStats(checkedCount);
        }

        // 更新权限统计
        function updatePermissionStats(checkedCount) {
            const statsElement = document.getElementById('permission-stats');
            if (!statsElement) return;
            
            const totalCount = allCategories.length;
            const percentage = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
            
            statsElement.innerHTML = `
                <div class="text-sm text-gray-600">
                    已选择 <span class="font-semibold text-blue-600">${checkedCount}</span> / ${totalCount} 个类别
                    <span class="text-gray-400 ml-2">(${percentage}%)</span>
                </div>
            `;
        }

        // 全选设备类别
        function selectAllCategories() {
            const checkboxes = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                updateCategoryStyle(parseInt(checkbox.value), true);
            });
        }

        // 清空所有类别选择
        function clearAllCategories() {
            const checkboxes = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                updateCategoryStyle(parseInt(checkbox.value), false);
            });
        }

        // 关闭用户设备类别模态框
        function closeUserCategoriesModal() {
            document.getElementById('userCategoriesModal').classList.remove('show');
            managingCategoriesUserId = null;
            
            // 清理权限统计显示
            const statsElement = document.getElementById('permission-stats');
            if (statsElement) {
                statsElement.innerHTML = '';
            }
        }

        // 管理用户器具权限
        async function manageUserEquipmentPermissions(userId, username) {
            managingEquipmentPermissionsUserId = userId;
            document.getElementById('equipment-permission-user-name').textContent = username;
            
            try {
                // 并行加载类别、器具管理状态和用户当前权限
                const [categoriesResponse, managedStatusResponse, userPermissionsResponse] = await Promise.all([
                    fetch('/api/categories/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/users/equipment-permissions/managed-status', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok || !managedStatusResponse.ok || !userPermissionsResponse.ok) {
                    throw new Error('Failed to load data');
                }

                allCategories = await categoriesResponse.json();
                equipmentManagedStatus = await managedStatusResponse.json();
                const userPermissions = await userPermissionsResponse.json();
                
                // 填充类别选择器
                populateCategorySelector();
                
                // 保存用户权限到全局变量
                window.currentUserEquipmentPermissions = userPermissions;
                
                const modal = document.getElementById('userEquipmentPermissionsModal');
                
                // 使用测试模态框的成功方法 - 移动模态框到body并设置样式
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    -webkit-backdrop-filter: blur(4px);
                    backdrop-filter: blur(4px);
                `;
                
                // 强制重绘
                modal.offsetHeight;
                
                // 确保模态框在body中
                if (modal.parentNode !== document.body) {
                    document.body.appendChild(modal);
                }
                
            } catch (error) {
                console.error('加载用户器具权限失败:', error);
                showNotification('加载用户器具权限失败: ' + error.message, 'error');
            }
        }

        // 填充类别选择器
        function populateCategorySelector() {
            const selectElement = document.getElementById('category-select');
            selectElement.innerHTML = '<option value="">选择类别</option>';
            
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }

        // 加载类别下的器具
        function loadCategoryEquipment() {
            const categoryId = document.getElementById('category-select').value;
            
            if (!categoryId) {
                document.getElementById('equipment-checkboxes').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle mr-2"></i>
                        请先选择一个设备类别
                    </div>
                `;
                return;
            }
            
            const category = allCategories.find(c => c.id == categoryId);
            if (!category || !category.predefined_names) {
                document.getElementById('equipment-checkboxes').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle mr-2"></i>
                        该类别下没有预定义器具
                    </div>
                `;
                return;
            }
            
            renderEquipmentCheckboxes(categoryId, category.predefined_names);
        }

        // 渲染器具复选框
        function renderEquipmentCheckboxes(categoryId, equipmentNames) {
            const container = document.getElementById('equipment-checkboxes');
            
            // 获取用户当前在该类别下的权限
            const userPermissions = window.currentUserEquipmentPermissions || [];
            const userEquipmentNames = userPermissions
                .filter(p => p.category_id == categoryId)
                .map(p => p.equipment_name);
            
            container.innerHTML = equipmentNames.map(equipmentName => {
                const isChecked = userEquipmentNames.includes(equipmentName);
                // 检查该器具是否已被其他用户管理
                const isManagedByOthers = isEquipmentManagedByOtherUser(categoryId, equipmentName);
                return `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded cursor-pointer ${isChecked ? 'bg-purple-50 border-l-4 border-purple-500' : ''} ${isManagedByOthers ? 'opacity-50 cursor-not-allowed' : ''}">
                        <input type="checkbox" 
                               class="w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 focus:ring-2" 
                               value="${equipmentName}"
                               ${isChecked ? 'checked' : ''}
                               ${isManagedByOthers ? 'disabled' : ''}
                               id="equipment-${equipmentName.replace(/[^a-zA-Z0-9]/g, '-')}"
                               onchange="updateEquipmentStyle('${equipmentName}', this.checked)">
                        <div class="flex-1">
                            <span class="text-sm font-medium ${isChecked ? 'text-purple-900' : 'text-gray-700'}">${equipmentName}</span>
                            ${isManagedByOthers ? '<span class="text-xs text-red-500 ml-2">(已被管理)</span>' : ''}
                        </div>
                    </label>
                `;
            }).join('');
            
            // 更新权限统计
            updateEquipmentPermissionStats(userEquipmentNames.length, equipmentNames.length);
        }

        // 检查器具是否被其他用户管理
        function isEquipmentManagedByOtherUser(categoryId, equipmentName) {
            const managedItem = equipmentManagedStatus.find(item => 
                item.category_id == categoryId && item.equipment_name == equipmentName
            );
            // 如果该器具被管理，且不是由当前用户管理
            return managedItem && managedItem.is_managed && managedItem.managed_by_user_id != managingEquipmentPermissionsUserId;
        }

        // 更新器具样式
        function updateEquipmentStyle(equipmentName, isChecked) {
            const checkboxId = `equipment-${equipmentName.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const checkbox = document.getElementById(checkboxId);
            if (!checkbox) return;
            
            const label = checkbox.closest('label');
            if (!label) return;
            
            if (isChecked) {
                label.classList.add('bg-purple-50', 'border-l-4', 'border-purple-500');
                label.classList.remove('hover:bg-gray-100');
                const nameSpan = label.querySelector('span');
                if (nameSpan) {
                    nameSpan.classList.add('text-purple-900');
                    nameSpan.classList.remove('text-gray-700');
                }
            } else {
                label.classList.remove('bg-purple-50', 'border-l-4', 'border-purple-500');
                label.classList.add('hover:bg-gray-100');
                const nameSpan = label.querySelector('span');
                if (nameSpan) {
                    nameSpan.classList.remove('text-purple-900');
                    nameSpan.classList.add('text-gray-700');
                }
            }
            
            // 更新权限统计
            const categoryId = document.getElementById('category-select').value;
            if (categoryId) {
                const category = allCategories.find(c => c.id == categoryId);
                if (category && category.predefined_names) {
                    const checkedCount = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:checked').length;
                    updateEquipmentPermissionStats(checkedCount, category.predefined_names.length);
                }
            }
        }

        // 更新器具权限统计
        function updateEquipmentPermissionStats(checkedCount, totalCount) {
            const statsElement = document.getElementById('equipment-permission-stats');
            if (!statsElement) return;
            
            const percentage = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
            
            statsElement.innerHTML = `
                <div class="text-sm text-gray-600">
                    已选择 <span class="font-semibold text-purple-600">${checkedCount}</span> / ${totalCount} 个器具
                    <span class="text-gray-400 ml-2">(${percentage}%)</span>
                </div>
            `;
        }

        // 全选器具
        function selectAllEquipment() {
            const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                updateEquipmentStyle(checkbox.value, true);
            });
        }

        // 清空所有器具选择
        function clearAllEquipment() {
            const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                updateEquipmentStyle(checkbox.value, false);
            });
        }

        // 保存用户器具权限
        async function saveUserEquipmentPermissions() {
            if (!managingEquipmentPermissionsUserId) return;

            const categoryId = document.getElementById('category-select').value;
            if (!categoryId) {
                showNotification('请选择一个设备类别', 'warning');
                return;
            }

            const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:checked');
            const equipmentNames = Array.from(checkboxes).map(cb => cb.value);

            try {
                const response = await fetch(`/api/users/${managingEquipmentPermissionsUserId}/equipment-permissions`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category_id: parseInt(categoryId),
                        equipment_names: equipmentNames
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                showNotification('用户器具权限更新成功', 'success');
                
                // 重新加载该用户的权限显示
                await loadUserPermissions(managingEquipmentPermissionsUserId);
                
                // 如果详情面板是展开状态，也更新详情内容
                const detailsRow = document.getElementById(`permission-details-${managingEquipmentPermissionsUserId}`);
                if (!detailsRow.classList.contains('hidden')) {
                    await loadPermissionDetails(managingEquipmentPermissionsUserId);
                }
                
                // 等待一小段时间确保显示更新后再关闭模态框
                setTimeout(() => {
                    closeUserEquipmentPermissionsModal();
                }, 300);
                
            } catch (error) {
                console.error('保存用户器具权限失败:', error);
                showNotification('保存用户器具权限失败: ' + error.message, 'error');
            }
        }

        // 关闭用户器具权限模态框
        function closeUserEquipmentPermissionsModal() {
            const modal = document.getElementById('userEquipmentPermissionsModal');
            modal.style.display = 'none';
            managingEquipmentPermissionsUserId = null;
            
            // 清理表单
            document.getElementById('category-select').value = '';
            document.getElementById('equipment-checkboxes').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-info-circle mr-2"></i>
                    请先选择一个设备类别
                </div>
            `;
            
            // 清理权限统计显示
            const statsElement = document.getElementById('equipment-permission-stats');
            if (statsElement) {
                statsElement.innerHTML = '';
            }
        }

        // 保存用户设备类别
        async function saveUserCategories() {
            if (!managingCategoriesUserId) return;

            const checkboxes = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]:checked');
            const categoryIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            try {
                const response = await fetch(`/api/users/${managingCategoriesUserId}/categories`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category_ids: categoryIds
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                showNotification('用户设备类别权限更新成功', 'success');
                
                // 重新加载该用户的权限显示（类别+器具）
                await loadUserPermissions(managingCategoriesUserId);
                
                // 如果详情面板是展开状态，也更新详情内容
                const detailsRow = document.getElementById(`permission-details-${managingCategoriesUserId}`);
                if (!detailsRow.classList.contains('hidden')) {
                    await loadPermissionDetails(managingCategoriesUserId);
                }
                
                // 等待一小段时间确保显示更新后再关闭模态框
                setTimeout(() => {
                    closeUserCategoriesModal();
                }, 300);
                
            } catch (error) {
                console.error('保存用户设备类别失败:', error);
                showNotification('保存用户设备类别失败: ' + error.message, 'error');
            }
        }

        // 分页事件监听器
        function setupPaginationEventListeners() {
            // 每页显示条数变化
            document.getElementById('page-size').addEventListener('change', function() {
                itemsPerPage = parseInt(this.value);
                currentPage = 1;
                // 保存每页显示条数到本地存储
                localStorage.setItem('users_page_size', this.value);
                loadUsersData();
            });

            // 上一页
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadUsersData();
                }
            });

            // 下一页
            document.getElementById('next-page').addEventListener('click', function() {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    loadUsersData();
                }
            });
        }

        // 更新分页信息
        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('total-count').textContent = totalItems;
            
            // 更新按钮状态
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // 生成页码按钮
            generatePageNumbers(currentPage, totalPages);
        }

        // 生成页码按钮
        function generatePageNumbers(currentPage, totalPages) {
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一页
            if (startPage > 1) {
                pageNumbersContainer.appendChild(createPageButton(1, currentPage));
                if (startPage > 2) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
            }
            
            // 页码按钮
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersContainer.appendChild(createPageButton(i, currentPage));
            }
            
            // 最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                pageNumbersContainer.appendChild(createPageButton(totalPages, currentPage));
            }
        }
        
        // 创建页码按钮
        function createPageButton(pageNum, currentPage) {
            const button = document.createElement('button');
            button.className = `px-3 py-2 border text-sm font-medium rounded-lg transition-colors ${
                pageNum === currentPage 
                    ? 'bg-blue-500 text-white border-blue-500' 
                    : 'border-gray-300 text-gray-700 hover:bg-gray-50'
            }`;
            button.textContent = pageNum;
            button.onclick = () => changePage(pageNum);
            return button;
        }
        
        // 创建省略号
        function createEllipsis() {
            const span = document.createElement('span');
            span.className = 'px-3 py-2 text-gray-500';
            span.textContent = '...';
            return span;
        }
        
        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            loadUsersData();
        }

        // 切换权限详情显示
        async function togglePermissionDetails(userId) {
            const detailsRow = document.getElementById(`permission-details-${userId}`);
            const btn = document.getElementById(`permission-detail-btn-${userId}`);
            
            if (detailsRow.classList.contains('hidden')) {
                // 展开详情
                detailsRow.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                btn.title = '隐藏权限信息';
                
                // 加载详细信息
                await loadPermissionDetails(userId);
            } else {
                // 收起详情
                detailsRow.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-info-circle"></i>';
                btn.title = '查看完整权限信息';
            }
        }

        // 加载权限详细信息
        async function loadPermissionDetails(userId) {
            const contentElement = document.getElementById(`permission-details-content-${userId}`);
            if (!contentElement) return;
            
            try {
                // 并行加载类别权限和器具权限
                const [categoriesResponse, equipmentResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok || !equipmentResponse.ok) {
                    throw new Error('Failed to load permission details');
                }

                const userCategories = await categoriesResponse.json();
                const equipmentPermissions = await equipmentResponse.json();
                
                // 查找用户信息
                const user = currentUsers.find(u => u.id === userId);
                
                let detailsHTML = '';
                
                if (user && user.is_admin) {
                    detailsHTML = `
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-crown text-purple-600 mr-2"></i>
                                <span class="font-medium text-purple-900">系统管理员</span>
                            </div>
                            <p class="text-sm text-purple-700">拥有系统的完整访问权限，可以管理所有设备类别和器具。</p>
                        </div>
                    `;
                } else {
                    const hasCategoryPermissions = userCategories && userCategories.length > 0;
                    const hasEquipmentPermissions = equipmentPermissions && equipmentPermissions.length > 0;
                    
                    if (!hasCategoryPermissions && !hasEquipmentPermissions) {
                        detailsHTML = `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <div class="flex items-center">
                                    <i class="fas fa-ban text-gray-400 mr-2"></i>
                                    <span class="text-gray-600">暂无任何管理权限</span>
                                </div>
                            </div>
                        `;
                    } else {
                        detailsHTML = '<div class="space-y-3">';
                        
                        // 类别权限
                        if (hasCategoryPermissions) {
                            detailsHTML += `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-tags text-blue-600 mr-2"></i>
                                        <span class="font-medium text-blue-900">设备类别权限 (${userCategories.length})</span>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        ${userCategories.map(uc => `
                                            <div class="bg-white rounded px-2 py-1 text-sm text-blue-700 border border-blue-200">
                                                ${uc.category.name}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // 器具权限
                        if (hasEquipmentPermissions) {
                            // 按类别分组显示器具权限
                            const equipmentByCategory = {};
                            equipmentPermissions.forEach(ep => {
                                if (!equipmentByCategory[ep.category_name]) {
                                    equipmentByCategory[ep.category_name] = [];
                                }
                                equipmentByCategory[ep.category_name].push(ep.equipment_name);
                            });
                            
                            detailsHTML += `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-tools text-green-600 mr-2"></i>
                                        <span class="font-medium text-green-900">器具权限 (${equipmentPermissions.length})</span>
                                    </div>
                                    <div class="space-y-2">
                                        ${Object.entries(equipmentByCategory).map(([categoryName, equipmentNames]) => `
                                            <div class="bg-white rounded p-2 border border-green-200">
                                                <div class="text-xs font-medium text-green-700 mb-1">${categoryName}</div>
                                                <div class="flex flex-wrap gap-1">
                                                    ${equipmentNames.map(name => `
                                                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${name}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        detailsHTML += '</div>';
                    }
                }
                
                contentElement.innerHTML = detailsHTML;
                
            } catch (error) {
                console.error('加载权限详情失败:', error);
                contentElement.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="flex items-center text-red-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span class="text-sm">加载权限信息失败</span>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>