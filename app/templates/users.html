<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 设备台账管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/session-manager.js?v=2"></script>
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/tab-session-manager.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #667eea;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部通知容器 -->
    <div id="notification-container" class="fixed top-4 right-4 z-[9999] space-y-2 max-w-md"></div>
    
    <div class="flex h-screen">
        <!-- 左侧导航栏 -->
        <div class="w-64 gradient-bg shadow-xl fixed left-0 top-0 h-full z-10">
            <div class="flex flex-col h-full">
                <!-- Logo和标题 -->
                <div class="flex items-center justify-center h-16 px-4 border-b border-white/20">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-list text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-lg font-bold">设备台账管理系统</h1>
                    </div>
                </div>

                <!-- 导航菜单 -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="/dashboard" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="/equipment" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg">
                        <i class="fas fa-cogs mr-3 text-lg"></i>
                        <span>设备管理</span>
                    </a>
                        <a href="/reports" class="sidebar-item flex items-center px-4 py-3 text-white/90 rounded-lg" id="reports-link">
                        <i class="fas fa-chart-bar mr-3 text-lg"></i>
                        <span>统计报表</span>
                    </a>
                    
                    <!-- 系统管理下拉菜单 -->
                    <div class="relative">
                        <button class="sidebar-item flex items-center justify-between w-full px-4 py-3 text-white/90 rounded-lg" id="system-menu-btn" aria-label="展开系统管理菜单" aria-expanded="false">
                            <div class="flex items-center">
                                <i class="fas fa-cog mr-3 text-lg"></i>
                                <span>系统管理</span>
                            </div>
                            <i class="fas fa-chevron-down text-sm transition-transform duration-200" id="system-menu-arrow"></i>
                        </button>
                        <div class="ml-4 mt-1 space-y-1 hidden" id="system-submenu">
                            <a href="/categories" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-tags mr-3"></i>
                                <span>设备类别</span>
                            </a>
                            <a href="/departments" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-building mr-3"></i>
                                <span>部门管理</span>
                            </a>
                            <a href="/users" class="sidebar-item active flex items-center px-4 py-2 text-white/80 rounded-lg text-sm">
                                <i class="fas fa-users mr-3"></i>
                                <span>用户管理</span>
                            </a>
                            <a href="/audit" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="audit-link">
                                <i class="fas fa-history mr-3"></i>
                                <span>操作日志</span>
                            </a>
                            <a href="/settings" class="sidebar-item flex items-center px-4 py-2 text-white/80 rounded-lg text-sm" id="settings-link">
                                <i class="fas fa-cog mr-3"></i>
                                <span>系统设置</span>
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- 用户信息 -->
                <div class="border-t border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-white text-xl mr-3"></i>
                            <div>
                                <p class="text-white text-base font-medium" id="current-user"></p>
                            </div>
                        </div>
                        <button class="text-white/70 hover:text-white transition-colors" id="logout-btn" aria-label="退出登录">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 ml-64 overflow-hidden">
            <div class="h-full overflow-y-auto">
                <div class="p-8">
            
            <!-- 主要内容 -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">用户管理</h2>
                <p class="text-gray-600">管理系统用户账户、权限和访问控制</p>
            </div>

            <!-- 操作栏 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="搜索用户名..." 
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex gap-3">
                        <button class="btn-primary text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200" onclick="openCreateUserModal()" aria-label="创建新用户">
                            <i class="fas fa-plus mr-2"></i>创建用户
                        </button>
                    </div>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <i class="fas fa-users text-2xl text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">用户总数</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-users-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i class="fas fa-user-shield text-2xl text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">管理员用户</p>
                            <p class="text-2xl font-bold text-gray-900" id="admin-users-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100">
                            <i class="fas fa-user text-2xl text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">普通用户</p>
                            <p class="text-2xl font-bold text-gray-900" id="normal-users-count">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户列表 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">用户列表</h3>
                        <div class="text-sm text-gray-600">
                            共 <span id="users-total-count" class="font-semibold text-gray-900">-</span> 个用户
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">用户信息</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">权限等级</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">管理权限</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">详情</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">创建时间</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="users-table-body">
                            <!-- 动态加载的用户数据 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 统一分页控件 -->
                <div id="pagination-container" class="flex items-center justify-between mt-6 px-6 pb-6">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700">每页显示</span>
                        <select id="page-size" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-700">条</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="prev-page" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                            <i class="fas fa-chevron-left mr-1"></i>上一页
                        </button>
                        <div id="page-numbers" class="flex items-center space-x-1">
                            <!-- 页码按钮将动态生成 -->
                        </div>
                        <button id="next-page" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                            下一页<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700">
                        <span id="page-info">第 1 页，共 1 页</span>
                        <span class="text-gray-500 mx-2">|</span>
                        <span>共 <span id="total-count">0</span> 条</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
    </div>

    <!-- 创建/编辑用户模态框 -->
    <div id="userModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title">创建用户</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeUserModal()" aria-label="关闭对话框">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="user-form">
                    <div class="mb-4">
                        <label for="user-username" class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                        <input type="text" id="user-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入用户名" required>
                    </div>
                    
                    <div class="mb-4" id="password-field">
                        <label for="user-password" class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <div class="relative">
                            <input type="password" id="user-password" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入密码" required>
                            <button type="button" id="toggleUserPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="userPasswordEyeIcon"></i>
                            </button>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                            <h4 class="text-blue-800 font-medium text-sm mb-2">密码要求：</h4>
                            <ul class="text-xs space-y-2">
                                <li id="userLengthCheck" class="flex items-center">
                                    <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                    <span class="text-gray-600">至少6个字符长度</span>
                                </li>
                                <li id="userLetterCheck" class="flex items-center">
                                    <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                    <span class="text-gray-600">必须包含字母</span>
                                </li>
                                <li id="userNumberCheck" class="flex items-center">
                                    <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                    <span class="text-gray-600">必须包含数字</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-4" id="change-password-field" style="display: none;">
                        <label class="flex items-center mb-2">
                            <input type="checkbox" id="change-password" class="mr-2 rounded border-gray-300">
                            <span class="text-sm text-gray-700">修改密码</span>
                        </label>
                        <div id="new-password-fields" style="display: none;">
                            <div class="mb-3">
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                                <div class="relative">
                                    <input type="password" id="new-password" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入新密码">
                                    <button type="button" id="toggleNewPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-eye" id="newPasswordEyeIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                                <div class="relative">
                                    <input type="password" id="confirm-password" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请再次输入新密码">
                                    <button type="button" id="toggleConfirmPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-eye" id="confirmPasswordEyeIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 class="text-blue-800 font-medium text-sm mb-2">密码要求：</h4>
                                <ul class="text-xs space-y-2">
                                    <li id="editLengthCheck" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                        <span class="text-gray-600">至少6个字符长度</span>
                                    </li>
                                    <li id="editLetterCheck" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                        <span class="text-gray-600">必须包含字母</span>
                                    </li>
                                    <li id="editNumberCheck" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                        <span class="text-gray-600">必须包含数字</span>
                                    </li>
                                    <li id="editMatchCheck" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                        <span class="text-gray-600">两次密码输入一致</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="user-is-admin" class="flex items-center">
                            <input type="checkbox" id="user-is-admin" class="mr-2 rounded border-gray-300">
                            <span class="text-sm text-gray-700">管理员权限</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">管理员拥有系统的完整访问权限</p>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeUserModal()">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" id="save-user-btn">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="deleteUserModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
            </div>
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-700">您确定要删除用户 <span id="delete-user-name" class="font-semibold"></span> 吗？</p>
                        <p class="text-sm text-gray-500 mt-1">此操作不可恢复。</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeDeleteUserModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmDeleteUser()">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
  
    <!-- 管理用户器具权限模态框 -->
    <div id="userEquipmentPermissionsModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[85vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">管理用户器具权限</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeUserEquipmentPermissionsModal()" aria-label="关闭对话框">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">用户: <span id="equipment-permission-user-name" class="font-semibold"></span></p>
                    <p class="text-xs text-gray-500">选择该用户可以管理的具体器具</p>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-gray-700">设备类别</label>
                        <select id="category-select" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadCategoryEquipment()">
                            <option value="">选择类别</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div id="equipment-permission-stats" class="mb-3">
                        <!-- 权限统计将在这里显示 -->
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-gray-700">器具列表</label>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="show-only-with-devices" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="toggleEquipmentFilter()" checked>
                                <label for="show-only-with-devices" class="text-sm text-gray-700 cursor-pointer">只显示有设备的器具</label>
                            </div>
                            <div class="border-l border-gray-300 pl-3 flex space-x-2">
                                <button type="button" class="text-xs text-blue-600 hover:text-blue-800" onclick="selectAllEquipment()">
                                    全选
                                </button>
                                <button type="button" class="text-xs text-gray-600 hover:text-gray-800" onclick="clearAllEquipment()">
                                    清空
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-3 max-h-64 overflow-y-auto bg-gray-50" id="equipment-checkboxes">
                        <div class="text-center text-gray-500 py-4">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            正在加载有设备的器具...
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="closeUserEquipmentPermissionsModal()">
                        取消
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="directClearAllPermissions()">
                        <i class="fas fa-trash-alt mr-2"></i>清空权限
                    </button>
                    <button type="button" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="saveUserEquipmentPermissions()">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUsers = [];
        let editingUserId = null;
        let deletingUserId = null;
        let managingCategoriesUserId = null;
        let managingEquipmentPermissionsUserId = null;
        let allCategories = [];
        let equipmentManagedStatus = [];
        let currentEquipmentCounts = {}; // 存储当前类别的设备数量信息
        let currentPage = 1;
        let itemsPerPage = parseInt(localStorage.getItem('users_page_size') || '20');
        let totalItems = 0;

        // 动态获取token的辅助函数
        function getCurrentToken() {
            return sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
        }

        // 获取带token的请求头
        function getAuthHeaders() {
            const token = getCurrentToken();
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializePage();
                setupEventListeners();
                loadUsersData();
                loadCategories();
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败，请刷新页面重试', 'error');
            }
        });

        // 初始化页面
        function initializePage() {
            // 设置系统管理菜单展开状态
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            if (systemSubmenu && systemMenuArrow) {
                systemSubmenu.classList.remove('hidden');
                systemMenuArrow.style.transform = 'rotate(180deg)';
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 搜索输入框
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterUsers();
                }, 300);
            });

            // 用户表单提交
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);

            // 密码修改复选框
            const changePasswordCheckbox = document.getElementById('change-password');
            if (changePasswordCheckbox) {
                changePasswordCheckbox.addEventListener('change', function() {
                    const newPasswordFields = document.getElementById('new-password-fields');
                    const newPassword = document.getElementById('new-password');
                    const confirmPassword = document.getElementById('confirm-password');
                    
                    if (this.checked) {
                        newPasswordFields.style.display = 'block';
                        newPassword.required = true;
                        confirmPassword.required = true;
                    } else {
                        newPasswordFields.style.display = 'none';
                        newPassword.required = false;
                        confirmPassword.required = false;
                        newPassword.value = '';
                        confirmPassword.value = '';
                        // 清除验证样式
                        newPassword.classList.remove('border-red-500', 'border-green-500');
                        newPassword.classList.add('border-gray-300');
                        confirmPassword.classList.remove('border-red-500', 'border-green-500');
                        confirmPassword.classList.add('border-gray-300');
                    }
                });
            }

            // 密码显示切换
            setupPasswordToggle('toggleUserPassword', 'user-password', 'userPasswordEyeIcon');
            setupPasswordToggle('toggleNewPassword', 'new-password', 'newPasswordEyeIcon');
            setupPasswordToggle('toggleConfirmPassword', 'confirm-password', 'confirmPasswordEyeIcon');

            // 密码输入实时验证
            document.getElementById('user-password').addEventListener('input', function() {
                validateUserPassword();
            });
            
            document.getElementById('new-password').addEventListener('input', function() {
                validateEditPassword();
            });
            
            document.getElementById('confirm-password').addEventListener('input', function() {
                validateEditPassword();
            });

            // 侧边栏导航
            setupSidebarNavigation();

            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeUserModal();
                    closeDeleteUserModal();
                    closeUserEquipmentPermissionsModal();
                }
            });

            // 点击模态框外部关闭
            document.getElementById('userModal').addEventListener('click', function(e) {
                if (e.target === this) closeUserModal();
            });

            document.getElementById('deleteUserModal').addEventListener('click', function(e) {
                if (e.target === this) closeDeleteUserModal();
            });

            document.getElementById('userEquipmentPermissionsModal').addEventListener('click', function(e) {
                if (e.target === this) closeUserEquipmentPermissionsModal();
            });
            
            // 分页事件监听器
            setupPaginationEventListeners();
        }

        // 设置侧边栏导航
        function setupSidebarNavigation() {
            // 系统管理下拉菜单
            const systemMenuBtn = document.getElementById('system-menu-btn');
            const systemSubmenu = document.getElementById('system-submenu');
            const systemMenuArrow = document.getElementById('system-menu-arrow');
            
            if (systemMenuBtn) {
                systemMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    systemSubmenu.classList.toggle('hidden');
                    
                    if (systemSubmenu.classList.contains('hidden')) {
                        systemMenuArrow.style.transform = 'rotate(0deg)';
                    } else {
                        systemMenuArrow.style.transform = 'rotate(180deg)';
                    }
                });
            }
            
            // 退出登录
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('确定要退出登录吗？')) {
                        // 先调用后端登出API销毁会话
                        const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
                        if (token) {
                            fetch('/api/auth/logout', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Logout response:', data);
                            })
                            .catch(error => {
                                console.error('Logout error:', error);
                            })
                            .finally(() => {
                                // 清除本地存储
                                sessionStorage.removeItem('access_token');
                                sessionStorage.removeItem('refresh_token');
                                sessionStorage.removeItem('user_info');
                                localStorage.removeItem('access_token');
                                localStorage.removeItem('refresh_token');
                                localStorage.removeItem('user_info');
                                
                                // 通知标签页会话管理器
                                if (window.tabSessionManager) {
                                    tabSessionManager.clearSession();
                                }
                                
                                window.location.href = '/login';
                            });
                        } else {
                            // 如果没有token，直接清除并跳转
                            sessionStorage.removeItem('access_token');
                            sessionStorage.removeItem('refresh_token');
                            sessionStorage.removeItem('user_info');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            localStorage.removeItem('user_info');
                            
                            // 通知标签页会话管理器
                            if (window.tabSessionManager) {
                                tabSessionManager.clearSession();
                            }
                            
                            window.location.href = '/login';
                        }
                    }
                });
            }
            
            // 检查登录状态
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const currentUserElement = document.getElementById('current-user');
                if (currentUserElement) {
                    currentUserElement.textContent = user.username || '用户';
                    currentUserElement.style.visibility = 'visible'; // 显示用户信息
                }
            }
        }

        // 加载用户数据
        async function loadUsersData() {
            try {
                showNotification('正在加载用户数据...', 'info');
                
                // 使用分页参数加载用户数据
                const skip = (currentPage - 1) * itemsPerPage;
                const users = await api.get(`/api/users/?skip=${skip}&limit=${itemsPerPage}`);
                currentUsers = users;
                
                // 获取总用户数用于分页
                const allUsers = await api.get('/api/users/');
                totalItems = allUsers.length;
                updateUsersStats(allUsers);
                
                renderUsersTable(users);
                updatePagination();
                
                // 加载当前页用户的设备类别
                for (const user of users) {
                    loadUserCategories(user.id);
                }
                
                showNotification('用户数据加载成功', 'success');
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                showNotification('加载用户数据失败: ' + error.message, 'error');
                renderUsersTable([]);
            }
        }

        // 加载所有设备类别
        async function loadCategories() {
            try {
                allCategories = await api.get('/api/categories/');
                
            } catch (error) {
                console.error('加载设备类别失败:', error);
                showNotification('加载设备类别失败: ' + error.message, 'error');
            }
        }

        // 加载用户的权限信息（类别权限 + 器具权限）
        async function loadUserCategories(userId) {
            try {
                // 并行加载类别权限和器具权限
                const [categoriesResponse, equipmentResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok) {
                    throw new Error(`加载类别权限失败: HTTP ${categoriesResponse.status}`);
                }
                if (!equipmentResponse.ok) {
                    throw new Error(`加载器具权限失败: HTTP ${equipmentResponse.status}`);
                }

                const userCategories = await categoriesResponse.json();
                const equipmentPermissions = await equipmentResponse.json();
                
                // 保存权限数据到全局变量
                if (!window.userPermissionsData) {
                    window.userPermissionsData = {};
                }
                window.userPermissionsData[userId] = {
                    category_permissions: userCategories,
                    equipment_permissions: equipmentPermissions
                };
                
                updateUserPermissionsDisplay(userId, userCategories, equipmentPermissions);
                
                // 更新删除按钮状态
                updateUserDeleteButton(userId);
                
            } catch (error) {
                console.error('加载用户权限失败:', error);
                const categoryElement = document.getElementById(`user-categories-${userId}`);
                if (categoryElement) {
                    categoryElement.innerHTML = '<span class="text-gray-400">加载失败</span>';
                }
            }
        }

        // 加载用户权限信息并更新显示
        async function loadUserPermissions(userId) {
            try {
                // 并行加载类别权限和器具权限
                const [categoriesResponse, equipmentResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok || !equipmentResponse.ok) {
                    throw new Error('Failed to load user permissions');
                }

                const userCategories = await categoriesResponse.json();
                const equipmentPermissions = await equipmentResponse.json();
                
                // 保存权限数据到全局变量
                if (!window.userPermissionsData) {
                    window.userPermissionsData = {};
                }
                window.userPermissionsData[userId] = {
                    category_permissions: userCategories,
                    equipment_permissions: equipmentPermissions
                };
                
                // 更新权限显示
                updateUserPermissionsDisplay(userId, userCategories, equipmentPermissions);
                
                // 更新删除按钮状态
                updateUserDeleteButton(userId);
                
            } catch (error) {
                console.error('加载用户权限失败:', error);
                const categoryElement = document.getElementById(`user-categories-${userId}`);
                if (categoryElement) {
                    categoryElement.innerHTML = '<span class="text-red-500">权限加载失败</span>';
                }
            }
        }

        // 更新用户权限显示（类别权限 + 器具权限）
        function updateUserPermissionsDisplay(userId, userCategories, equipmentPermissions) {
            const categoryElement = document.getElementById(`user-categories-${userId}`);
            if (!categoryElement) return;
            
            // 查找该用户是否为管理员
            const user = currentUsers.find(u => u.id === userId);
            const isAdmin = user && user.is_admin;
            
            if (isAdmin) {
                // 管理员显示所有权限
                categoryElement.innerHTML = '<span class="text-sm text-purple-600 font-medium">全部权限</span>';
            } else {
                const hasCategoryPermissions = userCategories && userCategories.length > 0;
                const hasEquipmentPermissions = equipmentPermissions && equipmentPermissions.length > 0;
                
                if (!hasCategoryPermissions && !hasEquipmentPermissions) {
                    categoryElement.innerHTML = '<span class="text-gray-400">无权限</span>';
                } else {
                    let permissionTexts = [];
                    let fullPermissionText = '';
                    
                    // 添加类别权限
                    if (hasCategoryPermissions) {
                        const categoryNames = userCategories.map(uc => uc.category.name);
                        const displayNames = categoryNames.slice(0, 2);
                        if (categoryNames.length > 2) {
                            permissionTexts.push(`${displayNames.join(', ')}+${categoryNames.length - 2}`);
                        } else {
                            permissionTexts.push(displayNames.join(', '));
                        }
                        fullPermissionText += `类别: ${categoryNames.join(', ')}`;
                    }
                    
                    // 添加器具权限
                    if (hasEquipmentPermissions) {
                        const equipmentNames = equipmentPermissions.map(ep => ep.equipment_name);
                        const displayNames = equipmentNames.slice(0, 3);
                        if (equipmentPermissions.length > 3) {
                            permissionTexts.push(`${displayNames.join(', ')}+${equipmentPermissions.length - 3}`);
                        } else {
                            permissionTexts.push(displayNames.join(', '));
                        }
                        if (fullPermissionText) fullPermissionText += ' | ';
                        fullPermissionText += `器具: ${equipmentNames.join(', ')}`;
                    }
                    
                    const displayText = permissionTexts.join(', ');
                    
                    // 如果权限被截断，添加Tooltip
                    if ((hasCategoryPermissions && userCategories.length > 2) || 
                        (hasEquipmentPermissions && equipmentPermissions.length > 3)) {
                        categoryElement.innerHTML = `
                            <div class="relative inline-block group">
                                <span class="text-sm text-gray-900 cursor-help border-b border-dotted border-gray-400">${displayText}</span>
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                                    <div class="text-center">${fullPermissionText}</div>
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        categoryElement.innerHTML = `<span class="text-sm text-gray-900">${displayText}</span>`;
                    }
                }
            }
            
            // 更新删除按钮状态
            updateUserDeleteButton(userId);
        }

        // 更新用户删除按钮状态
        function updateUserDeleteButton(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) {
                return;
            }
            
            // 找到该用户行的操作列
            const userRow = document.querySelector(`#user-categories-${userId}`).closest('tr');
            if (!userRow) {
                console.log('User row not found');
                return;
            }
            
            const actionCell = userRow.querySelector('td:last-child');
            if (!actionCell) {
                console.log('Action cell not found');
                return;
            }
            
            // 重新生成删除按钮
            const deleteButtonHTML = getUserDeleteButton(user);
            
            // 找到删除按钮并替换
            const deleteButton = actionCell.querySelector('button[onclick*="deleteUser"]');
            if (deleteButton) {
                deleteButton.outerHTML = deleteButtonHTML;
            }
        }

        // 渲染用户表格
        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            暂无用户数据
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 flex-shrink-0">
                                <div class="h-10 w-10 rounded-full ${user.is_admin ? 'bg-purple-100' : 'bg-blue-100'} flex items-center justify-center">
                                    <i class="fas ${user.is_admin ? 'fa-user-shield text-purple-600' : 'fa-user text-blue-600'}"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.username}</div>
                                <div class="text-sm text-gray-500">ID: ${user.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            user.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                        }">
                            ${user.is_admin ? '管理员' : '普通用户'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="text-sm text-gray-900" id="user-categories-${user.id}">
                            <span class="text-gray-400">加载中...</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center">
                            <button onclick="togglePermissionDetails(${user.id})" 
                                    class="text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-50 transition-colors"
                                    title="查看完整权限信息"
                                    id="permission-detail-btn-${user.id}">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                        ${formatDateTime(user.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center justify-center space-x-2">
                            ${getUserPermissionManagementButtons(user)}
                            ${getUserEditButton(user)}
                            ${getUserDeleteButton(user)}
                        </div>
                    </td>
                </tr>
                <tr id="permission-details-${user.id}" class="hidden">
                    <td colspan="6" class="px-6 py-4 bg-gray-50">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-gray-900">
                                    <i class="fas fa-key mr-2 text-blue-600"></i>
                                    ${user.username} 的完整权限信息
                                </h4>
                                <button onclick="togglePermissionDetails(${user.id})" 
                                        class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="permission-details-content-${user.id}" class="space-y-3">
                                <div class="text-sm text-gray-500">正在加载权限信息...</div>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 检查用户是否可以删除
        function canDeleteUser(user) {
            const currentUser = JSON.parse(sessionStorage.getItem('user_info') || localStorage.getItem('user_info') || '{}');
            
            // 检查是否为当前登录用户
            if (currentUser.id === user.id) {
                return { canDelete: false, reason: '无法删除当前登录用户' };
            }
            
            // 检查用户是否为系统管理员（不能删除最后一个管理员）
            if (user.is_admin) {
                const adminUsers = currentUsers.filter(u => u.is_admin).length;
                if (adminUsers <= 1) {
                    return { canDelete: false, reason: '系统至少需要保留一个管理员用户' };
                }
            }
            
            // 检查用户是否有权限（类别权限或器具权限）
            const userPermissions = window.userPermissionsData ? window.userPermissionsData[user.id] : null;
            
            // 检查类别权限
            if (userPermissions && userPermissions.category_permissions && userPermissions.category_permissions.length > 0) {
                return { canDelete: false, reason: '该用户管理着设备类别，无法删除' };
            }
            
            // 检查器具权限
            if (userPermissions && userPermissions.equipment_permissions && userPermissions.equipment_permissions.length > 0) {
                return { canDelete: false, reason: '该用户管理着器具，无法删除' };
            }
            
            return { canDelete: true, reason: '' };
        }

        // 获取用户权限管理按钮
        function getUserPermissionManagementButtons(user) {
            const currentUser = JSON.parse(sessionStorage.getItem('user_info') || localStorage.getItem('user_info') || '{}');
            
            // 如果是管理员账号，显示灰色不可点击的按钮
            if (user.is_admin) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="管理员拥有所有权限，无需管理" disabled>
                        <i class="fas fa-tools mr-1"></i>器具权限
                    </button>
                `;
            }
            
            // 如果是当前登录用户，显示灰色不可点击的按钮
            if (currentUser.id === user.id) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="无法管理自己的权限" disabled>
                        <i class="fas fa-tools mr-1"></i>器具权限
                    </button>
                `;
            }
            
            // 普通用户显示正常的权限管理按钮（只保留器具权限管理）
            return `
                <button class="text-purple-600 hover:text-purple-900 px-2 py-1 rounded text-sm" onclick="manageUserEquipmentPermissions(${user.id}, '${user.username}')" title="管理器具权限">
                    <i class="fas fa-tools mr-1"></i>器具权限
                </button>
            `;
        }
        
        // 获取用户编辑按钮
        function getUserEditButton(user) {
            const currentUser = JSON.parse(sessionStorage.getItem('user_info') || localStorage.getItem('user_info') || '{}');
            
            // 如果是管理员账号，显示灰色不可点击的按钮
            if (user.is_admin) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="无法编辑管理员账号" disabled>
                        <i class="fas fa-edit mr-1"></i>编辑
                    </button>
                `;
            }
            
            // 如果是当前登录用户，显示灰色不可点击的按钮
            if (currentUser.id === user.id) {
                return `
                    <button class="text-gray-400 cursor-not-allowed px-2 py-1 rounded text-sm" title="无法编辑自己的账号" disabled>
                        <i class="fas fa-edit mr-1"></i>编辑
                    </button>
                `;
            }
            
            // 普通用户显示正常的编辑按钮
            return `
                <button class="text-green-600 hover:text-green-900 px-2 py-1 rounded text-sm" onclick="editUser(${user.id})" title="编辑用户信息">
                    <i class="fas fa-edit mr-1"></i>编辑
                </button>
            `;
        }

        // 获取用户删除按钮
        function getUserDeleteButton(user) {
            const deleteCheck = canDeleteUser(user);
            
            if (!deleteCheck.canDelete) {
                return `<button class="text-gray-400 cursor-not-allowed" title="${deleteCheck.reason}" disabled>
                    <i class="fas fa-trash mr-1"></i>删除
                </button>`;
            }
            
            return `<button class="text-red-600 hover:text-red-900" onclick="deleteUser(${user.id}, '${user.username}')">
                <i class="fas fa-trash mr-1"></i>删除
            </button>`;
        }

        // 更新用户统计
        function updateUsersStats(users) {
            const totalUsers = users.length;
            const adminUsers = users.filter(user => user.is_admin).length;
            const normalUsers = totalUsers - adminUsers;
            
            document.getElementById('total-users-count').textContent = totalUsers;
            document.getElementById('admin-users-count').textContent = adminUsers;
            document.getElementById('normal-users-count').textContent = normalUsers;
            document.getElementById('users-total-count').textContent = totalUsers;
        }

        // 筛选用户
        function filterUsers() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchQuery) {
                renderUsersTable(currentUsers);
                return;
            }
            
            const filteredUsers = currentUsers.filter(user =>
                user.username.toLowerCase().includes(searchQuery)
            );
            
            renderUsersTable(filteredUsers);
            
            // 更新分页信息显示
            const totalCountElement = document.getElementById('total-count');
            if (totalCountElement) {
                totalCountElement.textContent = filteredUsers.length;
            }
        }

        // 打开创建用户模态框
        function openCreateUserModal() {
            editingUserId = null;
            document.getElementById('modal-title').textContent = '创建用户';
            document.getElementById('user-form').reset();
            document.getElementById('password-field').style.display = 'block';
            document.getElementById('user-password').required = true;
            document.getElementById('change-password-field').style.display = 'none';
            document.getElementById('save-user-btn').innerHTML = '<i class="fas fa-save mr-2"></i>创建';
            document.getElementById('userModal').classList.add('show');
        }

        // 编辑用户
        function editUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            document.getElementById('modal-title').textContent = '编辑用户';
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-is-admin').checked = user.is_admin;
            
            // 编辑用户时显示密码修改选项
            document.getElementById('password-field').style.display = 'none';
            document.getElementById('user-password').required = false;
            document.getElementById('change-password-field').style.display = 'block';
            document.getElementById('change-password').checked = false;
            document.getElementById('new-password-fields').style.display = 'none';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('new-password').required = false;
            document.getElementById('confirm-password').required = false;
            
            document.getElementById('save-user-btn').innerHTML = '<i class="fas fa-save mr-2"></i>保存';
            document.getElementById('userModal').classList.add('show');
        }

        // 关闭用户模态框
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
            editingUserId = null;
        }

        // 密码显示切换功能
        function setupPasswordToggle(toggleId, passwordId, eyeIconId) {
            const toggleBtn = document.getElementById(toggleId);
            const passwordInput = document.getElementById(passwordId);
            const eyeIcon = document.getElementById(eyeIconId);
            
            if (toggleBtn && passwordInput && eyeIcon) {
                toggleBtn.addEventListener('click', function() {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        eyeIcon.className = 'fas fa-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        eyeIcon.className = 'fas fa-eye';
                    }
                });
            }
        }

        // 更新密码检查状态的辅助函数
        function updatePasswordCheck(checkId, isValid) {
            const checkElement = document.getElementById(checkId);
            if (!checkElement) return;
            
            const icon = checkElement.querySelector('i');
            const text = checkElement.querySelector('span');
            
            if (isValid) {
                icon.className = 'fas fa-check text-green-500 mr-2 w-4';
                text.className = 'text-green-600';
            } else {
                icon.className = 'fas fa-times text-red-500 mr-2 w-4';
                text.className = 'text-gray-600';
            }
        }
        
        // 验证创建用户密码
        function validateUserPassword() {
            const password = document.getElementById('user-password').value;
            
            const lengthValid = password.length >= 6;
            const letterValid = /[a-zA-Z]/.test(password);
            const numberValid = /\d/.test(password);
            
            updatePasswordCheck('userLengthCheck', lengthValid);
            updatePasswordCheck('userLetterCheck', letterValid);
            updatePasswordCheck('userNumberCheck', numberValid);
            
            return lengthValid && letterValid && numberValid;
        }
        
        // 验证编辑用户密码
        function validateEditPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            const lengthValid = newPassword.length >= 6;
            const letterValid = /[a-zA-Z]/.test(newPassword);
            const numberValid = /\d/.test(newPassword);
            const matchValid = newPassword === confirmPassword && newPassword.length > 0;
            
            updatePasswordCheck('editLengthCheck', lengthValid);
            updatePasswordCheck('editLetterCheck', letterValid);
            updatePasswordCheck('editNumberCheck', numberValid);
            updatePasswordCheck('editMatchCheck', matchValid);
            
            return lengthValid && letterValid && numberValid && matchValid;
        }
        
        // 处理用户表单提交
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value;
            const changePassword = document.getElementById('change-password')?.checked || false;
            const newPassword = document.getElementById('new-password')?.value || '';
            const confirmPassword = document.getElementById('confirm-password')?.value || '';
            const isAdmin = document.getElementById('user-is-admin').checked;
            
            if (!username) {
                showNotification('请输入用户名', 'warning');
                return;
            }
            
            // 创建用户时密码验证
            if (!editingUserId) {
                if (!password) {
                    showNotification('请输入密码', 'warning');
                    return;
                }
                if (!validateUserPassword()) {
                    showNotification('请确保密码满足所有要求', 'warning');
                    return;
                }
            }
            
            // 编辑用户时密码修改验证
            if (editingUserId && changePassword) {
                if (!newPassword) {
                    showNotification('请输入新密码', 'warning');
                    return;
                }
                if (!validateEditPassword()) {
                    showNotification('请确保新密码满足所有要求', 'warning');
                    return;
                }
            }
            
            try {
                document.getElementById('save-user-btn').disabled = true;
                
                const userData = {
                    username,
                    is_admin: isAdmin
                };
                
                if (!editingUserId) {
                    // 创建用户
                    userData.password = password;
                } else if (changePassword) {
                    // 编辑用户且修改密码
                    userData.password = newPassword;
                }
                
                let response;
                if (editingUserId) {
                    // 更新用户
                    response = await fetch(`/api/users/${editingUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                } else {
                    // 创建用户
                    response = await fetch('/api/users/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                showNotification(editingUserId ? '用户更新成功' : '用户创建成功', 'success');
                closeUserModal();
                await loadUsersData();
                
            } catch (error) {
                console.error('保存用户失败:', error);
                showNotification('保存用户失败: ' + error.message, 'error');
            } finally {
                document.getElementById('save-user-btn').disabled = false;
            }
        }

        // 删除用户
        function deleteUser(userId, username) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) {
                showNotification('用户不存在', 'error');
                return;
            }
            
            const deleteCheck = canDeleteUser(user);
            if (!deleteCheck.canDelete) {
                showNotification(deleteCheck.reason, 'warning');
                return;
            }
            
            // 通过验证，显示删除确认对话框
            deletingUserId = userId;
            document.getElementById('delete-user-name').textContent = username;
            document.getElementById('deleteUserModal').classList.add('show');
        }

        // 关闭删除用户模态框
        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('show');
            deletingUserId = null;
        }

        // 确认删除用户
        async function confirmDeleteUser() {
            if (!deletingUserId) return;
            
            try {
                const response = await fetch(`/api/users/${deletingUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getCurrentToken()}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                showNotification('用户删除成功', 'success');
                closeDeleteUserModal();
                await loadUsersData();
                
            } catch (error) {
                console.error('删除用户失败:', error);
                showNotification('删除用户失败: ' + error.message, 'error');
            }
        }

        // 格式化日期时间为北京时间
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            
            const date = new Date(dateTimeString);
            if (isNaN(date.getTime())) return dateTimeString;
            
            // 数据库返回的是UTC时间，直接转换为北京时间 (UTC+8)
            const beijingOffset = 8 * 60 * 60 * 1000; // 北京时间偏移量（毫秒）
            const beijingDate = new Date(date.getTime() + beijingOffset);
            
            return beijingDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 管理用户设备类别
        async function manageUserCategories(userId, username) {
            managingCategoriesUserId = userId;
            document.getElementById('category-user-name').textContent = username;
            
            try {
                // 并行加载用户当前的设备类别和所有类别的管理状态
                const [userCategoriesResponse, managedStatusResponse] = await Promise.all([
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/users/categories/managed-status', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!userCategoriesResponse.ok) {
                    throw new Error(`HTTP ${userCategoriesResponse.status}: ${userCategoriesResponse.statusText}`);
                }

                if (!managedStatusResponse.ok) {
                    throw new Error(`HTTP ${managedStatusResponse.status}: ${managedStatusResponse.statusText}`);
                }

                const userCategories = await userCategoriesResponse.json();
                const managedStatus = await managedStatusResponse.json();
                
                // 保存管理状态到全局变量
                window.categoriesManagedStatus = managedStatus;
                
                renderCategoriesCheckboxes(userCategories);
                document.getElementById('userCategoriesModal').classList.add('show');
                
            } catch (error) {
                console.error('加载用户设备类别失败:', error);
                showNotification('加载用户设备类别失败: ' + error.message, 'error');
            }
        }

        // 渲染设备类别复选框
        function renderCategoriesCheckboxes(userCategories) {
            const container = document.getElementById('categories-checkboxes');
            
            if (!allCategories || allCategories.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">暂无设备类别</p>';
                return;
            }

            const userCategoryIds = userCategories.map(uc => uc.category_id);
            
            container.innerHTML = allCategories.map(category => {
                const isChecked = userCategoryIds.includes(category.id);
                // 检查该类别是否已被其他用户管理
                const isManagedByOthers = isCategoryManagedByOtherUser(category.id, userCategoryIds);
                return `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded cursor-pointer ${isChecked ? 'bg-blue-50 border-l-4 border-blue-500' : ''} ${isManagedByOthers ? 'opacity-50 cursor-not-allowed' : ''}">
                        <input type="checkbox" 
                               class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2" 
                               value="${category.id}"
                               ${isChecked ? 'checked' : ''}
                               ${isManagedByOthers ? 'disabled' : ''}
                               id="category-${category.id}"
                               onchange="updateCategoryStyle(${category.id}, this.checked)">
                        <div class="flex-1">
                            <span class="text-sm font-medium ${isChecked ? 'text-blue-900' : 'text-gray-700'}">${category.name}</span>
                            ${isManagedByOthers ? '<span class="text-xs text-red-500 ml-2">(已被管理)</span>' : ''}
                        </div>
                    </label>
                `;
            }).join('');
            
            // 更新权限统计
            updatePermissionStats(userCategories.length);
        }

        // 检查类别是否被其他用户管理
        function isCategoryManagedByOtherUser(categoryId, currentUserCategoryIds) {
            if (!window.categoriesManagedStatus) return false;
            
            const categoryStatus = window.categoriesManagedStatus.find(status => status.category_id === categoryId);
            if (!categoryStatus) return false;
            
            // 如果该类别被管理，且不是由当前用户管理
            return categoryStatus.is_managed && !currentUserCategoryIds.includes(categoryId);
        }

        // 更新类别样式
        function updateCategoryStyle(categoryId, isChecked) {
            const checkbox = document.getElementById(`category-${categoryId}`);
            if (!checkbox) return;
            
            const label = checkbox.closest('label');
            if (!label) return;
            
            if (isChecked) {
                label.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
                label.classList.remove('hover:bg-gray-100');
                const nameSpan = label.querySelector('span');
                if (nameSpan) {
                    nameSpan.classList.add('text-blue-900');
                    nameSpan.classList.remove('text-gray-700');
                }
            } else {
                label.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                label.classList.add('hover:bg-gray-100');
                const nameSpan = label.querySelector('span');
                if (nameSpan) {
                    nameSpan.classList.remove('text-blue-900');
                    nameSpan.classList.add('text-gray-700');
                }
            }
            
            // 更新权限统计
            const checkedCount = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]:checked').length;
            updatePermissionStats(checkedCount);
        }

        // 更新权限统计
        function updatePermissionStats(checkedCount) {
            const statsElement = document.getElementById('permission-stats');
            if (!statsElement) return;
            
            const totalCount = allCategories.length;
            const percentage = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
            
            statsElement.innerHTML = `
                <div class="text-sm text-gray-600">
                    已选择 <span class="font-semibold text-blue-600">${checkedCount}</span> / ${totalCount} 个类别
                    <span class="text-gray-400 ml-2">(${percentage}%)</span>
                </div>
            `;
        }

        // 全选设备类别
        function selectAllCategories() {
            const checkboxes = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                updateCategoryStyle(parseInt(checkbox.value), true);
            });
        }

        // 清空所有类别选择
        function clearAllCategories() {
            const checkboxes = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                updateCategoryStyle(parseInt(checkbox.value), false);
            });
        }

        // 关闭用户设备类别模态框
        function closeUserCategoriesModal() {
            document.getElementById('userCategoriesModal').classList.remove('show');
            managingCategoriesUserId = null;
            
            // 清理权限统计显示
            const statsElement = document.getElementById('permission-stats');
            if (statsElement) {
                statsElement.innerHTML = '';
            }
        }

        // 管理用户器具权限
        async function manageUserEquipmentPermissions(userId, username) {
            managingEquipmentPermissionsUserId = userId;
            document.getElementById('equipment-permission-user-name').textContent = username;
            
            try {
                // 并行加载类别、器具管理状态和用户当前权限
                const [categoriesResponse, managedStatusResponse, userPermissionsResponse] = await Promise.all([
                    fetch('/api/categories/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/users/equipment-permissions/managed-status', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!categoriesResponse.ok || !managedStatusResponse.ok || !userPermissionsResponse.ok) {
                    throw new Error('Failed to load data');
                }

                allCategories = await categoriesResponse.json();
                equipmentManagedStatus = await managedStatusResponse.json();
                const userPermissions = await userPermissionsResponse.json();
                
                // 填充类别选择器
                populateCategorySelector();
                
                // 保存用户权限到全局变量
                window.currentUserEquipmentPermissions = userPermissions;
                
                // 初始加载所有有设备的器具（因为默认勾选了筛选）
                await loadAllEquipmentWithDevices();
                
                const modal = document.getElementById('userEquipmentPermissionsModal');
                
                // 使用测试模态框的成功方法 - 移动模态框到body并设置样式
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    -webkit-backdrop-filter: blur(4px);
                    backdrop-filter: blur(4px);
                `;
                
                // 强制重绘
                modal.offsetHeight;
                
                // 确保模态框在body中
                if (modal.parentNode !== document.body) {
                    document.body.appendChild(modal);
                }
                
            } catch (error) {
                console.error('加载用户器具权限失败:', error);
                showNotification('加载用户器具权限失败: ' + error.message, 'error');
            }
        }

        // 填充类别选择器
        function populateCategorySelector() {
            const selectElement = document.getElementById('category-select');
            selectElement.innerHTML = '<option value="">选择类别</option>';
            
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }

        // 加载所有类别中包含设备的器具
        async function loadAllEquipmentWithDevices() {
            try {
                const response = await fetch('/api/users/equipment-counts-all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getCurrentToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const allEquipmentWithDevices = await response.json();
                    renderAllEquipmentWithDevices(allEquipmentWithDevices);
                } else {
                    console.warn('Failed to load all equipment with devices:', response.statusText);
                    document.getElementById('equipment-checkboxes').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            加载器具信息失败
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading all equipment with devices:', error);
                document.getElementById('equipment-checkboxes').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        加载器具信息失败
                    </div>
                `;
            }
        }

        // 渲染所有包含设备的器具
        function renderAllEquipmentWithDevices(equipmentList) {
            const container = document.getElementById('equipment-checkboxes');
            
            if (!equipmentList || equipmentList.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle mr-2"></i>
                        暂无包含设备的器具
                    </div>
                `;
                updateEquipmentPermissionStats(0, 0);
                return;
            }

            // 获取用户当前的器具权限
            const userPermissions = window.currentUserEquipmentPermissions || [];
            
            // 按类别分组显示
            const groupedByCategory = {};
            equipmentList.forEach(item => {
                if (!groupedByCategory[item.category_name]) {
                    groupedByCategory[item.category_name] = [];
                }
                groupedByCategory[item.category_name].push(item);
            });

            let totalChecked = 0;
            const htmlContent = Object.entries(groupedByCategory).map(([categoryName, items]) => {
                const categoryItems = items.map(item => {
                    const isChecked = userPermissions.some(p => 
                        p.category_id === item.category_id && p.equipment_name === item.equipment_name
                    );
                    const isManagedByOthers = isEquipmentManagedByOtherUser(item.category_id, item.equipment_name);
                    
                    if (isChecked) totalChecked++;
                    
                    // 生成唯一的ID
                    const uniqueId = `equipment-${item.category_id}-${btoa(encodeURIComponent(item.equipment_name)).replace(/[^a-zA-Z0-9]/g, '')}`;
                    
                    const backgroundClass = isChecked ? 
                        'bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-500' :
                        'bg-gradient-to-r from-green-50 to-blue-50 border-l-2 border-green-300';
                    
                    const textColorClass = isChecked ? 'text-purple-900' : 'text-gray-700';
                    
                    return `
                        <div class="flex items-center space-x-2 p-2 rounded ${backgroundClass} ${isManagedByOthers ? 'opacity-50 cursor-not-allowed' : ''} ml-4">
                            <input type="checkbox" 
                                   ${isChecked ? 'checked' : ''}
                                   ${isManagedByOthers ? 'disabled' : ''}
                                   value="${item.equipment_name}"
                                   data-category-id="${item.category_id}"
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                   id="${uniqueId}"
                                   onchange="updateEquipmentStyleInAll('${item.equipment_name}', ${item.category_id}, this.checked)">
                            <label for="${uniqueId}" class="flex-1 cursor-pointer">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-cog text-green-600 mr-2 text-sm"></i>
                                        <span class="text-sm font-medium ${textColorClass}">${item.equipment_name}</span>
                                        ${isManagedByOthers ? '<span class="text-xs text-red-500 ml-2">(已被管理)</span>' : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-cube mr-1"></i>${item.device_count}台
                                        </span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="mb-4">
                        <div class="bg-gray-100 px-3 py-2 rounded-t-lg">
                            <span class="text-sm font-semibold text-gray-700">
                                <i class="fas fa-folder mr-2"></i>${categoryName}
                            </span>
                        </div>
                        <div class="bg-white rounded-b-lg border-l-2 border-gray-200 py-2">
                            ${categoryItems}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = htmlContent;
            updateEquipmentPermissionStats(totalChecked, equipmentList.length);
        }

        // 更新所有器具列表中的器具样式
        function updateEquipmentStyleInAll(equipmentName, categoryId, isChecked) {
            // 使用与渲染时相同的逻辑生成ID
            const uniqueId = `equipment-${categoryId}-${btoa(encodeURIComponent(equipmentName)).replace(/[^a-zA-Z0-9]/g, '')}`;
            const checkbox = document.getElementById(uniqueId);
            if (!checkbox) return;
            
            const container = checkbox.closest('div');
            if (!container) return;
            
            const label = container.querySelector('label');
            const nameSpan = label?.querySelector('span');
            
            if (isChecked) {
                // 选中状态：使用紫色样式
                container.className = container.className
                    .replace(/bg-gradient-to-r from-green-50 to-blue-50 border-l-2 border-green-300/, '')
                    .replace(/hover:bg-gray-100/, '');
                
                if (!container.className.includes('from-purple-50 to-blue-50')) {
                    container.className += ' bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-500';
                }
                
                if (nameSpan) {
                    nameSpan.className = nameSpan.className.replace(/text-gray-700/, 'text-purple-900');
                }
            } else {
                // 未选中状态：恢复绿色样式
                container.className = container.className
                    .replace(/bg-gradient-to-r from-purple-50 to-blue-50/, '')
                    .replace(/border-l-4 border-purple-500/, '');
                
                if (!container.className.includes('from-green-50 to-blue-50')) {
                    container.className += ' bg-gradient-to-r from-green-50 to-blue-50 border-l-2 border-green-300';
                }
                
                if (nameSpan) {
                    nameSpan.className = nameSpan.className.replace(/text-purple-900/, 'text-gray-700');
                }
            }
            
            // 更新权限统计
            const checkedCount = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:checked').length;
            const totalCount = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]').length;
            updateEquipmentPermissionStats(checkedCount, totalCount);
        }

        // 加载类别下的器具
        async function loadCategoryEquipment() {
            const categoryId = document.getElementById('category-select').value;
            
            if (!categoryId) {
                document.getElementById('equipment-checkboxes').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle mr-2"></i>
                        请先选择一个设备类别
                    </div>
                `;
                return;
            }
            
            const category = allCategories.find(c => c.id == categoryId);
            if (!category || !category.predefined_names) {
                document.getElementById('equipment-checkboxes').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle mr-2"></i>
                        该类别下没有预定义器具
                    </div>
                `;
                return;
            }

            try {
                // 获取该类别下器具的设备数量信息
                const response = await fetch(`/api/users/equipment-counts/${categoryId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getCurrentToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                let equipmentCounts = {};
                if (response.ok) {
                    const data = await response.json();
                    equipmentCounts = data.equipment_counts || {};
                } else {
                    console.warn('Failed to load equipment counts:', response.statusText);
                }

                // 保存设备数量信息到全局变量
                currentEquipmentCounts = equipmentCounts;

                renderEquipmentCheckboxes(categoryId, category.predefined_names, equipmentCounts);
            } catch (error) {
                console.error('Error loading equipment counts:', error);
                // 如果获取设备数量失败，仍然渲染器具列表，但不显示数量
                currentEquipmentCounts = {};
                renderEquipmentCheckboxes(categoryId, category.predefined_names, {});
            }
        }

        // 切换器具筛选
        async function toggleEquipmentFilter() {
            const categoryId = document.getElementById('category-select').value;
            const showOnlyWithDevices = document.getElementById('show-only-with-devices').checked;
            
            if (!categoryId) {
                // 没有选择类别
                if (showOnlyWithDevices) {
                    // 显示所有有设备的器具
                    await loadAllEquipmentWithDevices();
                } else {
                    // 显示提示信息
                    document.getElementById('equipment-checkboxes').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-info-circle mr-2"></i>
                            请先选择一个设备类别
                        </div>
                    `;
                    updateEquipmentPermissionStats(0, 0);
                }
                return;
            }
            
            // 已选择类别，使用原有逻辑
            const category = allCategories.find(c => c.id == categoryId);
            if (!category || !category.predefined_names) return;
            
            renderEquipmentCheckboxes(categoryId, category.predefined_names, currentEquipmentCounts);
        }

        // 渲染器具复选框
        function renderEquipmentCheckboxes(categoryId, equipmentNames, equipmentCounts = {}) {
            const container = document.getElementById('equipment-checkboxes');
            
            // 检查是否只显示有设备的器具
            const showOnlyWithDevices = document.getElementById('show-only-with-devices')?.checked || false;
            
            // 根据筛选条件过滤器具名称
            let filteredEquipmentNames = equipmentNames;
            if (showOnlyWithDevices) {
                filteredEquipmentNames = equipmentNames.filter(name => {
                    const deviceCount = equipmentCounts[name] || 0;
                    return deviceCount > 0;
                });
                
                // 如果没有找到有设备的器具，显示提示信息
                if (filteredEquipmentNames.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-info-circle mr-2"></i>
                            该类别下没有包含设备的器具
                            <div class="mt-2">
                                <button type="button" class="text-blue-600 hover:text-blue-800 text-sm" onclick="document.getElementById('show-only-with-devices').checked = false; toggleEquipmentFilter();">
                                    显示全部器具
                                </button>
                            </div>
                        </div>
                    `;
                    updateEquipmentPermissionStats(0, 0);
                    return;
                }
            }
            
            // 获取用户当前在该类别下的权限
            const userPermissions = window.currentUserEquipmentPermissions || [];
            const userEquipmentNames = userPermissions
                .filter(p => p.category_id == categoryId)
                .map(p => p.equipment_name);
            
            container.innerHTML = filteredEquipmentNames.map(equipmentName => {
                const isChecked = userEquipmentNames.includes(equipmentName);
                // 检查该器具是否已被其他用户管理
                const isManagedByOthers = isEquipmentManagedByOtherUser(categoryId, equipmentName);
                
                // 获取设备数量
                const deviceCount = equipmentCounts[equipmentName] || 0;
                const hasDevices = deviceCount > 0;
                
                // 根据设备数量决定背景色样式
                let backgroundClass = '';
                let textColorClass = '';
                let countDisplayClass = '';
                
                if (isChecked) {
                    if (hasDevices) {
                        backgroundClass = 'bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-500';
                        textColorClass = 'text-purple-900';
                    } else {
                        backgroundClass = 'bg-purple-50 border-l-4 border-purple-500';
                        textColorClass = 'text-purple-900';
                    }
                } else if (hasDevices) {
                    backgroundClass = 'bg-gradient-to-r from-green-50 to-blue-50 border-l-2 border-green-300';
                    textColorClass = 'text-gray-700';
                    countDisplayClass = 'bg-green-100 text-green-800';
                } else {
                    backgroundClass = 'hover:bg-gray-100';
                    textColorClass = 'text-gray-700';
                    countDisplayClass = 'bg-gray-100 text-gray-600';
                }
                
                // 生成唯一的ID，使用Base64编码确保唯一性
                const uniqueId = `equipment-${categoryId}-${btoa(encodeURIComponent(equipmentName)).replace(/[^a-zA-Z0-9]/g, '')}`;
                
                return `
                    <div class="flex items-center space-x-2 p-2 rounded ${backgroundClass} ${isManagedByOthers ? 'opacity-50 cursor-not-allowed' : ''}">
                        <input type="checkbox" 
                               ${isChecked ? 'checked' : ''}
                               ${isManagedByOthers ? 'disabled' : ''}
                               value="${equipmentName}"
                               class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                               id="${uniqueId}"
                               onchange="updateEquipmentStyle('${equipmentName}', this.checked)">
                        <label for="${uniqueId}" class="flex-1 cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    ${hasDevices ? '<i class="fas fa-cog text-green-600 mr-2 text-sm"></i>' : '<i class="fas fa-circle-o text-gray-400 mr-2 text-sm"></i>'}
                                    <span class="text-sm font-medium ${textColorClass}">${equipmentName}</span>
                                    ${isManagedByOthers ? '<span class="text-xs text-red-500 ml-2">(已被管理)</span>' : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${hasDevices ? 
                                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${countDisplayClass}">
                                            <i class="fas fa-cube mr-1"></i>${deviceCount}台
                                        </span>` : 
                                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${countDisplayClass}">
                                            无设备
                                        </span>`
                                    }
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
            
            // 更新权限统计 - 使用过滤后的器具数量
            const filteredUserEquipmentNames = userEquipmentNames.filter(name => 
                filteredEquipmentNames.includes(name)
            );
            updateEquipmentPermissionStats(filteredUserEquipmentNames.length, filteredEquipmentNames.length);
        }

        // 检查器具是否被其他用户管理
        function isEquipmentManagedByOtherUser(categoryId, equipmentName) {
            const managedItem = equipmentManagedStatus.find(item => 
                item.category_id == categoryId && item.equipment_name == equipmentName
            );
            // 如果该器具被管理，且不是由当前用户管理
            return managedItem && managedItem.is_managed && managedItem.managed_by_user_id != managingEquipmentPermissionsUserId;
        }

        // 更新器具样式
        function updateEquipmentStyle(equipmentName, isChecked) {
            // 获取当前选中的类别ID
            const categoryId = document.getElementById('category-select').value;
            if (!categoryId) return;
            
            // 使用与渲染时相同的逻辑生成ID
            const uniqueId = `equipment-${categoryId}-${btoa(encodeURIComponent(equipmentName)).replace(/[^a-zA-Z0-9]/g, '')}`;
            const checkbox = document.getElementById(uniqueId);
            if (!checkbox) return;
            
            const container = checkbox.closest('div');
            if (!container) return;
            
            const label = container.querySelector('label');
            const nameSpan = label?.querySelector('span');
            
            if (isChecked) {
                // 选中状态：使用紫色样式
                container.className = container.className
                    .replace(/bg-gradient-to-r from-green-50 to-blue-50 border-l-2 border-green-300/, '')
                    .replace(/hover:bg-gray-100/, '');
                
                if (container.className.includes('from-purple-50 to-blue-50')) {
                    // 已经有渐变背景，不需要修改
                } else {
                    // 添加选中的紫色背景
                    container.className += ' bg-purple-50 border-l-4 border-purple-500';
                }
                
                if (nameSpan) {
                    nameSpan.className = nameSpan.className.replace(/text-gray-700/, 'text-purple-900');
                }
            } else {
                // 未选中状态：恢复原有样式
                container.className = container.className
                    .replace(/bg-purple-50/, '')
                    .replace(/bg-gradient-to-r from-purple-50 to-blue-50/, '')
                    .replace(/border-l-4 border-purple-500/, '');
                
                // 检查是否有设备来决定背景色
                const deviceCountElement = container.querySelector('[class*="fas fa-cube"], [class*="无设备"]');
                const hasDevices = deviceCountElement && deviceCountElement.className.includes('fa-cube');
                
                if (hasDevices) {
                    if (!container.className.includes('from-green-50 to-blue-50')) {
                        container.className += ' bg-gradient-to-r from-green-50 to-blue-50 border-l-2 border-green-300';
                    }
                } else {
                    if (!container.className.includes('hover:bg-gray-100')) {
                        container.className += ' hover:bg-gray-100';
                    }
                }
                
                if (nameSpan) {
                    nameSpan.className = nameSpan.className.replace(/text-purple-900/, 'text-gray-700');
                }
            }
            
            // 更新权限统计
            if (categoryId) {
                const category = allCategories.find(c => c.id == categoryId);
                if (category && category.predefined_names) {
                    const checkedCount = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:checked').length;
                    updateEquipmentPermissionStats(checkedCount, category.predefined_names.length);
                }
            }
        }

        // 更新器具权限统计
        function updateEquipmentPermissionStats(checkedCount, totalCount) {
            const statsElement = document.getElementById('equipment-permission-stats');
            if (!statsElement) return;
            
            const percentage = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
            
            statsElement.innerHTML = `
                <div class="text-sm text-gray-600">
                    已选择 <span class="font-semibold text-purple-600">${checkedCount}</span> / ${totalCount} 个器具
                    <span class="text-gray-400 ml-2">(${percentage}%)</span>
                </div>
            `;
        }

        // 全选器具
        function selectAllEquipment() {
            const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                updateEquipmentStyle(checkbox.value, true);
            });
        }

        // 清空所有器具选择
        function clearAllEquipment() {
            const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                updateEquipmentStyle(checkbox.value, false);
            });
        }

        // 保存用户器具权限
        async function saveUserEquipmentPermissions() {
            if (!managingEquipmentPermissionsUserId) return;

            const categoryId = document.getElementById('category-select').value;
            const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]:checked');
            
            // 如果没有选择任何器具，询问用户是否要清空权限
            if (checkboxes.length === 0) {
                const confirmed = confirm('您没有选择任何器具，是否要清空该用户在当前操作范围内的所有器具权限？\n\n注意：此操作将移除相关权限，用户将无法管理对应的器具。');
                if (!confirmed) {
                    return;
                }
                
                // 处理清空权限的逻辑
                await clearUserEquipmentPermissions(categoryId);
                return;
            }
            
            // 如果选择了特定类别，使用原有逻辑
            if (categoryId) {
                const equipmentNames = Array.from(checkboxes).map(cb => cb.value);
                
                try {
                    const response = await fetch(`/api/users/${managingEquipmentPermissionsUserId}/equipment-permissions`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            category_id: parseInt(categoryId),
                            equipment_names: equipmentNames
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    showNotification('用户器具权限更新成功', 'success');
                    await refreshUserPermissions();
                    
                } catch (error) {
                    console.error('保存用户器具权限失败:', error);
                    showNotification('保存失败: ' + error.message, 'error');
                }
                return;
            }
            
            // 处理跨类别器具选择
            const categoryIds = new Set();
            const equipmentByCategory = {};
            
            // 按类别分组新选择的器具
            checkboxes.forEach(checkbox => {
                const catId = checkbox.getAttribute('data-category-id');
                const equipmentName = checkbox.value;
                
                if (catId) {
                    const categoryId = parseInt(catId);
                    categoryIds.add(categoryId);
                    
                    if (!equipmentByCategory[categoryId]) {
                        equipmentByCategory[categoryId] = new Set();
                    }
                    equipmentByCategory[categoryId].add(equipmentName);
                }
            });
            
            if (categoryIds.size === 0) {
                showNotification('无法确定器具的类别信息', 'error');
                return;
            }
            
            try {
                // 获取用户当前的所有器具权限
                const currentPermissions = window.currentUserEquipmentPermissions || [];
                
                // 为每个涉及的类别准备完整的权限列表（现有权限 + 新选择的权限）
                const updatePromises = Array.from(categoryIds).map(async (categoryId) => {
                    // 获取该类别下用户现有的权限
                    const existingEquipmentInCategory = currentPermissions
                        .filter(p => p.category_id === categoryId)
                        .map(p => p.equipment_name);
                    
                    // 获取该类别下新选择的权限
                    const newEquipmentInCategory = Array.from(equipmentByCategory[categoryId] || []);
                    
                    // 合并现有权限和新选择的权限，去重
                    const allEquipmentInCategory = [...new Set([...existingEquipmentInCategory, ...newEquipmentInCategory])];
                    
                    // 调用API更新该类别的权限
                    const response = await fetch(`/api/users/${managingEquipmentPermissionsUserId}/equipment-permissions`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            category_id: categoryId,
                            equipment_names: allEquipmentInCategory
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        const categoryName = allCategories.find(c => c.id === categoryId)?.name || categoryId;
                        throw new Error(`${categoryName}: ${errorData.detail || response.statusText}`);
                    }
                    
                    return { categoryId, success: true };
                });
                
                await Promise.all(updatePromises);
                
                // 显示成功信息
                if (categoryIds.size === 1) {
                    showNotification('用户器具权限更新成功', 'success');
                } else {
                    const categoryNames = Array.from(categoryIds).map(id => {
                        const category = allCategories.find(c => c.id === id);
                        return category ? category.name : id;
                    }).join('、');
                    showNotification(`已成功更新用户在 ${categoryNames} 等 ${categoryIds.size} 个类别下的器具权限`, 'success');
                }
                
                await refreshUserPermissions();
                
            } catch (error) {
                console.error('保存用户器具权限失败:', error);
                showNotification('保存失败: ' + error.message, 'error');
            }
        }
        
        // 清空用户器具权限
        async function clearUserEquipmentPermissions(categoryId) {
            try {
                // 如果选择了特定类别，只清空该类别下的权限
                if (categoryId) {
                    const response = await fetch(`/api/users/${managingEquipmentPermissionsUserId}/equipment-permissions`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            category_id: parseInt(categoryId),
                            equipment_names: [] // 空数组表示清空该类别下的所有权限
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const categoryName = allCategories.find(c => c.id == categoryId)?.name || '选定类别';
                    showNotification(`已清空用户在 ${categoryName} 下的所有器具权限`, 'success');
                } else {
                    // 如果没有选择特定类别，清空用户的所有器具权限
                    const currentPermissions = window.currentUserEquipmentPermissions || [];
                    
                    // 获取所有涉及的类别ID
                    const categoryIds = [...new Set(currentPermissions.map(p => p.category_id))];
                    
                    if (categoryIds.length === 0) {
                        showNotification('该用户当前没有任何器具权限', 'info');
                        await refreshUserPermissions();
                        return;
                    }
                    
                    // 为每个类别发送清空请求
                    const clearPromises = categoryIds.map(async (catId) => {
                        const response = await fetch(`/api/users/${managingEquipmentPermissionsUserId}/equipment-permissions`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${getCurrentToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                category_id: catId,
                                equipment_names: [] // 空数组表示清空该类别下的所有权限
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            const categoryName = allCategories.find(c => c.id === catId)?.name || catId;
                            throw new Error(`${categoryName}: ${errorData.detail || response.statusText}`);
                        }
                        
                        return { categoryId: catId, success: true };
                    });
                    
                    await Promise.all(clearPromises);
                    
                    showNotification(`已清空用户在所有 ${categoryIds.length} 个类别下的器具权限`, 'success');
                }
                
                await refreshUserPermissions();
                
            } catch (error) {
                console.error('清空用户器具权限失败:', error);
                showNotification('清空失败: ' + error.message, 'error');
            }
        }
        
        // 直接清空所有权限（通过按钮）
        async function directClearAllPermissions() {
            if (!managingEquipmentPermissionsUserId) return;
            
            const categoryId = document.getElementById('category-select').value;
            const userName = document.getElementById('equipment-permission-user-name').textContent;
            
            let confirmMessage;
            if (categoryId) {
                const categoryName = allCategories.find(c => c.id == categoryId)?.name || '选定类别';
                confirmMessage = `确定要清空用户 "${userName}" 在 "${categoryName}" 下的所有器具权限吗？\n\n此操作将移除该用户在此类别下的所有器具管理权限。`;
            } else {
                confirmMessage = `确定要清空用户 "${userName}" 的所有器具权限吗？\n\n此操作将移除该用户在所有类别下的器具管理权限，请谨慎操作。`;
            }
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) {
                return;
            }
            
            await clearUserEquipmentPermissions(categoryId);
        }
        
        // 刷新用户权限显示
        async function refreshUserPermissions() {
            // 重新加载该用户的权限显示
            await loadUserPermissions(managingEquipmentPermissionsUserId);
            
            // 如果详情面板是展开状态，也更新详情内容
            const detailsRow = document.getElementById(`permission-details-${managingEquipmentPermissionsUserId}`);
            if (!detailsRow.classList.contains('hidden')) {
                await loadPermissionDetails(managingEquipmentPermissionsUserId);
            }
            
            // 等待一小段时间确保显示更新后再关闭模态框
            setTimeout(() => {
                closeUserEquipmentPermissionsModal();
            }, 300);
        }

        // 关闭用户器具权限模态框
        function closeUserEquipmentPermissionsModal() {
            const modal = document.getElementById('userEquipmentPermissionsModal');
            modal.style.display = 'none';
            managingEquipmentPermissionsUserId = null;
            
            // 清理表单和筛选状态
            document.getElementById('category-select').value = '';
            document.getElementById('show-only-with-devices').checked = true; // 重置为默认勾选状态
            document.getElementById('equipment-checkboxes').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    正在加载有设备的器具...
                </div>
            `;
            
            // 清理权限统计显示
            const statsElement = document.getElementById('equipment-permission-stats');
            if (statsElement) {
                statsElement.innerHTML = '';
            }
            
            // 清理全局变量
            currentEquipmentCounts = {};
        }

        // 保存用户设备类别
        async function saveUserCategories() {
            if (!managingCategoriesUserId) return;

            const checkboxes = document.querySelectorAll('#categories-checkboxes input[type="checkbox"]:checked');
            const categoryIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            try {
                const response = await fetch(`/api/users/${managingCategoriesUserId}/categories`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getCurrentToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category_ids: categoryIds
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                showNotification('用户设备类别权限更新成功', 'success');
                
                // 重新加载该用户的权限显示（类别+器具）
                await loadUserPermissions(managingCategoriesUserId);
                
                // 如果详情面板是展开状态，也更新详情内容
                const detailsRow = document.getElementById(`permission-details-${managingCategoriesUserId}`);
                if (!detailsRow.classList.contains('hidden')) {
                    await loadPermissionDetails(managingCategoriesUserId);
                }
                
                // 等待一小段时间确保显示更新后再关闭模态框
                setTimeout(() => {
                    closeUserCategoriesModal();
                }, 300);
                
            } catch (error) {
                console.error('保存用户设备类别失败:', error);
                showNotification('保存用户设备类别失败: ' + error.message, 'error');
            }
        }

        // 分页事件监听器
        function setupPaginationEventListeners() {
            // 每页显示条数变化
            document.getElementById('page-size').addEventListener('change', function() {
                itemsPerPage = parseInt(this.value);
                currentPage = 1;
                // 保存每页显示条数到本地存储
                localStorage.setItem('users_page_size', this.value);
                loadUsersData();
            });

            // 上一页
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadUsersData();
                }
            });

            // 下一页
            document.getElementById('next-page').addEventListener('click', function() {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    loadUsersData();
                }
            });
        }

        // 更新分页信息
        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('total-count').textContent = totalItems;
            
            // 更新按钮状态
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // 生成页码按钮
            generatePageNumbers(currentPage, totalPages);
        }

        // 生成页码按钮
        function generatePageNumbers(currentPage, totalPages) {
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一页
            if (startPage > 1) {
                pageNumbersContainer.appendChild(createPageButton(1, currentPage));
                if (startPage > 2) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
            }
            
            // 页码按钮
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersContainer.appendChild(createPageButton(i, currentPage));
            }
            
            // 最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                pageNumbersContainer.appendChild(createPageButton(totalPages, currentPage));
            }
        }
        
        // 创建页码按钮
        function createPageButton(pageNum, currentPage) {
            const button = document.createElement('button');
            button.className = `px-3 py-2 border text-sm font-medium rounded-lg transition-colors ${
                pageNum === currentPage 
                    ? 'bg-blue-500 text-white border-blue-500' 
                    : 'border-gray-300 text-gray-700 hover:bg-gray-50'
            }`;
            button.textContent = pageNum;
            button.onclick = () => changePage(pageNum);
            return button;
        }
        
        // 创建省略号
        function createEllipsis() {
            const span = document.createElement('span');
            span.className = 'px-3 py-2 text-gray-500';
            span.textContent = '...';
            return span;
        }
        
        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            loadUsersData();
        }

        // 切换权限详情显示
        async function togglePermissionDetails(userId) {
            const detailsRow = document.getElementById(`permission-details-${userId}`);
            const btn = document.getElementById(`permission-detail-btn-${userId}`);
            
            if (detailsRow.classList.contains('hidden')) {
                // 展开详情
                detailsRow.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                btn.title = '隐藏权限信息';
                
                // 加载详细信息
                await loadPermissionDetails(userId);
            } else {
                // 收起详情
                detailsRow.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-info-circle"></i>';
                btn.title = '查看完整权限信息';
            }
        }

        // 加载权限详细信息
        async function loadPermissionDetails(userId) {
            const contentElement = document.getElementById(`permission-details-content-${userId}`);
            if (!contentElement) return;
            
            try {
                // 并行加载所有类别、用户类别权限和器具权限
                const [allCategoriesResponse, categoriesResponse, equipmentResponse] = await Promise.all([
                    fetch('/api/categories/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/categories`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/users/${userId}/equipment-permissions`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getCurrentToken()}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!allCategoriesResponse.ok || !categoriesResponse.ok || !equipmentResponse.ok) {
                    throw new Error('Failed to load permission details');
                }

                const allCategoriesData = await allCategoriesResponse.json();
                const userCategories = await categoriesResponse.json();
                const equipmentPermissions = await equipmentResponse.json();
                
                // 查找用户信息
                const user = currentUsers.find(u => u.id === userId);
                
                let detailsHTML = '';
                
                if (user && user.is_admin) {
                    detailsHTML = `
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-crown text-purple-600 mr-2"></i>
                                <span class="font-medium text-purple-900">系统管理员</span>
                            </div>
                            <p class="text-sm text-purple-700">拥有系统的完整访问权限，可以管理所有设备类别和器具。</p>
                        </div>
                    `;
                } else {
                    const hasCategoryPermissions = userCategories && userCategories.length > 0;
                    const hasEquipmentPermissions = equipmentPermissions && equipmentPermissions.length > 0;
                    
                    if (!hasCategoryPermissions && !hasEquipmentPermissions) {
                        detailsHTML = `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <div class="flex items-center">
                                    <i class="fas fa-ban text-gray-400 mr-2"></i>
                                    <span class="text-gray-600">暂无任何管理权限</span>
                                </div>
                            </div>
                        `;
                    } else {
                        detailsHTML = '<div class="space-y-3">';
                        
                        // 类别权限
                        if (hasCategoryPermissions) {
                            detailsHTML += `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-tags text-blue-600 mr-2"></i>
                                        <span class="font-medium text-blue-900">设备类别权限 (${userCategories.length})</span>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                                        ${userCategories.map(uc => `
                                            <div class="bg-white rounded px-2 py-1 text-sm text-blue-700 border border-blue-200 truncate" title="${uc.category.name}">
                                                ${uc.category.name}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // 器具权限
                        if (hasEquipmentPermissions) {
                            // 按类别分组显示器具权限
                            const equipmentByCategory = {};
                            equipmentPermissions.forEach(ep => {
                                // 根据category_id查找类别名称
                                const category = allCategoriesData.find(c => c.id === ep.category_id);
                                const categoryName = category ? category.name : `未知类别(ID: ${ep.category_id})`;
                                
                                if (!equipmentByCategory[categoryName]) {
                                    equipmentByCategory[categoryName] = [];
                                }
                                equipmentByCategory[categoryName].push(ep.equipment_name);
                            });
                            
                            detailsHTML += `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-tools text-green-600 mr-2"></i>
                                        <span class="font-medium text-green-900">器具权限 (${equipmentPermissions.length})</span>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                                        ${Object.entries(equipmentByCategory).map(([categoryName, equipmentNames]) => `
                                            <div class="bg-white rounded p-2 border border-green-200">
                                                <div class="text-xs font-medium text-green-700 mb-1 truncate" title="${categoryName}">${categoryName}</div>
                                                <div class="flex flex-wrap gap-1">
                                                    ${equipmentNames.map(name => `
                                                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded truncate" title="${name}">${name}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        detailsHTML += '</div>';
                    }
                }
                
                contentElement.innerHTML = detailsHTML;
                
            } catch (error) {
                console.error('加载权限详情失败:', error);
                contentElement.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="flex items-center text-red-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span class="text-sm">加载权限信息失败</span>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>