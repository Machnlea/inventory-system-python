# 设备生命周期管理系统需求文档

## 1. 项目概述

### 1.1 项目目标
为设备台账管理系统增加生命周期时间轴功能，实现对设备从导入到报废全过程的跟踪记录，提供可视化的时间轴展示，帮助管理员了解设备的完整历史记录。

### 1.2 核心价值
- 提供设备全生命周期的可视化展示
- 自动化检定提醒和倒计时功能
- 规范化检定记录管理
- 增强设备状态变更的可追溯性

## 2. 功能需求

### 2.1 生命周期时间轴展示

#### 2.1.1 时间轴位置
- **展示位置**: 设备详情页 (`/equipment/view?id={equipment_id}`)
- **展示方式**: 垂直时间轴，按时间倒序排列（最新事件在上方）
- **响应式设计**: 支持桌面端和移动端展示

#### 2.1.2 时间轴事件类型
1. **设备导入** - 设备首次录入系统
2. **检定记录** - 内检/外检完成记录
3. **状态变更** - 在用/停用/报废状态变更
4. **维修记录** - 设备维修保养记录
5. **附件上传** - 证书、文档等附件上传
6. **生命周期结束** - 设备报废或检定不合格

### 2.2 检定管理功能

#### 2.2.1 检定方式区分
- **内检设备**:
  - 检定证书和证书编号：**可选**
  - 检定结果：自动标记为"合格"（更新检定日期即视为合格）
  - 检定机构：可填写内部检定部门
  - 证书形式：可选择"内部检定记录"或"检定证书"

- **外检设备**:
  - 检定证书：**必须上传**
  - 证书编号：**必填**
  - 检定结果：**必填**（合格/不合格/限制使用）
  - 检定机构：**必填**
  - 证书形式：**必选**（检定证书/校准证书）

#### 2.2.2 检定更新流程
1. **触发方式**:
   - 设备管理页面的"更新检定日期"按钮
   - 设备详情页的"新增检定记录"按钮
   - 批量更新检定日期功能

2. **内检流程**:
   ```
   选择新检定日期 → 
   选择是否上传证书（可选） → 
   填写证书编号（可选） → 
   自动计算下次检定日期 → 
   创建生命周期记录
   ```

3. **外检流程**:
   ```
   选择新检定日期 → 
   上传检定证书（必须） → 
   填写证书编号（必须） → 
   选择检定结果（必须） → 
   填写检定机构（必须） → 
   选择证书形式（必须） → 
   自动计算下次检定日期 → 
   创建生命周期记录
   ```

### 2.3 状态管理功能

#### 2.3.1 设备状态类型
- **在用**: 设备正常使用中
- **停用**: 设备暂停使用（可恢复）
- **报废**: 设备永久停止使用

#### 2.3.2 状态变更规则
1. **停用设备**:
   - 需要填写停用原因
   - 可选择上传相关文档
   - 停用后不进行检定提醒

2. **报废设备**:
   - **必须填写**报废原因
   - **可选择上传**报废相关附件（如报废申请、处置证明等）
   - 报废后生命周期结束
   - 报废设备不可恢复为在用状态

3. **检定不合格**:
   - 当外检结果为"不合格"时
   - 设备自动标记为停用状态
   - 生命周期状态标记为"已结束"
   - 需要维修合格后才能恢复使用

### 2.4 提醒和预警功能

#### 2.4.1 检定倒计时
- **显示位置**: 设备详情页顶部卡片
- **计算方式**: 根据上次检定日期 + 检定周期计算
- **显示格式**: "距下次检定还有 X 天"
- **颜色标识**:
  - 绿色：30天以上
  - 橙色：7-30天
  - 红色：7天以内或已过期

#### 2.4.2 检定提醒规则
- **提前30天**: 黄色提醒
- **提前7天**: 橙色预警
- **已过期**: 红色警告
- **随坏随换设备**: 不显示倒计时

### 2.5 历史记录查看

#### 2.5.1 检定历史
- 显示所有历史检定记录
- 包含检定日期、检定方式、检定结果
- 显示证书编号（如有）
- 提供证书附件下载链接

#### 2.5.2 状态变更历史
- 记录所有状态变更时间
- 显示变更原因
- 展示操作人员信息

## 3. 数据库设计需求

### 3.1 设备生命周期表 (equipment_lifecycle)

```sql
CREATE TABLE equipment_lifecycle (
    id INTEGER PRIMARY KEY,
    equipment_id INTEGER NOT NULL,                    -- 设备ID
    event_type VARCHAR(50) NOT NULL,                  -- 事件类型：导入/检定/状态变更/维修/报废
    event_date DATE NOT NULL,                         -- 事件发生日期
    event_time DATETIME DEFAULT CURRENT_TIMESTAMP,    -- 事件记录时间
    
    -- 检定相关字段
    calibration_date DATE,                            -- 检定日期
    calibration_method VARCHAR(20),                   -- 检定方式：内检/外检
    verification_result VARCHAR(20),                  -- 检定结果：合格/不合格/限制使用
    is_qualified BOOLEAN DEFAULT TRUE,                -- 是否合格
    valid_until DATE,                                 -- 有效期至
    next_calibration_date DATE,                       -- 下次检定日期
    
    -- 证书相关字段
    certificate_number VARCHAR(100),                  -- 证书编号
    verification_agency VARCHAR(100),                 -- 检定机构
    certificate_type VARCHAR(50),                     -- 证书类型：检定证书/校准证书/内部记录
    certificate_file_id INTEGER,                      -- 证书附件ID
    
    -- 状态变更相关字段
    old_status VARCHAR(20),                           -- 变更前状态
    new_status VARCHAR(20),                           -- 变更后状态
    status_change_reason TEXT,                        -- 状态变更原因
    
    -- 其他字段
    cost DECIMAL(10,2),                               -- 检定/维修费用
    notes TEXT,                                       -- 备注说明
    operator_id INTEGER NOT NULL,                     -- 操作人员ID
    is_lifecycle_end BOOLEAN DEFAULT FALSE,           -- 是否生命周期结束
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (equipment_id) REFERENCES equipments(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    FOREIGN KEY (certificate_file_id) REFERENCES equipment_attachments(id)
);
```

### 3.2 扩展现有附件表

为 `equipment_attachments` 表添加生命周期关联：

```sql
ALTER TABLE equipment_attachments ADD COLUMN lifecycle_event_id INTEGER;
ALTER TABLE equipment_attachments ADD COLUMN attachment_category VARCHAR(50); -- 证书/报废文档/维修记录等
```

## 4. 界面设计需求

### 4.1 设备详情页布局

```
┌─────────────────────────────────────────────────┐
│                设备基本信息卡片                    │
│         (包含检定倒计时显示)                       │
└─────────────────────────────────────────────────┘

┌─────────────────┬───────────────────────────────┐
│   设备详细信息    │        生命周期时间轴          │
│                 │                               │
│   ● 基本信息     │  ● 2024-12-01 检定完成         │
│   ● 检定信息     │    外检 - 合格                │
│   ● 制造信息     │    证书：JD-2024-1001         │
│   ● 附件列表     │                               │
│                 │  ● 2024-06-15 状态变更         │
│                 │    在用 → 停用                │
│                 │                               │
│                 │  ● 2024-01-10 设备导入         │
│                 │    初始录入                   │
└─────────────────┴───────────────────────────────┘
```

### 4.2 时间轴样式设计

- **时间线**: 左侧垂直线条，使用主题色
- **事件节点**: 圆形图标，不同事件类型使用不同颜色
- **事件卡片**: 包含事件详情的卡片式布局
- **交互功能**: 点击事件可展开详情，查看附件等

### 4.3 检定更新模态框

#### 内检模态框字段：
- 检定日期（必填）
- 证书编号（可选）
- 上传证书（可选）
- 备注（可选）

#### 外检模态框字段：
- 检定日期（必填）
- 检定结果（必选：合格/不合格/限制使用）
- 检定机构（必填）
- 证书编号（必填）
- 证书形式（必选：检定证书/校准证书）
- 上传证书（必填）
- 检定费用（可选）
- 备注（可选）

## 5. 业务流程

### 5.1 设备导入流程
```
设备数据导入 → 
自动创建"设备导入"生命周期记录 → 
计算首次检定到期时间 → 
设置检定提醒
```

### 5.2 检定更新流程
```
用户点击更新检定日期 → 
判断检定方式(内检/外检) → 
显示对应的模态框 → 
用户填写必要信息 → 
验证数据完整性 → 
更新设备表信息 → 
创建检定生命周期记录 → 
上传相关附件 → 
计算下次检定日期 → 
刷新时间轴显示
```

### 5.3 设备报废流程
```
用户选择报废设备 → 
填写报废原因(必填) → 
上传报废文档(可选) → 
确认报废操作 → 
更新设备状态为"报废" → 
创建"生命周期结束"记录 → 
停止所有检定提醒
```

## 6. 技术实现要点

### 6.1 后端API设计
- `GET /api/equipment/{id}/lifecycle` - 获取设备生命周期记录
- `POST /api/equipment/{id}/lifecycle/calibration` - 创建检定记录
- `PUT /api/equipment/{id}/status` - 更新设备状态
- `POST /api/equipment/{id}/lifecycle/event` - 创建生命周期事件

### 6.2 前端组件设计
- `EquipmentLifecycleTimeline` - 时间轴主组件
- `LifecycleEvent` - 单个事件组件
- `CalibrationModal` - 检定更新模态框
- `StatusChangeModal` - 状态变更模态框

### 6.3 数据处理逻辑
- 自动检定日期计算
- 检定提醒规则引擎
- 生命周期状态管理
- 附件关联管理

## 7. 用户权限控制

### 7.1 查看权限
- 所有用户可查看所属部门设备的生命周期
- 管理员可查看所有设备的生命周期

### 7.2 操作权限
- 部门用户：不能操作所属部门的设备
- 管理员：可操作所有设备
- 器具管理员：可操作管理的设备
- 检定记录创建后不可删除，只能查看

## 8. 验收标准

### 8.1 功能验收
- [ ] 设备详情页正确显示生命周期时间轴
- [ ] 内检和外检流程按需求正确实现
- [ ] 检定倒计时计算准确
- [ ] 设备状态变更正确记录
- [ ] 报废流程完整实现
- [ ] 附件上传和下载功能正常

### 8.2 性能验收
- [ ] 时间轴加载时间 < 2秒
- [ ] 支持100+生命周期事件展示
- [ ] 移动端响应式布局正常

### 8.3 数据验收
- [ ] 生命周期记录数据完整性
- [ ] 历史数据迁移正确
- [ ] 数据库查询性能合格

## 9. 实施计划

### Phase 1: 数据库设计和后端API (3-4天)
- 创建生命周期表
- 实现基础CRUD API
- 数据迁移脚本

### Phase 2: 前端时间轴组件 (2-3天)
- 时间轴UI组件开发
- 设备详情页集成
- 响应式布局适配

### Phase 3: 检定管理功能 (3-4天)
- 内检/外检模态框开发
- 检定记录创建流程
- 附件上传集成

### Phase 4: 状态管理和提醒 (2-3天)
- 状态变更功能
- 检定倒计时
- 报废流程实现

### Phase 5: 测试和优化 (2-3天)
- 功能测试
- 性能优化
- 用户体验优化

## 10. 风险评估

### 10.1 技术风险
- **数据迁移风险**: 现有设备数据需要创建初始生命周期记录
- **性能风险**: 大量历史数据可能影响时间轴加载速度
- **兼容性风险**: 新功能需要与现有功能保持兼容

### 10.2 缓解措施
- 制定详细的数据迁移计划和回滚方案
- 实现分页加载和虚拟滚动优化性能
- 充分的回归测试确保兼容性

---

**文档版本**: v1.0  
**创建日期**: 2025-01-01  
**更新日期**: 2025-01-01  
**创建人员**: Claude Code  