好的，完全没有问题。# **计量设备台账管理系统 - 需求规格说明书 (增强版)**

*   **版本:** 1.1
*   **最后更新:** 2024-05-21

#### **项目概述**
本项目旨在开发一个现代化的计量设备台账管理系统，以取代传统、低效的手动管理方式。系统将实现设备信息的集中管理、检定周期的智能提醒、操作历史的全程追溯以及便捷的数据分析与报表功能，最终实现无纸化、自动化、智能化的设备管理目标。

#### **技术栈**
*   **前端:** React + Tailwind CSS
*   **后端:** Python + FastAPI
*   **Python环境管理:** uv

---

### **1. 核心功能需求 (Functional Requirements)**

#### **1.1. 用户账户与权限系统**

系统包含两种用户角色，权限划分明确：

*   **管理员 (Administrator):**
    *   拥有系统的最高权限。
    *   **账户管理:** 创建、查看、编辑、删除“器具负责人”账户。
    *   **基础数据管理:** 创建、编辑、删除“设备类别”和“使用部门”。
    *   **权限分配:** 为每个“器具负责人”分配其可管理的一个或多个“设备类别”。
    *   **设备完全访问权限:** 拥有对系统中所有设备台账的增、删、改、查权限，不受“设备类别”分配的限制。

*   **器具负责人 (Equipment Custodian):**
    *   权限受限，由管理员分配。
    *   只能查看和管理 (增、删、改、查) 自己被授权的“设备类别”下的设备台账。
    *   无法访问任何未被授权的设备数据。

#### **1.2. 设备管理**

*   **核心操作:** 支持设备信息的录入、修改和删除。
*   **设备信息字段详情:**

| 字段名称 | 数据类型 | 是否必填 | 备注 / 规则 |
| :--- | :--- | :--- | :--- |
| 使用部门 | 选项(关联) | 是 | 从管理员创建的“使用部门”列表中选择。 |
| 设备类别 | 选项(关联) | 是 | 从管理员创建的“设备类别”列表中选择。 |
| 计量器具名称 | 字符串 | 是 | |
| 型号/规格 | 字符串 | 是 | |
| 准确度等级 | 字符串 | 是 | |
| 测量范围 | 字符串 | 否 | |
| **计量编号** | **字符串** | **是** | **全局唯一，作为设备的核心标识。** |
| 检定周期 | 选项 | 是 | 预设选项：`6个月`, `12个月`, `24个月`，`36个月`和`随坏随换`。 当检定周期为`随坏随换`，就没有**有效期至**，且**检定(校准)日期**就不是必填项 |
| 检定(校准)日期 | 日期 (YYYY-MM-DD) | 是 | 当`检定周期`是`6个月`, `12个月`, `24个月`，`36个月`是必填项，当检定周期为`随坏随换`为非必填项 |
| **有效期至** | 日期 (YYYY-MM-DD) | **自动计算** | **计算规则: `有效期至 = 检定日期 + 检定周期 - 1天`。**由系统自动生成，无需手动填写。 |
| 安装地点 | 字符串 | 否 | |
| 分度值 | 字符串 | 否 | |
| 制造厂家 | 字符串 | 否 | |
| 出厂日期 | 日期 (YYYY-MM-DD) | 否 | |
| 检定方式 | 选项 | 是 | 预设选项：`内检`, `外检`。 |
| **证书编号** | 字符串 | **条件必填** | `检定方式`为`外检`时必填。 |
| **检定结果** | 字符串 | **条件必填** | `检定方式`为`外检`时必填。 |
| **检定机构** | 字符串 | **条件必填** | `检定方式`为`外检`时必填。 |
| **证书形式** | 字符串 | **条件必填** | `检定方式`为`外检`时必填。 |
| 管理级别 | 选项 | 是 | 预设选项：`A级`, `B级`, `C级`。系统将强制设定：若`检定方式`为`外检`，此项自动设为 `-` 且不可更改。 |
| 原值/元 | 数值 | 否 | 允许小数，步长可1。 |
| 设备状态 | 选项 | 是 | 预设选项：`在用`, `停用`, `报废`。 |
| **状态变更时间** | 日期(YYYY-MM-DD) | **条件记录** | 当`设备状态`变更为`停用`或`报废`时，自动记录当前时间，并允许用户修改。 |
| 备注 | 字符串 | 否 | |

*   **文件附件管理:**
    *   支持为每台设备上传附件，尤其是**检定证书**的扫描件。
    *   支持格式：`PDF`, `JPG`, `PNG`，`docx` 等常见文档和图片格式。
    *   用户可在设备详情页在线预览或下载已上传的附件。
*   **列表排序:** 设备管理列表默认按照`有效期至`的升序（从近到远）进行排序。
*   **批量操作:** 支持对筛选出的设备进行批量操作（如批量删除、修改状态等）。

#### **1.3. 检定提醒与通知 (新)**

此模块是系统的核心价值之一，将系统从被动台账升级为主动助手。

*   **待办事项与状态提醒 (Dashboard模块):**
    *   在用户登录后的主页（Dashboard）上，以醒目的卡片形式展示以下关键提醒：
        *   **即将到期 (本月内):** `X` 台设备需要送检。
        *   **已经超期:** `Y` 台设备超期未检。
    *   用户点击数字可直接跳转到筛选好的设备列表。
*   **自动化通知系统 (Notification System):**
    *   **提醒规则:** 在设备`有效期至`日期前 `X` 天（`X` 可由管理员在系统设置中配置，默认为30天），系统自动向该设备的“器具负责人”发送提醒通知（邮件或系统内消息）。
    *   **升级提醒:** 对于“已经超期”的设备，系统可配置每周或每日持续发送提醒，并可选择是否将提醒抄送给管理员，以确保问题得到处理。

#### **1.4. 数据查询与报表**

*   **查询功能:**
    *   支持基于多个字段的组合条件筛选（如部门、类别、状态等）。
    *   支持对关键字段（如名称、编号、型号等）的模糊搜索。
*   **数据统计与报表 (Dashboard):**
    *   **关键指标 (KPIs) 展示:**
        *   设备总数、在用设备数、停用设备数、报废设备数
        *   本月待检设备数
        *   超期未检设备数
    *   **可视化图表:**
        *   **饼图1:** 在用设备的【设备类别】分布。
        *   **饼图2:** 在用设备的【使用部门】分布。
    *   **可视化表格:**
        *   在Dashboard上展示当月待检的设备列表，按日期紧急程度排序。

#### **1.5. 数据导入与导出**

*   **数据导入:**
    *   **格式:** 支持 Excel (.xlsx) 文件导入。
    *   **导入字段顺序:** `使用部门`, `设备类别`, `计量器具名称`, `型号/规格`, `准确度等级`, `测量范围`, `计量编号`, `检定周期`, `检定(校准)日期`, `安装地点`, `分度值`, `制造厂家`, `出厂日期`, `检定方式`, `管理级别`, `原值/元`, `设备状态`,`状态变更时间`, `证书编号`, `检定结果`, `检定机构`, `证书形式`, `备注`。
    *   **注意:** 导入模板中不包含`有效期至`列。该字段将由系统根据`检定日期`和`检定周期`自动计算并生成。
    *   **数据校验:** 导入时进行严格校验（部门/类别存在性、日期格式、枚举值合法性）。
    *   **冲突处理:** 当导入的`计量编号`已存在时，提示用户选择**“覆盖”**或**“跳过”**。
    *   **错误反馈:** 弹窗汇总导入失败信息，明确指出 **Excel行号、字段名及失败原因**。

*   **数据导出:**
    *   **格式:** 支持导出为 Excel 文件，可导出全部或当前筛选结果。
    *   **导出字段顺序:** `序号`, `使用部门`, `设备类别`, `计量器具名称`, `型号/规格`, `准确度等级`, `测量范围`, `计量编号`, `检定周期`, `检定(校准)日期`, `有效期至`, `安装地点`, `分度值`, `制造厂家`, `出厂日期`, `检定方式`, `管理级别`, `原值/元`, `设备状态`,`状态变更时间`， `负责人`, `备注`。
    *   **动态列逻辑:**
        1.  **负责人:** 显示负责此设备类别的“器具负责人”账号名，若设备类别没有分配负责人，那么设备类别负责人为管理员。
        2.  **状态变更时间:** 若`设备状态`为`停用`或`报废`，则动态增加此列。
        3.  **外检信息:** 若`检定方式`为`外检`，则动态增加`证书编号`, `检定结果`, `检定机构`, `证书形式`列。

#### **1.6. 操作历史追溯 (Audit Trail)**

*   **日志记录范围:**
    *   **数据操作:** 对设备、用户、设备类别、使用部门的**创建、修改、删除**。
    *   **权限变更:** 管理员分配或变更设备类别的负责人。
    *   **用户会话:** 用户的**登录成功、登录失败、登出**事件。
*   **增强日志格式 (包含数据快照):**
    *   **创建:** `[时间] [用户A] 创建了设备 [计量编号: XXX, 名称: 高精度天平]`
    *   **修改:** `[时间] [用户B] 修改了设备 [计量编号: YYY] 的状态。旧值:“在用”，新值:“停用”。`
    *   **删除:** `[时间] [管理员] 删除了设备 [计量编号: ZZZ, 名称: 分析天平, 型号: FA2004]`
*   **功能:** 支持按操作人员、时间范围、操作类型追溯历史记录，并以时间线形式清晰展示。

---

### **2. 核心业务逻辑与约束 (Business Rules)**

*   **负责人删除约束:** 若一个“器具负责人”仍被分配管理任何“设备类别”，则禁止删除该账户。管理员必须先解除其所有管理职责。
*   **基础数据删除约束:** 若一个“设备类别”或“使用部门”下仍关联有任何设备，则禁止删除。必须先将关联设备转移或删除。
*   **权责分配与变更规则:**
    *   一个“设备类别”同时只能分配给一个“器具负责人”，确保责任明确。
    *   当管理员变更某设备类别的负责人时，系统应在**操作历史**中明确记录此变更，例如：`[时间] [管理员] 将 [设备类别: 天平] 的负责人由 [用户A] 变更为 [用户B]`。

---

### **3. 非功能性需求 (Non-Functional Requirements)**

*   **性能要求:**
    *   常规页面和数据请求的响应时间应在2秒以内。
    *   系统应能支持至少50个并发用户流畅访问。
*   **安全要求:**
    *   前后端数据传输必须使用 HTTPS 加密。
    *   所有API接口必须经过严格的用户身份验证和权限校验。
    *   用户密码必须经过加盐哈希处理后存储。
*   **可用性与可访问性要求:**
    *   用户界面应遵循现代设计标准，美观、简洁、操作直观。
    *   系统应在主流现代浏览器（Chrome, Firefox, Edge, Safari）上表现一致。
    *   系统界面设计应遵循Web内容可访问性指南(WCAG)，确保良好的可访问性 (Accessibility, a11y)，方便所有用户使用。
*   **数据备份与恢复 (Data Backup & Recovery):**
    *   **备份策略:** 系统应支持每日数据库全量自动备份。
    *   **备份存储:** 备份文件应存储在与生产服务器物理隔离的位置，并保留最近7-14天的备份。
    *   **恢复能力:** 应制定数据恢复预案，确保在发生数据丢失事件时，能将系统恢复至24小时内的某个时间点 (RPO <= 24h)。