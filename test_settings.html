<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置API测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">设置API测试</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">测试结果</h2>
            <div id="test-results" class="space-y-2">
                <!-- 测试结果将在这里显示 -->
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold mb-4">操作</h2>
            <div class="space-x-4">
                <button onclick="testGetSettings()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    测试获取设置
                </button>
                <button onclick="testUpdateSettings()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    测试更新设置
                </button>
                <button onclick="testResetSettings()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    测试重置设置
                </button>
            </div>
        </div>
    </div>

    <script>
        // 简化的API客户端
        class TestApiClient {
            constructor() {
                this.baseURL = '';
                this.token = localStorage.getItem('access_token');
            }

            getHeaders() {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }
                
                return headers;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: this.getHeaders(),
                    ...options
                };

                try {
                    const response = await fetch(url, config);
                    
                    if (response.status === 401) {
                        throw new Error('需要登录认证');
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `请求失败: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    throw error;
                }
            }

            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            async put(endpoint, data = {}) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }

            async post(endpoint, data = {}) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
        }

        const api = new TestApiClient();

        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const div = document.createElement('div');
            
            const colors = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'info': 'text-blue-600',
                'warning': 'text-yellow-600'
            };
            
            div.className = colors[type] || 'text-gray-600';
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            resultsDiv.appendChild(div);
            
            // 自动滚动到底部
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testGetSettings() {
            try {
                logResult('正在测试获取设置...', 'info');
                const response = await api.get('/api/settings');
                logResult(`获取设置成功: ${JSON.stringify(response)}`, 'success');
            } catch (error) {
                logResult(`获取设置失败: ${error.message}`, 'error');
            }
        }

        async function testUpdateSettings() {
            try {
                logResult('正在测试更新设置...', 'info');
                const testSettings = {
                    themeMode: 'light',
                    pageSize: 10,
                    sessionTimeout: 2,
                    minPasswordLength: 6,
                    enableTwoFactor: false,
                    enableLoginLog: true
                };
                
                const response = await api.put('/api/settings', testSettings);
                logResult(`更新设置成功: ${JSON.stringify(response)}`, 'success');
            } catch (error) {
                logResult(`更新设置失败: ${error.message}`, 'error');
            }
        }

        async function testResetSettings() {
            try {
                logResult('正在测试重置设置...', 'info');
                const response = await api.post('/api/settings/reset');
                logResult(`重置设置成功: ${JSON.stringify(response)}`, 'success');
            } catch (error) {
                logResult(`重置设置失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动测试
        window.addEventListener('load', function() {
            logResult('设置API测试页面已加载', 'info');
            logResult('请先登录系统，然后点击测试按钮', 'warning');
        });
    </script>
</body>
</html>