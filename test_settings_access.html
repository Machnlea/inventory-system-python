<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½®æƒé™æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ç³»ç»Ÿè®¾ç½®æƒé™æµ‹è¯•</h1>
            
            <!-- æµ‹è¯•ç”¨æˆ·ä¿¡æ¯è¾“å…¥ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                        <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="è¾“å…¥ç”¨æˆ·å" value="æµ‹è¯•ç”¨æˆ·">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·ç±»å‹</label>
                        <select id="userType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="manager">æ™®é€šç”¨æˆ·</option>
                            <option value="department_user">éƒ¨é—¨ç”¨æˆ·</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 space-x-2">
                    <button onclick="simulateLogin()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        æ¨¡æ‹Ÿç™»å½•
                    </button>
                    <button onclick="testSettingsAccess()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        æµ‹è¯•è®¿é—®ç³»ç»Ÿè®¾ç½®
                    </button>
                    <button onclick="clearUserInfo()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                        æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
                    </button>
                </div>
            </div>

            <!-- ä¾§è¾¹æ é¢„è§ˆ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ä¾§è¾¹æ é¢„è§ˆ</h2>
                <div class="w-64 bg-gray-800 rounded-lg p-4">
                    <div class="text-white text-lg font-bold mb-4">è®¾å¤‡å°è´¦ç®¡ç†ç³»ç»Ÿ</div>
                    <nav class="space-y-2">
                        <a href="#" class="flex items-center px-3 py-2 text-white/90 rounded">
                            <i class="fas fa-home mr-3"></i>
                            <span>ä»ªè¡¨ç›˜</span>
                        </a>
                        <a href="#" class="flex items-center px-3 py-2 text-white/90 rounded">
                            <i class="fas fa-cogs mr-3"></i>
                            <span>è®¾å¤‡ç®¡ç†</span>
                        </a>
                        <a href="#" class="flex items-center px-3 py-2 text-white/90 rounded">
                            <i class="fas fa-chart-bar mr-3"></i>
                            <span>ç»Ÿè®¡æŠ¥è¡¨</span>
                        </a>
                        
                        <!-- ç³»ç»Ÿç®¡ç†ä¸‹æ‹‰èœå• -->
                        <div class="relative">
                            <button class="flex items-center justify-between w-full px-3 py-2 text-white/90 rounded">
                                <div class="flex items-center">
                                    <i class="fas fa-cog mr-3"></i>
                                    <span>ç³»ç»Ÿç®¡ç†</span>
                                </div>
                                <i class="fas fa-chevron-down text-sm"></i>
                            </button>
                            <div class="ml-4 mt-1 space-y-1">
                                <a href="#" class="flex items-center px-3 py-2 text-white/80 rounded text-sm">
                                    <i class="fas fa-tags mr-3"></i>
                                    <span>è®¾å¤‡ç±»åˆ«</span>
                                </a>
                                <a href="#" class="flex items-center px-3 py-2 text-white/80 rounded text-sm">
                                    <i class="fas fa-building mr-3"></i>
                                    <span>éƒ¨é—¨ç®¡ç†</span>
                                </a>
                                <a href="#" class="flex items-center px-3 py-2 text-white/80 rounded text-sm">
                                    <i class="fas fa-users mr-3"></i>
                                    <span>ç”¨æˆ·ç®¡ç†</span>
                                </a>
                                <a href="#" class="flex items-center px-3 py-2 text-white/80 rounded text-sm">
                                    <i class="fas fa-history mr-3"></i>
                                    <span>æ“ä½œæ—¥å¿—</span>
                                </a>
                                <!-- ç³»ç»Ÿè®¾ç½® - ä»…ç®¡ç†å‘˜å¯è§ -->
                                <a href="/settings" class="flex items-center px-3 py-2 text-white rounded text-sm" id="settings-link" style="display: none;">
                                    <i class="fas fa-cog mr-3"></i>
                                    <span>ç³»ç»Ÿè®¾ç½®</span>
                                </a>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>

            <!-- å½“å‰ç”¨æˆ·çŠ¶æ€ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">å½“å‰ç”¨æˆ·çŠ¶æ€</h2>
                <div id="userStatus" class="text-gray-600">
                    å°šæœªç™»å½•
                </div>
            </div>

            <!-- æµ‹è¯•æ—¥å¿— -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h2 class="text-xl font-semibold mb-4">æµ‹è¯•æ—¥å¿—</h2>
                <div id="testLog" class="text-sm text-gray-600 max-h-40 overflow-y-auto">
                    ç­‰å¾…æµ‹è¯•...
                </div>
            </div>
        </div>
    </div>

    <script>
        let testLog = [];

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.unshift(`[${timestamp}] ${message}`);
            updateTestLog();
        }

        function updateTestLog() {
            document.getElementById('testLog').innerHTML = testLog.join('<br>');
        }

        // æ£€æŸ¥ç”¨æˆ·æƒé™å¹¶æ˜¾ç¤º/éšè—ç³»ç»Ÿè®¾ç½®èœå•
        function checkUserPermissions() {
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                const settingsLink = document.getElementById('settings-link');
                
                // ä»…å½“ç”¨æˆ·æ˜¯ç®¡ç†å‘˜æ—¶æ˜¾ç¤ºç³»ç»Ÿè®¾ç½®èœå•
                if (user.is_admin && settingsLink) {
                    settingsLink.style.display = 'flex';
                    addLog(`âœ… ç®¡ç†å‘˜ç”¨æˆ· ${user.username} å¯ä»¥çœ‹åˆ°ç³»ç»Ÿè®¾ç½®èœå•`);
                } else if (settingsLink) {
                    settingsLink.style.display = 'none';
                    addLog(`âŒ éç®¡ç†å‘˜ç”¨æˆ· ${user.username} çœ‹ä¸åˆ°ç³»ç»Ÿè®¾ç½®èœå•`);
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                document.getElementById('userStatus').innerHTML = `
                    <div class="space-y-2">
                        <p><strong>ç”¨æˆ·å:</strong> ${user.username}</p>
                        <p><strong>ç”¨æˆ·ç±»å‹:</strong> ${user.user_type}</p>
                        <p><strong>æ˜¯å¦ç®¡ç†å‘˜:</strong> ${user.is_admin ? 'æ˜¯' : 'å¦'}</p>
                        <p><strong>ç³»ç»Ÿè®¾ç½®èœå•:</strong> ${user.is_admin ? 'å¯è§' : 'éšè—'}</p>
                    </div>
                `;
            } else {
                document.getElementById('userStatus').innerHTML = '<p class="text-gray-600">å°šæœªç™»å½•</p>';
                const settingsLink = document.getElementById('settings-link');
                if (settingsLink) {
                    settingsLink.style.display = 'none';
                }
                addLog('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œç³»ç»Ÿè®¾ç½®èœå•å·²éšè—');
            }
        }

        // æ¨¡æ‹Ÿç™»å½•
        function simulateLogin() {
            const username = document.getElementById('username').value || 'æµ‹è¯•ç”¨æˆ·';
            const userType = document.getElementById('userType').value;
            
            const userInfo = {
                id: 1,
                username: username,
                user_type: userType,
                is_admin: userType === 'admin',
                department_id: null,
                first_login: false,
                is_active: true
            };
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            sessionStorage.setItem('user_info', JSON.stringify(userInfo));
            localStorage.setItem('user_info', JSON.stringify(userInfo));
            
            // æ£€æŸ¥æƒé™
            checkUserPermissions();
            
            addLog(`ğŸ”“ æ¨¡æ‹Ÿç™»å½•æˆåŠŸï¼ç”¨æˆ·ï¼š${username}ï¼Œç±»å‹ï¼š${userType}`);
        }

        // æµ‹è¯•è®¿é—®ç³»ç»Ÿè®¾ç½®
        function testSettingsAccess() {
            const userInfo = sessionStorage.getItem('user_info') || localStorage.getItem('user_info');
            if (!userInfo) {
                addLog('âŒ è¯·å…ˆç™»å½•');
                return;
            }

            const user = JSON.parse(userInfo);
            
            if (user.is_admin) {
                addLog('ğŸ”“ ç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ­£åœ¨è·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®é¡µé¢...');
                // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šè·³è½¬åˆ° /settings
                addLog('âœ… è·³è½¬åˆ° /settings (æ¨¡æ‹Ÿ)');
            } else {
                addLog('ğŸš« éç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿè®¾ç½®');
                addLog('ğŸ”„ æ­£åœ¨é‡å®šå‘åˆ°ä»ªè¡¨ç›˜... (æ¨¡æ‹Ÿ)');
                // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šé‡å®šå‘åˆ° /dashboard
            }
        }

        // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
        function clearUserInfo() {
            sessionStorage.removeItem('user_info');
            localStorage.removeItem('user_info');
            checkUserPermissions();
            addLog('ğŸ—‘ï¸ ç”¨æˆ·ä¿¡æ¯å·²æ¸…é™¤');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æƒé™
        document.addEventListener('DOMContentLoaded', function() {
            checkUserPermissions();
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œæƒé™æ£€æŸ¥å·²æ‰§è¡Œ');
        });
    </script>
</body>
</html>