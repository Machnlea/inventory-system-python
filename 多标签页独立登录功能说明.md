# 多标签页独立登录功能说明

## 功能概述

现在系统支持在同一浏览器内的不同标签页独立登录不同账号。每个标签页维护独立的登录状态，当尝试在新标签页登录已在其他标签页使用的账号时，系统会提供选择机制。

## 主要特性

### 1. 标签页独立登录
- 每个标签页可以独立登录不同的用户账号
- 使用 `sessionStorage` 替代 `localStorage` 实现标签页隔离
- 关闭标签页时自动清除该标签页的登录状态

### 2. 登录冲突检测
- 当尝试登录已在其他标签页使用的账号时，自动检测冲突
- 显示友好的冲突提示对话框
- 提供详细的冲突信息（如检测到的标签页数量）

### 3. "挤掉"功能
- 用户可以选择强制登录并退出其他标签页的相同账号
- 被挤掉的标签页会显示通知并自动跳转到登录页面
- 提供取消登录的选项

### 4. 跨标签页通信
- 使用 `BroadcastChannel` API 实现标签页间实时通信
- 支持登录状态同步和冲突检测
- 自动处理标签页关闭和会话清理

## 测试方法

### 基础测试：多标签页独立登录

1. **打开第一个标签页**
   - 访问 `http://127.0.0.1:8000/login`
   - 使用账号A登录（如 `admin` / `password`）
   - 登录成功后查看仪表盘

2. **打开第二个标签页**
   - 在同一浏览器中新开标签页
   - 访问 `http://127.0.0.1:8000/login`
   - 使用不同账号B登录（如其他用户账号）
   - 确认可以成功登录且不影响第一个标签页

3. **验证独立性**
   - 在两个标签页间切换，确认各自保持独立的登录状态
   - 关闭其中一个标签页，另一个标签页应继续正常工作

### 冲突检测测试：登录冲突提示

1. **创建冲突场景**
   - 第一个标签页登录账号A
   - 第二个标签页尝试登录相同的账号A

2. **验证冲突检测**
   - 系统应该显示冲突提示对话框
   - 对话框显示："用户 [账号A] 已在其他标签页登录"
   - 显示检测到的标签页数量

3. **测试取消选项**
   - 点击"取消登录"按钮
   - 确认登录被取消，停留在登录页面
   - 第一个标签页应该继续正常工作

### "挤掉"功能测试：强制登录

1. **执行强制登录**
   - 重复上述冲突场景
   - 在冲突对话框中选择"强制登录"

2. **验证挤掉效果**
   - 第二个标签页应该成功登录
   - 第一个标签页应该：
     - 显示通知："您的账号在其他标签页登录，当前会话已结束"
     - 2秒后自动跳转到登录页面

3. **确认状态**
   - 第一个标签页已退出登录
   - 第二个标签页正常使用账号A

### 高级测试：多用户多标签页

1. **复杂场景设置**
   - 标签页1：登录用户A
   - 标签页2：登录用户B
   - 标签页3：尝试登录用户A（应触发冲突）
   - 标签页4：尝试登录用户C

2. **验证行为**
   - 标签页3的冲突检测应正确识别标签页1
   - 标签页4应该能正常登录用户C
   - 如果标签页3强制登录，只有标签页1应该被挤掉

## 技术实现细节

### 会话存储
```javascript
// 新方式：使用 sessionStorage（标签页独立）
sessionStorage.setItem('access_token', token);
sessionStorage.setItem('user_info', JSON.stringify(user));

// 旧方式：使用 localStorage（浏览器共享）- 已替换
// localStorage.setItem('access_token', token);
```

### 跨标签页通信
```javascript
// 创建广播频道
const channel = new BroadcastChannel('tab-session-manager');

// 发送消息
channel.postMessage({
    type: 'login_check_request',
    username: username,
    fromTab: this.tabId
});

// 监听消息
channel.addEventListener('message', (event) => {
    this.handleMessage(event.data);
});
```

### 冲突检测流程
1. 用户提交登录表单
2. 系统广播登录检查请求到所有标签页
3. 其他标签页响应当前登录状态
4. 收集响应并检测冲突
5. 如有冲突，显示选择对话框
6. 根据用户选择执行相应操作

## 兼容性说明

- **浏览器要求**: 支持 `BroadcastChannel` API 的现代浏览器
- **向后兼容**: 自动降级到原有的 `localStorage` 方式
- **移动端**: 完全支持移动浏览器的多标签页功能

## 故障排除

### 常见问题

1. **登录后立即跳转到登录页**
   - 检查浏览器控制台是否有JavaScript错误
   - 确认所有页面都已加载 `tab-session-manager.js`

2. **冲突检测不工作**
   - 确认浏览器支持 `BroadcastChannel` API
   - 检查网络控制台是否有跨域问题

3. **标签页通信失败**
   - 确认所有标签页都在同一域名下
   - 检查浏览器的安全设置

### 调试方法

在浏览器控制台中查看调试信息：
```javascript
// 查看当前标签页ID
console.log(tabSessionManager.tabId);

// 查看当前用户信息
console.log(tabSessionManager.getCurrentUser());

// 手动测试冲突检测
tabSessionManager.checkLoginConflict('username').then(console.log);
```

## 总结

该功能实现了真正的多标签页独立登录体验，同时提供了智能的冲突检测和处理机制。用户可以在同一浏览器内方便地切换不同账号进行工作，大大提升了使用便利性。