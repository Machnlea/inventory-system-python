# 设备检定历史记录功能需求文档

## 项目概述
为设备台账管理系统增加检定历史记录功能，支持内检和外检两种检定方式的差异化处理，并实现检定结果的自动化状态管理。

## 功能需求

### 1. 检定方式分类

#### 1.1 内检设备
- **特点**：设备内部进行的检定
- **字段要求**：
  - 证书编号：可选填写
  - 证书形式：可选填写
  - 检定结果：可选填写
  - 证书附件：可选上传
  - 备注：可选填写

#### 1.2 外检设备
- **特点**：外部机构进行的检定
- **字段要求**：
  - 证书编号：**必填**
  - 检定结果：**必填**
  - 检定机构：**必填**
  - 证书形式：**必填**
  - 证书附件：**可选上传**

### 2. 检定结果处理

#### 2.1 检定结果选项
- **合格**（默认选择）
- **不合格**

#### 2.2 不合格处理逻辑
当选择"不合格"时：
- 设备状态自动变更为"报废"
- **必填字段**：
  - 状态变更时间（报废时间）
- **可选字段**：
  - 报废原因
  - 相关附件

### 3. 设备状态说明

#### 3.1 设备状态分类
- **在用**：检定合格，正常使用
- **停用**：检定合格，因其他原因停止使用
- **报废**：检定不合格，需要报废处理

#### 3.2 状态变更规则
- 检定合格 → 保持原状态（在用/停用）
- 检定不合格 → 自动变更为报废

### 4. 检定历史记录内容

#### 4.1 记录组成
- **设备添加时间**：
  - 手动添加：实际创建时间
  - 批量导入：导入时间
  - 检定历史时间
- **检定基础信息**：
  - 检定(校准)日期：**必填**
  - 有效期至：系统自动生成
  - 本次检定结果：合格/不合格
- **证书信息**：
  - 证书编号（内检可选，外检必填）
  - 证书形式（内检可选，外检必填）
  - 证书附件（内检可选，外检可选）
- **检定机构信息**：
  - 检定机构（外检必填）
- **其他信息**：
  - 备注（可选）

#### 4.2 显示位置
- **主要位置**：设备详情页 `/equipment/view?id={id}` 的检定历史卡片


### 5. 界面交互需求

#### 5.1 设备管理页面更新检定日期功能
**位置**：`http://127.0.0.1:8000/equipment` 还要该页面的批量操作-批量更新检定日期，如果是批量操作，将会按照顺序，外检设备会一个弹窗确认保存了跳下一个设备的弹窗保存确认

**功能流程**：
1. 点击"更新检定日期"按钮
2. 弹出检定信息更新窗口
3. 根据设备检定方式（内检/外检）显示不同表单
4. 填写相关信息
5. 选择检定结果（合格/不合格）
6. 如选择不合格，显示报废信息填写区域
7. 提交更新
8. 选中多个设备点击"批量更新检定日期"按钮。依次弹出上面的检定信息更新窗口，一个设备更新了跳下一个设备的检定信息更新窗口

**表单字段**：
```
通用字段：
- 检定(校准)日期：日期选择器，必填
- 有效期至：在填写了检定(校准)日期，系统自动按照检定周期生成，系统已有功能，请保持不变
- 本次检定结果：单选框（合格/不合格），默认合格

内检设备额外字段：
- 证书形式：文本输入框，可选（检定证书/校准证书），现在外检设备有这个字段，拓展到内检设备
- 证书编号：文本输入框，可选，现在外检设备有这个字段，拓展到内检设备
- 检定结果：文本输入框，可选
- 证书附件：文件上传，可选
- 备注：文本域，可选

外检设备额外字段：
- 证书编号：文本输入框，必填
- 检定结果：文本输入框，必填
- 检定机构：文本输入框，必填
- 证书形式：下拉选择，必填（检定证书/校准证书）
- 证书附件：文件上传，必选

不合格时显示的报废信息：
- 状态变更时间：日期时间选择器，必填，默认填写当前日期，用户可修改
- 报废原因：文本域，可选
- 相关附件：文件上传，可选
```

#### 5.2 设备详情页面检定历史显示
**位置**：`http://127.0.0.1:8000/equipment/view?id=1`

**显示内容**：
- 时间线形式展示检定历史
- 每条记录包含：
  - 检定日期
  - 检定结果（合格/不合格）
  - 证书编号（如有）
  - 证书形式（检定证书/校准证书）
  - 有效期至
  - 附件下载链接（如有）
  - 详细信息展开功能

### 6. 数据库字段扩展需求

#### 6.1 设备表 (Equipment) 新增字段
```sql
-- 检定相关扩展字段
certificate_number VARCHAR(100),      -- 证书编号，现在外检设备有这个字段，拓展到内检设备
certificate_form VARCHAR(50),         -- 证书形式（检定证书/校准证书），现在外检设备有这个字段，拓展到内检设备
verification_result VARCHAR(50),      -- 本次检定结果
verification_agency VARCHAR(100),     -- 检定机构，外检专属
calibration_notes TEXT,               -- 检定备注

-- 状态管理字段
status_change_date DATETIME,          -- 状态变更时间
disposal_reason TEXT,                 -- 报废原因
```

#### 6.2 新表：检定历史记录 (CalibrationHistory)
```sql
CREATE TABLE calibration_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    equipment_id INT NOT NULL,                    -- 设备ID
    calibration_date DATE NOT NULL,               -- 检定日期
    valid_until DATE NOT NULL,                    -- 有效期至
    calibration_method VARCHAR(20) NOT NULL,      -- 检定方式（内检/外检）
    calibration_result VARCHAR(20) NOT NULL,      -- 本次检定结果（合格/不合格）
    certificate_number VARCHAR(100),              -- 证书编号
    certificate_form VARCHAR(50),                 -- 证书形式
    verification_result VARCHAR(50),              -- 检定结果描述
    verification_agency VARCHAR(100),             -- 检定机构
    notes TEXT,                                   -- 备注
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,-- 记录创建时间
    created_by INT,                               -- 创建者ID
    
    FOREIGN KEY (equipment_id) REFERENCES equipment(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

#### 6.3 附件关联表扩展
- 支持检定历史记录的附件关联
- 区分证书附件和报废相关附件

### 7. API接口需求

#### 7.1 检定更新接口
```
PUT /api/equipment/{id}/calibration
- 更新设备检定信息
- 创建检定历史记录
- 处理状态变更逻辑
- 上传相关附件
```

#### 7.2 检定历史查询接口
```
GET /api/equipment/{id}/calibration-history
- 获取设备检定历史记录列表
- 支持分页和排序
```

#### 7.3 报废处理接口
```
PUT /api/equipment/{id}/disposal
- 处理设备报废相关信息
- 更新设备状态
```

### 8. 业务规则

#### 8.1 数据验证规则
1. 外检设备的证书编号、检定结果、检定机构、证书形式为必填
2. 选择不合格时，状态变更时间为必填
3. 检定日期不能晚于有效期至日期
4. 已报废设备不允许更新检定信息

#### 8.2 权限控制
- 只有具备设备管理权限的用户可以更新检定信息
- 检定历史记录创建后不可删除，只可查看

#### 8.3 通知机制
- 设备状态变更时发送通知
- 检定到期前提醒相关人员

### 9. 实施优先级

#### 第一阶段（高优先级）
1. 数据库结构设计和创建
2. 基础API接口开发
3. 设备管理页面检定更新功能

#### 第二阶段（中优先级）  
1. 设备详情页面检定历史显示
2. 附件管理功能集成
3. 报废处理流程

#### 第三阶段（低优先级）
1. 通知提醒功能
2. 数据导出功能
3. 统计报表功能

### 10. 技术考虑

#### 10.1 性能优化
- 检定历史记录分页加载
- 附件预览优化
- 数据库索引优化

#### 10.2 兼容性
- 向后兼容现有设备数据
- 批量数据迁移脚本
- 渐进式功能部署

#### 10.3 数据完整性
- 事务处理确保数据一致性
- 历史记录不可篡改
- 审计日志记录

## 验收标准

1. 内检设备可以选择性填写证书信息
2. 外检设备必须填写完整证书信息
3. 检定不合格时设备自动变更为报废状态
4. 检定历史记录完整准确显示
5. 文件上传和预览功能正常
6. 数据验证和错误提示完善
7. 权限控制符合安全要求

## 风险评估

1. **数据迁移风险**：现有设备数据需要平滑迁移
2. **性能风险**：大量历史记录可能影响查询性能
3. **用户体验风险**：复杂表单可能降低用户操作效率
4. **数据一致性风险**：多表关联操作需要确保事务完整性

---

**文档版本**：v1.0  
**创建日期**：2025-09-02  
**最后更新**：2025-09-02