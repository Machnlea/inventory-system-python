# 检定历史记录数据库字段扩展需求

## 项目概述
基于现有设备数据库模型分析，确定检定历史记录功能所需的数据库字段扩展方案。

## 现有设备表字段分析

### 已存在字段（无需新增）
通过分析 `app/models/models.py` 中的Equipment模型（第95-145行），以下需求字段已经存在：

| 字段名 | 数据类型 | 说明 | 模型中位置 |
|--------|----------|------|------------|
| `certificate_number` | String(100) | 证书编号 | models.py:115 |
| `verification_result` | String(100) | 检定结果 | models.py:116 |
| `verification_agency` | String(100) | 检定机构 | models.py:117 |
| `certificate_form` | String(50) | 证书形式 | models.py:118 |
| `status_change_date` | Date | 状态变更时间 | models.py:134 |

### 现有基础字段
以下基础字段也已存在，支持检定功能：

| 字段名 | 数据类型 | 说明 | 模型中位置 |
|--------|----------|------|------------|
| `calibration_cycle` | String(10) | 检定周期 | models.py:109 |
| `calibration_date` | Date | 检定日期 | models.py:110 |
| `valid_until` | Date | 有效期至 | models.py:111 |
| `calibration_method` | String(50) | 检定方式 | models.py:112 |
| `status` | String(20) | 设备状态 | models.py:133 |
| `notes` | Text | 备注 | models.py:135 |

## 需要新增的字段

### 设备表 (Equipment) 新增字段

根据需求分析，需要为设备表新增以下字段：

| 字段名 | 数据类型 | 默认值 | 可空 | 说明 |
|--------|----------|--------|------|------|
| `calibration_notes` | Text | NULL | YES | 检定备注（专门用于检定相关备注，区别于通用备注） |
| `disposal_reason` | Text | NULL | YES | 报废原因 |
| `current_calibration_result` | String(20) | '合格' | NO | 当前检定结果（合格/不合格） |

### 新增表：检定历史记录 (CalibrationHistory)

创建全新的检定历史记录表：

```sql
CREATE TABLE calibration_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    equipment_id INTEGER NOT NULL,                    -- 设备ID
    calibration_date DATE NOT NULL,                   -- 检定日期
    valid_until DATE NOT NULL,                        -- 有效期至
    calibration_method VARCHAR(20) NOT NULL,          -- 检定方式（内检/外检）
    calibration_result VARCHAR(20) NOT NULL,          -- 本次检定结果（合格/不合格）
    certificate_number VARCHAR(100),                  -- 证书编号
    certificate_form VARCHAR(50),                     -- 证书形式（检定证书/校准证书）
    verification_result VARCHAR(100),                 -- 检定结果描述
    verification_agency VARCHAR(100),                 -- 检定机构
    notes TEXT,                                       -- 检定备注
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,    -- 记录创建时间
    created_by INTEGER,                               -- 创建者ID
    
    FOREIGN KEY (equipment_id) REFERENCES equipments(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 附件表扩展

扩展现有的 `EquipmentAttachment` 表，支持检定历史记录的附件关联：

| 字段名 | 数据类型 | 默认值 | 可空 | 说明 |
|--------|----------|--------|------|------|
| `calibration_history_id` | Integer | NULL | YES | 检定历史记录ID（新增外键） |
| `attachment_category` | String(50) | 'equipment' | NO | 附件类别（equipment/calibration/disposal） |

## 索引优化建议

### 检定历史记录表索引
```sql
-- 按设备查询优化
CREATE INDEX idx_calibration_history_equipment_id ON calibration_history(equipment_id);

-- 按创建时间查询优化
CREATE INDEX idx_calibration_history_created_at ON calibration_history(created_at);

-- 按检定日期查询优化
CREATE INDEX idx_calibration_history_calibration_date ON calibration_history(calibration_date);

-- 复合索引：按设备和检定日期查询优化
CREATE INDEX idx_calibration_history_equipment_date ON calibration_history(equipment_id, calibration_date DESC);
```

### 附件表索引扩展
```sql
-- 检定历史记录附件查询优化
CREATE INDEX idx_equipment_attachments_calibration_history ON equipment_attachments(calibration_history_id);

-- 附件类别查询优化
CREATE INDEX idx_equipment_attachments_category ON equipment_attachments(attachment_category);
```

## 数据迁移策略

### 现有数据处理
1. **保持现有设备表数据不变**：所有现有字段继续保持
2. **为新增字段设置默认值**：
   - `calibration_notes`: NULL
   - `disposal_reason`: NULL
   - `current_calibration_result`: '合格'

### 历史数据迁移
1. **为现有设备创建初始检定历史记录**：
   ```sql
   INSERT INTO calibration_history (
       equipment_id, calibration_date, valid_until, 
       calibration_method, calibration_result,
       certificate_number, certificate_form, 
       verification_result, verification_agency,
       notes, created_at, created_by
   )
   SELECT 
       id, calibration_date, valid_until,
       calibration_method, '合格',
       certificate_number, certificate_form,
       verification_result, verification_agency,
       notes, created_at, 1  -- 默认创建者为管理员
   FROM equipments 
   WHERE calibration_date IS NOT NULL;
   ```

## 业务逻辑影响分析

### 字段关系映射
- **设备表当前字段** ↔ **检定历史最新记录**：保持数据一致性
- **状态变更逻辑**：检定不合格时自动设置 `status = '报废'` 和 `disposal_reason`
- **附件关联**：证书附件可同时关联设备和检定历史记录

### 数据一致性规则
1. 设备表的检定信息始终反映最新的检定结果
2. 每次检定更新时，同步更新设备表和创建检定历史记录
3. 附件上传时根据类型关联到相应的表记录

## 实施优先级

### 第一阶段：数据库结构
1. 创建检定历史记录表
2. 为设备表添加新增字段
3. 扩展附件表字段
4. 创建相关索引

### 第二阶段：数据迁移
1. 为现有设备创建初始检定历史记录
2. 数据完整性验证
3. 业务逻辑测试

### 第三阶段：功能集成
1. 后端API接口开发
2. 前端界面集成
3. 完整功能测试

## 兼容性保证

1. **向后兼容**：现有API和功能不受影响
2. **渐进升级**：可逐步迁移到新的检定历史功能
3. **数据完整性**：确保现有数据在扩展过程中不丢失

## 风险评估

### 低风险
- 新增字段允许NULL值，不影响现有数据
- 检定历史记录表为独立新表，不影响现有业务

### 中风险  
- 附件表扩展需要谨慎处理现有附件关联
- 数据迁移过程需要确保数据一致性

### 缓解措施
- 在测试环境充分验证迁移脚本
- 生产环境迁移前完整备份数据库
- 分阶段实施，确保每个阶段都可回滚

---

**文档版本**：v1.0  
**创建日期**：2025-09-02  
**基于模型**：app/models/models.py (Equipment: 95-145行)  
**数据库类型**：SQLite